% Package imports

\usepackage[english]{babel}
\usepackage{caption}
\usepackage{afterpage}
\usepackage{atbegshi} % Package to insert content at the beginning
\usepackage{etoolbox}
\usepackage{fancyhdr}
\usepackage{fontspec}
\usepackage{geometry}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{marginfix} % Fixes the issue of margin notes being cut off
\usepackage{minitoc}
\usepackage{marginnote}
\usepackage{mathptmx}
\usepackage{newpxtext} % Palatino-like font
\usepackage{ragged2e}
\usepackage{longtable}
\usepackage{titlesec}
\usepackage{tocloft}
\usepackage{xcolor}
\usepackage[outercaption, ragged]{sidecap}
\usepackage{tcolorbox}    % For creating colored boxes
\usepackage{etoolbox}      % For redefining footnotes
\usepackage{footmisc}      % Optional: For extra footnote formatting control
\usepackage{sidenotes}

% Define the Crimson color
\definecolor{crimson}{HTML}{A51C30}

% Define a minimalist sidenote style with shading and no box
% \let\oldsidenote\marginnote
% \renewcommand{\marginnote}[1]{%
%   \oldsidenote{%
%     \vspace{-1em} % Adjust vertical position slightly to align better
%     \noindent
%     \colorbox{blue!5}{\parbox{0.9\marginparwidth}{\raggedright\footnotesize #1}}%
%   }
% }

% Redefine \sidenote to include a custom minimalist styled box with a vertical bar
\renewcommand{\thefootnote}{\textcolor{crimson}{\arabic{footnote}}}

\let\oldsidenote\sidenote
\renewcommand{\sidenote}[1]{%
  \oldsidenote{%
    \vspace{-1em} % Adjust position to align better with main text
    \noindent
    \begin{minipage}{0.9\marginparwidth}
      \color{crimson!100} % Light blue color for the vertical line
      \rule{0.5pt}{1.5em} \hspace{0.3em} % Thin vertical line with spacing
      {\footnotesize #1} % Light background for sidenote text
    \end{minipage}%
  }
}

% Redefine the figure environment (fixes the bug where even page captions don't show, odd I know!)
\makeatletter
\let\oldfigure\figure
\let\endoldfigure\endfigure
\renewenvironment{figure}[1][htbp]{%
  \oldfigure[#1]%
}{%
  \endoldfigure
}
\makeatother

\babelprovide[import]{czech}

\patchcmd{\chapter}{\thispagestyle{plain}}{\thispagestyle{fancy}}{}{}

% Page style settings
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE]{\color{crimson}\nouppercase{\rightmark}}
\fancyhead[RO]{\color{crimson}\thepage}
\fancyhead[LO]{\color{crimson}\MakeUppercase{\leftmark}}
\fancyhead[RE]{\color{crimson}\thepage}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyhead[LE,RO]{\color{crimson}\thepage}
  \renewcommand{\headrulewidth}{0.4pt}
  \renewcommand{\footrulewidth}{0pt}
}

% KOMA-Script adjustments
\addtokomafont{disposition}{\rmfamily\color{crimson}}
\addtokomafont{chapter}{\color{crimson}}
\addtokomafont{section}{\color{crimson}}
\addtokomafont{subsection}{\color{crimson}}

\newenvironment{abstract}{
  \chapter*{\abstractname}
  \addcontentsline{toc}{chapter}{\abstractname}
  \small
}{
  \clearpage 
}

\hypersetup{
  linkcolor=crimson,
  citecolor=crimson,
  urlcolor=crimson,
  pdfpagelayout=TwoPageRight, % This sets the layout to two-page mode with the first page alone
  pdfstartview=Fit % This sets the initial zoom to fit the page
}

\geometry{
  paperwidth=7.5in,
  paperheight=9.25in,
  top=1in,
  bottom=1in,
  inner=1in,
  outer=2.25in,
  marginparwidth=1.5in,
  twoside
}

% Redefine \part (if you want to apply the Crimson color here)
\titleformat{\part}[display]
  {\normalfont\Huge\bfseries\color{crimson}} % Set the color to crimson
  {\partname~\thepart}
  {0pt}
  {\Huge}
  [\vspace{20pt}]

% Redefine \section
\titleformat{\section}
  {\normalfont\Large\bfseries\color{crimson}} % Set the color to crimson
  {\thesection}
  {10pt}
  {}

% Redefine \subsection
\titleformat{\subsection}
  {\normalfont\large\bfseries\color{crimson}} % Set the color to crimson
  {\thesubsection}
  {10pt}
  {}

% Redefine \subsubsection
\titleformat{\subsubsection}
  {\normalfont\normalsize\bfseries\color{crimson}} % Set the color to crimson
  {\thesubsubsection}
  {10pt}
  {}

% Redefine \paragraph (if you want to apply the Crimson color here)
\titleformat{\paragraph}[runin]
  {\normalfont\normalsize\bfseries\color{crimson}} % Set the color to crimson
  {\theparagraph}
  {10pt}
  {}
  [\textbf{.}]

% Redefine \subparagraph (if you want to apply the Crimson color here)
\titleformat{\subparagraph}[runin]
  {\normalfont\normalsize\itshape\color{crimson}} % Set the color to crimson
  {\thesubparagraph}
  {10pt}
  {}
  [\textbf{.}]

% Customize Chapter title format
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries\color{crimson}} % Apply the crimson color
  {\chaptername\ \thechapter} % Prefix "Chapter X"
  {20pt} % Space between number and title
  {\Huge} % Format the title itself
  []

% Ensure that \chaptername is set to "Chapter"
\renewcommand{\chaptername}{Chapter}

\setcounter{tocdepth}{2}
\setlength{\cftsecnumwidth}{2.75em} % Adjust width for section numbers
\setlength{\cftsubsecnumwidth}{3.25em} % Adjust width for subsection numbers
\setlength{\cftsubsubsecnumwidth}{4em} % Adjust width for subsubsection numbers

\setcounter{minitocdepth}{3} % Set depth for in-chapter mini-TOCs
\dominitoc % Place \minitoc command at the start of each chapter
