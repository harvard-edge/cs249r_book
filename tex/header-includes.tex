% Package imports

\usepackage[english]{babel}
\usepackage{caption}
\usepackage{afterpage}
\usepackage{atbegshi} % Package to insert content at the beginning
\usepackage{etoolbox}
\usepackage{etex}
\usepackage{fancyhdr}
\usepackage{fontspec}
\usepackage{geometry}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{marginfix} % Fixes the issue of margin notes being cut off
\usepackage{marginnote}
\usepackage{mathptmx}
\usepackage{morewrites}
\usepackage{newpxtext} % Palatino-like font
\usepackage{ragged2e}
\usepackage{longtable}
\usepackage{titletoc}  % Load the titletoc package for TOC customization
\usepackage{titlesec}
\usepackage{xcolor}
\usepackage[outercaption, ragged]{sidecap}

% Define the Crimson color
\definecolor{crimson}{HTML}{A51C30}

% Redefine the figure environment (fixes the bug where even page captions don't show, odd I know!)
\makeatletter
\let\oldfigure\figure
\let\endoldfigure\endfigure
\renewenvironment{figure}[1][htbp]{%
  \oldfigure[#1]%
}{%
  \endoldfigure
}
\makeatother

\babelprovide[import]{czech}

\patchcmd{\chapter}{\thispagestyle{plain}}{\thispagestyle{fancy}}{}{}

% Page style settings
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE]{\color{crimson}\nouppercase{\rightmark}}
\fancyhead[RO]{\color{crimson}\thepage}
\fancyhead[LO]{\color{crimson}\MakeUppercase{\leftmark}}
\fancyhead[RE]{\color{crimson}\thepage}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyhead[LE,RO]{\color{crimson}\thepage}
  \renewcommand{\headrulewidth}{0.4pt}
  \renewcommand{\footrulewidth}{0pt}
}

% KOMA-Script adjustments
\addtokomafont{disposition}{\rmfamily\color{crimson}}
\addtokomafont{chapter}{\color{crimson}}
\addtokomafont{section}{\color{crimson}}
\addtokomafont{subsection}{\color{crimson}}

\newenvironment{abstract}{
  \chapter*{\abstractname}
  \addcontentsline{toc}{chapter}{\abstractname}
  \small
}{
  \clearpage 
}

\hypersetup{
  linkcolor=crimson,
  citecolor=crimson,
  urlcolor=crimson,
  pdfpagelayout=TwoPageRight, % This sets the layout to two-page mode with the first page alone
  pdfstartview=Fit % This sets the initial zoom to fit the page
}

\geometry{
  paperwidth=7.5in,
  paperheight=9.25in,
  top=1in,
  bottom=1in,
  inner=1in,
  outer=2.25in,
  marginparwidth=1.5in,
  twoside
}

% Redefine \part (if you want to apply the Crimson color here)
\titleformat{\part}[display]
  {\normalfont\Huge\bfseries\color{crimson}} % Set the color to crimson
  {\partname~\thepart}
  {0pt}
  {\Huge}
  [\vspace{20pt}]

% Redefine \section
\titleformat{\section}
  {\normalfont\Large\bfseries\color{crimson}} % Set the color to crimson
  {\thesection}
  {10pt}
  {}

% Redefine \subsection
\titleformat{\subsection}
  {\normalfont\large\bfseries\color{crimson}} % Set the color to crimson
  {\thesubsection}
  {10pt}
  {}

% Redefine \subsubsection
\titleformat{\subsubsection}
  {\normalfont\normalsize\bfseries\color{crimson}} % Set the color to crimson
  {\thesubsubsection}
  {10pt}
  {}

% Redefine \paragraph (if you want to apply the Crimson color here)
\titleformat{\paragraph}[runin]
  {\normalfont\normalsize\bfseries\color{crimson}} % Set the color to crimson
  {\theparagraph}
  {10pt}
  {}
  [\textbf{.}]

% Redefine \subparagraph (if you want to apply the Crimson color here)
\titleformat{\subparagraph}[runin]
  {\normalfont\normalsize\itshape\color{crimson}} % Set the color to crimson
  {\thesubparagraph}
  {10pt}
  {}
  [\textbf{.}]

% Customize Chapter title format
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries\color{crimson}} % Apply crimson color to chapter titles
  {\chaptername\ \thechapter} % Display "Chapter X" before the title
  {20pt} % Space between chapter number and title
  {\Huge} % Format the chapter title itself
  []

% Define \chaptername to be "Chapter"
\renewcommand{\chaptername}{Chapter}

% Define a custom style for chapter-level TOCs, named "chapter"
\titlecontents{chapter}[0pt]{\bfseries\Large} % Indentation and styling for chapter TOCs
  {\contentslabel{2em}}  % Spacing for TOC entries
  {}
  {\titlerule*[1pc]{.}\contentspage}  % Add dotted line to page number

% Define the \chaptertoc macro, using the "chapter" TOC style
\newcommand{\chaptertoc}{
  \begin{minipage}{\textwidth}
    \vspace*{1em}
    \printcontents[chapter]{chapter}{1}{\setcounter{tocdepth}{2}}
  \end{minipage}
}