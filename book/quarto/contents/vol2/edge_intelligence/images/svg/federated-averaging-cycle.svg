<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 680 460" font-family="Helvetica Neue, Helvetica, Arial, sans-serif">
  <defs>
    <marker id="arr" markerWidth="9" markerHeight="7" refX="8" refY="3.5" orient="auto">
      <path d="M0,0 L9,3.5 L0,7 Z" fill="#333"/>
    </marker>
    <marker id="arr-blue" markerWidth="9" markerHeight="7" refX="8" refY="3.5" orient="auto">
      <path d="M0,0 L9,3.5 L0,7 Z" fill="#4a90c4"/>
    </marker>
    <marker id="arr-green" markerWidth="9" markerHeight="7" refX="8" refY="3.5" orient="auto">
      <path d="M0,0 L9,3.5 L0,7 Z" fill="#3d9e5a"/>
    </marker>
    <marker id="arr-orange" markerWidth="9" markerHeight="7" refX="8" refY="3.5" orient="auto">
      <path d="M0,0 L9,3.5 L0,7 Z" fill="#c87b2a"/>
    </marker>
  </defs>

  <rect width="680" height="460" fill="#fafafa" rx="3"/>

  <!-- Phase labels column (left) -->
  <!-- Phase 1 -->
  <rect x="14" y="22" width="92" height="88" rx="5" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.2"/>
  <text x="60" y="42" font-size="9" font-weight="700" fill="#1a5a8a" text-anchor="middle">Phase 1</text>
  <text x="60" y="57" font-size="8.5" fill="#333" text-anchor="middle">Server distributes</text>
  <text x="60" y="70" font-size="8.5" fill="#333" text-anchor="middle">global model</text>
  <text x="60" y="83" font-size="8" fill="#4a90c4" text-anchor="middle">w → clients</text>
  <text x="60" y="100" font-size="8" fill="#777" font-style="italic" text-anchor="middle">broadcast</text>

  <!-- Phase 2 -->
  <rect x="14" y="140" width="92" height="88" rx="5" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.2"/>
  <text x="60" y="160" font-size="9" font-weight="700" fill="#7a4a10" text-anchor="middle">Phase 2</text>
  <text x="60" y="175" font-size="8.5" fill="#333" text-anchor="middle">Local training</text>
  <text x="60" y="188" font-size="8.5" fill="#333" text-anchor="middle">on private data</text>
  <text x="60" y="202" font-size="8" fill="#c87b2a" text-anchor="middle">E epochs each</text>
  <text x="60" y="217" font-size="8" fill="#777" font-style="italic" text-anchor="middle">no comm.</text>

  <!-- Phase 3 -->
  <rect x="14" y="258" width="92" height="88" rx="5" fill="#d4edda" stroke="#3d9e5a" stroke-width="1.2"/>
  <text x="60" y="278" font-size="9" font-weight="700" fill="#1a6a3a" text-anchor="middle">Phase 3</text>
  <text x="60" y="293" font-size="8.5" fill="#333" text-anchor="middle">Upload model</text>
  <text x="60" y="306" font-size="8.5" fill="#333" text-anchor="middle">updates Δw</text>
  <text x="60" y="320" font-size="8" fill="#3d9e5a" text-anchor="middle">Δw → server</text>
  <text x="60" y="335" font-size="8" fill="#777" font-style="italic" text-anchor="middle">dashed = small</text>

  <!-- Phase 4 -->
  <rect x="14" y="376" width="92" height="68" rx="5" fill="#e0e0e0" stroke="#999" stroke-width="1.2"/>
  <text x="60" y="396" font-size="9" font-weight="700" fill="#444" text-anchor="middle">Phase 4</text>
  <text x="60" y="411" font-size="8.5" fill="#333" text-anchor="middle">FedAvg</text>
  <text x="60" y="424" font-size="8.5" fill="#333" text-anchor="middle">w ← agg(Δw_i)</text>
  <text x="60" y="437" font-size="8" fill="#777" font-style="italic" text-anchor="middle">new global w</text>

  <!-- Vertical flow arrows between phases -->
  <line x1="60" y1="112" x2="60" y2="138" stroke="#333" stroke-width="1.5" marker-end="url(#arr)"/>
  <line x1="60" y1="230" x2="60" y2="256" stroke="#333" stroke-width="1.5" marker-end="url(#arr)"/>
  <line x1="60" y1="348" x2="60" y2="374" stroke="#333" stroke-width="1.5" marker-end="url(#arr)"/>

  <!-- Central column: Server -->
  <rect x="270" y="18" width="140" height="54" rx="8" fill="#cfe2f3" stroke="#4a90c4" stroke-width="2"/>
  <text x="340" y="40" font-size="11" font-weight="700" fill="#1a5a8a" text-anchor="middle">Global Server</text>
  <text x="340" y="56" font-size="9" fill="#4a90c4" text-anchor="middle">FedAvg Aggregator</text>

  <!-- 4 Client devices in middle section -->
  <!-- Client positions: left pair and right pair, centered around x=340 -->
  <!-- Phase 2 row: clients training locally -->

  <!-- Client 1 -->
  <rect x="148" y="148" width="90" height="72" rx="5" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.2"/>
  <text x="193" y="166" font-size="8.5" font-weight="600" fill="#7a4a10" text-anchor="middle">Client 1</text>
  <!-- mini neural net bars -->
  <rect x="162" y="175" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.5"/>
  <rect x="162" y="184" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.7"/>
  <rect x="162" y="193" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.9"/>
  <!-- local loop arrow -->
  <path d="M230,168 Q242,168 242,183 Q242,198 230,198" fill="none" stroke="#c87b2a" stroke-width="1.2" stroke-dasharray="3,2" marker-end="url(#arr-orange)"/>
  <text x="244" y="186" font-size="7" fill="#c87b2a">local</text>

  <!-- Client 2 -->
  <rect x="290" y="148" width="90" height="72" rx="5" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.2"/>
  <text x="335" y="166" font-size="8.5" font-weight="600" fill="#7a4a10" text-anchor="middle">Client 2</text>
  <rect x="304" y="175" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.5"/>
  <rect x="304" y="184" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.7"/>
  <rect x="304" y="193" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.9"/>
  <path d="M372,168 Q384,168 384,183 Q384,198 372,198" fill="none" stroke="#c87b2a" stroke-width="1.2" stroke-dasharray="3,2" marker-end="url(#arr-orange)"/>

  <!-- Client 3 -->
  <rect x="148" y="268" width="90" height="72" rx="5" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.2"/>
  <text x="193" y="286" font-size="8.5" font-weight="600" fill="#7a4a10" text-anchor="middle">Client 3</text>
  <rect x="162" y="295" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.5"/>
  <rect x="162" y="304" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.7"/>
  <rect x="162" y="313" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.9"/>
  <path d="M230,288 Q242,288 242,303 Q242,318 230,318" fill="none" stroke="#c87b2a" stroke-width="1.2" stroke-dasharray="3,2" marker-end="url(#arr-orange)"/>

  <!-- Client 4 -->
  <rect x="290" y="268" width="90" height="72" rx="5" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.2"/>
  <text x="335" y="286" font-size="8.5" font-weight="600" fill="#7a4a10" text-anchor="middle">Client 4</text>
  <rect x="304" y="295" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.5"/>
  <rect x="304" y="304" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.7"/>
  <rect x="304" y="313" width="62" height="6" rx="2" fill="#c87b2a" opacity="0.9"/>
  <path d="M372,288 Q384,288 384,303 Q384,318 372,318" fill="none" stroke="#c87b2a" stroke-width="1.2" stroke-dasharray="3,2" marker-end="url(#arr-orange)"/>

  <!-- Phase 1: Server → Clients (solid arrows down) -->
  <line x1="310" y1="72" x2="225" y2="148" stroke="#4a90c4" stroke-width="1.5" marker-end="url(#arr-blue)"/>
  <line x1="340" y1="72" x2="335" y2="148" stroke="#4a90c4" stroke-width="1.5" marker-end="url(#arr-blue)"/>
  <line x1="310" y1="72" x2="193" y2="148" stroke="#4a90c4" stroke-width="1.5" marker-end="url(#arr-blue)"/>
  <line x1="370" y1="72" x2="360" y2="148" stroke="#4a90c4" stroke-width="1.5" marker-end="url(#arr-blue)"/>
  <text x="253" y="110" font-size="8" fill="#4a90c4" text-anchor="middle">global model w</text>

  <!-- Phase 3: Clients → Server (dashed arrows up) -->
  <line x1="200" y1="268" x2="304" y2="72" stroke="#3d9e5a" stroke-width="1.3" stroke-dasharray="6,3" marker-end="url(#arr-green)"/>
  <line x1="320" y1="268" x2="326" y2="72" stroke="#3d9e5a" stroke-width="1.3" stroke-dasharray="6,3" marker-end="url(#arr-green)"/>
  <line x1="190" y1="268" x2="300" y2="72" stroke="#3d9e5a" stroke-width="1.3" stroke-dasharray="6,3" marker-end="url(#arr-green)"/>
  <line x1="350" y1="268" x2="345" y2="72" stroke="#3d9e5a" stroke-width="1.3" stroke-dasharray="6,3" marker-end="url(#arr-green)"/>
  <text x="445" y="195" font-size="8" fill="#3d9e5a" text-anchor="middle">Δw (updates only)</text>

  <!-- Phase 4: FedAvg box at bottom center -->
  <rect x="266" y="386" width="148" height="50" rx="6" fill="#e0e0e0" stroke="#999" stroke-width="1.5"/>
  <text x="340" y="407" font-size="10" font-weight="700" fill="#333" text-anchor="middle">FedAvg</text>
  <text x="340" y="422" font-size="8.5" fill="#555" text-anchor="middle">w ← Σ (n_k/N) · w_k</text>
  <text x="340" y="434" font-size="8" fill="#777" text-anchor="middle">weighted average by data size</text>

  <!-- Arrow from server to FedAvg -->
  <line x1="340" y1="72" x2="340" y2="384" stroke="#999" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arr)"/>

  <!-- Privacy annotation box -->
  <rect x="488" y="220" width="178" height="44" rx="4" fill="#d4edda" stroke="#3d9e5a" stroke-width="1"/>
  <text x="577" y="238" font-size="8.5" font-weight="700" fill="#1a6a3a" text-anchor="middle">No raw data leaves device</text>
  <text x="577" y="252" font-size="8" fill="#3d9e5a" text-anchor="middle">Only gradient updates Δw transmitted</text>

  <!-- Round arrow indicating cycle -->
  <path d="M 440,45 Q 490,45 490,80 Q 490,440 440,440 Q 230,440 230,400" fill="none" stroke="#999" stroke-width="1" stroke-dasharray="5,3" marker-end="url(#arr)"/>
  <text x="478" y="248" font-size="8" fill="#999" font-style="italic" text-anchor="middle" transform="rotate(90, 478, 248)">next round</text>

  <text x="340" y="452" font-size="9" fill="#999" text-anchor="middle" font-style="italic">FedAvg iterates multiple communication rounds until global model converges.</text>
</svg>
