<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 680 468" font-family="Helvetica Neue, Helvetica, Arial, sans-serif">
  <defs>
    <marker id="arrow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#333"/>
    </marker>
    <marker id="arrow-orange" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#c87b2a"/>
    </marker>
    <marker id="arrow-green" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#3d9e5a"/>
    </marker>
  </defs>

  <rect width="680" height="468" fill="#fff"/>

  <!-- Step numbering column -->
  <!-- Step 1: Each client computes local gradients -->
  <g transform="translate(20, 20)">
    <rect x="0" y="0" width="640" height="90" rx="6" fill="#f7f7f7" stroke="#bbb" stroke-width="1.2"/>
    <text x="28" y="18" font-size="10" font-weight="700" fill="#a31f34">Step 1</text>
    <text x="100" y="18" font-size="10" font-weight="600" fill="#333">Each client computes local gradients from private data</text>

    <!-- 4 clients with gradients -->
    <g transform="translate(30, 30)">
      <rect x="0" y="0" width="125" height="48" rx="4" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.2"/>
      <text x="62" y="18" font-size="9" font-weight="700" fill="#333" text-anchor="middle">Client 1</text>
      <text x="62" y="36" font-size="9" fill="#4a90c4" text-anchor="middle">g1 = [0.3, -0.1, 0.5]</text>
    </g>

    <g transform="translate(175, 30)">
      <rect x="0" y="0" width="125" height="48" rx="4" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.2"/>
      <text x="62" y="18" font-size="9" font-weight="700" fill="#333" text-anchor="middle">Client 2</text>
      <text x="62" y="36" font-size="9" fill="#4a90c4" text-anchor="middle">g2 = [0.1, 0.4, -0.2]</text>
    </g>

    <g transform="translate(320, 30)">
      <rect x="0" y="0" width="125" height="48" rx="4" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.2"/>
      <text x="62" y="18" font-size="9" font-weight="700" fill="#333" text-anchor="middle">Client 3</text>
      <text x="62" y="36" font-size="9" fill="#4a90c4" text-anchor="middle">g3 = [-0.2, 0.3, 0.1]</text>
    </g>

    <g transform="translate(465, 30)">
      <rect x="0" y="0" width="125" height="48" rx="4" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.2"/>
      <text x="62" y="18" font-size="9" font-weight="700" fill="#333" text-anchor="middle">Client 4</text>
      <text x="62" y="36" font-size="9" fill="#4a90c4" text-anchor="middle">g4 = [0.2, -0.3, 0.4]</text>
    </g>
  </g>

  <!-- Step 2: Clients add random masks -->
  <g transform="translate(20, 122)">
    <rect x="0" y="0" width="640" height="90" rx="6" fill="#f7f7f7" stroke="#bbb" stroke-width="1.2"/>
    <text x="28" y="18" font-size="10" font-weight="700" fill="#a31f34">Step 2</text>
    <text x="100" y="18" font-size="10" font-weight="600" fill="#333">Each client generates pairwise random masks (masks sum to zero)</text>

    <!-- Masked values -->
    <g transform="translate(30, 30)">
      <rect x="0" y="0" width="125" height="48" rx="4" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.2"/>
      <text x="62" y="18" font-size="9" font-weight="700" fill="#333" text-anchor="middle">Client 1 + mask</text>
      <text x="62" y="36" font-size="9" fill="#c87b2a" text-anchor="middle">g1 + r1 = [1.7, 0.8, -0.3]</text>
    </g>

    <g transform="translate(175, 30)">
      <rect x="0" y="0" width="125" height="48" rx="4" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.2"/>
      <text x="62" y="18" font-size="9" font-weight="700" fill="#333" text-anchor="middle">Client 2 + mask</text>
      <text x="62" y="36" font-size="9" fill="#c87b2a" text-anchor="middle">g2 + r2 = [-0.8, 1.1, 0.6]</text>
    </g>

    <g transform="translate(320, 30)">
      <rect x="0" y="0" width="125" height="48" rx="4" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.2"/>
      <text x="62" y="18" font-size="9" font-weight="700" fill="#333" text-anchor="middle">Client 3 + mask</text>
      <text x="62" y="36" font-size="9" fill="#c87b2a" text-anchor="middle">g3 + r3 = [0.5, -0.4, 1.2]</text>
    </g>

    <g transform="translate(465, 30)">
      <rect x="0" y="0" width="125" height="48" rx="4" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.2"/>
      <text x="62" y="18" font-size="9" font-weight="700" fill="#333" text-anchor="middle">Client 4 + mask</text>
      <text x="62" y="36" font-size="9" fill="#c87b2a" text-anchor="middle">g4 + r4 = [-1.0, -1.2, -0.7]</text>
    </g>
  </g>

  <!-- Step 3: Send masked gradients to server -->
  <g transform="translate(20, 224)">
    <rect x="0" y="0" width="640" height="50" rx="6" fill="#f7f7f7" stroke="#bbb" stroke-width="1.2"/>
    <text x="28" y="18" font-size="10" font-weight="700" fill="#a31f34">Step 3</text>
    <text x="100" y="18" font-size="10" font-weight="600" fill="#333">Send masked values to server (server cannot see individual gradients)</text>

    <!-- Arrows going to server -->
    <line x1="92" y1="38" x2="250" y2="38" stroke="#c87b2a" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arrow-orange)"/>
    <line x1="237" y1="38" x2="310" y2="38" stroke="#c87b2a" stroke-width="1.2" stroke-dasharray="4,3"/>
    <line x1="382" y1="38" x2="370" y2="38" stroke="#c87b2a" stroke-width="1.2" stroke-dasharray="4,3"/>
    <line x1="527" y1="38" x2="415" y2="38" stroke="#c87b2a" stroke-width="1.2" stroke-dasharray="4,3"/>

    <!-- Server icon -->
    <rect x="310" y="26" width="100" height="22" rx="3" fill="#fdebd0" stroke="#c87b2a" stroke-width="1"/>
    <text x="360" y="41" font-size="8" font-weight="600" fill="#c87b2a" text-anchor="middle">encrypted channel</text>
  </g>

  <!-- Step 4: Server aggregates -->
  <g transform="translate(20, 286)">
    <rect x="0" y="0" width="640" height="80" rx="6" fill="#d4edda" stroke="#3d9e5a" stroke-width="1.5"/>
    <text x="28" y="18" font-size="10" font-weight="700" fill="#a31f34">Step 4</text>
    <text x="100" y="18" font-size="10" font-weight="600" fill="#333">Server sums all masked values; pairwise masks cancel out</text>

    <!-- Sum equation -->
    <g transform="translate(30, 30)">
      <rect x="0" y="0" width="580" height="40" rx="4" fill="#f7f7f7" stroke="#bbb" stroke-width="1"/>
      <text x="290" y="16" font-size="10" fill="#333" text-anchor="middle">SUM = (g1+r1) + (g2+r2) + (g3+r3) + (g4+r4)</text>
      <text x="290" y="34" font-size="10" font-weight="700" fill="#3d9e5a" text-anchor="middle">= (g1+g2+g3+g4) + (r1+r2+r3+r4) = g1+g2+g3+g4 + 0 = [0.4, 0.3, 0.8]</text>
    </g>
  </g>

  <!-- Key insight box -->
  <g transform="translate(20, 380)">
    <rect x="0" y="0" width="310" height="55" rx="6" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.2"/>
    <text x="155" y="18" font-size="10" font-weight="700" fill="#333" text-anchor="middle">What the server learns</text>
    <line x1="10" y1="25" x2="300" y2="25" stroke="#4a90c4" stroke-width="0.6"/>
    <text x="155" y="40" font-size="9" fill="#3d9e5a" text-anchor="middle" font-weight="600">Only the aggregate: SUM(gi) = [0.4, 0.3, 0.8]</text>
    <text x="155" y="52" font-size="9" fill="#555" text-anchor="middle">Individual gradients are never revealed</text>
  </g>

  <g transform="translate(350, 380)">
    <rect x="0" y="0" width="310" height="55" rx="6" fill="#f9d6d5" stroke="#c44" stroke-width="1.2"/>
    <text x="155" y="18" font-size="10" font-weight="700" fill="#333" text-anchor="middle">What the server cannot learn</text>
    <line x1="10" y1="25" x2="300" y2="25" stroke="#c44" stroke-width="0.6"/>
    <text x="155" y="40" font-size="9" fill="#a31f34" text-anchor="middle" font-weight="600">Any individual gi is hidden by random mask ri</text>
    <text x="155" y="52" font-size="9" fill="#555" text-anchor="middle">Privacy of each client's data is preserved</text>
  </g>

  <!-- Bottom annotation -->
  <text x="340" y="455" font-size="9" fill="#999" text-anchor="middle" font-style="italic">Pairwise random masks cancel upon summation; the server learns only the aggregate gradient, never individual updates.</text>
</svg>
