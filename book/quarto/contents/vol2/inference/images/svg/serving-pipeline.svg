<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 680 460" font-family="Helvetica Neue, Helvetica, Arial, sans-serif">
  <defs>
    <marker id="arrow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#555"/>
    </marker>
    <marker id="arrow-accent" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#a31f34"/>
    </marker>
  </defs>

  <!-- Background regions -->
  <!-- CPU region -->
  <rect x="28" y="100" width="210" height="260" rx="6" fill="#f7f7f7" stroke="#bbb" stroke-width="1.2"/>
  <text x="133" y="120" text-anchor="middle" font-size="9.5" font-weight="600" fill="#555">CPU PRE/POST</text>

  <!-- GPU region -->
  <rect x="260" y="100" width="310" height="260" rx="6" fill="#f7f7f7" stroke="#bbb" stroke-width="1.2"/>
  <text x="415" y="120" text-anchor="middle" font-size="9.5" font-weight="600" fill="#555">GPU INFERENCE</text>

  <!-- === Top: Multiple client requests funneling to Load Balancer === -->
  <!-- Client requests -->
  <rect x="20" y="20" width="56" height="28" rx="4" fill="#f7f7f7" stroke="#bbb" stroke-width="1.2"/>
  <text x="48" y="38" text-anchor="middle" font-size="8.5" fill="#333">Req 1</text>
  <rect x="20" y="54" width="56" height="28" rx="4" fill="#f7f7f7" stroke="#bbb" stroke-width="1.2"/>
  <text x="48" y="72" text-anchor="middle" font-size="8.5" fill="#333">Req 2</text>
  <rect x="20" y="88" width="56" height="28" rx="4" fill="#f7f7f7" stroke="#bbb" stroke-width="1.2"/>
  <text x="48" y="106" text-anchor="middle" font-size="8.5" fill="#333">Req N</text>

  <!-- Dots between Req 2 and Req N -->
  <text x="48" y="87" text-anchor="middle" font-size="9" fill="#999">...</text>

  <!-- Arrows from requests to LB -->
  <line x1="76" y1="34" x2="100" y2="68" stroke="#555" stroke-width="1" marker-end="url(#arrow)"/>
  <line x1="76" y1="68" x2="100" y2="68" stroke="#555" stroke-width="1" marker-end="url(#arrow)"/>
  <line x1="76" y1="102" x2="100" y2="68" stroke="#555" stroke-width="1" marker-end="url(#arrow)"/>

  <!-- Load Balancer -->
  <rect x="102" y="46" width="80" height="44" rx="5" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.5"/>
  <text x="142" y="64" text-anchor="middle" font-size="10" font-weight="700" fill="#333">Load</text>
  <text x="142" y="77" text-anchor="middle" font-size="10" font-weight="700" fill="#333">Balancer</text>

  <!-- Arrow LB to Preprocessing -->
  <line x1="142" y1="90" x2="142" y2="136" stroke="#555" stroke-width="1.2" marker-end="url(#arrow)"/>

  <!-- === Stage 1: Preprocessing (Tokenization) === -->
  <rect x="42" y="138" width="120" height="50" rx="5" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.5"/>
  <text x="102" y="160" text-anchor="middle" font-size="11" font-weight="700" fill="#333">Preprocessing</text>
  <text x="102" y="175" text-anchor="middle" font-size="9" fill="#555">Tokenization</text>

  <!-- Arrow Preprocessing to Prefill -->
  <line x1="162" y1="163" x2="274" y2="163" stroke="#555" stroke-width="1.2" marker-end="url(#arrow)"/>

  <!-- === Stage 2: Prefill (Compute-bound) === -->
  <rect x="276" y="132" width="130" height="62" rx="5" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.5"/>
  <text x="341" y="153" text-anchor="middle" font-size="11" font-weight="700" fill="#333">Prefill Stage</text>
  <text x="341" y="167" text-anchor="middle" font-size="9" fill="#555">Prompt KV</text>
  <text x="341" y="179" text-anchor="middle" font-size="9" fill="#555">computation</text>

  <!-- Annotation: Compute-bound -->
  <text x="341" y="210" text-anchor="middle" font-size="9" font-weight="600" fill="#a31f34">Compute-bound (parallel)</text>

  <!-- === KV Cache cylinder between prefill and decode === -->
  <g transform="translate(432, 135)">
    <!-- Cylinder body -->
    <rect x="0" y="8" width="44" height="42" rx="0" fill="#d4edda" stroke="#3d9e5a" stroke-width="1.4"/>
    <!-- Top ellipse -->
    <ellipse cx="22" cy="10" rx="22" ry="8" fill="#d4edda" stroke="#3d9e5a" stroke-width="1.4"/>
    <!-- Bottom ellipse (visible arc) -->
    <path d="M0,50 A22,8 0 0,0 44,50" fill="none" stroke="#3d9e5a" stroke-width="1.4"/>
    <!-- Label -->
    <text x="22" y="33" text-anchor="middle" font-size="9" font-weight="700" fill="#333">KV</text>
    <text x="22" y="44" text-anchor="middle" font-size="9" font-weight="700" fill="#333">Cache</text>
  </g>

  <!-- Arrow Prefill to KV Cache -->
  <line x1="406" y1="163" x2="430" y2="163" stroke="#3d9e5a" stroke-width="1.2" marker-end="url(#arrow)"/>

  <!-- Arrow KV Cache to Decode -->
  <line x1="478" y1="163" x2="498" y2="260" stroke="#3d9e5a" stroke-width="1.2" marker-end="url(#arrow)"/>

  <!-- === Stage 3: Decode (Memory-bound) === -->
  <rect x="430" y="244" width="130" height="62" rx="5" fill="#f9d6d5" stroke="#c44" stroke-width="1.5"/>
  <text x="495" y="265" text-anchor="middle" font-size="11" font-weight="700" fill="#333">Decode Stage</text>
  <text x="495" y="279" text-anchor="middle" font-size="9" fill="#555">Autoregressive</text>
  <text x="495" y="291" text-anchor="middle" font-size="9" fill="#555">generation</text>

  <!-- Annotation: Memory-bound -->
  <text x="495" y="322" text-anchor="middle" font-size="9" font-weight="600" fill="#a31f34">Memory-bound (sequential)</text>

  <!-- Decode self-loop arrow (autoregressive) -->
  <path d="M560,260 C582,260 582,290 560,290" fill="none" stroke="#c44" stroke-width="1" stroke-dasharray="3,2"/>
  <text x="590" y="278" font-size="8" fill="#c44">token</text>
  <text x="590" y="288" font-size="8" fill="#c44">loop</text>

  <!-- Arrow Decode to Postprocessing -->
  <line x1="430" y1="275" x2="162" y2="275" stroke="#555" stroke-width="1.2" marker-end="url(#arrow)"/>

  <!-- === Stage 4: Postprocessing (Detokenization) === -->
  <rect x="42" y="250" width="120" height="50" rx="5" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.5"/>
  <text x="102" y="272" text-anchor="middle" font-size="11" font-weight="700" fill="#333">Postprocessing</text>
  <text x="102" y="287" text-anchor="middle" font-size="9" fill="#555">Detokenization</text>

  <!-- Arrow Postprocessing to Response -->
  <line x1="102" y1="300" x2="102" y2="346" stroke="#555" stroke-width="1.2" marker-end="url(#arrow)"/>

  <!-- === Response === -->
  <rect x="52" y="348" width="100" height="36" rx="5" fill="#d4edda" stroke="#3d9e5a" stroke-width="1.5"/>
  <text x="102" y="371" text-anchor="middle" font-size="11" font-weight="700" fill="#333">Response</text>

  <!-- === Latency budget breakdown at bottom === -->
  <g transform="translate(28, 410)">
    <!-- Segmented bar -->
    <rect x="0" y="0" width="70" height="14" fill="#fdebd0" stroke="#c87b2a" stroke-width="0.8"/>
    <text x="35" y="11" text-anchor="middle" font-size="7.5" fill="#333">Routing</text>

    <rect x="70" y="0" width="60" height="14" fill="#cfe2f3" stroke="#4a90c4" stroke-width="0.8"/>
    <text x="100" y="11" text-anchor="middle" font-size="7.5" fill="#333">Pre</text>

    <rect x="130" y="0" width="160" height="14" fill="#cfe2f3" stroke="#4a90c4" stroke-width="0.8"/>
    <text x="210" y="11" text-anchor="middle" font-size="7.5" fill="#333">Prefill (TTFT)</text>

    <rect x="290" y="0" width="280" height="14" fill="#f9d6d5" stroke="#c44" stroke-width="0.8"/>
    <text x="430" y="11" text-anchor="middle" font-size="7.5" fill="#333">Decode (TPOT x N tokens)</text>

    <rect x="570" y="0" width="52" height="14" fill="#cfe2f3" stroke="#4a90c4" stroke-width="0.8"/>
    <text x="596" y="11" text-anchor="middle" font-size="7.5" fill="#333">Post</text>

    <text x="311" y="32" text-anchor="middle" font-size="9" font-style="italic" fill="#999">Latency budget breakdown</text>
  </g>
</svg>
