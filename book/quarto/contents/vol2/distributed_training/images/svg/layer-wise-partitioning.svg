<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 680 472"
     font-family="Helvetica Neue, Helvetica, Arial, sans-serif">

  <defs>
    <marker id="arrow" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#555"/>
    </marker>
    <marker id="arrow-red" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#a31f34"/>
    </marker>
    <pattern id="bubble-hatch" patternUnits="userSpaceOnUse" width="6" height="6" patternTransform="rotate(45)">
      <line x1="0" y1="0" x2="0" y2="6" stroke="#ccc" stroke-width="0.8"/>
    </pattern>
  </defs>

  <!-- ── Background ── -->
  <rect width="680" height="472" fill="#fff" rx="4"/>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- ── Top section: Layer partitioning ── -->
  <!-- ═══════════════════════════════════════════════ -->

  <!-- ── Input ── -->
  <rect x="18" y="58" width="52" height="64" rx="4" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.2"/>
  <text x="44" y="86" font-size="9" font-weight="700" fill="#333" text-anchor="middle">Input</text>
  <text x="44" y="98" font-size="8" fill="#555" text-anchor="middle">Batch</text>

  <line x1="70" y1="90" x2="88" y2="90" stroke="#555" stroke-width="1" marker-end="url(#arrow)"/>

  <!-- ── GPU 0: Layers 1-4 ── -->
  <rect x="92" y="42" width="120" height="96" rx="5" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.5"/>
  <rect x="94" y="32" width="30" height="14" rx="2" fill="#a31f34"/>
  <text x="109" y="42" font-size="7.5" font-weight="700" fill="#fff" text-anchor="middle">GPU 0</text>
  <text x="152" y="70" font-size="10" font-weight="700" fill="#333" text-anchor="middle">Layers 1-4</text>
  <text x="152" y="84" font-size="8.5" fill="#555" text-anchor="middle">Embedding +</text>
  <text x="152" y="96" font-size="8.5" fill="#555" text-anchor="middle">Attention blocks</text>
  <!-- Layer sub-blocks -->
  <rect x="100" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#4a90c4" stroke-width="0.8"/>
  <text x="112" y="112" font-size="7" fill="#4a90c4" text-anchor="middle">L1</text>
  <rect x="128" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#4a90c4" stroke-width="0.8"/>
  <text x="140" y="112" font-size="7" fill="#4a90c4" text-anchor="middle">L2</text>
  <rect x="156" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#4a90c4" stroke-width="0.8"/>
  <text x="168" y="112" font-size="7" fill="#4a90c4" text-anchor="middle">L3</text>
  <rect x="184" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#4a90c4" stroke-width="0.8"/>
  <text x="196" y="112" font-size="7" fill="#4a90c4" text-anchor="middle">L4</text>

  <!-- Activation checkpoint marker -->
  <rect x="214" y="70" width="16" height="40" rx="2" fill="#d4edda" stroke="#3d9e5a" stroke-width="1"/>
  <text x="222" y="94" font-size="7" fill="#3d9e5a" text-anchor="middle" transform="rotate(-90,222,94)">Ckpt</text>

  <line x1="230" y1="90" x2="248" y2="90" stroke="#555" stroke-width="1" marker-end="url(#arrow)"/>

  <!-- ── GPU 1: Layers 5-8 ── -->
  <rect x="252" y="42" width="120" height="96" rx="5" fill="#d4edda" stroke="#3d9e5a" stroke-width="1.5"/>
  <rect x="254" y="32" width="30" height="14" rx="2" fill="#a31f34"/>
  <text x="269" y="42" font-size="7.5" font-weight="700" fill="#fff" text-anchor="middle">GPU 1</text>
  <text x="312" y="70" font-size="10" font-weight="700" fill="#333" text-anchor="middle">Layers 5-8</text>
  <text x="312" y="84" font-size="8.5" fill="#555" text-anchor="middle">Attention +</text>
  <text x="312" y="96" font-size="8.5" fill="#555" text-anchor="middle">FFN blocks</text>
  <rect x="260" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#3d9e5a" stroke-width="0.8"/>
  <text x="272" y="112" font-size="7" fill="#3d9e5a" text-anchor="middle">L5</text>
  <rect x="288" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#3d9e5a" stroke-width="0.8"/>
  <text x="300" y="112" font-size="7" fill="#3d9e5a" text-anchor="middle">L6</text>
  <rect x="316" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#3d9e5a" stroke-width="0.8"/>
  <text x="328" y="112" font-size="7" fill="#3d9e5a" text-anchor="middle">L7</text>
  <rect x="344" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#3d9e5a" stroke-width="0.8"/>
  <text x="356" y="112" font-size="7" fill="#3d9e5a" text-anchor="middle">L8</text>

  <rect x="374" y="70" width="16" height="40" rx="2" fill="#d4edda" stroke="#3d9e5a" stroke-width="1"/>
  <text x="382" y="94" font-size="7" fill="#3d9e5a" text-anchor="middle" transform="rotate(-90,382,94)">Ckpt</text>

  <line x1="390" y1="90" x2="408" y2="90" stroke="#555" stroke-width="1" marker-end="url(#arrow)"/>

  <!-- ── GPU 2: Layers 9-12 ── -->
  <rect x="412" y="42" width="120" height="96" rx="5" fill="#fdebd0" stroke="#c87b2a" stroke-width="1.5"/>
  <rect x="414" y="32" width="30" height="14" rx="2" fill="#a31f34"/>
  <text x="429" y="42" font-size="7.5" font-weight="700" fill="#fff" text-anchor="middle">GPU 2</text>
  <text x="472" y="70" font-size="10" font-weight="700" fill="#333" text-anchor="middle">Layers 9-12</text>
  <text x="472" y="84" font-size="8.5" fill="#555" text-anchor="middle">FFN +</text>
  <text x="472" y="96" font-size="8.5" fill="#555" text-anchor="middle">Norm blocks</text>
  <rect x="420" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#c87b2a" stroke-width="0.8"/>
  <text x="432" y="112" font-size="7" fill="#c87b2a" text-anchor="middle">L9</text>
  <rect x="448" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#c87b2a" stroke-width="0.8"/>
  <text x="460" y="112" font-size="7" fill="#c87b2a" text-anchor="middle">L10</text>
  <rect x="476" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#c87b2a" stroke-width="0.8"/>
  <text x="488" y="112" font-size="7" fill="#c87b2a" text-anchor="middle">L11</text>
  <rect x="504" y="102" width="25" height="14" rx="2" fill="#fff" stroke="#c87b2a" stroke-width="0.8"/>
  <text x="516" y="112" font-size="7" fill="#c87b2a" text-anchor="middle">L12</text>

  <rect x="534" y="70" width="16" height="40" rx="2" fill="#d4edda" stroke="#3d9e5a" stroke-width="1"/>
  <text x="542" y="94" font-size="7" fill="#3d9e5a" text-anchor="middle" transform="rotate(-90,542,94)">Ckpt</text>

  <line x1="550" y1="90" x2="568" y2="90" stroke="#555" stroke-width="1" marker-end="url(#arrow)"/>

  <!-- ── GPU 3: Layers 13-16 ── -->
  <rect x="572" y="42" width="96" height="96" rx="5" fill="#f9d6d5" stroke="#c44" stroke-width="1.5"/>
  <rect x="574" y="32" width="30" height="14" rx="2" fill="#a31f34"/>
  <text x="589" y="42" font-size="7.5" font-weight="700" fill="#fff" text-anchor="middle">GPU 3</text>
  <text x="620" y="70" font-size="10" font-weight="700" fill="#333" text-anchor="middle">Layers</text>
  <text x="620" y="84" font-size="10" font-weight="700" fill="#333" text-anchor="middle">13-16</text>
  <text x="620" y="98" font-size="8.5" fill="#555" text-anchor="middle">+ Output head</text>
  <rect x="580" y="102" width="22" height="14" rx="2" fill="#fff" stroke="#c44" stroke-width="0.8"/>
  <text x="591" y="112" font-size="6.5" fill="#c44" text-anchor="middle">L13</text>
  <rect x="604" y="102" width="22" height="14" rx="2" fill="#fff" stroke="#c44" stroke-width="0.8"/>
  <text x="615" y="112" font-size="6.5" fill="#c44" text-anchor="middle">L14</text>
  <rect x="628" y="102" width="18" height="14" rx="2" fill="#fff" stroke="#c44" stroke-width="0.8"/>
  <text x="637" y="112" font-size="6.5" fill="#c44" text-anchor="middle">...</text>

  <!-- ── Backward pass arrows (below) ── -->
  <line x1="620" y1="138" x2="620" y2="160" stroke="#a31f34" stroke-width="1" marker-end="url(#arrow-red)"/>
  <text x="640" y="155" font-size="8" fill="#a31f34" font-weight="600">Loss</text>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- ── Bottom section: Pipeline timeline ── -->
  <!-- ═══════════════════════════════════════════════ -->

  <text x="340" y="186" font-size="11" font-weight="700" fill="#333" text-anchor="middle">Pipeline Schedule: Micro-batches Through Stages</text>

  <!-- Mini Gantt chart showing pipeline bubble -->
  <!-- Axes -->
  <line x1="60" y1="206" x2="60" y2="376" stroke="#333" stroke-width="1.2"/>
  <line x1="60" y1="376" x2="650" y2="376" stroke="#333" stroke-width="1.2"/>

  <text x="52" y="232" font-size="8.5" fill="#555" text-anchor="end" font-weight="600">GPU 0</text>
  <text x="52" y="272" font-size="8.5" fill="#555" text-anchor="end" font-weight="600">GPU 1</text>
  <text x="52" y="312" font-size="8.5" fill="#555" text-anchor="end" font-weight="600">GPU 2</text>
  <text x="52" y="352" font-size="8.5" fill="#555" text-anchor="end" font-weight="600">GPU 3</text>

  <text x="355" y="396" font-size="9" font-weight="600" fill="#333" text-anchor="middle">Time</text>

  <!-- GPU 0: F0 F1 F2 F3 ... bubbles ... B3 -->
  <rect x="66" y="218" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="84" y="234" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F0</text>
  <rect x="104" y="218" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="122" y="234" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F1</text>
  <rect x="142" y="218" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="160" y="234" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F2</text>
  <rect x="180" y="218" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="198" y="234" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F3</text>
  <!-- Bubbles -->
  <rect x="218" y="218" width="152" height="24" rx="2" fill="url(#bubble-hatch)" stroke="#bbb" stroke-width="0.8"/>
  <text x="294" y="234" font-size="8" fill="#999" text-anchor="middle">idle (bubble)</text>
  <!-- B3 -->
  <rect x="372" y="218" width="36" height="24" rx="2" fill="#fdebd0" stroke="#c87b2a" stroke-width="1"/>
  <text x="390" y="234" font-size="8" font-weight="700" fill="#333" text-anchor="middle">B3</text>

  <!-- GPU 1 -->
  <rect x="66" y="258" width="36" height="24" rx="2" fill="url(#bubble-hatch)" stroke="#bbb" stroke-width="0.8"/>
  <rect x="104" y="258" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="122" y="274" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F0</text>
  <rect x="142" y="258" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="160" y="274" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F1</text>
  <rect x="180" y="258" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="198" y="274" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F2</text>
  <rect x="218" y="258" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="236" y="274" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F3</text>
  <rect x="256" y="258" width="114" height="24" rx="2" fill="url(#bubble-hatch)" stroke="#bbb" stroke-width="0.8"/>
  <rect x="372" y="258" width="36" height="24" rx="2" fill="#fdebd0" stroke="#c87b2a" stroke-width="1"/>
  <text x="390" y="274" font-size="8" font-weight="700" fill="#333" text-anchor="middle">B3</text>

  <!-- GPU 2 -->
  <rect x="66" y="298" width="74" height="24" rx="2" fill="url(#bubble-hatch)" stroke="#bbb" stroke-width="0.8"/>
  <rect x="142" y="298" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="160" y="314" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F0</text>
  <rect x="180" y="298" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="198" y="314" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F1</text>
  <rect x="218" y="298" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="236" y="314" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F2</text>
  <rect x="256" y="298" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="274" y="314" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F3</text>
  <rect x="294" y="298" width="76" height="24" rx="2" fill="url(#bubble-hatch)" stroke="#bbb" stroke-width="0.8"/>
  <rect x="372" y="298" width="36" height="24" rx="2" fill="#fdebd0" stroke="#c87b2a" stroke-width="1"/>
  <text x="390" y="314" font-size="8" font-weight="700" fill="#333" text-anchor="middle">B3</text>

  <!-- GPU 3 -->
  <rect x="66" y="338" width="112" height="24" rx="2" fill="url(#bubble-hatch)" stroke="#bbb" stroke-width="0.8"/>
  <rect x="180" y="338" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="198" y="354" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F0</text>
  <rect x="218" y="338" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="236" y="354" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F1</text>
  <rect x="256" y="338" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="274" y="354" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F2</text>
  <rect x="294" y="338" width="36" height="24" rx="2" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1"/>
  <text x="312" y="354" font-size="8" font-weight="700" fill="#333" text-anchor="middle">F3</text>
  <rect x="332" y="338" width="38" height="24" rx="2" fill="url(#bubble-hatch)" stroke="#bbb" stroke-width="0.8"/>
  <rect x="372" y="338" width="36" height="24" rx="2" fill="#fdebd0" stroke="#c87b2a" stroke-width="1"/>
  <text x="390" y="354" font-size="8" font-weight="700" fill="#333" text-anchor="middle">B3</text>

  <!-- ── Pipeline bubble annotation ── -->
  <!-- Bracket for fill bubble (GPU 3) -->
  <line x1="66" y1="368" x2="178" y2="368" stroke="#a31f34" stroke-width="1.2"/>
  <text x="122" y="380" font-size="8" fill="#a31f34" font-weight="600" text-anchor="middle">Fill phase bubble</text>

  <!-- ── Annotation ── -->
  <text x="490" y="232" font-size="9" fill="#999" font-style="italic">Point-to-point activations</text>
  <text x="490" y="246" font-size="9" fill="#999" font-style="italic">between stage boundaries;</text>
  <text x="490" y="260" font-size="9" fill="#999" font-style="italic">low BW requirement</text>
  <text x="490" y="278" font-size="9" fill="#999" font-style="italic">(Ethernet is sufficient)</text>

  <!-- ── Bottom note ── -->
  <text x="340" y="440" font-size="9" fill="#999" font-style="italic" text-anchor="middle">4 pipeline stages (GPUs), 4 micro-batches. Activation checkpoints at stage boundaries save memory.</text>
  <text x="340" y="454" font-size="9" fill="#999" font-style="italic" text-anchor="middle">Bubble overhead = (p-1)/(p-1+m) where p = stages, m = micro-batches.</text>

</svg>
