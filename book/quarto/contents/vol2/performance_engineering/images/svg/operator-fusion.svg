<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 680 460" font-family="Helvetica Neue, Helvetica, Arial, sans-serif">
  <defs>
    <marker id="arrow-down" markerWidth="7" markerHeight="5" refX="3.5" refY="5" orient="auto">
      <path d="M0,0 L7,0 L3.5,5 Z" fill="#c44"/>
    </marker>
    <marker id="arrow-up" markerWidth="7" markerHeight="5" refX="3.5" refY="0" orient="auto">
      <path d="M0,5 L7,5 L3.5,0 Z" fill="#c44"/>
    </marker>
    <marker id="arrow-right" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto">
      <path d="M0,0 L7,2.5 L0,5 Z" fill="#555"/>
    </marker>
    <marker id="arrow-right-green" markerWidth="7" markerHeight="5" refX="7" refY="2.5" orient="auto">
      <path d="M0,0 L7,2.5 L0,5 Z" fill="#3d9e5a"/>
    </marker>
  </defs>

  <rect width="680" height="460" fill="white"/>

  <!-- ===== SECTION A: UNFUSED (top half) ===== -->
  <text x="340" y="24" text-anchor="middle" font-size="12" font-weight="700" fill="#a31f34">(a) Unfused: 6 HBM round-trips</text>

  <!-- HBM bar top -->
  <rect x="40" y="38" width="600" height="24" rx="3" fill="#f9d6d5" stroke="#c44" stroke-width="1.2"/>
  <text x="340" y="55" text-anchor="middle" font-size="10" font-weight="700" fill="#c44">HBM (Off-chip Memory)</text>

  <!-- Kernel 1: LayerNorm -->
  <rect x="80" y="100" width="120" height="44" rx="4" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.2"/>
  <text x="140" y="118" text-anchor="middle" font-size="10" font-weight="700" fill="#333">LayerNorm</text>
  <text x="140" y="132" text-anchor="middle" font-size="9" fill="#555">Kernel 1</text>

  <!-- HBM read arrow into K1 -->
  <line x1="110" y1="62" x2="110" y2="98" stroke="#c44" stroke-width="1.2" marker-end="url(#arrow-down)"/>
  <text x="98" y="82" font-size="8" fill="#c44" text-anchor="end">Read</text>
  <!-- HBM write arrow out of K1 -->
  <line x1="170" y1="98" x2="170" y2="62" stroke="#c44" stroke-width="1.2" marker-end="url(#arrow-up)"/>
  <text x="182" y="82" font-size="8" fill="#c44">Write</text>

  <!-- Kernel 2: GeLU -->
  <rect x="260" y="100" width="120" height="44" rx="4" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.2"/>
  <text x="320" y="118" text-anchor="middle" font-size="10" font-weight="700" fill="#333">GeLU</text>
  <text x="320" y="132" text-anchor="middle" font-size="9" fill="#555">Kernel 2</text>

  <!-- HBM read arrow into K2 -->
  <line x1="290" y1="62" x2="290" y2="98" stroke="#c44" stroke-width="1.2" marker-end="url(#arrow-down)"/>
  <text x="278" y="82" font-size="8" fill="#c44" text-anchor="end">Read</text>
  <!-- HBM write arrow out of K2 -->
  <line x1="350" y1="98" x2="350" y2="62" stroke="#c44" stroke-width="1.2" marker-end="url(#arrow-up)"/>
  <text x="362" y="82" font-size="8" fill="#c44">Write</text>

  <!-- Kernel 3: Linear -->
  <rect x="440" y="100" width="120" height="44" rx="4" fill="#cfe2f3" stroke="#4a90c4" stroke-width="1.2"/>
  <text x="500" y="118" text-anchor="middle" font-size="10" font-weight="700" fill="#333">Linear</text>
  <text x="500" y="132" text-anchor="middle" font-size="9" fill="#555">Kernel 3</text>

  <!-- HBM read arrow into K3 -->
  <line x1="470" y1="62" x2="470" y2="98" stroke="#c44" stroke-width="1.2" marker-end="url(#arrow-down)"/>
  <text x="458" y="82" font-size="8" fill="#c44" text-anchor="end">Read</text>
  <!-- HBM write arrow out of K3 -->
  <line x1="530" y1="98" x2="530" y2="62" stroke="#c44" stroke-width="1.2" marker-end="url(#arrow-up)"/>
  <text x="542" y="82" font-size="8" fill="#c44">Write</text>

  <!-- Flow arrows between kernels -->
  <line x1="200" y1="122" x2="258" y2="122" stroke="#555" stroke-width="1" stroke-dasharray="4,3"/>
  <line x1="380" y1="122" x2="438" y2="122" stroke="#555" stroke-width="1" stroke-dasharray="4,3"/>

  <!-- Cost annotation unfused -->
  <rect x="80" y="156" width="480" height="22" rx="3" fill="#fff5f5" stroke="#c44" stroke-width="0.8"/>
  <text x="320" y="171" text-anchor="middle" font-size="9.5" font-weight="700" fill="#c44">Total: 3 Reads + 3 Writes = 6 HBM transfers (each ~3.35 TB/s limited)</text>

  <!-- Separator -->
  <line x1="30" y1="198" x2="650" y2="198" stroke="#e0e0e0" stroke-width="1"/>

  <!-- ===== SECTION B: FUSED (bottom half) ===== -->
  <text x="340" y="222" text-anchor="middle" font-size="12" font-weight="700" fill="#3d9e5a">(b) Fused: 2 HBM round-trips</text>

  <!-- HBM bar top -->
  <rect x="40" y="236" width="600" height="24" rx="3" fill="#f9d6d5" stroke="#c44" stroke-width="1.2"/>
  <text x="340" y="253" text-anchor="middle" font-size="10" font-weight="700" fill="#c44">HBM (Off-chip Memory)</text>

  <!-- Single fused kernel -->
  <rect x="120" y="298" width="400" height="60" rx="6" fill="#d4edda" stroke="#3d9e5a" stroke-width="1.8"/>
  <text x="320" y="322" text-anchor="middle" font-size="11" font-weight="700" fill="#333">Fused Kernel: LayerNorm + GeLU + Linear</text>
  <text x="320" y="340" text-anchor="middle" font-size="9.5" fill="#555">Intermediates stay in SRAM / registers (20 ns access, 0.5 pJ)</text>

  <!-- Single HBM read arrow -->
  <line x1="220" y1="260" x2="220" y2="296" stroke="#c44" stroke-width="1.5" marker-end="url(#arrow-down)"/>
  <text x="200" y="280" font-size="9" fill="#c44" text-anchor="end" font-weight="700">1 Read</text>

  <!-- Single HBM write arrow -->
  <line x1="420" y1="296" x2="420" y2="260" stroke="#c44" stroke-width="1.5" marker-end="url(#arrow-up)"/>
  <text x="440" y="280" font-size="9" fill="#c44" font-weight="700">1 Write</text>

  <!-- Internal data flow arrows inside fused kernel -->
  <text x="225" y="354" font-size="8" fill="#3d9e5a" font-weight="700">LN</text>
  <line x1="242" y1="350" x2="280" y2="350" stroke="#3d9e5a" stroke-width="1" marker-end="url(#arrow-right-green)"/>
  <text x="288" y="354" font-size="8" fill="#3d9e5a" font-weight="700">GeLU</text>
  <line x1="312" y1="350" x2="355" y2="350" stroke="#3d9e5a" stroke-width="1" marker-end="url(#arrow-right-green)"/>
  <text x="365" y="354" font-size="8" fill="#3d9e5a" font-weight="700">Linear</text>

  <!-- SRAM label inside -->
  <rect x="188" y="364" width="66" height="16" rx="2" fill="#d4edda" stroke="#3d9e5a" stroke-width="0.6"/>
  <text x="221" y="375" text-anchor="middle" font-size="7.5" fill="#3d9e5a" font-weight="700">SRAM</text>
  <rect x="298" y="364" width="66" height="16" rx="2" fill="#d4edda" stroke="#3d9e5a" stroke-width="0.6"/>
  <text x="331" y="375" text-anchor="middle" font-size="7.5" fill="#3d9e5a" font-weight="700">SRAM</text>

  <!-- Cost annotation fused -->
  <rect x="120" y="392" width="400" height="22" rx="3" fill="#f0fff0" stroke="#3d9e5a" stroke-width="0.8"/>
  <text x="320" y="407" text-anchor="middle" font-size="9.5" font-weight="700" fill="#3d9e5a">Total: 1 Read + 1 Write = 2 HBM transfers (3x reduction)</text>

  <!-- Comparison annotation at bottom -->
  <rect x="140" y="428" width="400" height="24" rx="4" fill="#f7f7f7" stroke="#bbb" stroke-width="0.8"/>
  <text x="340" y="444" text-anchor="middle" font-size="9" fill="#555" font-style="italic">HBM access: ~640 pJ/access, ~300 ns latency | SRAM access: ~0.5 pJ, ~20 ns</text>

</svg>
