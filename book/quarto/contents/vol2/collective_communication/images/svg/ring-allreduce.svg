<?xml version="1.0" encoding="UTF-8"?>
<!--
  Ring AllReduce — 4-GPU ring, showing Scatter-Reduce → AllGather phases.
  Layout: top row = 4 GPUs in a clean horizontal ring diagram (Phase 1),
           bottom row = same ring after AllGather completes (Phase 2).
  Vol 2 figure — no title (caption from QMD fig-cap).
-->
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 680 500"
     font-family="Helvetica Neue, Helvetica, Arial, sans-serif">
  <defs>
    <style>
      .lbl      { font-size: 10px; font-weight: 700; fill: #333; text-anchor: middle; }
      .sublbl   { font-size: 8.5px; fill: #666; text-anchor: middle; }
      .phase    { font-size: 11px; font-weight: 700; fill: #333; }
      .formula  { font-size: 8.5px; fill: #777; font-style: italic; }
      .ck       { stroke-width: 0.8; }
      .ck-a     { fill: #cfe2f3; stroke: #4a90c4; }
      .ck-b     { fill: #d4edda; stroke: #3d9e5a; }
      .ck-c     { fill: #fdebd0; stroke: #c87b2a; }
      .ck-d     { fill: #f9d6d5; stroke: #c44; }
      .ck-ok    { fill: #e8f5e9; stroke: #2d7a2d; stroke-width: 1.2; }
      .gpu-box  { fill: #f7f7f7; stroke: #bbb; stroke-width: 1.2; }
      .ring-bus { fill: none; stroke: #ccc; stroke-width: 1.2; stroke-dasharray: 5,4; }
      .arrow-sr { fill: none; stroke: #4a7aab; stroke-width: 1.5; }
      .arrow-ag { fill: none; stroke: #2d7a2d; stroke-width: 1.5; }
      .div      { stroke: #ddd; stroke-width: 1; }
      .note     { font-size: 8.5px; fill: #999; font-style: italic; text-anchor: middle; }
      .ck-lbl   { font-size: 8px; font-weight: 700; fill: #444; text-anchor: middle; }
    </style>

    <marker id="msr" markerWidth="7" markerHeight="6" refX="6" refY="3" orient="auto">
      <polygon points="0 0,7 3,0 6" fill="#4a7aab"/>
    </marker>
    <marker id="mag" markerWidth="7" markerHeight="6" refX="6" refY="3" orient="auto">
      <polygon points="0 0,7 3,0 6" fill="#2d7a2d"/>
    </marker>
  </defs>

  <!-- ══════════════════════════════════════════════════════
       PHASE 1 — SCATTER-REDUCE
       4 GPUs in a row connected by a bus. After N-1 steps,
       each GPU holds exactly one fully-reduced chunk.
  ═══════════════════════════════════════════════════════ -->

  <text x="32" y="30" class="phase">Phase 1 — Scatter-Reduce</text>
  <text x="32" y="44" class="formula">Each GPU sends its chunk to the next; partial sums accumulate over N−1 steps.</text>

  <!-- Horizontal bus line -->
  <line x1="90" y1="115" x2="590" y2="115" class="ring-bus"/>
  <!-- wrap-around bus (bottom) -->
  <path d="M 90,115 Q 90,155 120,160 L 560,160 Q 590,155 590,115" class="ring-bus"/>

  <!-- Helper macro: GPU box at cx, showing 4 chunks
       Parameters encoded in g transforms below.
       Box: 96w × 52h, chunks are 20w × 38h at y=7 spacing 24 -->

  <!-- ── GPU 0 (x=60): owns chunk A (fully reduced) ── -->
  <g transform="translate(60,75)">
    <rect x="0" y="0" width="96" height="52" rx="4" class="gpu-box"/>
    <text x="48" y="-5" class="lbl">GPU 0</text>
    <!-- A=ok, B C D = partial -->
    <rect x="4"  y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="26" y="7" width="20" height="38" class="ck ck-b"/>
    <rect x="48" y="7" width="20" height="38" class="ck ck-c"/>
    <rect x="70" y="7" width="20" height="38" class="ck ck-d"/>
    <text x="14"  y="30" class="ck-lbl">A✓</text>
    <text x="36"  y="30" class="ck-lbl">B</text>
    <text x="58"  y="30" class="ck-lbl">C</text>
    <text x="80"  y="30" class="ck-lbl">D</text>
  </g>

  <!-- ── GPU 1 (x=220): owns chunk B ── -->
  <g transform="translate(196,75)">
    <rect x="0" y="0" width="96" height="52" rx="4" class="gpu-box"/>
    <text x="48" y="-5" class="lbl">GPU 1</text>
    <rect x="4"  y="7" width="20" height="38" class="ck ck-a"/>
    <rect x="26" y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="48" y="7" width="20" height="38" class="ck ck-c"/>
    <rect x="70" y="7" width="20" height="38" class="ck ck-d"/>
    <text x="14"  y="30" class="ck-lbl">A</text>
    <text x="36"  y="30" class="ck-lbl">B✓</text>
    <text x="58"  y="30" class="ck-lbl">C</text>
    <text x="80"  y="30" class="ck-lbl">D</text>
  </g>

  <!-- ── GPU 2 (x=380): owns chunk C ── -->
  <g transform="translate(332,75)">
    <rect x="0" y="0" width="96" height="52" rx="4" class="gpu-box"/>
    <text x="48" y="-5" class="lbl">GPU 2</text>
    <rect x="4"  y="7" width="20" height="38" class="ck ck-a"/>
    <rect x="26" y="7" width="20" height="38" class="ck ck-b"/>
    <rect x="48" y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="70" y="7" width="20" height="38" class="ck ck-d"/>
    <text x="14"  y="30" class="ck-lbl">A</text>
    <text x="36"  y="30" class="ck-lbl">B</text>
    <text x="58"  y="30" class="ck-lbl">C✓</text>
    <text x="80"  y="30" class="ck-lbl">D</text>
  </g>

  <!-- ── GPU 3 (x=540): owns chunk D ── -->
  <g transform="translate(468,75)">
    <rect x="0" y="0" width="96" height="52" rx="4" class="gpu-box"/>
    <text x="48" y="-5" class="lbl">GPU 3</text>
    <rect x="4"  y="7" width="20" height="38" class="ck ck-a"/>
    <rect x="26" y="7" width="20" height="38" class="ck ck-b"/>
    <rect x="48" y="7" width="20" height="38" class="ck ck-c"/>
    <rect x="70" y="7" width="20" height="38" class="ck ck-ok"/>
    <text x="14"  y="30" class="ck-lbl">A</text>
    <text x="36"  y="30" class="ck-lbl">B</text>
    <text x="58"  y="30" class="ck-lbl">C</text>
    <text x="80"  y="30" class="ck-lbl">D✓</text>
  </g>

  <!-- Scatter-reduce directional arrows (top bus, left→right) -->
  <path d="M 156,100 L 196,100" class="arrow-sr" marker-end="url(#msr)"/>
  <path d="M 292,100 L 332,100" class="arrow-sr" marker-end="url(#msr)"/>
  <path d="M 428,100 L 468,100" class="arrow-sr" marker-end="url(#msr)"/>
  <!-- wrap-around (right→left on bottom bus) -->
  <path d="M 516,130 Q 516,160 340,160 Q 160,160 110,130" class="arrow-sr" marker-end="url(#msr)"/>

  <!-- Phase 1 outcome label -->
  <text x="340" y="178" class="sublbl">After N−1 = 3 passes: each GPU holds one fully-reduced shard (✓).</text>

  <!-- Legend for Phase 1 -->
  <rect x="592" y="78" width="12" height="12" class="ck ck-ok"/>
  <text x="608" y="89" font-size="8" fill="#333">= fully reduced</text>
  <rect x="592" y="95" width="12" height="12" class="ck ck-a"/>
  <text x="608" y="106" font-size="8" fill="#333">= partial shard</text>

  <!-- ══════════════════════════════════════════════════════
       DIVIDER
  ═══════════════════════════════════════════════════════ -->
  <line x1="32" y1="198" x2="648" y2="198" class="div"/>

  <!-- ══════════════════════════════════════════════════════
       PHASE 2 — ALLGATHER
       Each GPU broadcasts its fully-reduced shard to all others.
       Final state: every GPU holds all 4 reduced chunks.
  ═══════════════════════════════════════════════════════ -->

  <text x="32" y="220" class="phase">Phase 2 — AllGather</text>
  <text x="32" y="234" class="formula">Each GPU forwards the now-reduced shard it received; after N−1 steps all chunks are complete everywhere.</text>

  <!-- Bus lines -->
  <line x1="90" y1="305" x2="590" y2="305" class="ring-bus"/>
  <path d="M 90,305 Q 90,345 120,350 L 560,350 Q 590,345 590,305" class="ring-bus"/>

  <!-- All 4 GPUs — all chunks fully reduced -->
  <g transform="translate(60,265)">
    <rect x="0" y="0" width="96" height="52" rx="4" class="gpu-box"/>
    <text x="48" y="-5" class="lbl">GPU 0</text>
    <rect x="4"  y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="26" y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="48" y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="70" y="7" width="20" height="38" class="ck ck-ok"/>
    <text x="14"  y="30" class="ck-lbl">A✓</text>
    <text x="36"  y="30" class="ck-lbl">B✓</text>
    <text x="58"  y="30" class="ck-lbl">C✓</text>
    <text x="80"  y="30" class="ck-lbl">D✓</text>
  </g>

  <g transform="translate(196,265)">
    <rect x="0" y="0" width="96" height="52" rx="4" class="gpu-box"/>
    <text x="48" y="-5" class="lbl">GPU 1</text>
    <rect x="4"  y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="26" y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="48" y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="70" y="7" width="20" height="38" class="ck ck-ok"/>
    <text x="14"  y="30" class="ck-lbl">A✓</text>
    <text x="36"  y="30" class="ck-lbl">B✓</text>
    <text x="58"  y="30" class="ck-lbl">C✓</text>
    <text x="80"  y="30" class="ck-lbl">D✓</text>
  </g>

  <g transform="translate(332,265)">
    <rect x="0" y="0" width="96" height="52" rx="4" class="gpu-box"/>
    <text x="48" y="-5" class="lbl">GPU 2</text>
    <rect x="4"  y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="26" y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="48" y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="70" y="7" width="20" height="38" class="ck ck-ok"/>
    <text x="14"  y="30" class="ck-lbl">A✓</text>
    <text x="36"  y="30" class="ck-lbl">B✓</text>
    <text x="58"  y="30" class="ck-lbl">C✓</text>
    <text x="80"  y="30" class="ck-lbl">D✓</text>
  </g>

  <g transform="translate(468,265)">
    <rect x="0" y="0" width="96" height="52" rx="4" class="gpu-box"/>
    <text x="48" y="-5" class="lbl">GPU 3</text>
    <rect x="4"  y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="26" y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="48" y="7" width="20" height="38" class="ck ck-ok"/>
    <rect x="70" y="7" width="20" height="38" class="ck ck-ok"/>
    <text x="14"  y="30" class="ck-lbl">A✓</text>
    <text x="36"  y="30" class="ck-lbl">B✓</text>
    <text x="58"  y="30" class="ck-lbl">C✓</text>
    <text x="80"  y="30" class="ck-lbl">D✓</text>
  </g>

  <!-- AllGather arrows (green, left→right) -->
  <path d="M 156,290 L 196,290" class="arrow-ag" marker-end="url(#mag)"/>
  <path d="M 292,290 L 332,290" class="arrow-ag" marker-end="url(#mag)"/>
  <path d="M 428,290 L 468,290" class="arrow-ag" marker-end="url(#mag)"/>
  <path d="M 516,320 Q 516,350 340,350 Q 160,350 110,320" class="arrow-ag" marker-end="url(#mag)"/>

  <!-- Phase 2 outcome label -->
  <text x="340" y="370" class="sublbl">All GPUs now hold the complete, fully-reduced gradient tensor.</text>

  <!-- ══════════════════════════════════════════════════════
       BANDWIDTH FORMULA
  ═══════════════════════════════════════════════════════ -->
  <line x1="32" y1="390" x2="648" y2="390" class="div"/>

  <text x="340" y="406" class="note">
    Total bus traffic per GPU:  2 · (N−1)/N · S  →  2S  as N → ∞  (bandwidth-optimal)
  </text>
  <text x="340" y="420" class="note">
    Each phase requires N−1 send/receive steps.  S = total tensor size.
  </text>

  <!-- Step key -->
  <line x1="200" y1="437" x2="230" y2="437" stroke="#4a7aab" stroke-width="1.5"/>
  <text x="235" y="440" font-size="8" fill="#4a7aab">Scatter-Reduce</text>
  <line x1="330" y1="437" x2="360" y2="437" stroke="#2d7a2d" stroke-width="1.5"/>
  <text x="365" y="440" font-size="8" fill="#2d7a2d">AllGather</text>
</svg>
