% ML Systems Stack Diagram Prototype
% Tests smooth gradient data bar with layer-colored wires.
% Compile: pdflatex mlsys-stack-prototype.tex

\documentclass[border=10pt]{standalone}
\usepackage{tikz}
\usetikzlibrary{positioning, calc}
\usepackage{xcolor}

\definecolor{crimson}{HTML}{A51C30}

% ─── Icons ────────────────────────────────────────────────────────────────
\tikzset{
    icon_hardware/.pic={
        \draw[thick] (-0.25,-0.25) rectangle (0.25,0.25);
        \foreach \x in {-0.15, 0, 0.15} \foreach \y in {-0.15, 0, 0.15}
            \fill (\x,\y) circle (0.03);
        \foreach \i in {-0.15, 0.15} {
            \draw (-0.25, \i) -- (-0.35, \i); \draw (0.25, \i) -- (0.35, \i);
            \draw (\i, -0.25) -- (\i, -0.35); \draw (\i, 0.25) -- (\i, 0.35);
        }
    },
    icon_frameworks/.pic={
        \draw[thick] (-0.25,-0.2) rectangle (0.25,-0.08);
        \draw[thick] (-0.2,-0.08) rectangle (0.2,0.04);
        \draw[thick] (-0.15,0.04) rectangle (0.15,0.16);
    },
    icon_models/.pic={
        \node[circle,fill,inner sep=0.8pt] (i1) at (-0.25,-0.15) {};
        \node[circle,fill,inner sep=0.8pt] (i2) at (-0.25,0.15) {};
        \node[circle,fill,inner sep=0.8pt] (h1) at (0,-0.15) {};
        \node[circle,fill,inner sep=0.8pt] (h2) at (0,0.15) {};
        \node[circle,fill,inner sep=0.8pt] (o1) at (0.25,0) {};
        \draw (i1)--(h1); \draw (i1)--(h2);
        \draw (i2)--(h1); \draw (i2)--(h2);
        \draw (h1)--(o1); \draw (h2)--(o1);
    },
    icon_training/.pic={
        \draw[thick, ->] (0,0.15) arc (90:360:0.15);
        \draw[thick, ->] (0,-0.15) arc (-90:180:0.15);
        \node[scale=0.6] at (0,0) {$\nabla$};
    },
    icon_serving/.pic={
        \draw[thick] (-0.3,-0.2) rectangle (0.3,0.2);
        \foreach \y in {-0.08, 0.08}
            \draw (-0.2,\y) -- (0.2,\y);
        \fill (0.15, 0.14) circle (0.03);
        \fill (0.15, -0.02) circle (0.03);
        \fill (0.15, -0.14) circle (0.03);
    },
    icon_operations/.pic={
        \draw[thick] (0.1,0) circle (0.13);
        \draw[thick] (-0.1,0.05) circle (0.1);
        \foreach \a in {0,60,...,300} {
            \draw[thick] (0.1,0) ++(\a:0.13) -- ++(\a:0.05);
        }
        \foreach \a in {0,72,...,288} {
            \draw[thick] (-0.1,0.05) ++(\a:0.1) -- ++(\a:0.04);
        }
    },
    icon_applications/.pic={
        \draw[thick] (-0.3,-0.2) rectangle (0.3,0.2);
        \draw (-0.3,0.1) -- (0.3,0.1);
        \node[scale=0.5, anchor=center] at (0,-0.05) {$>\_$};
    }
}

% ─── Stack layer helper ───────────────────────────────────────────────────
\newcommand{\stacklayer}[4]{
    \ifnum#3=0
        \def\fillcol{black!5}
        \def\textcol{black!30}
    \else
        \def\fillcol{crimson!#3}
        \ifnum#3>50
            \def\textcol{white}
        \else
            \def\textcol{crimson}
        \fi
    \fi
    \node[
        draw=white, line width=0.5pt, fill=\fillcol,
        minimum width=2.6cm, minimum height=1.0cm,
        anchor=south west, rounded corners=0pt, inner sep=0pt
    ] (box) at (0,#1) {};
    \node[anchor=west, text=\textcol, font=\sffamily\scriptsize\bfseries]
        at ($(box.west)+(0.12,0)$) {#2};
    \path (box.east) +(-0.50,0)
        pic[scale=0.78, draw=\textcol, fill=\textcol, text=\textcol] {#4};
}

% ─── mlsysstack: smooth gradient data bar + layer-colored wires ──────────
\newcommand{\mlsysstack}[8]{
    \begin{tikzpicture}
        \stacklayer{6.0}{Applications}{#7}{icon_applications}
        \stacklayer{5.0}{Operations}{#6}{icon_operations}
        \stacklayer{4.0}{Serving}{#5}{icon_serving}
        \stacklayer{3.0}{Training}{#4}{icon_training}
        \stacklayer{2.0}{Models}{#3}{icon_models}
        \stacklayer{1.0}{Frameworks}{#2}{icon_frameworks}
        \stacklayer{0.0}{Hardware}{#1}{icon_hardware}

        % Data bar gradient: stops = layer intensities.
        % Wires are inlets; the bar color at each height matches that
        % wire. PGF interpolates smoothly between stops — the gradient
        % flows from one wire to the next like color filling a pipe.
        \pgfmathtruncatemacro{\dhw}{#1}
        \pgfmathtruncatemacro{\dfw}{#2}
        \pgfmathtruncatemacro{\dmod}{#3}
        \pgfmathtruncatemacro{\dtrn}{#4}
        \pgfmathtruncatemacro{\dsrv}{#5}
        \pgfmathtruncatemacro{\dops}{#6}
        \pgfmathtruncatemacro{\dapp}{#7}

        % Define stop colors by mixing crimson with white.
        % crimson!N!white means N% crimson + (100-N)% white.
        % For 0 intensity, use a near-white with a hint of warmth.
        \colorlet{stop@hw}{crimson!\dhw!white}
        \colorlet{stop@fw}{crimson!\dfw!white}
        \colorlet{stop@mod}{crimson!\dmod!white}
        \colorlet{stop@trn}{crimson!\dtrn!white}
        \colorlet{stop@srv}{crimson!\dsrv!white}
        \colorlet{stop@ops}{crimson!\dops!white}
        \colorlet{stop@app}{crimson!\dapp!white}

        \pgfdeclareverticalshading{databarshading}{100bp}{%
            color(0bp)=(stop@hw);
            color(8bp)=(stop@hw);
            color(22bp)=(stop@fw);
            color(36bp)=(stop@mod);
            color(50bp)=(stop@trn);
            color(64bp)=(stop@srv);
            color(78bp)=(stop@ops);
            color(92bp)=(stop@app);
            color(100bp)=(stop@app)
        }

        \shade[shading=databarshading, rounded corners=1.5pt]
            (2.85, -0.1) rectangle (3.15, 7.10);

        % Wires: each colored by its layer's intensity
        \foreach \layerint/\ypos in {#1/0.5, #2/1.5, #3/2.5, #4/3.5, #5/4.5, #6/5.5, #7/6.5} {
            \pgfmathtruncatemacro{\lint}{\layerint}
            \ifnum\lint=0
                \def\wirecol{black!8}
            \else
                \edef\wirecol{crimson!\lint}
            \fi
            \draw[\wirecol, line width=1.2pt] (2.6, \ypos) -- (2.85, \ypos);
        }

        % Data label
        \pgfmathtruncatemacro{\maxint}{max(max(max(#1,#2),max(#3,#4)),max(max(#5,#6),#7))}
        \ifnum\maxint>50
            \def\datatextcol{white}
        \else
            \ifnum\maxint<10
                \def\datatextcol{black!25}
            \else
                \def\datatextcol{crimson}
            \fi
        \fi
        \node[rotate=90, text=\datatextcol, font=\sffamily\scriptsize\bfseries]
            at (3.0, 3.5) {Data};
    \end{tikzpicture}
}

\begin{document}

% ═══ TEST 1: Responsible Engineering ══════════════════════════════════════
% Apps=90, Ops=40 — gradient bright at top, fades through middle, dim bottom
% The "circuit" lights up between Apps and Ops through the data bar
\mlsysstack{0}{0}{10}{10}{20}{40}{90}{25}

\hspace{1.5cm}

% ═══ TEST 2: Training ════════════════════════════════════════════════════
% Training=90, HW=50, Models=45 — gradient bright in bottom-middle,
% fades to nothing at top. Circuit through HW-FW-MOD-TRN.
\mlsysstack{50}{25}{45}{90}{12}{10}{0}{20}

\hspace{1.5cm}

% ═══ TEST 3: Data Engineering ════════════════════════════════════════════
% All layers faint but data bar has strong baseline (90).
% Gradient is soft everywhere with gentle peaks at Training(25).
\mlsysstack{15}{10}{10}{25}{10}{15}{10}{90}

\hspace{1.5cm}

% ═══ TEST 4: HW Acceleration ════════════════════════════════════════════
% HW=90 dominates, data=0. Gradient bright at bottom, fades sharply.
\mlsysstack{90}{35}{25}{35}{30}{0}{0}{0}

\hspace{1.5cm}

% ═══ TEST 5: Data Selection ══════════════════════════════════════════════
% Only Training=50 and Models=25, data=90. Two bright-ish spots
% connected through data bar, rest faint.
\mlsysstack{0}{0}{25}{50}{0}{0}{0}{90}

\hspace{1.5cm}

% ═══ TEST 6: Introduction (uniform) ═════════════════════════════════════
% All at 30 — smooth uniform gradient throughout.
\mlsysstack{30}{30}{30}{30}{30}{30}{30}{30}

\end{document}
