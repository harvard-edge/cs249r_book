% =============================================================================
% LATEX HEADER CONFIGURATION FOR MLSYSBOOK PDF
% =============================================================================
% This file contains all LaTeX package imports, custom commands, and styling
% definitions for the PDF output of the Machine Learning Systems textbook.
%
% Key Features:
% - Harvard crimson branding throughout
% - Custom part/chapter/section styling
% - Professional table formatting with colored headers
% - Margin notes with custom styling
% - TikZ-based part dividers
% - Page numbering (Roman for frontmatter, Arabic for mainmatter)
%
% Note: This file is included via _quarto-pdf.yml and affects PDF output only.
% HTML/EPUB styling is handled separately via CSS files.
% =============================================================================

% =============================================================================
% PACKAGE IMPORTS
% =============================================================================

% Layout and positioning
% \usepackage[outercaption, ragged]{sidecap}  % Commented out to make figure captions inline instead of in margin
\usepackage{adjustbox}      % Adjusting box dimensions
\usepackage{afterpage}      % Execute commands after page break
\usepackage{morefloats}     % Increase number of floats
\usepackage{array}          % Enhanced table column formatting
\usepackage{atbegshi}       % Insert content at page beginning
%\usepackage{changepage}     % Change page dimensions mid-document
\usepackage{emptypage}      % Clear headers/footers on empty pages

% Language and text
\usepackage[english]{babel} % English language support
\usepackage{microtype}      % Improved typography and hyphenation

% Captions and floats
\usepackage{caption}
% Caption styling configuration
%\captionsetup[table]{belowskip=5pt}
\captionsetup{format=plain}
\DeclareCaptionLabelFormat{mylabel}{#1
#2:\hspace{1.0ex}}
\DeclareCaptionFont{ninept}{\fontsize{7pt}{8}\selectfont #1}

% Figure captions: Small font, bold label, ragged right
\captionsetup[figure]{labelfont={bf,ninept},labelsep=space,
belowskip=2pt,aboveskip=6pt,labelformat=mylabel,
justification=raggedright,singlelinecheck=false,font={ninept}}

% Table captions: Small font, bold label, ragged right
\captionsetup[table]{belowskip=6pt,labelfont={bf,ninept},labelsep=none,
labelformat=mylabel,justification=raggedright,singlelinecheck=false,font={ninept}}

% Typography fine-tuning
\emergencystretch=5pt       % Allow extra stretch to avoid overfull boxes

% Utility packages
\usepackage{etoolbox}       % For patching commands and environments

% Page layout and headers
\usepackage{fancyhdr}       % Custom headers and footers
\usepackage{geometry}       % Page dimensions and margins

% Graphics and figures
\usepackage{graphicx}       % Include graphics
\usepackage{float}          % Improved float placement
\usepackage[skins,breakable]{tcolorbox} % Coloured and framed text boxes
\tcbset{before upper=\setlength{\parskip}{2pt}}

% Tables
\usepackage{longtable}      % Multi-page tables

% Fonts and typography
\usepackage{fontspec}       % Font selection for LuaLaTeX
\usepackage{mathptmx}       % Times-like math fonts
\usepackage{newpxtext}      % Palatino-like font for body text

% Colors and visual elements
\usepackage[dvipsnames]{xcolor}  % Extended color support
\usepackage{tikz}           % Programmatic graphics
\usetikzlibrary{positioning}
\usetikzlibrary{calc}
\usepackage{tikzpagenodes}  % TikZ positioning relative to page

% Code listings
\usepackage{listings}       % Code highlighting

% Hyperlinks
\usepackage{hyperref}       % Clickable links in PDF

% Conditional logic
\usepackage{ifthen}         % If-then-else commands

% Math symbols
\usepackage{amsmath}        % AMS math extensions
\usepackage{amssymb}        % AMS math symbols
\usepackage{latexsym}       % Additional LaTeX symbols
\usepackage{pifont}         % Zapf Dingbats symbols
\providecommand{\blacklozenge}{\ding{117}}  % Black diamond symbol

% Lists
\usepackage{enumitem}       % Customizable lists
\usepackage{multicol}       % Multi-column layouts (used for glossary)

% Margin notes and sidenotes
\usepackage{marginfix}      % Fixes margin note overflow
\usepackage{marginnote}     % Margin notes
\usepackage{sidenotes}      % Academic-style sidenotes
\renewcommand\raggedrightmarginnote{\sloppy}
\renewcommand\raggedleftmarginnote{\sloppy}

% Safety fallback: ensure \sidenote is defined even if sidenotes package fails
% This allows graceful degradation to footnotes
\providecommand{\sidenote}[1]{\footnote{#1}}

% Typography improvements
\usepackage{ragged2e}       % Better ragged text
\usepackage[all]{nowidow}   % Prevent widows and orphans
\usepackage{needspace}      % Ensure minimum space on page

% Section formatting
\usepackage[explicit]{titlesec}  % Custom section titles
\usepackage{tocloft}        % Table of contents formatting
\usepackage{etoc}           % Local (chapter-level) table of contents

% QR codes and icons
\usepackage{fontawesome5}   % Font Awesome icons
\usepackage{qrcode}         % QR code generation
\qrset{link, height=15mm}

% =============================================================================
% FLOAT CONFIGURATION
% =============================================================================
% Allow more floats per page to handle figure-heavy chapters
% Note: 1000 is needed for copyedit builds with double-spacing
\extrafloats{1000}
\setcounter{topnumber}{12}       % Max floats at top of page
\setcounter{bottomnumber}{12}    % Max floats at bottom of page
\setcounter{totalnumber}{24}     % Max floats per page
\setcounter{dbltopnumber}{8}     % Max floats at top of two-column page
\renewcommand{\topfraction}{.95}  % Max fraction of page for top floats
\renewcommand{\bottomfraction}{.95}
\renewcommand{\textfraction}{.05}  % Min fraction of page for text
\renewcommand{\floatpagefraction}{.7}  % Min fraction of float page
\renewcommand{\dbltopfraction}{.95}

% Prevent "Float(s) lost" errors by flushing floats more aggressively
\usepackage{placeins}  % Provides \FloatBarrier

% =============================================================================
% COLOR DEFINITIONS
% =============================================================================
% NOTE: TikZ colors (BlueLine, GreenLine, RedLine, OrangeLine, etc.) are defined
% in the YAML config files under format > pdf > tikz > include-headers.
% Only colors specific to LaTeX packages (not TikZ) are defined here.

% Primary accent color - defined by theme-colors-volX.tex
% Fallback to Harvard crimson if theme file not loaded
\providecolor{accentcolor}{HTML}{A51C30}
% Alias for backwards compatibility
\colorlet{crimson}{accentcolor}

% Quiz element colors
\definecolor{quiz-question-color1}{RGB}{225,243,248}  % Light blue background
\definecolor{quiz-question-color2}{RGB}{17,158,199}   % Blue border
\definecolor{quiz-answer-color1}{RGB}{250,234,241}    % Light pink background
\definecolor{quiz-answer-color2}{RGB}{152,14,90}      % Magenta border

% =============================================================================
% LIST FORMATTING
% =============================================================================
% Tighter list spacing for academic style
\def\tightlist{}
\setlist{itemsep=1pt, parsep=1pt, topsep=0pt,after={\vspace{0.3\baselineskip}}}
\let\tightlist\relax

\makeatletter
\@ifpackageloaded{framed}{}{\usepackage{framed}}
\@ifpackageloaded{fancyvrb}{}{\usepackage{fancyvrb}}
\makeatother

\makeatletter
%New float "codelisting" has been updated
\AtBeginDocument{%
\floatstyle{ruled}
\newfloat{codelisting}{!htb}{lop}
\floatname{codelisting}{Listing}
\floatplacement{codelisting}{!htb}
\captionsetup[codelisting]{labelfont={bf,ninept},labelformat=mylabel,
  singlelinecheck=false,width=\linewidth,labelsep=none,font={ninept}}%
\renewenvironment{snugshade}{%
   \def\OuterFrameSep{3pt}%
   \def\FrameCommand{\fboxsep=5pt\colorbox{shadecolor}}%
   \MakeFramed{\advance\hsize-\width\FrameRestore}%
   \leftskip 0.5em \rightskip 0.5em%
   \small% decrease font size
   }{\endMakeFramed}%
}
\makeatother

%The space before and after the verbatim environment "Highlighting" has been reduced
\fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{framesep=0mm,commandchars=\\\{\}}

\makeatletter
\renewcommand\fs@ruled{\def\@fs@cfont{\bfseries}\let\@fs@capt\floatc@ruled
\def\@fs@pre{\hrule height.8pt depth0pt \kern2pt}%
\def\@fs@post{\kern2pt\hrule\relax}%
\def\@fs@mid{\kern2pt\hrule\kern1pt}%space between float and caption
\let\@fs@iftopcapt\iftrue}
\makeatother


% =============================================================================
% HYPHENATION RULES
% =============================================================================
% Explicit hyphenation points for technical terms to avoid bad breaks
\hyphenation{
  light-weight
  light-weight-ed
  de-vel-op-ment
  un-der-stand-ing
  mod-els
  prin-ci-ples
  ex-per-tise
  com-pli-cat-ed
  blue-print
  per‧for‧mance
  com-mu-ni-ca-tion
  par-a-digms
  hy-per-ten-sion
  a-chieved
}

% =============================================================================
% CODE LISTING CONFIGURATION
% =============================================================================
% Settings for code blocks using listings package
\lstset{
breaklines=true,              % Automatic line wrapping
breakatwhitespace=true,       % Break at whitespace only
basicstyle=\ttfamily,         % Monospace font
frame=none,                   % No frame around code
keepspaces=true,              % Preserve spaces
showspaces=false,             % Don't show space characters
showtabs=false,               % Don't show tab characters
columns=flexible,             % Flexible column width
belowskip=0pt,               % Minimal spacing
aboveskip=0pt
}

% =============================================================================
% PAGE GEOMETRY
% =============================================================================
% MIT Press trim size: 8" x 10" (per publisher specifications, Feb 2026)
%
% Layout (per MIT Press markup):
%   - 1/2" (0.5in) from top of page to header
%   - 5/8" (0.625in) bottom margin
%   - 7/8" (0.875in) inner/gutter margin (binding side)
%   - 1/4" (0.25in) from page edge to margin notes
%
\geometry{
  paperwidth=8in,
  paperheight=10in,
  top=0.5in,                  % 1/2" from top edge to header
  bottom=0.625in,             % 5/8" bottom margin
  inner=0.875in,              % 7/8" gutter (binding side)
  outer=1.75in,               % Outer margin (includes space for sidenotes)
  headheight=14pt,            % Height for header text (~0.2")
  headsep=18pt,               % Small gap between header line and text
  includehead,                % Header starts at top margin position
  footskip=24pt,              % Space from text to footer
  marginparwidth=1.25in,      % Width for margin notes
  marginparsep=0.25in,        % Gap between text and margin notes
  twoside                     % Different left/right pages
}

% =============================================================================
% SIDENOTE STYLING
% =============================================================================
% Custom sidenote design with crimson vertical bar
\renewcommand{\thefootnote}{\textcolor{crimson}{\arabic{footnote}}}

% Save original sidenote command
\makeatletter
\@ifundefined{oldsidenote}{
  \let\oldsidenote\sidenote%
}{}
\makeatother

% Redefine sidenote with vertical crimson bar
\renewcommand{\sidenote}[1]{%
  \oldsidenote{%
    \noindent
    \color{crimson!100}                        % Crimson vertical line
    \raisebox{0em}{%
      \rule{0.5pt}{1.5em}                      % Thin vertical line
    }
    \hspace{0.3em}                             % Space after line
    \color{black}                              % Reset text color
    \footnotesize #1                           % Sidenote content
  }%
}

% =============================================================================
% FLOAT HANDLING
% =============================================================================
% Patch LaTeX's output routine to handle float overflow gracefully
% The "Float(s) lost" error occurs in \@doclearpage when \@currlist is not empty
% This patch silently clears pending floats that can't be placed
\makeatletter
\let\orig@doclearpage\@doclearpage
\def\@doclearpage{%
  \ifx\@currlist\@empty\else
    \global\let\@currlist\@empty
    \typeout{Warning: Floats cleared to prevent overflow}%
  \fi
  \orig@doclearpage
}
\makeatother

% Additional safety for structural commands
\let\originalbackmatter\backmatter
\renewcommand{\backmatter}{%
  \clearpage%
  \originalbackmatter%
}

\let\originalfrontmatter\frontmatter
\renewcommand{\frontmatter}{%
  \clearpage%
  \originalfrontmatter%
}

\let\originalmainmatter\mainmatter
\renewcommand{\mainmatter}{%
  \clearpage%
  \originalmainmatter%
}

% =============================================================================
% PAGE HEADERS AND FOOTERS
% =============================================================================
% Ensure chapters use fancy page style (not plain)
\patchcmd{\chapter}{\thispagestyle{plain}}{\thispagestyle{fancy}}{}{}

% Main page style with crimson headers
% Page numbers on OUTSIDE edge (standard book convention per MIT Press)
\pagestyle{fancy}
\fancyhf{}                                              % Clear all
\fancyhead[LE]{\color{crimson}\thepage}                 % Left even: page number (outside)
\fancyhead[RE]{\small\color{crimson}\nouppercase{\rightmark}}  % Right even: section
\fancyhead[LO]{\small\color{crimson}\nouppercase{\leftmark}}   % Left odd: chapter
\fancyhead[RO]{\color{crimson}\thepage}                 % Right odd: page number (outside)
\renewcommand{\headrulewidth}{0.4pt}                    % Thin header line
\renewcommand{\footrulewidth}{0pt}                      % No footer line

% Plain page style (for chapter openings)
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyfoot[C]{\color{crimson}\thepage}                % Centered page number
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

% =============================================================================
% KOMA-SCRIPT FONT ADJUSTMENTS
% =============================================================================
% Apply crimson color to all heading levels
\addtokomafont{disposition}{\rmfamily\color{crimson}}
\addtokomafont{chapter}{\color{crimson}}
\addtokomafont{section}{\color{crimson}}
\addtokomafont{subsection}{\color{crimson}}

% =============================================================================
% ABSTRACT ENVIRONMENT
% =============================================================================
\newenvironment{abstract}{
  \chapter*{\abstractname}
  \addcontentsline{toc}{chapter}{\abstractname}
  \small
}{
  \clearpage
}

% =============================================================================
% HYPERLINK CONFIGURATION
% =============================================================================
% Crimson-colored links throughout, single-page PDF layout (MIT Press preflight)
\hypersetup{
  linkcolor=crimson,
  citecolor=crimson,
  urlcolor=crimson,
  pdfpagelayout=SinglePage,     % Single page view (per MIT Press requirement)
  pdfstartview=Fit              % Initial zoom fits page
}

% =============================================================================
% PART SUMMARY SYSTEM
% =============================================================================
% Allows adding descriptive text below part titles
\newcommand{\partsummary}{}     % Empty by default
\newif\ifhaspartsummary%
\haspartsummaryfalse%

\newcommand{\setpartsummary}[1]{%
  \renewcommand{\partsummary}{#1}%
  \haspartsummarytrue%
}

% Additional colors for part page backgrounds
\definecolor{BrownLL}{RGB}{233,222,220}
\definecolor{BlueDD}{RGB}{62,100,125}
\colorlet{BlueDD}{magenta}

% ===============================================================================
% PART STYLING SYSTEM
% ===============================================================================
%
% This system provides three distinct visual styles for book organization:
%
% 1. NUMBERED PARTS (\part{title}) - For main book sections
%    - Roman numerals (I, II, III, etc.) in top right corner
%    - Crimson title with horizontal lines above/below
%    - "Part I" label in sidebar
%    - Used for: foundations, principles, optimization, deployment, etc.
%
% 2. UNNUMBERED PARTS (\part*{title}) - For special sections like "Labs"
%    - Division-style geometric background (left side)
%    - No Roman numerals
%    - Used for: labs section
%
% 3. DIVISIONS (\division{title}) - For major book divisions
%    - Clean geometric background with centered title
%    - Used for: frontmatter, main_content, backmatter
%
% The Lua filter (inject-parts.lua) automatically routes parts by {key:xxx} commands
% to the appropriate LaTeX command based on the key name.
% ===============================================================================

% NUMBERED PARTS: Roman numeral styling for main book sections
\titleformat{\part}[display]
{\thispagestyle{empty}}{}{20pt}{
\begin{tikzpicture}[remember picture,overlay]
%%%
%%
\node[crimson,align=flush right,
inner sep=0,outer sep=0mm,draw=none,%
anchor=east,minimum height=31mm, text width=1.2\textwidth,
yshift=-30mm,font={%
\fontsize{98pt}{104}\selectfont\bfseries}]  (BG) at (current page text area.north east){\thepart};
%
\node[black,inner sep=0mm,draw=none,
anchor=mid,text width=1.2\textwidth,
 minimum height=35mm, align=right,
node distance=7mm,below=of BG,
font={\fontsize{30pt}{34}\selectfont}]
(BGG)  {\hyphenchar\font=-1 \color{black}\MakeUppercase {#1}};
\draw [crimson,line width=3pt] ([yshift=0mm]BGG.north west) -- ([yshift=0mm]BGG.north east);
\draw [crimson,line width=2pt] ([yshift=0mm]BGG.south west) -- ([yshift=0mm]BGG.south east);
%
\node[fill=crimson,text=white,rotate=90,%
anchor=south west,minimum height=15mm,
minimum width=40mm,font={%
\fontsize{20pt}{20}\selectfont\bfseries}](BP)  at
(current page text area.south east)
{{\sffamily Part}~\thepart};
%
\path[red](BP.north west)-|coordinate(PS)(BGG.south west);
%
% Part summary box commented out for cleaner design
% \ifhaspartsummary
% \node[inner sep=4pt,text width=0.7\textwidth,draw=none,fill=BrownLL!40,
% align=justify,font={\fontsize{9pt}{12}\selectfont},anchor=south west]
% at (PS) {\partsummary};
% \fi
\end{tikzpicture}
}[]

\renewcommand{\thepart}{\Roman{part}}

% UNNUMBERED PARTS: Division-style background for special sections
\titleformat{name=\part,numberless}[display]
{\thispagestyle{empty}}{}{20pt}{
\begin{tikzpicture}[remember picture,overlay]
%%%
\coordinate(S1)at([yshift=-200mm]current page.north west);
\draw[draw=none,fill=BlueDD!7](S1)--++(45:16)coordinate(S2)-
|(S2|-current page.north west)--(current page.north west)coordinate(S3)--(S1);
%
\coordinate(E1)at([yshift=-98mm]current page.north west);
\draw[draw=none,fill=BlueDD!15](E1)--(current page.north west)coordinate(E2)
--++(0:98mm)coordinate(E3)--(E1);
%
\coordinate(D1)at([yshift=15mm]current page.south west);
\draw[draw=none,fill=BlueDD!40,opacity=0.5](D1)--++(45:5.5)coordinate(D2)
-|(D2|-current page.north west)--(current page.north west)coordinate(D3)--(D1);
%%%%
\path[red](S2)-|(S2-|current page.east)coordinate(SS2);
%PART
\node[crimson,align=flush right,inner sep=0,outer sep=0mm,draw=none,anchor=south,
font={\fontsize{48pt}{48}\selectfont\bfseries}]  (BG) at ($(S2)!0.5!(SS2)$){\hphantom{Part}};
%%%
\path[green]([yshift=15mm]D2)-|coordinate(TPD)(BG.south east);
\node[inner sep=0mm,draw=none,anchor=south east,%text width=0.9\textwidth,
align=right,font={\fontsize{40pt}{40}\selectfont}]
(BGG) at (TPD)  {\color{crimson}\MakeUppercase {#1}};%\MakeUppercase {}
\end{tikzpicture}
}

% Define \numberedpart command for numbered parts
% Note: This command also triggers the switch from Roman to Arabic page numbering
% when the first numbered part is encountered (before Chapter 1)
\makeatletter
\newif\if@firstnumberedpart%
\@firstnumberedparttrue%

\newcommand{\numberedpart}[1]{%
\FloatBarrier%  % Flush all pending floats before part break
\clearpage
% Switch to Arabic page numbering on first numbered part
\if@firstnumberedpart%
  \cleardoublepage%
  \setcounter{lastRomanPage}{\value{page}}%
  \pagenumbering{arabic}%
  \@firstnumberedpartfalse%
  \@firstnumberedfalse%  % Also mark chapters as not first (prevents double switch)
\fi
\thispagestyle{empty}
\stepcounter{part}%
\begin{tikzpicture}[remember picture,overlay]
%%%
%%
\node[crimson,align=flush right,
inner sep=0,outer sep=0mm,draw=none,%
anchor=east,minimum height=31mm, text width=1.2\textwidth,
yshift=-30mm,font={%
\fontsize{98pt}{104}\selectfont\bfseries}]  (BG) at (current page text area.north east){\thepart};
%
\node[black,inner sep=0mm,draw=none,
anchor=mid,text width=1.2\textwidth,
 minimum height=35mm, align=right,
node distance=7mm,below=of BG,
font={\fontsize{30pt}{34}\selectfont}]
(BGG)  {\hyphenchar\font=-1 \color{black}\MakeUppercase {#1}};
\draw [crimson,line width=3pt] ([yshift=0mm]BGG.north west) -- ([yshift=0mm]BGG.north east);
\draw [crimson,line width=2pt] ([yshift=0mm]BGG.south west) -- ([yshift=0mm]BGG.south east);
%
\node[fill=crimson,text=white,rotate=90,%
anchor=south west,minimum height=15mm,
minimum width=40mm,font={%
\fontsize{20pt}{20}\selectfont\bfseries}](BP)  at
(current page text area.south east)
{{\sffamily Part}~\thepart};
%
\path[red](BP.north west)-|coordinate(PS)(BGG.south west);
%
% Part summary box commented out for cleaner design
% \ifhaspartsummary
% \node[inner sep=4pt,text width=0.7\textwidth,draw=none,fill=BrownLL!40,
% align=justify,font={\fontsize{9pt}{12}\selectfont},anchor=south west]
% at (PS) {\partsummary};
% \fi
\end{tikzpicture}
\clearpage
}
\makeatother


% DIVISIONS: Clean geometric styling with subtle tech elements
% Used for frontmatter, main_content, and backmatter divisions
\newcommand{\division}[1]{%
\FloatBarrier%  % Flush all pending floats before division break
\clearpage
\thispagestyle{empty}
\begin{tikzpicture}[remember picture,overlay]

% Clean geometric background (original design)
\coordinate(S1)at([yshift=-200mm]current page.north west);
\draw[draw=none,fill=BlueDD!7](S1)--++(45:16)coordinate(S2)-
|(S2|-current page.north west)--(current page.north west)coordinate(S3)--(S1);

\coordinate(E1)at([yshift=-98mm]current page.north west);
\draw[draw=none,fill=BlueDD!15](E1)--(current page.north west)coordinate(E2)
--++(0:98mm)coordinate(E3)--(E1);

\coordinate(D1)at([yshift=15mm]current page.south west);
\draw[draw=none,fill=BlueDD!40,opacity=0.5](D1)--++(45:5.5)coordinate(D2)
-|(D2|-current page.north west)--(current page.north west)coordinate(D3)--(D1);

% Subtle tech elements - positioned in white areas for better visibility
% Upper right white area - more visible
\draw[crimson!40, line width=0.8pt] ([xshift=140mm,yshift=-60mm]current page.north west) -- ++(40mm,0);
\draw[crimson!40, line width=0.8pt] ([xshift=150mm,yshift=-70mm]current page.north west) -- ++(30mm,0);
\draw[crimson!35, line width=0.7pt] ([xshift=160mm,yshift=-60mm]current page.north west) -- ++(0,-15mm);
\draw[crimson!35, line width=0.7pt] ([xshift=170mm,yshift=-70mm]current page.north west) -- ++(0,10mm);

% Circuit nodes - upper right
\fill[crimson!50] ([xshift=160mm,yshift=-60mm]current page.north west) circle (1.5mm);
\fill[white] ([xshift=160mm,yshift=-60mm]current page.north west) circle (0.8mm);
\fill[crimson!50] ([xshift=170mm,yshift=-70mm]current page.north west) circle (1.3mm);
\fill[white] ([xshift=170mm,yshift=-70mm]current page.north west) circle (0.6mm);

% Lower right white area - enhanced visibility
\draw[crimson!45, line width=0.9pt] ([xshift=140mm,yshift=-190mm]current page.north west) -- ++(45mm,0);
\draw[crimson!45, line width=0.9pt] ([xshift=150mm,yshift=-200mm]current page.north west) -- ++(35mm,0);
\draw[crimson!40, line width=0.8pt] ([xshift=160mm,yshift=-190mm]current page.north west) -- ++(0,-20mm);
\draw[crimson!40, line width=0.8pt] ([xshift=170mm,yshift=-200mm]current page.north west) -- ++(0,15mm);

% Additional connecting lines in lower right
\draw[crimson!35, line width=0.7pt] ([xshift=130mm,yshift=-180mm]current page.north west) -- ++(25mm,0);
\draw[crimson!35, line width=0.7pt] ([xshift=145mm,yshift=-180mm]current page.north west) -- ++(0,-25mm);

% Circuit nodes - lower right (more prominent)
\fill[crimson!55] ([xshift=160mm,yshift=-190mm]current page.north west) circle (1.6mm);
\fill[white] ([xshift=160mm,yshift=-190mm]current page.north west) circle (0.9mm);
\fill[crimson!55] ([xshift=170mm,yshift=-200mm]current page.north west) circle (1.4mm);
\fill[white] ([xshift=170mm,yshift=-200mm]current page.north west) circle (0.7mm);
\fill[crimson!50] ([xshift=145mm,yshift=-180mm]current page.north west) circle (1.2mm);
\fill[white] ([xshift=145mm,yshift=-180mm]current page.north west) circle (0.6mm);

% Title positioned in center - clean and readable
\node[inner sep=0mm,draw=none,anchor=center,text width=0.8\textwidth,
align=center,font={\fontsize{40pt}{40}\selectfont}]
(BGG) at (current page.center)  {\color{crimson}\MakeUppercase {#1}};

\end{tikzpicture}
\clearpage
}

% LAB DIVISIONS: Circuit-style neural network design for lab sections
% Used specifically for lab platform sections (arduino, xiao, grove, etc.)
\newcommand{\labdivision}[1]{%
\FloatBarrier%  % Flush all pending floats before lab division break
\clearpage
\thispagestyle{empty}
\begin{tikzpicture}[remember picture,overlay]
% Circuit background with subtle gradient
\coordinate(S1)at([yshift=-200mm]current page.north west);
\draw[draw=none,fill=BlueDD!5](S1)--++(45:16)coordinate(S2)-
|(S2|-current page.north west)--(current page.north west)coordinate(S3)--(S1);

% TOP AREA: Circuit lines in upper white space
\draw[crimson!50, line width=1.5pt] ([xshift=30mm,yshift=-40mm]current page.north west) -- ++(60mm,0);
\draw[crimson!40, line width=1pt] ([xshift=120mm,yshift=-50mm]current page.north west) -- ++(50mm,0);
\draw[crimson!50, line width=1.5pt] ([xshift=40mm,yshift=-70mm]current page.north west) -- ++(40mm,0);

% Connecting lines in top area
\draw[crimson!30, line width=1pt] ([xshift=60mm,yshift=-40mm]current page.north west) -- ++(0,-20mm);
\draw[crimson!30, line width=1pt] ([xshift=145mm,yshift=-50mm]current page.north west) -- ++(0,10mm);

% Neural nodes in top area
\fill[crimson!70] ([xshift=60mm,yshift=-40mm]current page.north west) circle (2.5mm);
\fill[white] ([xshift=60mm,yshift=-40mm]current page.north west) circle (1.5mm);
\fill[crimson!60] ([xshift=145mm,yshift=-50mm]current page.north west) circle (2mm);
\fill[white] ([xshift=145mm,yshift=-50mm]current page.north west) circle (1mm);
\fill[crimson!80] ([xshift=80mm,yshift=-70mm]current page.north west) circle (2mm);
\fill[white] ([xshift=80mm,yshift=-70mm]current page.north west) circle (1mm);

% BOTTOM AREA: Circuit lines in lower white space
\draw[crimson!50, line width=1.5pt] ([xshift=20mm,yshift=-200mm]current page.north west) -- ++(70mm,0);
\draw[crimson!40, line width=1pt] ([xshift=110mm,yshift=-210mm]current page.north west) -- ++(60mm,0);
\draw[crimson!50, line width=1.5pt] ([xshift=35mm,yshift=-230mm]current page.north west) -- ++(45mm,0);

% Connecting lines in bottom area
\draw[crimson!30, line width=1pt] ([xshift=55mm,yshift=-200mm]current page.north west) -- ++(0,-20mm);
\draw[crimson!30, line width=1pt] ([xshift=140mm,yshift=-210mm]current page.north west) -- ++(0,15mm);

% Neural nodes in bottom area
\fill[crimson!70] ([xshift=55mm,yshift=-200mm]current page.north west) circle (2.5mm);
\fill[white] ([xshift=55mm,yshift=-200mm]current page.north west) circle (1.5mm);
\fill[crimson!60] ([xshift=140mm,yshift=-210mm]current page.north west) circle (2mm);
\fill[white] ([xshift=140mm,yshift=-210mm]current page.north west) circle (1mm);
\fill[crimson!80] ([xshift=80mm,yshift=-230mm]current page.north west) circle (2mm);
\fill[white] ([xshift=80mm,yshift=-230mm]current page.north west) circle (1mm);

% SIDE AREAS: Subtle circuit elements on left and right edges
\draw[crimson!30, line width=1pt] ([xshift=15mm,yshift=-120mm]current page.north west) -- ++(20mm,0);
\draw[crimson!30, line width=1pt] ([xshift=175mm,yshift=-130mm]current page.north west) -- ++(15mm,0);
\fill[crimson!50] ([xshift=25mm,yshift=-120mm]current page.north west) circle (1.5mm);
\fill[white] ([xshift=25mm,yshift=-120mm]current page.north west) circle (0.8mm);
\fill[crimson!50] ([xshift=185mm,yshift=-130mm]current page.north west) circle (1.5mm);
\fill[white] ([xshift=185mm,yshift=-130mm]current page.north west) circle (0.8mm);

% Title positioned in center - CLEAN AREA
\node[inner sep=0mm,draw=none,anchor=center,text width=0.8\textwidth,
align=center,font={\fontsize{44pt}{44}\selectfont\bfseries}]
(BGG) at (current page.center)  {\color{crimson}\MakeUppercase {#1}};

\end{tikzpicture}
\clearpage
}

% Define \lab command for lab styling (different visual treatment)
\newcommand{\lab}[1]{%
\begin{tikzpicture}[remember picture,overlay]
%%%
% Different background pattern for labs
\coordinate(S1)at([yshift=-200mm]current page.north west);
\draw[draw=none,fill=BlueDD!15](S1)--++(45:16)coordinate(S2)-
|(S2|-current page.north west)--(current page.north west)coordinate(S3)--(S1);
%
\coordinate(E1)at([yshift=-98mm]current page.north west);
\draw[draw=none,fill=BlueDD!25](E1)--(current page.north west)coordinate(E2)
--++(0:98mm)coordinate(E3)--(E1);
%
\coordinate(D1)at([yshift=15mm]current page.south west);
\draw[draw=none,fill=BlueDD!60,opacity=0.7](D1)--++(45:5.5)coordinate(D2)
-|(D2|-current page.north west)--(current page.north west)coordinate(D3)--(D1);
%%%%
\path[red](S2)-|(S2-|current page.east)coordinate(SS2);
%LAB - Different styling
\node[crimson,align=flush right,inner sep=0,outer sep=0mm,draw=none,anchor=south,
font={\fontsize{48pt}{48}\selectfont\bfseries}]  (BG) at ($(S2)!0.5!(SS2)$){\hphantom{Workshop}};
%%%
\path[green]([yshift=15mm]D2)-|coordinate(TPD)(BG.south east);
\node[inner sep=0mm,draw=none,anchor=south east,%text width=0.9\textwidth,
align=right,font={\fontsize{40pt}{40}\selectfont}]
(BGG) at (TPD)  {\color{crimson}\MakeUppercase {#1}};%\MakeUppercase {}
\end{tikzpicture}
\thispagestyle{empty}
\clearpage
}

% =============================================================================
% SECTION FORMATTING
% =============================================================================
% All section levels use crimson color and are ragged right

% Section (Large, bold, crimson)
\titleformat{\section}
  {\normalfont\Large\bfseries\color{crimson}\raggedright}
  {\thesection}
  {0.5em}
  {#1}
\titlespacing*{\section}{0pc}{10pt plus 3pt minus 3pt}{4pt plus 1pt minus 1pt}[0pc]

% Subsection (large, bold, crimson)
\titleformat{\subsection}
  {\normalfont\large\bfseries\color{crimson}\raggedright}
  {\thesubsection}
  {0.5em}
  {#1}
\titlespacing*{\subsection}{0pc}{9pt plus 3pt minus 3pt}{4pt plus 1pt minus 1pt}[0pc]

% Subsubsection (normal size, bold, crimson)
\titleformat{\subsubsection}
  {\normalfont\normalsize\bfseries\color{crimson}\raggedright}
  {\thesubsubsection}
  {0.5em}
  {#1}
\titlespacing*{\subsubsection}{0pc}{9pt plus 3pt minus 3pt}{3pt plus 1pt minus 1pt}[0pc]

% Paragraph (run-in, bold, crimson)
\titleformat{\paragraph}[runin]
  {\normalfont\normalsize\bfseries\color{crimson}}
  {\theparagraph}
  {0.5em}
  {#1}
\titlespacing*{\paragraph}{0pc}{4pt plus 2pt minus 1pt}{0.5em}[0pc]

% Subparagraph (run-in, italic, crimson)
\titleformat{\subparagraph}[runin]
  {\normalfont\normalsize\itshape\color{crimson}}
  {\thesubparagraph}
  {0.5em}
  {#1}
\titlespacing*{\subparagraph}{0pc}{4pt plus 2pt minus 1pt}{0.5em}[0pc]

% =============================================================================
% CHAPTER FORMATTING
% =============================================================================
% Numbered chapters: Large number aligned with title (Harris & Harris style)
% Design inspired by Harris & Harris "Digital Design and Computer Architecture"
\titleformat{\chapter}[block]
  {\normalfont\Huge\bfseries\color{crimson}}
  {}% No "Chapter X" prefix
  {0pt}
  {%
    % Title on left, large chapter number on right, vertically aligned
    \begin{tikzpicture}[baseline=(title.base)]
      % Chapter title (left-aligned)
      \node[anchor=base west, inner sep=0pt] (title) {#1};
      % Large chapter number (right side of text area, baseline-aligned with title)
      \node[anchor=base east,
            inner sep=0pt,
            font={\fontsize{72pt}{72pt}\selectfont\bfseries},
            text=crimson]
        at ([xshift=\textwidth]title.base west)
        {\thechapter};
    \end{tikzpicture}%
  }
  []

% Unnumbered chapters: no prefix, huge crimson title
\titleformat{name=\chapter,numberless}
  {\normalfont\huge\bfseries\color{crimson}}
  {}
  {0pt}
  {\Huge #1}
  []

\renewcommand{\chaptername}{Chapter}
% =============================================================================
% TABLE OF CONTENTS FORMATTING
% =============================================================================
\setcounter{tocdepth}{2}                      % Show chapters, sections, and subsections (MIT Press)

% TOC spacing adjustments for number widths and indentation
\setlength{\cftchapnumwidth}{2em}             % Chapter number width
\setlength{\cftsecnumwidth}{2.75em}           % Section number width
\setlength{\cftsubsecnumwidth}{3.25em}        % Subsection number width
\setlength{\cftsubsubsecnumwidth}{4em}        % Subsubsection number width
\setlength{\cftsubsecindent}{4.25em}          % Subsection indent
\setlength{\cftsubsubsecindent}{7.5em}        % Subsubsection indent

% Chapter entries in TOC: bold crimson with "Chapter" prefix
\renewcommand{\cftchapfont}{\bfseries\color{crimson}}
\renewcommand{\cftchappresnum}{\color{crimson}Chapter~}

% Custom formatting for division entries (styled like parts)
\newcommand{\divisionchapter}[1]{%
  \addvspace{12pt}%
  \noindent\hfil\bfseries\color{crimson}#1\hfil\par%
  \addvspace{6pt}%
}

% Adjust TOC spacing for "Chapter" prefix
\newlength{\xtraspace}
\settowidth{\xtraspace}{\cftchappresnum\cftchapaftersnum}
\addtolength{\cftchapnumwidth}{\xtraspace}

% Unnumbered chapters with TOC entry
\newcommand{\likechapter}[1]{%
    \chapter*{#1}
    \addcontentsline{toc}{chapter}{\textcolor{crimson}{#1}}
}

% =============================================================================
% PAGE NUMBERING SYSTEM
% =============================================================================
% Implements traditional book numbering:
% - Roman numerals (i, ii, iii...) for frontmatter
% - Arabic numerals (1, 2, 3...) for mainmatter
% Automatically switches at first numbered part OR first numbered chapter
% (whichever comes first). See \numberedpart command above for part handling.
\makeatletter
\newif\if@firstnumbered%
\@firstnumberedtrue%
\newif\if@firstunnumbered%
\@firstunnumberedtrue%

\newcounter{lastRomanPage}
\setcounter{lastRomanPage}{1}

% Start document with Roman numerals (frontmatter)
\AtBeginDocument{
  \pagenumbering{roman}
  \renewcommand{\thepage}{\roman{page}}
}

% Intercept chapter command
\let\old@chapter\chapter%
\renewcommand{\chapter}{%
  \@ifstar{\unnumbered@chapter}{\numbered@chapter}%
}

% Numbered chapters: switch to Arabic on first occurrence
\newcommand{\numbered@chapter}[1]{%
  \if@firstnumbered%
    \cleardoublepage%
    \setcounter{lastRomanPage}{\value{page}}%
    \pagenumbering{arabic}%
    \@firstnumberedfalse%
  \else
    \setcounter{page}{\value{page}}%
  \fi
  \setcounter{sidenote}{1}                    % Reset footnote counter per chapter
  \old@chapter{#1}%
}

% Unnumbered chapters: stay in Roman numerals
\newcommand{\unnumbered@chapter}[1]{%
  \if@firstunnumbered%
    \clearpage
    \setcounter{lastRomanPage}{\value{page}}%
    \pagenumbering{roman}%
    \@firstunnumberedfalse%
  \fi
  \setcounter{sidenote}{1}
  \old@chapter*{#1}%
}
\makeatother

% =============================================================================
% TABLE SIZING AND SPACING
% =============================================================================
% Make tables slightly smaller to fit more content
\AtBeginEnvironment{longtable}{\footnotesize}

% Increase vertical spacing in table cells (default is 1.0)
\renewcommand{\arraystretch}{1.5}

% Prefer placing figures and tables at the top of pages
\makeatletter
\renewcommand{\fps@figure}{t}  % Default placement: top of page
\renewcommand{\fps@table}{t}   % Default placement: top of page
\makeatother

% =============================================================================
% LONGTABLE PAGE BREAKING FIXES (Windows compatibility)
% =============================================================================
% Prevent "Infinite glue shrinkage" errors on Windows LaTeX builds
% by giving longtable more flexibility in page breaking

% Allow more flexible page breaking (vs strict \flushbottom)
\raggedbottom

% Process more rows before attempting page break (default is 20)
\setcounter{LTchunksize}{50}

% Add extra stretch for longtable environments specifically
\AtBeginEnvironment{longtable}{%
  \setlength{\emergencystretch}{3em}%
  \setlength{\parskip}{0pt plus 1pt}%
}

% =============================================================================
% TABLE STYLING - Clean tables with crimson borders
% =============================================================================
% Professional table appearance with:
% - Clean white background (no colored rows)
% - Crimson-colored borders
% - Good spacing for readability
%
% Note: Headers are automatically bolded by Quarto when using **text** in source
\usepackage{booktabs}      % Professional table rules (\toprule, \midrule, \bottomrule)
\usepackage{colortbl}      % For colored borders (\arrayrulecolor)

% Global table styling - crimson borders
\setlength{\arrayrulewidth}{0.5pt}          % Thinner borders than default
%\arrayrulecolor{crimson}                    % Crimson borders matching brand

\setcounter{chapter}{0}

% =============================================================================
% DROP CAPS (Lettrine)
% =============================================================================
% Decorative large first letter at chapter openings, following the tradition
% of Hennessy & Patterson and other MIT Press textbooks.
% Usage in QMD: \lettrine{T}{he first sentence...}
\usepackage{lettrine}
\renewcommand{\LettrineFontHook}{\color{crimson}\bfseries}
\setcounter{DefaultLines}{3}          % Drop cap spans 3 lines
\renewcommand{\DefaultLoversize}{0.1} % Slight oversize for visual weight
\renewcommand{\DefaultLraise}{0}      % No vertical shift
\setlength{\DefaultNindent}{0.5em}    % Indent of continuation text
\setlength{\DefaultSlope}{0pt}        % No slope on continuation

% =============================================================================
% RUNNING HEADERS — Truncation Safety
% =============================================================================
% Long chapter/section titles can overflow the header. These marks truncate
% gracefully so headers stay within the text block.
\renewcommand{\chaptermark}[1]{%
  \markboth{\thechapter.\ #1}{}}
\renewcommand{\sectionmark}[1]{%
  \markright{\thesection\ #1}}

% =============================================================================
% EPIGRAPH ENVIRONMENT
% =============================================================================
% For chapter-opening quotations. Renders as right-aligned italic block
% with attribution in small caps below.
% Usage: \epigraph{Quote text}{Author Name, \textit{Source}}
\newcommand{\bookepigraph}[2]{%
  \vspace{1em}%
  \begin{flushright}%
    \begin{minipage}{0.75\textwidth}%
      \raggedleft\itshape\small #1\\[0.5em]%
      \normalfont\small --- #2%
    \end{minipage}%
  \end{flushright}%
  \vspace{1.5em}%
}

% =============================================================================
% THUMB INDEX TABS
% =============================================================================
% Colored tabs on the outer page edge for quick chapter navigation.
% Each Part gets a different vertical position; chapters within a Part
% share the same tab position. Visible when flipping through the book.
\newcounter{thumbindex}
\setcounter{thumbindex}{0}
\newlength{\thumbtabheight}
\setlength{\thumbtabheight}{16mm}     % Height of each tab
\newlength{\thumbtabwidth}
\setlength{\thumbtabwidth}{8mm}       % Width protruding from edge
\newlength{\thumbtabgap}
\setlength{\thumbtabgap}{1mm}         % Gap between tabs

% Advance to next thumb tab position (call at each \part)
\newcommand{\nextthumb}{%
  \stepcounter{thumbindex}%
}

% Draw the thumb tab on every page (placed in header via fancyhdr)
\newcommand{\drawthumb}{%
  \ifnum\value{thumbindex}>0%
    \begin{tikzpicture}[remember picture,overlay]
      \pgfmathsetmacro{\thumboffset}{%
        20 + (\value{thumbindex}-1) * (16 + 1)}  % mm from top
      \ifodd\value{page}%
        % Odd pages: tab on right edge
        \fill[crimson!80]
          ([yshift=-\thumboffset mm]current page.north east)
          rectangle +(-\thumbtabwidth, -\thumbtabheight);
        \node[white,font=\tiny\bfseries,rotate=90]
          at ([yshift=-\thumboffset mm - 0.5\thumbtabheight,
               xshift=-0.5\thumbtabwidth]current page.north east)
          {\Roman{thumbindex}};
      \else
        % Even pages: tab on left edge
        \fill[crimson!80]
          ([yshift=-\thumboffset mm]current page.north west)
          rectangle +(\thumbtabwidth, -\thumbtabheight);
        \node[white,font=\tiny\bfseries,rotate=-90]
          at ([yshift=-\thumboffset mm - 0.5\thumbtabheight,
               xshift=0.5\thumbtabwidth]current page.north west)
          {\Roman{thumbindex}};
      \fi
    \end{tikzpicture}%
  \fi
}

% Hook into fancyhdr to draw thumb on every content page
\AddToHook{shipout/foreground}{%
  \drawthumb%
}

% =============================================================================
% CROP / BLEED MARKS
% =============================================================================
% For final print submission, uncomment the line below to add crop marks.
% MIT Press production will advise on exact requirements.
% \usepackage[cam,center,width=7.5in,height=10.5in]{crop}

% =============================================================================
% PDF/A ARCHIVAL COMPLIANCE
% =============================================================================
% MIT Press increasingly requires PDF/A for long-term preservation.
% This embeds all fonts and removes transparency.
% Note: pdfx must be loaded early; if it conflicts with hyperref,
% MIT Press production can handle the conversion post-build.
% Uncomment when ready for final submission:
% \usepackage[a-3u]{pdfx}

% =============================================================================
% ENHANCED WIDOW / ORPHAN CONTROL
% =============================================================================
% Prevent single lines at top/bottom of pages and breaks before equations
\clubpenalty=10000          % No orphans (single first line at bottom)
\widowpenalty=10000         % No widows (single last line at top)
\displaywidowpenalty=10000  % No widow before display math
\predisplaypenalty=10000    % No page break just before display math
\postdisplaypenalty=0       % Allow break after display math (natural)

% =============================================================================
% INDEX GENERATION (imakeidx)
% =============================================================================
% Creates a professional index at the end of the book.
% Usage in QMD files: \index{term} or \index{term!subterm}
% Features enabled:
%   - intoc=true: Adds "Index" entry to Table of Contents
%   - columns=3: Three-column index layout for space efficiency (MIT Press)
%   - columnseprule=true: Vertical line between columns
\usepackage{imakeidx}
\makeindex[intoc=true, columns=3, columnseprule=true]
\indexsetup{level=\scriptsize\sloppy}

% =============================================================================
% BIBLIOGRAPHY FONT SIZE (MIT Press page reduction)
% =============================================================================
% Shrink bibliography entries to footnotesize for space efficiency
\AtBeginEnvironment{CSLReferences}{\footnotesize}
\AtBeginEnvironment{thebibliography}{\footnotesize}

% Tighter spacing between bibliography entries
\AtBeginEnvironment{CSLReferences}{%
  \footnotesize%
  \setlength{\parskip}{1pt plus 0.5pt}%
}

% =============================================================================
% LIST OF FIGURES / LIST OF TABLES FONT SIZE (MIT Press page reduction)
% =============================================================================
% Shrink LOF and LOT entries for space efficiency
\renewcommand{\cftfigfont}{\footnotesize}
\renewcommand{\cfttabfont}{\footnotesize}
\renewcommand{\cftfigpagefont}{\footnotesize}
\renewcommand{\cfttabpagefont}{\footnotesize}
% Tighter spacing in LOF/LOT
\setlength{\cftbeforefigskip}{1pt}
\setlength{\cftbeforetabskip}{1pt}

% =============================================================================
% FIGURE MANIFEST FOR MIT PRESS (LaTeX extraction)
% =============================================================================
% Writes figure data during PDF compilation to an absolute path.
% Output: scripts/mit_press/FIGURE_MANIFEST_LATEX.txt
% =============================================================================

\newwrite\figlatex
\makeatletter
\AtBeginDocument{%
  \immediate\openout\figlatex=\jobname_figures.txt%
  \immediate\write\figlatex{LATEX FIGURE MANIFEST}%
  \immediate\write\figlatex{=====================}%
}

% Hook: write after each figure caption is processed
% Using deferred \write (no \immediate) so page number is captured at shipout
% when LaTeX knows the actual page where the float lands
\let\orig@makecaption\@makecaption
\renewcommand{\@makecaption}[2]{%
  \orig@makecaption{#1}{#2}%
  % Check if this is a figure caption
  \def\@figtest{figure}%
  \ifx\@captype\@figtest
    \write\figlatex{Figure \thefigure\space | Page \thepage}%
  \fi
}

% =============================================================================
% CHAPTER MINI-TOC (MARGIN)
% =============================================================================
% Places a compact, styled local table of contents in the margin at the
% chapter opening. Inspired by Harris & Harris "Digital Design and Computer
% Architecture" (Elsevier, 2nd ed.) which lists section numbers and titles
% in the right margin of the chapter opening page.
%
% Usage in QMD (inside the Purpose section, typically above \mlsysstack):
%   \begin{marginfigure}[<offset>]
%   \chapterminitoc
%   \end{marginfigure}
%
% The macro uses the etoc package to render a local TOC scoped to the
% current chapter. Only ## (section) level headings are shown (not ### or
% deeper) to keep it compact.
% =============================================================================

% --- Part heading in TOC (global only) ---
% Used by inject_parts.lua to add Part headings to the .toc file.
% Uses a simple boolean flag (\ifminitoc) that \chapterminitoc sets
% before calling \localtableofcontents, suppressing Part headings
% inside chapter mini-TOCs while rendering them in the main TOC.
\newif\ifminitoc
\minitocfalse
\DeclareRobustCommand{\tocpartentry}[1]{%
  \ifminitoc\else
    \par\addvspace{12pt}%
    \noindent\hfil\bfseries\color{crimson}#1\color{black}\hfil
    \par\addvspace{6pt}%
  \fi
}

% --- etoc style for the chapter mini-TOC ---
% Section entries: "X.Y  Title" in small sans-serif, crimson numbers.
%
% \chapterminitoc — called BEFORE ## Purpose (chapter scope) to ensure
%   etoc's \localtableofcontents scopes to the full chapter.
%   Renders directly in the margin via \marginnote (no vertical offset).
%
% \emitchapterminitoc — no-op kept for forward compatibility.
%
% Unnumbered sections (e.g. Purpose) are excluded via \etocifnumbered.
\newcommand{\chapterminitoc}{%
  \marginnote{%
    \parbox{\marginparwidth}{%
      \raggedright
      \setlength{\parskip}{0pt}%
      \setlength{\parindent}{0pt}%
      % --- Define compact line styles for sections only ---
      \etocsetstyle{section}%
        {}% begin
        {}% prefix
        {% contents: skip unnumbered sections, show numbered ones
          \etocifnumbered{%
            \noindent
            \makebox[2em][l]{%
              \sffamily\fontsize{6.5}{8}\selectfont\bfseries\color{crimson}%
              \etocnumber
            }%
            {\sffamily\fontsize{6.5}{8}\selectfont\bfseries\etocname}%
            \par\vspace{1pt}%
          }{}%
        }%
        {}% end
      %
      % Hide all levels except section
      \etocsetstyle{part}{}{}{}{}%
      \etocsetstyle{chapter}{}{}{}{}%
      \etocsetstyle{subsection}{}{}{}{}%
      \etocsetstyle{subsubsection}{}{}{}{}%
      %
      \etocsetnexttocdepth{section}%
      \etocsettocstyle{}{}%
      \etocinline
      \global\minitoctrue
      \localtableofcontents
      \global\minitocfalse
    }%
  }%
}
\newcommand{\emitchapterminitoc}{}

% =============================================================================
% ML SYSTEMS STACK DIAGRAM (REUSABLE MACRO)
% =============================================================================
% Renders a vertical stack of 7 layers with configurable shading (0-100).
% Used in "Purpose" sections to show which layers a chapter touches.
%
% ML Systems Stack Visualization
% ================================
% A 7-layer abstraction stack modeled after the traditional computer systems
% stack (Tanenbaum, Patterson & Hennessy). Each layer provides an abstraction
% to the layer above and consumes the layer below.
%
% Two variants:
%   \mlsysstack     — Margin figure: 7 layers + data bar (8 args)
%   \mlsysstackfull — Full-size with subtitles + data bar (8 args, for About page)
%
% Usage: \mlsysstack{<hw>}{<fw>}{<models>}{<train>}{<serve>}{<ops>}{<apps>}{<data>}
%        \mlsysstackfull{<hw>}{<fw>}{<models>}{<train>}{<serve>}{<ops>}{<apps>}{<data>}
%
% Arguments 1-7: Layer intensities (0 to 100, Integer)
%   0:   Gray (inactive / not covered)
%   100: Crimson (primary focus)
%   1-99: Gradient shading (contextual relevance)
%
% Argument 8: Data flow intensity (0 to 100)
%   Controls the color of the vertical data bar alongside the stack.
%
% Stack (bottom to top):
%   1. Hardware       — Accelerators, silicon, benchmarking
%   2. Frameworks     — PyTorch, TensorFlow, compilers, graph execution
%   3. Models         — Neural network architectures, DL foundations
%   4. Training       — Training loops, distributed training, data selection
%   5. Serving        — Inference runtime, model serving
%   6. Operations     — MLOps, monitoring, CI/CD, deployment pipelines
%   7. Applications   — End-user ML products, responsible AI
%   (Data)            — Cross-cutting flow: pipelines, engineering, selection

\tikzset{
    % Define simple icons as pics
    % Hardware: Chip with pins
    icon_hardware/.pic={
        \draw[thick] (-0.25,-0.25) rectangle (0.25,0.25);
        \foreach \x in {-0.15, 0, 0.15} \foreach \y in {-0.15, 0, 0.15}
            \fill (\x,\y) circle (0.03);
        \foreach \i in {-0.15, 0.15} {
            \draw (-0.25, \i) -- (-0.35, \i); \draw (0.25, \i) -- (0.35, \i);
            \draw (\i, -0.25) -- (\i, -0.35); \draw (\i, 0.25) -- (\i, 0.35);
        }
    },
    % Frameworks: Stacked blocks
    icon_frameworks/.pic={
        \draw[thick] (-0.25,-0.2) rectangle (0.25,-0.08);
        \draw[thick] (-0.2,-0.08) rectangle (0.2,0.04);
        \draw[thick] (-0.15,0.04) rectangle (0.15,0.16);
    },
    % Models: Neural Network graph
    icon_models/.pic={
        \node[circle,fill,inner sep=0.8pt] (i1) at (-0.25,-0.15) {};
        \node[circle,fill,inner sep=0.8pt] (i2) at (-0.25,0.15) {};
        \node[circle,fill,inner sep=0.8pt] (h1) at (0,-0.15) {};
        \node[circle,fill,inner sep=0.8pt] (h2) at (0,0.15) {};
        \node[circle,fill,inner sep=0.8pt] (o1) at (0.25,0) {};
        \draw (i1)--(h1); \draw (i1)--(h2);
        \draw (i2)--(h1); \draw (i2)--(h2);
        \draw (h1)--(o1); \draw (h2)--(o1);
    },
    % Training: Cycle/Loop with gradient
    icon_training/.pic={
        \draw[thick, ->] (0,0.15) arc (90:360:0.15);
        \draw[thick, ->] (0,-0.15) arc (-90:180:0.15);
        \node[scale=0.6] at (0,0) {$\nabla$};
    },
    % Serving: Server rack / box
    icon_serving/.pic={
        \draw[thick] (-0.3,-0.2) rectangle (0.3,0.2);
        \foreach \y in {-0.08, 0.08}
            \draw (-0.2,\y) -- (0.2,\y);
        \fill (0.15, 0.14) circle (0.03);
        \fill (0.15, -0.02) circle (0.03);
        \fill (0.15, -0.14) circle (0.03);
    },
    % Operations: Gears
    icon_operations/.pic={
        \draw[thick] (0.1,0) circle (0.13);
        \draw[thick] (-0.1,0.05) circle (0.1);
        \foreach \a in {0,60,...,300} {
            \draw[thick] (0.1,0) ++(\a:0.13) -- ++(\a:0.05);
        }
        \foreach \a in {0,72,...,288} {
            \draw[thick] (-0.1,0.05) ++(\a:0.1) -- ++(\a:0.04);
        }
    },
    % Applications: Window with prompt
    icon_applications/.pic={
        \draw[thick] (-0.3,-0.2) rectangle (0.3,0.2);
        \draw (-0.3,0.1) -- (0.3,0.1);
        \node[scale=0.5, anchor=center] at (0,-0.05) {$>\_$};
    }
}

\newcommand{\stacklayer}[4]{
    % Helper command for a single layer
    % #1: y-position (bottom)
    % #2: Text label
    % #3: Intensity (0-100)
    % #4: Icon name
    
    % Calculate colors based on intensity
    \ifnum#3=0
        \def\fillcol{black!5}
        \def\textcol{black!30}
    \else
        \def\fillcol{crimson!#3}
        % Text color logic: White for dark backgrounds (>50), Crimson for light (<50)
        \ifnum#3>50
            \def\textcol{white}
        \else
            \def\textcol{crimson}
        \fi
    \fi

    \node[
        draw=white,
        line width=0.5pt,
        fill=\fillcol,
        minimum width=2.8cm,
        minimum height=1.0cm,
        anchor=south west,
        rounded corners=0pt,
        inner sep=0pt
    ] (box) at (0,#1) {};
    
    % Text
    \node[anchor=west, text=\textcol, font=\sffamily\scriptsize\bfseries] at ($(box.west)+(0.15,0)$) {#2};
    
    % Icon (positioned on the right)
    \path (box.east) +(-0.4,0) pic[scale=0.8, draw=\textcol, fill=\textcol, text=\textcol] {#4};
}

% 7-layer stack with data bar for chapter margin figures
\newcommand{\mlsysstack}[8]{
    \begin{tikzpicture}
        % Stack layers with 1.0cm height and no gap (contiguous)
        % Layers are 2.8cm wide; data bar sits to the right with a gap
        
        % Layer 7: Applications
        \stacklayer{6.0}{Applications}{#7}{icon_applications}

        % Layer 6: Operations
        \stacklayer{5.0}{Operations}{#6}{icon_operations}

        % Layer 5: Serving
        \stacklayer{4.0}{Serving}{#5}{icon_serving}

        % Layer 4: Training
        \stacklayer{3.0}{Training}{#4}{icon_training}

        % Layer 3: Models
        \stacklayer{2.0}{Models}{#3}{icon_models}

        % Layer 2: Frameworks
        \stacklayer{1.0}{Frameworks}{#2}{icon_frameworks}

        % Layer 1: Hardware
        \stacklayer{0.0}{Hardware}{#1}{icon_hardware}

        % --- Data: vertical bar to the right of the stack ---
        % Cross-cutting interconnect connecting all layers (like a data bus)
        \ifnum#8=0
            \def\datacol{black!8}
            \def\datatextcol{black!25}
        \else
            \def\datacol{crimson!#8}
            \ifnum#8>50
                \def\datatextcol{white}
            \else
                \def\datatextcol{crimson}
            \fi
        \fi
        
        % Vertical data bar (separated from layers by a gap)
        \fill[\datacol, rounded corners=1.5pt]
            (2.95, -0.1) rectangle (3.25, 7.10);
        
        % Horizontal connectors from each layer into the data bar
        \foreach \ypos in {0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5} {
            \draw[\datacol, line width=1.2pt] (2.8, \ypos) -- (2.95, \ypos);
        }
        
        % "Data" label (rotated, centered in bar, matching layer font)
        \node[rotate=90, text=\datatextcol, font=\sffamily\scriptsize\bfseries]
            at (3.1, 3.5) {Data};

    \end{tikzpicture}
}

% Full-size stack with subtitles and data bar for introductory/explanatory use
\newcommand{\stacklayerfull}[5]{
    % Helper for full-size layers with subtitle
    % #1: y-position (bottom)
    % #2: Text label
    % #3: Subtitle (brief description)
    % #4: Intensity (0-100)
    % #5: Icon name
    
    % Calculate colors based on intensity
    \ifnum#4=0
        \def\fillcol{black!5}
        \def\textcol{black!30}
    \else
        \def\fillcol{crimson!#4}
        \ifnum#4>50
            \def\textcol{white}
        \else
            \def\textcol{crimson}
        \fi
    \fi

    \node[
        draw=white,
        line width=0.5pt,
        fill=\fillcol,
        minimum width=4.0cm,
        minimum height=1.1cm,
        anchor=south west,
        rounded corners=0pt,
        inner sep=0pt
    ] (box) at (0,#1) {};
    
    % Title
    \node[anchor=west, text=\textcol, font=\sffamily\scriptsize\bfseries]
        at ($(box.west)+(0.2,0.12)$) {#2};
    
    % Subtitle
    \node[anchor=west, text=\textcol, font=\sffamily\fontsize{4.5}{5.5}\selectfont, opacity=0.8]
        at ($(box.west)+(0.2,-0.12)$) {#3};
    
    % Icon (positioned on the right)
    \path (box.east) +(-0.5,0) pic[scale=0.8, draw=\textcol, fill=\textcol, text=\textcol] {#5};
}

\newcommand{\mlsysstackfull}[8]{
    \begin{tikzpicture}
        % Stack layers with 1.1cm height and no gap (contiguous)
        
        % Layer 7: Applications
        \stacklayerfull{6.60}{Applications}{End-user products, responsible AI}{#7}{icon_applications}

        % Layer 6: Operations
        \stacklayerfull{5.50}{Operations}{MLOps, monitoring, CI/CD}{#6}{icon_operations}

        % Layer 5: Serving
        \stacklayerfull{4.40}{Serving}{Inference runtime, deployment}{#5}{icon_serving}

        % Layer 4: Training
        \stacklayerfull{3.30}{Training}{Training loops, distributed training}{#4}{icon_training}

        % Layer 3: Models
        \stacklayerfull{2.20}{Models}{Neural network architectures}{#3}{icon_models}

        % Layer 2: Frameworks
        \stacklayerfull{1.10}{Frameworks}{PyTorch, TensorFlow, compilers}{#2}{icon_frameworks}

        % Layer 1: Hardware
        \stacklayerfull{0.0}{Hardware}{GPUs, TPUs, accelerators}{#1}{icon_hardware}

        % --- Data flow: vertical bar running along the right side ---
        % Represents data as the cross-cutting interconnect (like a data bus)
        \ifnum#8=0
            \def\datacol{black!8}
            \def\datatextcol{black!25}
        \else
            \def\datacol{crimson!#8}
            \ifnum#8>50
                \def\datatextcol{white}
            \else
                \def\datatextcol{crimson}
            \fi
        \fi
        
        % Vertical data bar (flush with layer right edge)
        \fill[\datacol, rounded corners=2pt]
            (4.02, -0.15) rectangle (4.32, 7.85);
        
        % Horizontal connectors from each layer into the data bar
        \foreach \ypos in {0.55, 1.65, 2.75, 3.85, 4.95, 6.05, 7.15} {
            \draw[\datacol, line width=1.5pt] (3.9, \ypos) -- (4.02, \ypos);
        }
        
        % "Data" label (rotated, centered in bar, matching layer font)
        \node[rotate=90, text=\datatextcol, font=\sffamily\scriptsize\bfseries]
            at (4.17, 3.85) {Data};

    \end{tikzpicture}
}

\AtEndDocument{%
  \immediate\closeout\figlatex%
}
\makeatother
