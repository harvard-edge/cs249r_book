# escape=`
# MLSysBook Windows Quarto Build Container (Windows Server 2022)
# - PowerShell 7 via ZIP (no MSI)
# - Quarto 1.7.31 via ZIP (no MSI)
# - Python 3.13.1 + requirements
# - Ghostscript + Inkscape (Chocolatey)
# - TeX Live pinned to 2025 snapshot + packages from tl_packages
# - R 4.3.2 + packages via install_packages.R
# - Verifications: versions, kpsewhich font files, TikZ smoke test

FROM mcr.microsoft.com/windows/server:ltsc2022

# Use Windows PowerShell initially
SHELL ["powershell.exe", "-NoLogo", "-ExecutionPolicy", "Bypass", "-Command"]

# ------------------------------------------------------------
# PHASE 0: Base dirs and env (same as quarto-build workflow)
# ------------------------------------------------------------
ENV R_LIBS_USER="C:/r-lib"
ENV QUARTO_LOG_LEVEL="INFO"
ENV PYTHONIOENCODING="utf-8"
ENV LANG="en_US.UTF-8"
ENV LC_ALL="en_US.UTF-8"

RUN Write-Host '=== STARTING BASE SETUP ===' ; `
    Write-Host 'Creating base directories...' ; `
    New-Item -ItemType Directory -Force -Path 'C:\temp' | Out-Null ; `
    Write-Host 'ðŸ“ Created C:\temp' ; `
    New-Item -ItemType Directory -Force -Path 'C:\r-lib' | Out-Null ; `
    Write-Host 'ðŸ“ Created C:\r-lib' ; `
    Write-Host 'Environment variables set:' ; `
    Write-Host "  R_LIBS_USER: $env:R_LIBS_USER" ; `
    Write-Host "  QUARTO_LOG_LEVEL: $env:QUARTO_LOG_LEVEL" ; `
    Write-Host "  PYTHONIOENCODING: $env:PYTHONIOENCODING" ; `
    Write-Host "  LANG: $env:LANG" ; `
    Write-Host "  LC_ALL: $env:LC_ALL" ; `
    Write-Host 'âœ… Base setup complete'

# ------------------------------------------------------------
# PHASE 1: PowerShell 7 (ZIP install, container-safe)
# ------------------------------------------------------------
RUN Write-Host '=== STARTING POWERSHELL 7 INSTALLATION ===' ; `
    Write-Host 'Using ZIP install for container compatibility' ; `
    Write-Host 'Download URL: https://github.com/PowerShell/PowerShell/releases/download/v7.4.1/PowerShell-7.4.1-win-x64.zip' ; `
    $Url = 'https://github.com/PowerShell/PowerShell/releases/download/v7.4.1/PowerShell-7.4.1-win-x64.zip' ; `
    $Zip = 'C:\PowerShell-7.4.1.zip' ; `
    Write-Host "Downloading PowerShell 7 to: $Zip" ; `
    Invoke-WebRequest -Uri $Url -OutFile $Zip -UseBasicParsing ; `
    Write-Host 'ðŸ“¥ Download completed' ; `
    Write-Host 'Creating PowerShell directory...' ; `
    New-Item -ItemType Directory -Force -Path 'C:\Program Files\PowerShell\7' | Out-Null ; `
    Write-Host 'ðŸ“ Directory created' ; `
    Write-Host 'Extracting ZIP file...' ; `
    Expand-Archive -Path $Zip -DestinationPath 'C:\Program Files\PowerShell\7' -Force ; `
    Write-Host 'ðŸ“¦ Extraction completed' ; `
    Write-Host 'Cleaning up ZIP file...' ; `
    Remove-Item $Zip -Force ; `
    Write-Host 'ðŸ§¹ Cleanup completed' ; `
    Write-Host 'Adding PowerShell to PATH...' ; `
    $mach = [Environment]::GetEnvironmentVariable('PATH','Machine') ; `
    Write-Host "Current PATH: $mach" ; `
    if ($mach -notmatch [regex]::Escape('C:\Program Files\PowerShell\7')) { `
      [Environment]::SetEnvironmentVariable('PATH', ('C:\Program Files\PowerShell\7;' + $mach), 'Machine') ; `
      Write-Host 'ðŸ”— PowerShell added to PATH' ; `
    } else { `
      Write-Host 'âš ï¸ PowerShell already in PATH' ; `
    } ; `
    Write-Host 'Verifying PowerShell installation...' ; `
    & 'C:\Program Files\PowerShell\7\pwsh.exe' -NoLogo -Command '$PSVersionTable.PSVersion ; Write-Host ''PowerShell 7 installation verified âœ…'''

# Switch to PowerShell 7 for subsequent layers
SHELL ["C:\\Program Files\\PowerShell\\7\\pwsh.exe", "-NoLogo", "-ExecutionPolicy", "Bypass", "-Command"]

# ------------------------------------------------------------
# PHASE 2: Chocolatey (package manager for Windows)
# ------------------------------------------------------------
RUN Write-Host '=== STARTING CHOCOLATEY INSTALLATION ===' ; `
    Write-Host 'Installing Chocolatey package manager...' ; `
    Write-Host 'Setting TLS 1.2 for download...' ; `
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 ; `
    Write-Host 'ðŸ”’ TLS 1.2 enabled' ; `
    Write-Host 'Downloading and executing Chocolatey install script...' ; `
    iex ((New-Object Net.WebClient).DownloadString('https://chocolatey.org/install.ps1')) ; `
    Write-Host 'ðŸ“¦ Chocolatey install script executed' ; `
    Write-Host 'Verifying Chocolatey installation...' ; `
    choco --version ; `
    Write-Host 'âœ… Chocolatey installation complete'

# ------------------------------------------------------------
# PHASE 3: Copy dependency files (same as quarto-build workflow)
# ------------------------------------------------------------
RUN Write-Host '=== STARTING DEPENDENCY FILE COPY ==='
COPY tools/dependencies/requirements.txt C:/temp/requirements.txt
COPY tools/dependencies/install_packages.R C:/temp/install_packages.R
COPY tools/dependencies/tl_packages C:/temp/tl_packages
COPY docker/windows/verify_r_packages.R C:/temp/verify_r_packages.R
RUN Write-Host 'âœ… Dependency file copy complete'

# ------------------------------------------------------------
# PHASE 4: Install TeX Live via Chocolatey with full scheme
# ------------------------------------------------------------
# CURRENT APPROACH: Official network installer (Chocolatey is broken - missing install-tl.zip)
RUN Write-Host '=== STARTING TEX LIVE INSTALLATION ===' ; `
    Write-Host 'ðŸ“¦ Using official TeX Live network installer' ; `
    Write-Host 'â° Installation will take 15-20 minutes' ; `
    Write-Host 'ðŸ”„ Downloading TeX Live installer...' ; `
    $installerUrl = 'https://mirror.ctan.org/systems/texlive/tlnet/install-tl-windows.exe' ; `
    $installerPath = 'C:\temp\install-tl-windows.exe' ; `
    Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath -UseBasicParsing ; `
    $installerSizeMB = [math]::Round((Get-Item $installerPath).Length / 1MB, 2) ; `
    Write-Host ('âœ… Downloaded installer (' + $installerSizeMB + ' MB)') ; `
    Write-Host 'ðŸ”§ Creating installation profile...' ; `
    $profilePath = 'C:\temp\texlive.profile' ; `
    'selected_scheme scheme-full' | Out-File -FilePath $profilePath -Encoding ASCII ; `
    'TEXDIR C:/texlive/2025' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'TEXMFCONFIG C:/texlive/2025/texmf-config' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'TEXMFHOME C:/texlive/2025/texmf-home' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'TEXMFLOCAL C:/texlive/2025/texmf-local' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'TEXMFSYSCONFIG C:/texlive/2025/texmf-config' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'TEXMFSYSVAR C:/texlive/2025/texmf-var' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'TEXMFVAR C:/texlive/2025/texmf-var' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'binary_windows 1' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'instopt_adjustpath 1' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'instopt_adjustrepo 1' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'instopt_letter 0' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'instopt_portable 0' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'instopt_write18_restricted 1' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_autobackup 0' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_backupdir tlpkg/backups' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_create_formats 1' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_desktop_integration 1' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_file_assocs 1' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_generate_updmap 0' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_install_docfiles 0' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_install_srcfiles 0' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_post_code 1' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_sys_bin C:/texlive/2025/bin/windows' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_sys_info C:/texlive/2025/texmf-dist/doc/info' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_sys_man C:/texlive/2025/texmf-dist/doc/man' | Add-Content -Path $profilePath -Encoding ASCII ; `
    'tlpdbopt_w32_multi_user 0' | Add-Content -Path $profilePath -Encoding ASCII ; `
    Write-Host 'âœ… Profile created' ; `
    Write-Host 'ðŸ“‹ Profile settings: scheme-full, no docs/sources' ; `
    Write-Host 'ðŸ”„ Running TeX Live installer (verbose, using fast US mirror)...' ; `
    & $installerPath -profile $profilePath -no-gui -v -repository https://mirrors.rit.edu/CTAN/systems/texlive/tlnet ; `
    $exitCode = $LASTEXITCODE ; `
    Write-Host "Installer exit code: $exitCode" ; `
    if ($exitCode -ne 0) { `
        Write-Host 'âŒ ERROR: TeX Live installation failed' ; `
        throw "TeX Live installation failed with exit code $exitCode" ; `
    } ; `
    Write-Host 'âœ… TeX Live installed successfully' ; `
    Write-Host 'ðŸ” Locating TeX Live installation...' ; `
    $texLiveBin = 'C:\texlive\2025\bin\windows' ; `
    if (-not (Test-Path $texLiveBin)) { `
        Write-Host 'âŒ ERROR: TeX Live bin directory not found' ; `
        Write-Host 'ðŸ“ Checking for alternative locations:' ; `
        Get-ChildItem 'C:\texlive' -Recurse -Depth 2 -Directory -ErrorAction SilentlyContinue | `
            Where-Object { $_.Name -eq 'windows' } | ForEach-Object { Write-Host "  Found: $($_.FullName)" } ; `
        throw "TeX Live bin directory not found at $texLiveBin" ; `
    } ; `
    Write-Host "âœ… TeX Live bin: $texLiveBin" ; `
    Write-Host 'ðŸ”§ Adding TeX Live to PATH...' ; `
    $mach = [Environment]::GetEnvironmentVariable('PATH','Machine') ; `
    $newPath = $texLiveBin + ';' + $mach ; `
    [Environment]::SetEnvironmentVariable('PATH', $newPath, 'Machine') ; `
    $env:PATH = $texLiveBin + ';' + $env:PATH ; `
    Write-Host 'âœ… PATH updated' ; `

# ALTERNATIVE: Chocolatey installation (BROKEN - missing install-tl.zip in package)
# DO NOT USE - Chocolatey texlive package has been broken since Oct 2025
# Error: "The system cannot find the file specified. C:\ProgramData\chocolatey\lib\texlive\tools\install-tl.zip"
#
# RUN Write-Host '=== STARTING TEX LIVE INSTALLATION ===' ; `
#     Write-Host 'ðŸ“¦ Installing TeX Live via Chocolatey with FULL scheme...' ; `
#     Write-Host 'â° This will take 15-20 minutes for full installation' ; `
#     choco install texlive --params "'/scheme:full'" -y ; `
#     if ($LASTEXITCODE -ne 0) { throw "Chocolatey TeX Live installation failed" } ; `
#     Write-Host 'âœ… TeX Live (full scheme) installed via Chocolatey' ; `
#     `
#     Write-Host 'ðŸ” Locating TeX Live installation...' ; `
#     $texLiveBin = Get-ChildItem -Path 'C:\texlive' -Recurse -Depth 3 -Directory -ErrorAction SilentlyContinue | `
#         Where-Object { $_.Name -eq 'windows' -and $_.FullName -like '*\bin\windows' } | `
#         Select-Object -First 1 -ExpandProperty FullName ; `
#     if (-not $texLiveBin) { `
#         Write-Host 'âŒ ERROR: TeX Live bin directory not found' ; `
#         Write-Host 'ðŸ“ Searching C:\texlive for bin directories:' ; `
#         Get-ChildItem 'C:\texlive' -Recurse -Depth 3 -Directory -ErrorAction SilentlyContinue | `
#             Where-Object { $_.Name -eq 'windows' } | ForEach-Object { Write-Host "  Found: $($_.FullName)" } ; `
#         throw 'TeX Live bin directory not found' ; `
#     } ; `
#     Write-Host "âœ… Found TeX Live bin: $texLiveBin" ; `
#     `
#     Write-Host 'ðŸ”§ Adding TeX Live to PATH...' ; `
#     $mach = [Environment]::GetEnvironmentVariable('PATH','Machine') ; `
#     $newPath = $texLiveBin + ';' + $mach ; `
#     [Environment]::SetEnvironmentVariable('PATH', $newPath, 'Machine') ; `
#     $env:PATH = $texLiveBin + ';' + $env:PATH ; `
#     Write-Host 'âœ… PATH updated'

# ------------------------------------------------------------
# PHASE 5: Install Scoop (Package manager setup)
# ------------------------------------------------------------
RUN Write-Host '=== STARTING SCOOP INSTALLATION ===' ; `
    Write-Host 'Setting UTF-8 encoding...' ; `
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8 ; `
    $OutputEncoding = [System.Text.Encoding]::UTF8 ; `
    Write-Host 'ðŸ”¤ UTF-8 encoding set' ; `
    Write-Host 'Setting execution policy...' ; `
    Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force ; `
    Write-Host 'ðŸ” Execution policy set' ; `
    Write-Host 'Installing Scoop package manager...' ; `
    Invoke-WebRequest -useb get.scoop.sh -outfile 'install.ps1' ; `
    Write-Host 'ðŸ“¥ Scoop install script downloaded' ; `
    & .\install.ps1 -RunAsAdmin ; `
    Write-Host 'ðŸ“¦ Scoop installed' ; `
    Write-Host 'Adding Scoop shims to PATH...' ; `
    $scoopShims = Join-Path (Resolve-Path ~).Path 'scoop\shims' ; `
    Write-Host "Scoop shims path: $scoopShims" ; `
    $mach = [Environment]::GetEnvironmentVariable('PATH','Machine') ; `
    [Environment]::SetEnvironmentVariable('PATH', ($scoopShims + ';' + $mach), 'Machine') ; `
    Write-Host 'ðŸ”— Added Scoop shims to PATH' ; `
# ------------------------------------------------------------
# FINAL: Verification of all installations
# ------------------------------------------------------------
RUN Write-Host '' ; `
    Write-Host '============================================' ; `
    Write-Host '=== INSTALLATION VERIFICATION ===' ; `
    Write-Host '============================================' ; `
    Write-Host '' ; `
    Write-Host 'ðŸ“¦ PowerShell Version:' ; `
    pwsh --version ; `
    Write-Host '' ; `
    Write-Host 'ðŸ“¦ TeX Live - lualatex:' ; `
    lualatex --version | Select-Object -First 2 ; `
    Write-Host '' ; `
    Write-Host 'ðŸ“¦ TeX Live - tlmgr:' ; `
    tlmgr --version | Select-Object -First 1 ; `
    Write-Host '' ; `
    Write-Host 'ðŸ“¦ Quarto:' ; `
    quarto --version ; `
    Write-Host '' ; `
    Write-Host 'ðŸ“¦ Python:' ; `
    python --version ; `
    Write-Host '' ; `
    Write-Host 'ðŸ“¦ R:' ; `
    Rscript --version 2>&1 | Select-Object -First 1 ; `
    Write-Host '' ; `
    Write-Host 'ðŸ“¦ Ghostscript:' ; `
    gs --version ; `
    Write-Host '' ; `
    Write-Host '============================================' ; `
    Write-Host 'âœ… ALL TOOLS VERIFIED AND READY' ; `
    Write-Host '============================================'
