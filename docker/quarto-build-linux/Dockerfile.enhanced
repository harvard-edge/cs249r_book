# MLSysBook Quarto Build Container - Enhanced with Progress Indicators
# Based on Ubuntu 22.04 with all dependencies pre-installed
# This container eliminates the 30-45 minute setup time for Linux builds

FROM ubuntu:22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV R_LIBS_USER=/usr/local/lib/R/library
ENV QUARTO_LOG_LEVEL=INFO
ENV PYTHONIOENCODING=utf-8
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV PATH=/usr/local/texlive/bin/x86_64-linux:$PATH

# === PHASE 1: SYSTEM DEPENDENCIES ===
RUN echo "ğŸš€ === STARTING SYSTEM DEPENDENCIES INSTALLATION ===" && \
    echo "â° Estimated time: 2-3 minutes" && \
    echo "ğŸ“Š Free disk space: $(df -h / | tail -1 | awk '{print $4}')" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ”„ Updating package lists..." && \
    apt-get update && \
    \
    echo "ğŸ“¦ Installing core system packages (42 packages)..." && \
    apt-get install -y \
    fonts-dejavu \
    fonts-freefont-ttf \
    gdk-pixbuf2.0-bin \
    libcairo2 \
    libfontconfig1 \
    libfontconfig1-dev \
    libfreetype6 \
    libfreetype6-dev \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libpangoft2-1.0-0 \
    libxml2-dev \
    libcurl4-openssl-dev \
    libjpeg-dev \
    libtiff5-dev \
    libpng-dev \
    libharfbuzz-dev \
    libfribidi-dev \
    librsvg2-dev \
    libgdal-dev \
    libudunits2-dev \
    wget \
    curl \
    git \
    && \
    \
    echo "ğŸ§¹ Cleaning package cache..." && \
    rm -rf /var/lib/apt/lists/* && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === SYSTEM DEPENDENCIES COMPLETE === (${duration}s)" && \
    echo "ğŸ“Š Free disk space: $(df -h / | tail -1 | awk '{print $4}')"

# === PHASE 2: INKSCAPE INSTALLATION ===
RUN echo "ğŸš€ === STARTING INKSCAPE INSTALLATION ===" && \
    echo "â° Estimated time: 1-2 minutes" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ”„ Adding Inkscape PPA repository..." && \
    apt-get update && \
    apt-get install -y software-properties-common && \
    add-apt-repository ppa:inkscape.dev/stable -y && \
    \
    echo "ğŸ“¦ Installing Inkscape..." && \
    apt-get update && \
    apt-get install -y inkscape && \
    \
    echo "ğŸ§¹ Cleaning package cache..." && \
    rm -rf /var/lib/apt/lists/* && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === INKSCAPE INSTALLATION COMPLETE === (${duration}s)"

# === PHASE 3: FONT CONFIGURATION ===
RUN echo "ğŸš€ === STARTING FONT CONFIGURATION ===" && \
    echo "â° Estimated time: 30 seconds" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ“¦ Installing additional fonts..." && \
    apt-get update && apt-get install -y \
    fonts-liberation \
    fontconfig && \
    \
    echo "ğŸ”„ Rebuilding font cache..." && \
    fc-cache -fv && \
    \
    echo "ğŸ§¹ Cleaning package cache..." && \
    rm -rf /var/lib/apt/lists/* && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === FONT CONFIGURATION COMPLETE === (${duration}s)"

# === PHASE 4: INKSCAPE VERIFICATION ===
RUN echo "ğŸš€ === TESTING INKSCAPE SVG TO PDF CONVERSION ===" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ“¦ Creating test SVG file..." && \
    echo '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="40" fill="red"/></svg>' > test.svg && \
    \
    echo "ğŸ”„ Converting SVG to PDF..." && \
    inkscape --export-type=pdf --export-filename=test.pdf test.svg && \
    \
    echo "ğŸ” Verifying conversion..." && \
    if [ -f test.pdf ]; then \
        echo "âœ… Inkscape SVG to PDF conversion successful!"; \
        echo "ğŸ“Š Generated PDF size: $(ls -lh test.pdf | awk '{print $5}')"; \
    else \
        echo "âŒ Inkscape SVG to PDF conversion failed."; \
        exit 1; \
    fi && \
    \
    echo "ğŸ§¹ Cleaning test files..." && \
    rm -f test.svg test.pdf && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === INKSCAPE VERIFICATION COMPLETE === (${duration}s)"

# === PHASE 5: GHOSTSCRIPT INSTALLATION ===
RUN echo "ğŸš€ === STARTING GHOSTSCRIPT INSTALLATION ===" && \
    echo "â° Estimated time: 30 seconds" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ“¦ Installing Ghostscript..." && \
    apt-get update && apt-get install -y ghostscript && \
    \
    echo "ğŸ§¹ Cleaning package cache..." && \
    rm -rf /var/lib/apt/lists/* && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === GHOSTSCRIPT INSTALLATION COMPLETE === (${duration}s)"

# === PHASE 6: TEX LIVE INSTALLATION ===
COPY tools/dependencies/tl_packages /tmp/
RUN echo "ğŸš€ === STARTING TEX LIVE INSTALLATION ===" && \
    echo "â° Estimated time: 8-12 minutes (largest phase)" && \
    echo "ğŸ“Š Free disk space before: $(df -h / | tail -1 | awk '{print $4}')" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ“¦ Installing TeX Live prerequisites..." && \
    apt-get update && apt-get install -y \
    perl \
    wget \
    xzdec && \
    rm -rf /var/lib/apt/lists/* && \
    \
    echo "ğŸ”„ Downloading TeX Live installer (~4MB)..." && \
    wget -O /tmp/install-tl-unx.tar.gz "https://mirror.ctan.org/systems/texlive/tlnet/install-tl-unx.tar.gz" && \
    \
    echo "ğŸ“¦ Extracting TeX Live installer..." && \
    cd /tmp && tar -xzf install-tl-unx.tar.gz && \
    \
    echo "ğŸ”§ Creating TeX Live installation profile..." && \
    echo "selected_scheme scheme-infraonly" > /tmp/texlive.profile && \
    echo "tlpdbopt_install_docfiles 0" >> /tmp/texlive.profile && \
    echo "tlpdbopt_install_srcfiles 0" >> /tmp/texlive.profile && \
    echo "TEXDIR /usr/local/texlive" >> /tmp/texlive.profile && \
    echo "TEXMFCONFIG /usr/local/texlive/texmf-config" >> /tmp/texlive.profile && \
    echo "TEXMFHOME /usr/local/texlive/texmf-home" >> /tmp/texlive.profile && \
    echo "TEXMFLOCAL /usr/local/texlive/texmf-local" >> /tmp/texlive.profile && \
    echo "TEXMFSYSCONFIG /usr/local/texlive/texmf-config" >> /tmp/texlive.profile && \
    echo "TEXMFSYSVAR /usr/local/texlive/texmf-var" >> /tmp/texlive.profile && \
    echo "TEXMFVAR /usr/local/texlive/texmf-var" >> /tmp/texlive.profile && \
    \
    echo "ğŸ”„ Installing TeX Live base system..." && \
    /tmp/install-tl-*/install-tl --profile=/tmp/texlive.profile && \
    \
    echo "ğŸ”§ Setting up TeX Live PATH..." && \
    echo 'export PATH=/usr/local/texlive/bin/x86_64-linux:$PATH' >> /etc/bash.bashrc && \
    export PATH=/usr/local/texlive/bin/x86_64-linux:$PATH && \
    \
    echo "ğŸ“Š Analyzing tl_packages file..." && \
    collection_count=$(grep -c '^collection-' /tmp/tl_packages) && \
    echo "ğŸ“¦ Found $collection_count TeX Live collections to install" && \
    \
    echo "ğŸ”„ Installing TeX Live collections..." && \
    i=1 && \
    grep -E '^collection-' /tmp/tl_packages | while read collection; do \
        echo "ğŸ“¦ [$i/$collection_count] Installing $collection..."; \
        tlmgr install "$collection"; \
        i=$((i+1)); \
    done && \
    \
    echo "ğŸ§¹ Cleaning up TeX Live installer..." && \
    rm -rf /tmp/install-tl-* /tmp/texlive.profile /tmp/install-tl-unx.tar.gz && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === TEX LIVE INSTALLATION COMPLETE === (${duration}s)" && \
    echo "ğŸ“Š Free disk space after: $(df -h / | tail -1 | awk '{print $4}')" && \
    echo "ğŸ“Š TeX Live disk usage: $(du -sh /usr/local/texlive 2>/dev/null || echo 'N/A')"

# === PHASE 7: TEX LIVE VERIFICATION ===
RUN echo "ğŸš€ === VERIFYING TEX LIVE INSTALLATION ===" && \
    start_time=$(date +%s) && \
    \
    export PATH=/usr/local/texlive/bin/x86_64-linux:$PATH && \
    echo "ğŸ” Checking TeX Live executables..." && \
    which lualatex && which pdflatex && \
    \
    echo "ğŸ“Š TeX Live version information:" && \
    lualatex --version | head -1 && \
    \
    echo "ğŸ” Testing basic LaTeX compilation..." && \
    echo '\documentclass{article}' > /tmp/test.tex && \
    echo '\begin{document}' >> /tmp/test.tex && \
    echo 'Hello TeX Live!' >> /tmp/test.tex && \
    echo '\end{document}' >> /tmp/test.tex && \
    \
    cd /tmp && lualatex test.tex >/dev/null 2>&1 && \
    if [ -f test.pdf ]; then \
        echo "âœ… LaTeX compilation test successful"; \
        echo "ğŸ“Š Generated PDF size: $(ls -lh test.pdf | awk '{print $5}')"; \
    else \
        echo "âŒ LaTeX compilation test failed"; \
        exit 1; \
    fi && \
    \
    echo "ğŸ§¹ Cleaning test files..." && \
    rm -f /tmp/test.* && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === TEX LIVE VERIFICATION COMPLETE === (${duration}s)"

# === PHASE 8: R INSTALLATION ===
RUN echo "ğŸš€ === STARTING R INSTALLATION ===" && \
    echo "â° Estimated time: 1-2 minutes" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ“¦ Installing R and development packages..." && \
    apt-get update && apt-get install -y \
    r-base \
    r-base-dev \
    r-recommended && \
    \
    echo "ğŸ§¹ Cleaning package cache..." && \
    rm -rf /var/lib/apt/lists/* && \
    \
    echo "ğŸ“Š R version: $(R --version | head -1)" && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === R INSTALLATION COMPLETE === (${duration}s)"

# === PHASE 9: PYTHON INSTALLATION ===
RUN echo "ğŸš€ === STARTING PYTHON INSTALLATION ===" && \
    echo "â° Estimated time: 1 minute" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ“¦ Installing Python 3 and development packages..." && \
    apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev && \
    \
    echo "ğŸ§¹ Cleaning package cache..." && \
    rm -rf /var/lib/apt/lists/* && \
    \
    echo "ğŸ“Š Python version: $(python3 --version)" && \
    echo "ğŸ“Š Pip version: $(pip3 --version)" && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === PYTHON INSTALLATION COMPLETE === (${duration}s)"

# === PHASE 10: QUARTO INSTALLATION ===
RUN echo "ğŸš€ === STARTING QUARTO INSTALLATION ===" && \
    echo "â° Estimated time: 30 seconds" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ”„ Downloading Quarto v1.7.31..." && \
    wget -q https://github.com/quarto-dev/quarto-cli/releases/download/v1.7.31/quarto-1.7.31-linux-amd64.deb && \
    \
    echo "ğŸ“¦ Installing Quarto..." && \
    dpkg -i quarto-1.7.31-linux-amd64.deb && \
    \
    echo "ğŸ§¹ Cleaning installer..." && \
    rm quarto-1.7.31-linux-amd64.deb && \
    \
    echo "ğŸ“Š Quarto version: $(quarto --version)" && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === QUARTO INSTALLATION COMPLETE === (${duration}s)"

# === PHASE 11: SETUP DIRECTORIES ===
RUN echo "ğŸš€ === SETTING UP DIRECTORIES ===" && \
    echo "ğŸ”§ Creating R library directory: $R_LIBS_USER" && \
    mkdir -p $R_LIBS_USER && \
    echo "ğŸ“Š R library path: $(ls -la $R_LIBS_USER)" && \
    echo "âœ… === DIRECTORY SETUP COMPLETE ==="

# Copy dependency files
COPY tools/dependencies/requirements.txt /tmp/
COPY tools/dependencies/install_packages.R /tmp/
COPY docker/quarto-build-linux/verify_r_packages.R /tmp/

# === PHASE 12: PYTHON PACKAGES ===
RUN echo "ğŸš€ === STARTING PYTHON PACKAGE INSTALLATION ===" && \
    echo "â° Estimated time: 1-2 minutes" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ”„ Upgrading pip..." && \
    pip3 install --upgrade pip && \
    \
    echo "ğŸ“Š Analyzing requirements.txt..." && \
    package_count=$(grep -v '^#' /tmp/requirements.txt | grep -v '^$' | wc -l) && \
    echo "ğŸ“¦ Found $package_count Python packages to install" && \
    \
    echo "ğŸ”„ Installing Python packages..." && \
    pip3 install -r /tmp/requirements.txt && \
    \
    echo "ğŸ“Š Installed Python packages:" && \
    pip3 list | head -10 && \
    echo "ğŸ“Š Total packages: $(pip3 list | wc -l)" && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === PYTHON PACKAGES COMPLETE === (${duration}s)"

# === PHASE 13: R PACKAGES ===
RUN echo "ğŸš€ === STARTING R PACKAGE INSTALLATION ===" && \
    echo "â° Estimated time: 3-5 minutes" && \
    start_time=$(date +%s) && \
    \
    R --slave -e " \
    # Set options for better package installation \
    options(repos = c(CRAN = 'https://cran.rstudio.com')); \
    \
    cat('ğŸ”„ Starting R package installation...\n'); \
    cat(paste('ğŸ“Š R library path:', Sys.getenv('R_LIBS_USER'), '\n')); \
    \
    # Create and set library path \
    lib_path <- Sys.getenv('R_LIBS_USER'); \
    dir.create(lib_path, showWarnings = FALSE, recursive = TRUE); \
    .libPaths(lib_path); \
    \
    # Install packages \
    cat('ğŸ“¦ [1/2] Installing remotes package...\n'); \
    install.packages('remotes'); \
    \
    if (file.exists('/tmp/install_packages.R')) { \
      cat('ğŸ“¦ [2/2] Installing packages from tools/dependencies/install_packages.R...\n'); \
      source('/tmp/install_packages.R'); \
    } else { \
      cat('âš ï¸ No tools/dependencies/install_packages.R found, installing common packages\n'); \
      pkgs <- c('rmarkdown', 'knitr', 'tidyverse', 'ggplot2', 'bookdown'); \
      cat(paste('ğŸ“¦ Installing packages:', paste(pkgs, collapse=', '), '\n')); \
      install.packages(pkgs); \
    }; \
    \
    cat('âœ… R package installation complete\n'); \
    cat('ğŸ“Š Installed packages summary:\n'); \
    ip <- installed.packages()[, 'Package']; \
    print(head(ip, 10)); \
    cat(paste('ğŸ“Š Total R packages installed:', length(ip), '\n')); \
    " && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === R PACKAGES COMPLETE === (${duration}s)"

# === PHASE 14: R PACKAGE VERIFICATION ===
RUN echo "ğŸš€ === VERIFYING R PACKAGE INSTALLATION ===" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ” Running R package verification script..." && \
    Rscript /tmp/verify_r_packages.R && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === R PACKAGE VERIFICATION COMPLETE === (${duration}s)"

# === PHASE 15: CLEANUP ===
RUN echo "ğŸš€ === STARTING CLEANUP ===" && \
    start_time=$(date +%s) && \
    \
    echo "ğŸ§¹ Removing temporary files..." && \
    rm -rf /tmp/requirements.txt /tmp/install_packages.R /tmp/verify_r_packages.R /tmp/tl_packages && \
    \
    echo "ğŸ“Š Final disk space: $(df -h / | tail -1 | awk '{print $4}')" && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === CLEANUP COMPLETE === (${duration}s)"

# Set working directory
WORKDIR /workspace

# === PHASE 16: FINAL VERIFICATION ===
RUN echo "ğŸš€ === FINAL VERIFICATION ===" && \
    start_time=$(date +%s) && \
    \
    export PATH=/usr/local/texlive/bin/x86_64-linux:$PATH && \
    echo "ğŸ” Verifying all installations..." && \
    \
    echo "ğŸ“Š Quarto: $(quarto --version)" && \
    echo "ğŸ“Š Python: $(python3 --version)" && \
    echo "ğŸ“Š R: $(R --version | head -1)" && \
    echo "ğŸ“Š TeX Live: $(lualatex --version | head -1)" && \
    \
    end_time=$(date +%s) && \
    duration=$((end_time - start_time)) && \
    echo "âœ… === FINAL VERIFICATION COMPLETE === (${duration}s)"

# === FINAL HEALTH CHECK ===
RUN export PATH=/usr/local/texlive/bin/x86_64-linux:$PATH && \
    echo "ğŸ‰ === CONTAINER BUILD COMPLETED SUCCESSFULLY ===" && \
    echo "ğŸ“Š Final Status Summary:" && \
    echo "  âœ… Quarto version: $(quarto --version)" && \
    echo "  âœ… Python version: $(python3 --version)" && \
    echo "  âœ… R version: $(R --version | head -1)" && \
    echo "  âœ… TeX Live: $(lualatex --version | head -1)" && \
    echo "  ğŸ“Š Final disk usage: $(df -h / | tail -1 | awk '{print $4}') free" && \
    echo "ğŸ‰ === READY FOR QUARTO BUILDS ==="