# MLSysBook Windows Quarto Build Container
# Replicates the exact environment that quarto-build workflow uses successfully
# Based on Windows Server 2022 (same as windows-latest GitHub Actions runner)

# Use full Windows instead of Server Core for better compatibility with package managers
# This matches the GitHub Actions windows-latest environment more closely
FROM mcr.microsoft.com/windows/server:ltsc2022

# === PHASE 1: POWERSHELL 7 INSTALLATION ===
RUN curl -L -o PowerShell.msi https://github.com/PowerShell/PowerShell/releases/download/v7.4.1/PowerShell-7.4.1-win-x64.msi && \
    if not exist PowerShell.msi (echo ‚ùå PowerShell download failed - aborting build && exit 1) && \
    msiexec /i PowerShell.msi /quiet /norestart && \
    if %ERRORLEVEL% neq 0 (echo ‚ùå PowerShell installation failed - aborting build && exit 1) && \
    del PowerShell.msi

# Add PowerShell to PATH
RUN setx PATH "%PATH%;C:\Program Files\PowerShell\7" /M

# Verify PowerShell 7 installation (separate RUN command so PATH takes effect)
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command "Write-Host 'PowerShell 7 installation verified'"

# === PHASE 2: CHOCOLATEY INSTALLATION ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    Write-Host 'üöÄ === STARTING CHOCOLATEY INSTALLATION ==='; \
    try { \
        Set-ExecutionPolicy Bypass -Scope Process -Force; \
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; \
        iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1')); \
        Write-Host '‚úÖ Chocolatey installation complete'; \
        # Test chocolatey installation \
        $chocoVersion = & choco --version 2>&1; \
        if ($LASTEXITCODE -ne 0) { throw 'Chocolatey test failed' }; \
        Write-Host ('üìä Chocolatey version: ' + $chocoVersion); \
    } catch { \
        Write-Host ('‚ùå Chocolatey installation failed: ' + $_.Exception.Message); \
        throw 'Chocolatey installation failed - aborting build'; \
    } \
    "

# Set environment variables to match workflow
ENV R_LIBS_USER=C:/r-lib
ENV QUARTO_LOG_LEVEL=INFO
ENV PYTHONIOENCODING=utf-8
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

# Copy dependency files needed for installations
COPY tools/dependencies/requirements/ C:/temp/requirements/
COPY tools/dependencies/requirements-build.txt C:/temp/requirements.txt
COPY tools/dependencies/install_packages.R C:/temp/install_packages.R
COPY tools/dependencies/tl_packages C:/temp/tl_packages
COPY docker/build-quarto-windows/verify_r_packages.R C:/temp/verify_r_packages.R

# Create necessary directories
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command "New-Item -ItemType Directory -Path 'C:/r-lib' -Force; New-Item -ItemType Directory -Path 'C:/temp' -Force"

# === PHASE 3: QUARTO INSTALLATION ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    Write-Host 'üöÄ === STARTING QUARTO INSTALLATION ==='; \
    Write-Host '‚è∞ Estimated time: 1-2 minutes'; \
    $startTime = Get-Date; \
    \
    Write-Host 'üì¶ Downloading Quarto 1.7.31...'; \
    try { \
        Invoke-WebRequest -Uri 'https://github.com/quarto-dev/quarto-cli/releases/download/v1.7.31/quarto-1.7.31-win.zip' -OutFile 'quarto.zip' -TimeoutSec 300; \
        if (-not (Test-Path 'quarto.zip') -or (Get-Item 'quarto.zip').Length -lt 10MB) { \
            throw 'Quarto download failed or file is too small'; \
        } \
    } catch { \
        Write-Host ('‚ùå Quarto download failed: ' + $_.Exception.Message); \
        throw 'Quarto download failed - aborting build'; \
    } \
    \
    Write-Host 'üì¶ Extracting Quarto...'; \
    try { \
        Expand-Archive -Path 'quarto.zip' -DestinationPath 'C:\quarto' -Force; \
        if (-not (Test-Path 'C:\quarto\quarto-1.7.31\bin\quarto.cmd')) { \
            throw 'Quarto extraction failed - quarto.cmd not found'; \
        } \
    } catch { \
        Write-Host ('‚ùå Quarto extraction failed: ' + $_.Exception.Message); \
        throw 'Quarto extraction failed - aborting build'; \
    } \
    \
    Write-Host 'üßπ Cleaning up installer...'; \
    Remove-Item 'quarto.zip'; \
    \
    $endTime = Get-Date; \
    $duration = ($endTime - $startTime).TotalMinutes; \
    Write-Host ('‚úÖ === QUARTO INSTALLATION COMPLETE === (' + $duration.ToString('F1') + ' minutes)'); \
    " && \
    setx PATH "%PATH%;C:\quarto\quarto-1.7.31\bin" /M

# === PHASE 4: PYTHON 3.13 INSTALLATION ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    Write-Host 'üöÄ === STARTING PYTHON 3.13 INSTALLATION ==='; \
    Write-Host '‚è∞ Estimated time: 2-3 minutes'; \
    $startTime = Get-Date; \
    Write-Host 'üì¶ Installing Python 3.13.1 (exact version from workflow)...'; \
    " && \
    choco install -y python --version=3.13.1 && \
    "C:\Program Files\PowerShell\7\pwsh.exe" -Command "if ($LASTEXITCODE -ne 0) { throw 'Python 3.13.1 installation failed - aborting build' }" && \
    "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    # Refresh environment variables to pick up Python PATH \
    $env:PATH = [System.Environment]::GetEnvironmentVariable('PATH', [System.EnvironmentVariableTarget]::Machine) + ';' + [System.Environment]::GetEnvironmentVariable('PATH', [System.EnvironmentVariableTarget]::User); \
    # Add common Python paths explicitly \
    $env:PATH += ';C:\Python313;C:\Python313\Scripts;C:\ProgramData\chocolatey\bin'; \
    \
    $endTime = Get-Date; \
    $duration = ($endTime - $startTime).TotalMinutes; \
    Write-Host ('‚úÖ === PYTHON 3.13 INSTALLATION COMPLETE === (' + $duration.ToString('F1') + ' minutes)'); \
    \
    # Test Python installation with explicit path handling \
    try { \
        $pythonVersion = & python --version 2>&1; \
        Write-Host ('üìä Python version: ' + $pythonVersion); \
        $pipVersion = & python -m pip --version 2>&1; \
        Write-Host ('üìä Pip version: ' + $pipVersion); \
    } catch { \
        Write-Host '‚ö†Ô∏è Python installed but not immediately available in PATH (normal for containers)'; \
        Write-Host 'Python will be available in subsequent RUN commands'; \
    } \
    "

# === PHASE 5: PYTHON PACKAGE INSTALLATION ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    Write-Host 'üöÄ === STARTING PYTHON PACKAGE INSTALLATION ==='; \
    Write-Host '‚è∞ Estimated time: 1-2 minutes'; \
    $startTime = Get-Date; \
    \
    # Ensure Python is in PATH \
    $env:PATH = [System.Environment]::GetEnvironmentVariable('PATH', [System.EnvironmentVariableTarget]::Machine) + ';C:\Python313;C:\Python313\Scripts;C:\ProgramData\chocolatey\bin'; \
    \
    Write-Host 'üîÑ Upgrading pip...'; \
    & python -m pip install --upgrade pip; \
    if ($LASTEXITCODE -ne 0) { throw 'Pip upgrade failed - aborting build' }; \
    \
    Write-Host 'üìä Analyzing requirements.txt...'; \
    $packageCount = (Get-Content 'C:/temp/requirements.txt' | Where-Object { $_ -notmatch '^#' -and $_ -ne '' }).Count; \
    Write-Host ('üì¶ Found ' + $packageCount + ' Python packages to install'); \
    \
    Write-Host 'üîÑ Installing Python packages...'; \
    & python -m pip install -r C:/temp/requirements.txt; \
    if ($LASTEXITCODE -ne 0) { throw 'Python packages installation failed - aborting build' }; \
    \
    $endTime = Get-Date; \
    $duration = ($endTime - $startTime).TotalMinutes; \
    Write-Host ('‚úÖ === PYTHON PACKAGES COMPLETE === (' + $duration.ToString('F1') + ' minutes)'); \
    \
    try { \
        $packageCount = (& python -m pip list | Measure-Object).Count; \
        Write-Host ('üìä Total packages: ' + $packageCount); \
    } catch { \
        Write-Host 'üìä Python packages installed successfully'; \
    } \
    "

# === PHASE 6: GHOSTSCRIPT INSTALLATION ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    Write-Host 'üöÄ === STARTING GHOSTSCRIPT INSTALLATION ==='; \
    Write-Host '‚è∞ Estimated time: 1-2 minutes (direct download only)'; \
    $startTime = Get-Date; \
    $gsInstalled = $false; \
    \
    Write-Host 'üì¶ Installing Ghostscript via direct download (latest version)...'; \
    \
    # Use same approach as working quarto-build.yml (with winget fallback to chocolatey) \
    try { \
                Write-Host 'üîÑ Trying winget installation (primary method from quarto-build.yml)...'; \
                winget install ArtifexSoftware.GhostScript --accept-source-agreements --accept-package-agreements; \
                Write-Host '‚úÖ Ghostscript installed via winget'; \
                $gsInstalled = $true; \
            } catch { \
                Write-Host 'üîÑ winget not available, using chocolatey fallback...'; \
                try { \
                    choco install ghostscript -y; \
                    if ($LASTEXITCODE -eq 0) { \
                        Write-Host '‚úÖ Ghostscript installed via chocolatey'; \
                        $gsInstalled = $true; \
                    } else { \
                        throw ('Chocolatey installation failed with exit code: ' + $LASTEXITCODE); \
                    } \
                } catch { \
                    Write-Host ('‚ùå All Ghostscript installation methods failed: ' + $_.Exception.Message); \
                    throw 'Ghostscript installation failed - aborting build'; \
                } \
            } \
    \
    Write-Host 'üîß Setting up Ghostscript PATH...'; \
    $gsPath = Get-ChildItem 'C:/Program Files/gs' -ErrorAction SilentlyContinue | Sort-Object Name -Descending | Select-Object -First 1; \
    if ($gsPath) { \
        $binPath = Join-Path $gsPath.FullName 'bin'; \
        Write-Host ('üìç Found Ghostscript at: ' + $binPath); \
        [Environment]::SetEnvironmentVariable('PATH', \"$env:PATH;$binPath\", [EnvironmentVariableTarget]::Machine); \
        \
        Write-Host 'üß™ Testing Ghostscript installation...'; \
        try { \
            $gsVersion = & \"$binPath/gs.exe\" --version 2>&1; \
            Write-Host ('‚úÖ Ghostscript version: ' + $gsVersion); \
        } catch { \
            Write-Host '‚ö†Ô∏è Ghostscript installed but test failed (normal in some containers)'; \
        } \
    } else { \
        Write-Host '‚ö†Ô∏è Ghostscript directory not found - checking alternative locations...'; \
        $altPaths = @('C:/Program Files (x86)/gs', 'C:/gs', 'C:/ghostscript'); \
        foreach ($altPath in $altPaths) { \
            if (Test-Path $altPath) { \
                Write-Host ('üìç Found Ghostscript at alternative location: ' + $altPath); \
                [Environment]::SetEnvironmentVariable('PATH', \"$env:PATH;$altPath/bin\", [EnvironmentVariableTarget]::Machine); \
                break; \
            } \
        } \
    } \
    \
    $endTime = Get-Date; \
    $duration = ($endTime - $startTime).TotalMinutes; \
    Write-Host ('‚úÖ === GHOSTSCRIPT INSTALLATION COMPLETE === (' + $duration.ToString('F1') + ' minutes)'); \
    "

# === PHASE 7: INKSCAPE INSTALLATION ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    Write-Host 'üöÄ === STARTING INKSCAPE INSTALLATION ==='; \
    Write-Host '‚è∞ Estimated time: 2-3 minutes'; \
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8; \
    $OutputEncoding = [System.Text.Encoding]::UTF8; \
    [Console]::InputEncoding = [System.Text.Encoding]::UTF8; \
    $startTime = Get-Date; \
    \
    $inkscapeInstalled = $false; \
    try { \
        Write-Host 'üîÑ Attempting winget installation (primary method)...'; \
        Write-Host 'üì¶ Downloading Inkscape package...'; \
        $wingetProcess = Start-Process -FilePath 'winget' -ArgumentList 'install', 'Inkscape.Inkscape', '--accept-source-agreements', '--accept-package-agreements' -Wait -PassThru -NoNewWindow; \
        if ($wingetProcess.ExitCode -eq 0) { \
            Write-Host '‚úÖ Inkscape installed via winget'; \
            $inkscapeInstalled = $true; \
        } else { \
            Write-Host ('‚ö†Ô∏è winget failed with exit code: ' + $wingetProcess.ExitCode); \
        } \
    } catch { \
        Write-Host ('‚ö†Ô∏è winget failed: ' + $_.Exception.Message); \
    } \
    \
    if (-not $inkscapeInstalled) { \
        Write-Host 'üîÑ winget failed, using chocolatey fallback...'; \
        try { \
            Write-Host 'üì¶ Installing via chocolatey (alternative method)...'; \
            choco install inkscape -y; \
            if ($LASTEXITCODE -eq 0) { \
                Write-Host '‚úÖ Inkscape installed via chocolatey'; \
                $inkscapeInstalled = $true; \
            } else { \
                throw ('Chocolatey installation failed with exit code: ' + $LASTEXITCODE); \
            } \
        } catch { \
            Write-Host ('‚ùå Chocolatey installation failed: ' + $_.Exception.Message); \
        } \
    } \
    \
    if (-not $inkscapeInstalled) { \
        Write-Host '‚ùå CRITICAL: All Inkscape installation methods failed'; \
        Write-Host '‚ùå Inkscape is required for SVG processing in Quarto'; \
        throw 'Inkscape installation failed - aborting build'; \
    } \
    \
    Write-Host 'üîß Adding Inkscape to PATH...'; \
    [Environment]::SetEnvironmentVariable('PATH', \"$env:PATH;C:\Program Files\Inkscape\bin\", [EnvironmentVariableTarget]::Machine); \
    \
    $endTime = Get-Date; \
    $duration = ($endTime - $startTime).TotalMinutes; \
    Write-Host ('‚úÖ === INKSCAPE INSTALLATION COMPLETE === (' + $duration.ToString('F1') + ' minutes)'); \
    "

# === PHASE 8: TEX LIVE INSTALLATION ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    Write-Host 'üöÄ === STARTING TEX LIVE INSTALLATION ==='; \
    Write-Host '‚è∞ Estimated time: 8-12 minutes (largest phase)'; \
    Write-Host 'Free disk space before: ' + ((Get-WmiObject -Class Win32_LogicalDisk -Filter \"DeviceID='C:'\").FreeSpace / 1GB).ToString('F2') + ' GB'; \
    $startTime = Get-Date; \
    \
    Write-Host 'üîÑ Downloading TeX Live installer...'; \
    try { \
        Invoke-WebRequest -Uri 'https://mirror.ctan.org/systems/texlive/tlnet/install-tl-windows.exe' -OutFile 'C:/temp/install-tl-windows.exe' -TimeoutSec 600; \
        if (-not (Test-Path 'C:/temp/install-tl-windows.exe') -or (Get-Item 'C:/temp/install-tl-windows.exe').Length -lt 1MB) { \
            throw 'TeX Live installer download failed or file is too small'; \
        } \
    } catch { \
        Write-Host ('‚ùå TeX Live installer download failed: ' + $_.Exception.Message); \
        throw 'TeX Live installer download failed - aborting build'; \
    } \
    \
    Write-Host 'üîß Creating TeX Live installation profile...'; \
    $profileContent = 'selected_scheme scheme-infraonly' + \"`n\" + \
                     'tlpdbopt_install_docfiles 0' + \"`n\" + \
                     'tlpdbopt_install_srcfiles 0' + \"`n\" + \
                     'TEXDIR C:/texlive' + \"`n\" + \
                     'TEXMFCONFIG C:/texlive/texmf-config' + \"`n\" + \
                     'TEXMFHOME C:/texlive/texmf-home' + \"`n\" + \
                     'TEXMFLOCAL C:/texlive/texmf-local' + \"`n\" + \
                     'TEXMFSYSCONFIG C:/texlive/texmf-config' + \"`n\" + \
                     'TEXMFSYSVAR C:/texlive/texmf-var' + \"`n\" + \
                     'TEXMFVAR C:/texlive/texmf-var'; \
    $profileContent | Out-File -FilePath 'C:/temp/texlive.profile' -Encoding ASCII; \
    \
    Write-Host 'üì¶ Installing TeX Live base system (this may take 3-5 minutes)...'; \
    $texInstallProcess = Start-Process -FilePath 'C:/temp/install-tl-windows.exe' -ArgumentList '-profile', 'C:/temp/texlive.profile' -Wait -PassThru; \
    if ($texInstallProcess.ExitCode -ne 0) { \
        Write-Host ('‚ùå TeX Live base installation failed with exit code: ' + $texInstallProcess.ExitCode); \
        throw 'TeX Live base installation failed - aborting build'; \
    } \
    \
    Write-Host 'üîß Adding TeX Live to PATH...'; \
    [Environment]::SetEnvironmentVariable('PATH', \"$env:PATH;C:\texlive\bin\windows\", [EnvironmentVariableTarget]::Machine); \
    \
    Write-Host 'üìä Analyzing tl_packages file...'; \
    $packages = Get-Content 'C:/temp/tl_packages' | Where-Object { $_.Trim() -ne '' }; \
    $packageCount = $packages.Count; \
    Write-Host ('üì¶ Found ' + $packageCount + ' TeX Live collections to install'); \
    \
    Write-Host 'üîÑ Installing TeX Live collections...'; \
    $i = 1; \
    foreach ($package in $packages) { \
        Write-Host ('üì¶ [' + $i + '/' + $packageCount + '] Installing: ' + $package.Trim()); \
        & 'C:/texlive/bin/windows/tlmgr.bat' install $package.Trim(); \
        $i++; \
    }; \
    \
    Write-Host 'üßπ Cleaning up TeX Live installer...'; \
    Remove-Item 'C:/temp/install-tl-windows.exe'; \
    Remove-Item 'C:/temp/texlive.profile'; \
    \
    $endTime = Get-Date; \
    $duration = ($endTime - $startTime).TotalMinutes; \
    Write-Host ('‚úÖ === TEX LIVE INSTALLATION COMPLETE === (' + $duration.ToString('F1') + ' minutes)'); \
    Write-Host 'Free disk space after: ' + ((Get-WmiObject -Class Win32_LogicalDisk -Filter \"DeviceID='C:'\").FreeSpace / 1GB).ToString('F2') + ' GB'; \
    "

# === TEX LIVE VERIFICATION (matching quarto-build.yml workflow) ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    Write-Host 'üîç Verifying TeX Live installation (matching workflow verification)...'; \
    \
    # Refresh PATH to include TeX Live \
    $env:PATH = [System.Environment]::GetEnvironmentVariable('PATH', [EnvironmentVariableTarget]::Machine); \
    \
    Write-Host 'üìä Checking LaTeX engines:'; \
    try { \
        $lualatexPath = Get-Command lualatex -ErrorAction SilentlyContinue; \
        if ($lualatexPath) { \
            Write-Host ('‚úÖ lualatex found at: ' + $lualatexPath.Source); \
            $lualatexVersion = & lualatex --version 2>&1 | Select-Object -First 2; \
            Write-Host ('üìä LuaLaTeX version: ' + ($lualatexVersion -join ' ')); \
        } else { \
            Write-Host '‚ùå lualatex not found in PATH'; \
        } \
    } catch { \
        Write-Host ('‚ö†Ô∏è lualatex check failed: ' + $_.Exception.Message); \
    } \
    \
    try { \
        $pdflatexPath = Get-Command pdflatex -ErrorAction SilentlyContinue; \
        if ($pdflatexPath) { \
            Write-Host ('‚úÖ pdflatex found at: ' + $pdflatexPath.Source); \
        } else { \
            Write-Host '‚ùå pdflatex not found in PATH'; \
        } \
    } catch { \
        Write-Host ('‚ö†Ô∏è pdflatex check failed: ' + $_.Exception.Message); \
    } \
    \
    Write-Host 'üìä Checking core LaTeX and TikZ packages (matching workflow):'; \
    $packages = @('pgf.sty', 'pgfplots.sty', 'xcolor.sty', 'amsmath.sty', 'standalone.cls'); \
    foreach ($package in $packages) { \
        try { \
            $result = & kpsewhich $package 2>&1; \
            if ($LASTEXITCODE -eq 0) { \
                Write-Host ('‚úÖ ' + $package + ' found'); \
            } else { \
                Write-Host ('‚ùå ' + $package + ' missing'); \
            } \
        } catch { \
            Write-Host ('‚ùå ' + $package + ' check failed'); \
        } \
    } \
    \
    Write-Host '‚úÖ TeX Live verification complete (allowing partial failures as per workflow)'; \
    "

# === PHASE 9: R INSTALLATION ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    Write-Host 'üöÄ === STARTING R INSTALLATION ==='; \
    Write-Host '‚è∞ Estimated time: 2-3 minutes'; \
    $startTime = Get-Date; \
    Write-Host 'üì¶ Installing R 4.4.1 (exact version from workflow)...'; \
    " && \
    choco install -y r --version=4.4.1 && \
    "C:\Program Files\PowerShell\7\pwsh.exe" -Command "if ($LASTEXITCODE -ne 0) { throw 'R 4.4.1 installation failed - aborting build' }" && \
    "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    $endTime = Get-Date; \
    $duration = ($endTime - $startTime).TotalMinutes; \
    Write-Host ('‚úÖ === R INSTALLATION COMPLETE === (' + $duration.ToString('F1') + ' minutes)'); \
    Write-Host ('üìä R version: ' + (R --version | Select-Object -First 1)); \
    "

# === PHASE 10: R PACKAGE INSTALLATION ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    Write-Host 'üöÄ === STARTING R PACKAGE INSTALLATION ==='; \
    Write-Host '‚è∞ Estimated time: 3-5 minutes'; \
    $startTime = Get-Date; \
    " && \
    Rscript -e " \
    tryCatch({ \
      options(repos = c(CRAN = 'https://cran.rstudio.com')); \
      cat('üì¶ Starting R package installation...\n'); \
      cat(paste('üìç R library path:', Sys.getenv('R_LIBS_USER'), '\n')); \
      \
      lib_path <- Sys.getenv('R_LIBS_USER'); \
      dir.create(lib_path, showWarnings = FALSE, recursive = TRUE); \
      .libPaths(lib_path); \
      \
      cat('üì¶ [1/2] Installing remotes package...\n'); \
      install.packages('remotes'); \
      if (!require(remotes, quietly = TRUE)) { \
        stop('Failed to install or load remotes package'); \
      } \
      \
      if (file.exists('C:/temp/install_packages.R')) { \
        cat('üì¶ [2/2] Installing packages from tools/dependencies/install_packages.R...\n'); \
        source('C:/temp/install_packages.R'); \
      } else { \
        cat('‚ö†Ô∏è No install_packages.R found, installing basic packages\n'); \
        install.packages(c('rmarkdown', 'knitr', 'ggplot2')); \
      } \
      \
      # Verify critical packages \
      critical_packages <- c('rmarkdown', 'knitr'); \
      for (pkg in critical_packages) { \
        if (!require(pkg, character.only = TRUE, quietly = TRUE)) { \
          stop(paste('Critical R package failed to install:', pkg)); \
        } \
      } \
      \
      cat('‚úÖ R package installation complete\n'); \
      ip <- installed.packages()[, 'Package']; \
      cat(paste('üìä Total R packages installed:', length(ip), '\n')); \
    }, error = function(e) { \
      cat('‚ùå R package installation failed:', conditionMessage(e), '\n'); \
      quit(status = 1); \
    }) \
    " && \
    "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    $endTime = Get-Date; \
    $duration = ($endTime - $startTime).TotalMinutes; \
    Write-Host ('‚úÖ === R PACKAGE INSTALLATION COMPLETE === (' + $duration.ToString('F1') + ' minutes)'); \
    "

# === PHASE 11: R PACKAGE VERIFICATION ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command "Write-Host 'üîç Verifying R package installation...'" && \
    Rscript C:/temp/verify_r_packages.R

# === PHASE 12: CLEANUP ===
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command " \
    Write-Host 'üßπ === STARTING CLEANUP ==='; \
    Remove-Item C:/temp/requirements.txt -ErrorAction SilentlyContinue; \
    Remove-Item C:/temp/install_packages.R -ErrorAction SilentlyContinue; \
    Remove-Item C:/temp/verify_r_packages.R -ErrorAction SilentlyContinue; \
    Remove-Item C:/temp/tl_packages -ErrorAction SilentlyContinue; \
    Remove-Item C:/temp/requirements/ -Recurse -Force -ErrorAction SilentlyContinue; \
    Write-Host '‚úÖ === CLEANUP COMPLETE ==='; \
    "

# Set working directory
WORKDIR C:/workspace

# Final verification (using same tools that workflow uses)
RUN quarto --version && \
    python --version && \
    R --version && \
    lualatex --version

# Health check
RUN "C:\Program Files\PowerShell\7\pwsh.exe" -Command "Write-Host '‚úÖ Windows container build completed successfully'"