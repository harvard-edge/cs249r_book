name: 'ğŸ› Debug Ghostscript Download'

# Minimal workflow to debug ONLY Ghostscript download issues
# Strips away all other complexity to isolate the problem

on:
  workflow_dispatch:
    inputs:
      test_dockerfile:
        description: 'Dockerfile to test'
        required: false
        default: 'docker/build-quarto-windows/Dockerfile.minimal'
        type: string

env:
  DOCKERFILE_PATH: ${{ inputs.test_dockerfile || 'docker/build-quarto-windows/Dockerfile.minimal' }}

jobs:
  debug-ghostscript:
    name: ğŸ› Debug Ghostscript Only
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ› Build minimal container (Ghostscript focus)
        run: |
          echo "ğŸš€ Building minimal container to debug Ghostscript..."
          echo "ğŸ“Š Using Dockerfile: ${{ env.DOCKERFILE_PATH }}"
          echo "ğŸ“Š Build strategy: --no-cache (always fresh for debugging)"
          
          # Always use no-cache for debugging
          docker build --no-cache -f ${{ env.DOCKERFILE_PATH }} -t ghostscript-debug:latest .
          
          echo "âœ… Build completed - check logs above for Ghostscript download details"

      - name: ğŸ§ª Test container functionality
        run: |
          echo "ğŸ§ª Testing minimal container..."
          
          # Basic container test
          docker run --rm ghostscript-debug:latest pwsh -Command "Write-Host 'Container is running'"
          
          # Check if Ghostscript is available
          echo "ğŸ“Š Checking for Ghostscript in container..."
          docker run --rm ghostscript-debug:latest pwsh -Command "
            if (Test-Path 'C:/Program Files/gs') {
              Write-Host 'âœ… Ghostscript directory found';
              Get-ChildItem 'C:/Program Files/gs' | ForEach-Object { Write-Host ('ğŸ“ ' + $_.Name) };
            } else {
              Write-Host 'âŒ Ghostscript directory not found';
            }
          "
          
          echo "ğŸ¯ Debug session complete - check build logs for download details"

      - name: ğŸ“‹ Debug Summary
        run: |
          echo "ğŸ› GHOSTSCRIPT DEBUG SESSION COMPLETE"
          echo ""
          echo "ğŸ“Š What was tested:"
          echo "  âœ… PowerShell 7 installation" 
          echo "  âœ… Multiple Ghostscript download methods"
          echo "  âœ… URL accessibility testing"
          echo "  âœ… File size validation"
          echo "  âœ… Installation process"
          echo "  âœ… Basic functionality test"
          echo ""
          echo "ğŸ” Check build logs above for:"
          echo "  - Which URLs are accessible"
          echo "  - Which download method works"
          echo "  - Exact error messages"
          echo "  - File sizes and paths"
          echo ""
          echo "ğŸ’¡ Next steps based on results:"
          echo "  - If download works: Add back other components"
          echo "  - If download fails: Try different URLs or methods"
          echo "  - If install fails: Debug installation parameters"
