name: 'ðŸ”¥ TinyTorch Â· ðŸŒ Deploy Site Only'

# =============================================================================
# TinyTorch Website-Only Deploy (No Version Bump)
# =============================================================================
#
# Use this workflow for website content updates that don't warrant a version bump:
# - Typo fixes, documentation updates
# - Team page changes, community content
# - CSS/styling tweaks
# - Navigation updates
#
# This workflow:
# âœ… Builds and deploys to production (gh-pages)
# âœ… Syncs dev â†’ main first
# âŒ Does NOT bump version numbers
# âŒ Does NOT create tags or releases
# âŒ Does NOT update announcement bar
#
# For releases with version bumps, use "TinyTorch Â· ðŸš€ Publish (Live)" instead.
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'What are you deploying? [e.g., "Team page update"]'
        required: true
        default: 'Website content update'
      confirm:
        description: 'Type "DEPLOY" to confirm (safety check)'
        required: true
        default: ''

permissions:
  contents: write
  actions: read

concurrency:
  group: gh-pages-deploy
  cancel-in-progress: false

jobs:
  validate:
    name: 'ðŸ” Validate'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.inputs.confirm == 'DEPLOY'

    steps:
      - name: âœ… Inputs validated
        run: |
          echo "ðŸ“‹ Deploying: ${{ github.event.inputs.description }}"
          echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"

  preflight:
    name: 'âœˆï¸ Preflight Checks'
    needs: validate
    uses: ./.github/workflows/tinytorch-validate-dev.yml
    with:
      test_type: 'build'  # Just verify it builds, skip full tests for hotfixes

  sync-from-dev:
    name: 'ðŸ”„ Sync dev â†’ main'
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.result == 'success'

    steps:
      - name: ðŸ“¥ Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”„ Merge dev into main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "ðŸ“¥ Fetching dev branch..."
          git fetch origin dev

          echo "ðŸ”„ Merging dev into main..."
          git merge origin/dev --no-edit -m "ðŸŒ Website update: ${{ github.event.inputs.description }}"

          echo "ðŸš€ Pushing updated main..."
          git push origin main

  build-and-deploy:
    name: 'ðŸ”¥ Build & Deploy'
    runs-on: ubuntu-latest
    needs: [preflight, sync-from-dev]
    if: needs.sync-from-dev.result == 'success'

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tinytorch/site/requirements.txt'

      - name: ðŸ“¦ Install dependencies
        working-directory: tinytorch
        run: |
          pip install --upgrade pip
          pip install -r site/requirements.txt

      - name: ðŸ”¨ Build Jupyter Book
        working-directory: tinytorch/site
        run: |
          jupyter-book build . --all
          touch _build/html/.nojekyll

      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./tinytorch/site/_build/html
          destination_dir: tinytorch
          publish_branch: gh-pages
          keep_files: true
          commit_message: 'ðŸŒ TinyTorch website update - ${{ github.event.inputs.description }}'

  summary:
    name: 'ðŸ“‹ Deploy Summary'
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: always()

    steps:
      - name: ðŸ“‹ Summary
        run: |
          echo "## ðŸŒ TinyTorch Website Deploy Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Description:** ${{ github.event.inputs.description }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** Website-only (no version bump)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Access:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“– [TinyTorch Website](https://mlsysbook.ai/tinytorch/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸ’¡ For versioned releases, use the 'TinyTorch Â· ðŸš€ Publish (Live)' workflow instead.*" >> $GITHUB_STEP_SUMMARY

  fail-validation:
    name: 'âŒ Validation Failed'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.inputs.confirm != 'DEPLOY'

    steps:
      - name: âŒ Invalid confirmation
        run: |
          echo "## âŒ Deploy Cancelled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** You must type exactly 'DEPLOY' to confirm" >> $GITHUB_STEP_SUMMARY
          echo "**Received:** ${{ github.event.inputs.confirm }}" >> $GITHUB_STEP_SUMMARY
          exit 1
