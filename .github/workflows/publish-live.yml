name: 'ğŸ“š Publish Live'

# Manual trigger only - big red button!
on:
  workflow_dispatch:
    inputs:
      description:
        description: 'What are you publishing? (e.g., "Chapter 5 updates", "Bug fixes")'
        required: true
        default: ''
      confirm:
        description: 'Type "PUBLISH" to confirm you want to go live'
        required: true
        default: ''

permissions:
  contents: write
  actions: read

jobs:
  validate-and-publish:
    name: 'ğŸ” Validate & Publish'
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'PUBLISH'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Check if dev branch tests passed
        run: |
          echo "ğŸ”„ Checking latest dev branch build status..."
          
          # Get the latest dev branch commit
          DEV_SHA=$(git rev-parse origin/dev)
          echo "ğŸ“Š Latest dev commit: $DEV_SHA"
          
          # Check if there's a successful workflow run for this commit
          echo "ğŸ”„ Checking workflow runs for dev branch..."
          
          # Use GitHub API to check workflow status
          WORKFLOW_STATUS=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?branch=dev&status=completed&per_page=10" \
            | jq -r --arg sha "$DEV_SHA" '.workflow_runs[] | select(.head_sha == $sha and .name == "ğŸ“š CI/CD Controller") | .conclusion' \
            | head -1)
          
          echo "ğŸ“Š Workflow status for dev: $WORKFLOW_STATUS"
          
          if [ "$WORKFLOW_STATUS" != "success" ]; then
            echo "âŒ Dev branch tests have not passed! Latest status: $WORKFLOW_STATUS"
            echo "ğŸ›‘ Cannot publish until dev branch is green âœ…"
            echo "ğŸ“‹ Please ensure your dev branch builds are successful before publishing."
            exit 1
          fi
          
          echo "âœ… Dev branch tests passed! Safe to publish."

      - name: ğŸ”„ Merge dev to main
        run: |
          echo "ğŸ”„ Configuring git..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "ğŸ”„ Switching to main branch..."
          git checkout main
          git pull origin main
          
          echo "ğŸ”„ Merging dev into main..."
          git merge origin/dev --no-ff -m "ğŸš€ Publish Live: ${{ github.event.inputs.description }}

          Merged dev branch to main for publication.
          
          Published by: ${{ github.actor }}
          Commit: $(git rev-parse origin/dev)
          Description: ${{ github.event.inputs.description }}"
          
          echo "âœ… Merge completed successfully!"

      - name: ğŸš€ Push to main and trigger production deployment
        run: |
          echo "ğŸš€ Pushing to main branch..."
          git push origin main
          
          echo "ğŸ“Š Main branch updated! This will trigger:"
          echo "  âœ… Production build workflow"
          echo "  âœ… GitHub Pages deployment"
          echo "  âœ… Live site update"
          echo ""
          echo "ğŸŒ Your content will be live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

      - name: ğŸ“‹ Publication Summary
        run: |
          echo "## ğŸ“š Publication Complete! ğŸ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**What was published:** ${{ github.event.inputs.description }}" >> $GITHUB_STEP_SUMMARY
          echo "**Published by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Published at:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”„ What happened:" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Verified dev branch tests passed" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Merged dev â†’ main branch" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Pushed to main (triggers production build)" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… GitHub Pages will deploy automatically" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor the production build in Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "- Site will be live in ~5-10 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- Check https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY

  fail-validation:
    name: 'âŒ Validation Failed'
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'PUBLISH'
    
    steps:
      - name: âŒ Invalid confirmation
        run: |
          echo "âŒ Publication cancelled - invalid confirmation"
          echo "ğŸ”’ You must type exactly 'PUBLISH' to confirm"
          echo "ğŸ“ You entered: '${{ github.event.inputs.confirm }}'"
          exit 1 