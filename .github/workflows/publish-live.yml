name: '🚀 Publish Live'

# Manual trigger only - big red button!
on:
  workflow_dispatch:
    inputs:
      description:
        description: 'What are you publishing? (e.g., "Add Chapter 12: Advanced Optimization", "Update AI Ethics section", "Fix notation in Chapter 3")'
        required: true
        default: ''
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - 'patch'
          - 'minor' 
          - 'major'
        default: 'minor'
      dev_commit:
        description: 'Specific dev commit to publish (leave empty for latest) - Use for publishing stable content while continuing work'
        required: false
        default: ''
      confirm:
        description: 'Type "PUBLISH" to confirm you want to go live'
        required: true
        default: ''

permissions:
  contents: write
  actions: read

jobs:
  validate-and-publish:
    name: '🔍 Validate & Publish'
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'PUBLISH'
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🔍 Check if dev branch tests passed
        run: |
          echo "🔄 Checking dev branch build status..."
          
          # Determine which commit to use
          if [ -n "${{ github.event.inputs.dev_commit }}" ]; then
            DEV_SHA="${{ github.event.inputs.dev_commit }}"
            echo "📌 Using specified commit: $DEV_SHA"
            
            # Validate the commit exists
            if ! git cat-file -e "$DEV_SHA" 2>/dev/null; then
              echo "❌ Commit $DEV_SHA does not exist!"
              exit 1
            fi
            
            # Check if commit is in dev branch
            if ! git merge-base --is-ancestor "$DEV_SHA" origin/dev; then
              echo "❌ Commit $DEV_SHA is not in dev branch history!"
              exit 1
            fi
          else
            DEV_SHA=$(git rev-parse origin/dev)
            echo "📊 Using latest dev commit: $DEV_SHA"
          fi
          
          # Check if there's a successful workflow run for this commit
          echo "🔄 Checking workflow runs for dev branch..."
          
          # Use GitHub API to check workflow status
          WORKFLOW_STATUS=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?branch=dev&status=completed&per_page=10" \
            | jq -r --arg sha "$DEV_SHA" '.workflow_runs[] | select(.head_sha == $sha and .name == "📚 CI/CD Controller") | .conclusion' \
            | head -1)
          
          echo "📊 Workflow status for dev: $WORKFLOW_STATUS"
          
          if [ "$WORKFLOW_STATUS" != "success" ]; then
            echo "❌ Dev branch tests have not passed! Latest status: $WORKFLOW_STATUS"
            echo "🛑 Cannot publish until dev branch is green ✅"
            echo "📋 Please ensure your dev branch builds are successful before publishing."
            exit 1
          fi
          
          echo "✅ Dev branch tests passed! Safe to publish."

      - name: 🏷️ Calculate Next Version
        id: version
        run: |
          echo "🔄 Getting latest release version..."
          
          # Get latest release version, default to v0.0.0 if no releases exist
          LATEST_VERSION=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" \
            | jq -r '.tag_name // "v0.0.0"')
            
          echo "📊 Latest version: $LATEST_VERSION"
          
          # Remove 'v' prefix for calculation
          VERSION_NUM=${LATEST_VERSION#v}
          
          # Split version into components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NUM"
          
          # Handle empty or invalid versions
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          
          echo "📊 Current version components: $MAJOR.$MINOR.$PATCH"
          
          # Calculate new version based on release type
          case "${{ github.event.inputs.release_type }}" in
            "major")
              NEW_MAJOR=$((MAJOR + 1))
              NEW_MINOR=0
              NEW_PATCH=0
              ;;
            "minor")
              NEW_MAJOR=$MAJOR
              NEW_MINOR=$((MINOR + 1))
              NEW_PATCH=0
              ;;
            "patch")
              NEW_MAJOR=$MAJOR
              NEW_MINOR=$MINOR
              NEW_PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="v$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH"
          echo "🎯 New version: $NEW_VERSION (${{ github.event.inputs.release_type }} release)"
          
          # Export for other steps
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "release_type=${{ github.event.inputs.release_type }}" >> $GITHUB_OUTPUT

      - name: 🔄 Merge dev to main
        run: |
          echo "🔄 Configuring git..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "🔄 Switching to main branch..."
          git checkout main
          git pull origin main
          
          echo "🔄 Merging dev into main..."
          
          # Determine which commit to merge
          if [ -n "${{ github.event.inputs.dev_commit }}" ]; then
            MERGE_COMMIT="${{ github.event.inputs.dev_commit }}"
            echo "📌 Merging specific commit: $MERGE_COMMIT"
          else
            MERGE_COMMIT="origin/dev"
            echo "📊 Merging latest dev: $MERGE_COMMIT"
          fi
          
          git merge "$MERGE_COMMIT" --no-ff -m "🚀 Release ${{ steps.version.outputs.new_version }}: ${{ github.event.inputs.description }}

          Merged dev branch to main for publication.
          
          Release Type: ${{ github.event.inputs.release_type }}
          Published by: ${{ github.actor }}
          Dev Commit: ${MERGE_COMMIT}
          Specific Commit: ${{ github.event.inputs.dev_commit || 'latest' }}
          Description: ${{ github.event.inputs.description }}"
          
          echo "✅ Merge completed successfully!"

      - name: 🏷️ Create Release Tag
        run: |
          echo "🏷️ Creating release tag ${{ steps.version.outputs.new_version }}..."
          git tag -a ${{ steps.version.outputs.new_version }} -m "Release ${{ steps.version.outputs.new_version }}: ${{ github.event.inputs.description }}"
          echo "✅ Tag created successfully!"

      - name: 🚀 Push to main and trigger production deployment
        run: |
                      echo "🚀 Pushing to main branch with tags..."
          git push origin main --tags
          
          echo "📊 Main branch updated! This will trigger:"
          echo "  ✅ Production build workflow (HTML + PDF generation)"
          echo "  ✅ GitHub Pages deployment with textbook content"
          echo "  ✅ Live academic website update"
          echo ""
          echo "🌐 Your textbook will be live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo "📚 Students can access the updated content immediately"

      - name: ⏳ Wait for Production Build
        run: |
          echo "⏳ Waiting for production build to complete before creating release..."
          sleep 30  # Give the build a moment to start
          
          # Wait for the build to complete
          for i in {1..20}; do
            BUILD_STATUS=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs?branch=main&status=completed&per_page=5" \
              | jq -r '.workflow_runs[] | select(.name == "📚 CI/CD Controller") | .conclusion' \
              | head -1)
            
            if [ "$BUILD_STATUS" = "success" ]; then
              echo "✅ Production build completed successfully!"
              break
            elif [ "$BUILD_STATUS" = "failure" ]; then
              echo "❌ Production build failed!"
              exit 1
            else
              echo "⏳ Build still in progress... (attempt $i/20)"
              sleep 30
            fi
          done

      - name: 📦 Create GitHub Release
        run: |
          echo "📦 Creating GitHub Release ${{ steps.version.outputs.new_version }}..."
          
          # Generate release notes
          cat > release_notes.md << EOF
          ## 📚 Release ${{ steps.version.outputs.new_version }}
          
          **${{ github.event.inputs.description }}**
          
          ### 📋 Release Information
          - **Type**: ${{ steps.version.outputs.release_type }} release
          - **Published by**: ${{ github.actor }}
          - **Published at**: $(date)
          
          ### 📖 What's Included
          - Updated interactive web version at [mlsysbook.ai](https://mlsysbook.ai)
          - Complete PDF textbook available for download
          - All chapters, exercises, and lab materials as of commit $(git rev-parse HEAD)
          - Compatible with MIT Press publication standards
          
          ### 🔗 Quick Links
          - 🌐 [Read Online](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})
                     - 📄 [Download PDF](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.new_version }}/Machine-Learning-Systems.pdf)
           - 📄 [Direct PDF Link](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/assets/Machine-Learning-Systems.pdf)
          EOF
          
          # Create the release
          RELEASE_RESPONSE=$(curl -s \
            -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases" \
            -d "{
              \"tag_name\": \"${{ steps.version.outputs.new_version }}\",
              \"name\": \"${{ steps.version.outputs.new_version }}: ${{ github.event.inputs.description }}\",
              \"body\": \"$(cat release_notes.md | sed 's/"/\\"/g' | tr '\n' '\\n')\",
              \"draft\": false,
              \"prerelease\": false
            }")
          
          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r '.id')
          echo "✅ Release created with ID: $RELEASE_ID"
          echo "release_id=$RELEASE_ID" >> $GITHUB_ENV

      - name: 📋 Publication Summary
        run: |
          echo "## 📚 Textbook Publication Complete! 🎉" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version Released:** ${{ steps.version.outputs.new_version }} (${{ steps.version.outputs.release_type }})" >> $GITHUB_STEP_SUMMARY
          echo "**Content Published:** ${{ github.event.inputs.description }}" >> $GITHUB_STEP_SUMMARY
          echo "**Published by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Source Commit:** ${{ github.event.inputs.dev_commit || 'latest' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Publication Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔄 What happened:" >> $GITHUB_STEP_SUMMARY
          echo "1. ✅ Verified dev branch tests passed" >> $GITHUB_STEP_SUMMARY
          echo "2. ✅ Calculated new version number" >> $GITHUB_STEP_SUMMARY
          echo "3. ✅ Merged dev → main branch" >> $GITHUB_STEP_SUMMARY
          echo "4. ✅ Created release tag ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "5. ✅ Pushed to main (triggered production build)" >> $GITHUB_STEP_SUMMARY
          echo "6. ✅ Created GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🌐 Access Your Published Textbook:" >> $GITHUB_STEP_SUMMARY
          echo "- 📖 [Interactive Web Textbook](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})" >> $GITHUB_STEP_SUMMARY
          echo "- 📦 [Version Release Notes](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.new_version }})" >> $GITHUB_STEP_SUMMARY
          echo "- 📄 [Download Complete PDF](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.new_version }}/Machine-Learning-Systems.pdf)" >> $GITHUB_STEP_SUMMARY
          echo "- 📄 [Direct PDF Access](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/assets/Machine-Learning-Systems.pdf)" >> $GITHUB_STEP_SUMMARY
          echo "- 🎓 [Share with Students](https://mlsysbook.ai)" >> $GITHUB_STEP_SUMMARY

  fail-validation:
    name: '❌ Validation Failed'
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'PUBLISH'
    
    steps:
      - name: ❌ Invalid confirmation
        run: |
          echo "❌ Publication cancelled - invalid confirmation"
          echo "🔒 You must type exactly 'PUBLISH' to confirm"
          echo "📝 You entered: '${{ github.event.inputs.confirm }}'"
          exit 1 