# quarto-build.yml
# This is a unified build workflow for both development and production builds of the CS249r book.
# It handles both development (cross-platform testing + staging site deployment) and 
# production (Linux-only build + GitHub Pages deployment) scenarios.

name: 'ðŸ“š Quarto Build'

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Build environment (development/production)'
      os:
        required: true
        type: string
        description: 'Operating system to run on (ubuntu-latest/windows-latest)'
      quarto-version:
        required: false
        type: string
        default: '1.7.13'
        description: 'Version of Quarto to use'
      r-version:
        required: false
        type: string
        default: '4.3.2'
        description: 'Version of R to use'
      target:
        required: true
        type: string
        enum: ['dev', 'main']
        description: 'Target branch (dev/main) - determines build behavior'

permissions:
  contents: write  # Required for pushing to repositories
  pages: write    # Required for GitHub Pages deployment

jobs:
  build:
    runs-on: ${{ inputs.os }}
    environment:
      name: ${{ inputs.environment }}
    
    steps:
      - name: ðŸ” Verify branch
        run: |
          if [[ "${{ inputs.target }}" == "main" && "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "âŒ Main build can only run on the main branch"
            exit 1
          fi
          if [[ "${{ inputs.target }}" == "dev" && "${{ github.ref }}" != "refs/heads/dev" ]]; then
            echo "âŒ Dev build can only run on the dev branch"
            exit 1
          fi
          echo "âœ… Branch verification passed"

      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.target }}
          fetch-depth: 0

      - name: ðŸ“¦ Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: ${{ inputs.quarto-version }}

      - name: Check Quarto syntax
        run: |
          quarto check

      - name: ðŸ“ Install TinyTeX
        shell: bash
        run: |
          echo "ðŸ”„ Installing TinyTeX..."
          quarto install tinytex
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "$HOME/.TinyTeX/bin/windows" >> $GITHUB_PATH
          else
            echo "$HOME/.TinyTeX/bin/x86_64-linux" >> $GITHUB_PATH
          fi
          echo "âœ… TinyTeX installed"

      - name: ðŸ“Š Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ inputs.r-version }}
          use-public-rspm: true

      - name: ðŸ’¾ Cache R packages
        uses: actions/cache@v3
        with:
          path: ${{ runner.os == 'Windows' && 'C:/Users/runneradmin/Documents/R/win-library' || '~/R/library' }}
          key: ${{ runner.os }}-r-${{ hashFiles('**/install_packages.R') }}
          restore-keys: |
            ${{ runner.os }}-r-

      - name: ðŸ“¦ Install R Dependencies
        shell: bash
        run: |
          echo "ðŸ”„ Installing R packages..."
          Rscript -e 'install.packages(c("renv", "remotes"))'
          Rscript -e 'renv::restore()'
          echo "âœ… R packages installed"

      - name: ðŸ› ï¸ Install Linux Dependencies
        if: ${{ runner.os == 'Linux' }}
        run: |
          echo "ðŸ”„ Installing Linux dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            libpangoft2-1.0-0 \
            fonts-dejavu \
            fonts-freefont-ttf \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libcogl-pango-dev \
            pango1.0-tools \
            libcairo2 \
            gdk-pixbuf2.0-bin \
            libgdk-pixbuf2.0-dev \
            librsvg2-bin \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libtiff5-dev \
            libjpeg-dev
          echo "âœ… Linux dependencies installed"

      - name: ðŸŽ¨ Install Inkscape (Linux)
        if: ${{ runner.os == 'Linux' }}
        run: |
          echo "ðŸ”„ Installing Inkscape..."
          sudo add-apt-repository ppa:inkscape.dev/stable -y
          sudo apt-get update
          sudo apt-get install inkscape -y
          echo "âœ… Inkscape installed"

      - name: ðŸŽ¨ Install Inkscape (Windows)
        if: ${{ runner.os == 'Windows' }}
        run: |
          echo "ðŸ”„ Installing Inkscape..."
          choco install inkscape -y
          echo "âœ… Inkscape installed"

      - name: ðŸ”¨ Render Quarto Project
        uses: quarto-dev/quarto-actions/render@v2

      - name: ðŸ“¤ Upload artifact
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: _book-${{ inputs.os }}
          path: _book

      - name: ðŸ Setup Python for PDF compression
        if: ${{ inputs.target == 'main' && runner.os == 'Linux' }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: ðŸ“¦ Install Ghostscript
        if: ${{ inputs.target == 'main' && runner.os == 'Linux' }}
        run: |
          echo "ðŸ”„ Installing Ghostscript..."
          sudo apt-get update
          sudo apt-get install -y ghostscript
          echo "âœ… Ghostscript installed"

      - name: ðŸ“„ Check and Compress PDF
        if: ${{ inputs.target == 'main' && runner.os == 'Linux' }}
        run: |
          set -e  # Exit on any error
          
          echo "ðŸ” Checking for PDF..."
          if [ ! -f "./_book/Machine-Learning-Systems.pdf" ]; then
            echo "âŒ PDF file not found!"
            exit 1
          fi
          
          echo "ðŸ”„ Compressing PDF..."
          python3 ./scripts/quarto_publish/gs_compress_pdf.py \
            -i ./_book/Machine-Learning-Systems.pdf \
            -o ./_book/ebook.pdf \
            -s "/ebook"
          
          if [ ! -f "./_book/ebook.pdf" ]; then
            echo "âŒ PDF compression failed!"
            exit 1
          fi
          
          mv ./_book/ebook.pdf ./_book/Machine-Learning-Systems.pdf
          echo "âœ… PDF compression complete"

      - name: ðŸš€ Stage to Dev Site
        if: ${{ inputs.target == 'dev' && runner.os == 'Linux' }}
        uses: cpina/github-action-push-to-another-repository@v1.7.2
        env:
          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
        with:
          source-directory: '_book'
          destination-github-username: 'harvard-edge'
          destination-repository-name: 'cs249r_book_dev'
          user-email: khoshnevis.naeem@gmail.com
          target-branch: 'main'
          target-directory: 'docs'
          commit-message: |
            ðŸ“š Push dev branch build

      - name: ðŸš€ Deploy to GitHub Pages
        if: ${{ inputs.target == 'main' && runner.os == 'Linux' }}
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: gh-pages
          render: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Build Summary
        run: |
          echo "## ðŸ“Š Build Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ Target: ${{ inputs.target }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’» OS: ${{ inputs.os }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ Environment: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š Quarto Version: ${{ inputs.quarto-version }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”¬ R Version: ${{ inputs.r-version }}" >> $GITHUB_STEP_SUMMARY
          echo "â° Completed at: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY