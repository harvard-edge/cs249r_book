name: 'ğŸ“š Quarto Build'

# This workflow builds a Quarto project and deploys it to either a development site or GitHub Pages
# It handles both Windows and Linux environments with extensive caching for better performance
on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Build environment (development/production)'
      os:
        required: true
        type: string
        description: 'Operating system to run on (ubuntu-latest/windows-latest)'
      quarto-version:
        required: false
        type: string
        default: '1.7.15'
        description: 'Version of Quarto to use'
      r-version:
        required: false
        type: string
        default: '4.3.2'
        description: 'Version of R to use'
      target:
        required: true
        type: string
        description: 'Target branch (dev/main) - determines build behavior'
    secrets:
      SSH_DEPLOY_KEY:
        required: true
        
permissions:
  contents: write
  pages: write

jobs:
  build:
    runs-on: ${{ inputs.os }}
    environment:
      name: ${{ inputs.environment }}
    env:
      G_MESSAGES_DEBUG: ""
      G_DEBUG: fatal-warnings
      R_LIBS_USER: ${{ github.workspace }}/.r-lib
          
    steps:
      - name: ğŸ” Validate inputs
        shell: pwsh
        run: |
          Write-Output "ğŸ”„ Validating workflow inputs..."
          Write-Output "ğŸ‘‰ Target: ${{ inputs.target }}"
          Write-Output "ğŸ‘‰ OS: ${{ inputs.os }}"
          Write-Output "ğŸ‘‰ Environment: ${{ inputs.environment }}"
          
          if (("${{ inputs.target }}" -ne "dev") -and ("${{ inputs.target }}" -ne "main")) {
            Write-Error "âŒ Target must be either 'dev' or 'main'"
            exit 1
          }
          Write-Output "âœ… Input validation passed"

      - name: ğŸ” Verify branch
        shell: pwsh
        run: |
          Write-Output "ğŸ”„ Verifying branch alignment..."
          Write-Output "ğŸ‘‰ Current branch: ${{ github.ref }}"
          Write-Output "ğŸ‘‰ Target branch: ${{ inputs.target }}"
          
          if (("${{ inputs.target }}" -eq "main") -and ("${{ github.ref }}" -ne "refs/heads/main")) {
            Write-Error "âŒ Main build can only run on the main branch"
            exit 1
          }
          if (("${{ inputs.target }}" -eq "dev") -and ("${{ github.ref }}" -ne "refs/heads/dev")) {
            Write-Error "âŒ Dev build can only run on the dev branch"
            exit 1
          }
          Write-Output "âœ… Branch verification passed"

      - name: Install Inkscape
        run: |
          sudo apt-get update
          sudo apt-get install -y inkscape
          inkscape --version
      
      - name: Install font dependencies
        run: |
          sudo apt-get install -y \
            fonts-freefont-ttf \
            fonts-liberation \
            fontconfig
          sudo fc-cache -f -v
      
      - name: Create test SVG
        run: |
          echo '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="40" fill="red"/></svg>' > test.svg
          cat test.svg
      
      - name: Test SVG to PNG conversion
        run: |
          inkscape test.svg --export-type=png --export-filename=test.png
          ls -la test.png
          file test.png
      
      - name: Test SVG to PDF conversion
        continue-on-error: true
        run: |
          echo "Attempting SVG to PDF conversion..."
          inkscape test.svg --export-type=pdf --export-filename=test.pdf
          if [ -f test.pdf ]; then
            echo "âœ… SVG to PDF conversion succeeded"
            ls -la test.pdf
            file test.pdf
          else
            echo "âŒ SVG to PDF conversion failed"
          fi
      
      - name: Test rsvg-convert as alternative
        run: |
          echo "Installing rsvg-convert..."
          sudo apt-get install -y librsvg2-bin
          
          echo "Converting SVG to PDF with rsvg-convert..."
          rsvg-convert -f pdf -o rsvg-test.pdf test.svg
          
          if [ -f rsvg-test.pdf ]; then
            echo "âœ… rsvg-convert SVG to PDF conversion succeeded"
            ls -la rsvg-test.pdf
            file rsvg-test.pdf
          else
            echo "âŒ rsvg-convert SVG to PDF conversion failed"
          fi
          
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target }}
          fetch-depth: 0

      - name: ğŸ“¦ Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: ${{ inputs.quarto-version }}
        # Outputs quarto version information after installation
        id: quarto-setup

      - name: ğŸ“‹ Quarto Setup Info
        shell: bash
        run: |
          echo "ğŸ”„ Checking Quarto installation..."
          quarto check
          echo "ğŸ“Š Quarto version info:"
          quarto --version
          echo "ğŸ“ Quarto installation location:"
          which quarto || where.exe quarto

      # Cache Linux system packages without hardcoded paths
      - name: ğŸ’¾ Cache APT packages
        if: runner.os == 'Linux'
        uses: actions/cache@v4
        id: cache-apt
        with:
          path: ~/.apt-cache
          key: apt-${{ runner.os }}-${{ hashFiles('.github/workflows/*.yml') }}
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ğŸ› ï¸ Install Linux Dependencies
        if: runner.os == 'Linux' && steps.cache-apt.outputs.cache-hit != 'true'
        shell: bash
        run: |
          echo "ğŸ”„ Installing Linux dependencies..."
          echo "ğŸ“¦ Creating APT cache directory"
          mkdir -p ~/.apt-cache

          echo "ğŸ“¦ Updating package lists"
          sudo apt-get update

          echo "ğŸ“¦ Installing required system libraries"
          sudo apt-get -o dir::cache::archives="$HOME/.apt-cache" install -y \
            fonts-dejavu \
            fonts-freefont-ttf \
            gdk-pixbuf2.0-bin \
            libgtk-3-0 \
            libcairo2 \
            libfontconfig1 \
            libfreetype6 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libpangoft2-1.0-0 \
            libxml2-dev \
            libcurl4-openssl-dev \
            libjpeg-dev \
            libtiff5-dev

          echo "âœ… Linux dependencies installed"
          
      - name: ğŸ¨ Install Inkscape (Linux)
        if: runner.os == 'Linux'
        run: |
          # First remove any existing Inkscape
          sudo apt-get remove -y inkscape || true
          
          # Install Inkscape from PPA for more reliable version
          echo "ğŸ“¦ Installing Inkscape from PPA..."
          sudo add-apt-repository ppa:inkscape.dev/stable -y
          sudo apt-get update
          sudo apt-get install -y inkscape
          
          # Update font cache after installing Inkscape
          echo "ğŸ§¹ Updating font cache..."
          sudo fc-cache -fv
          
          # Verify Inkscape installation
          echo "ğŸ“Š Inkscape version:"
          inkscape --version
          
          # Test SVG to PDF conversion with the new Inkscape
          echo "ğŸ§ª Testing Inkscape SVG to PDF conversion..."
          echo '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="40" fill="red"/></svg>' > test.svg
          
          inkscape --export-type=pdf --export-filename=test.pdf test.svg

          # Verify if the PDF was created
          if [ -f test.pdf ]; then
            echo "âœ… Inkscape SVG to PDF conversion successful!"
            ls -lh test.pdf
          else
            echo "âŒ Inkscape SVG to PDF conversion failed."
            echo "ğŸ” Checking Inkscape installation..."
            dpkg -l | grep inkscape
            which inkscape
            ldd $(which inkscape) | grep "not found" || echo "All dependencies resolved"
          fi

      - name: ğŸ¨ Install Inkscape (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install inkscape -y
          echo "C:\Program Files\Inkscape\bin" | Out-File -Append -Encoding ascii $env:GITHUB_PATH
          
          # Verify Inkscape installation
          inkscape --version

      - name: ğŸ“¦ Install & Update TeX Live 
        uses: teatimeguest/setup-texlive-action@v3
        with:
          version: latest
          packages: |
            scheme-basic      
            collection-latex  
            collection-latexrecommended   
            collection-fontsrecommended   
            collection-latexextra
            collection-pictures   
            collection-luatex     
            koma-script       
            standalone       
            tikz-cd         
            marginfix      
            newpx          
            luatex85
            listings       
          update-all-packages: true
          cache: true
          
      - name: ğŸ“Š Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ inputs.r-version }}
          use-public-rspm: true

      # - name: ğŸ“‹ R Setup Info
      #   shell: Rscript {0}
      #   run: |
      #     cat("ğŸ”„ R Version Information:\n")
      #     cat(paste("R version:", R.version$version.string, "\n"))
      #     cat(paste("R home:", R.home(), "\n"))
      #     cat(paste("R library paths:", paste(.libPaths(), collapse=", "), "\n"))

      # # Cache R packages using standard paths
      # - name: ğŸ’¾ Cache R packages
      #   uses: actions/cache@v4
      #   id: cache-r-packages
      #   with:
      #     path: |
      #       ${{ env.R_LIBS_USER }}
      #     key: r-pkgs-${{ runner.os }}-${{ inputs.r-version }}-${{ hashFiles('**/install_packages.R') }}
      #     restore-keys: |
      #       r-pkgs-${{ runner.os }}-${{ inputs.r-version }}-
      #     save-always: true

      # - name: ğŸ“¦ Install R packages
      #   if: steps.cache-r-packages.outputs.cache-hit != 'true'
      #   shell: Rscript {0}
      #   run: |
      #     # Set options for better package installation
      #     options(repos = c(CRAN = "https://cran.rstudio.com"))
          
      #     cat("ğŸ”„ Installing R packages...\n")
      #     cat(paste("R library path:", Sys.getenv("R_LIBS_USER"), "\n"))
          
      #     # Create and set library path
      #     lib_path <- Sys.getenv("R_LIBS_USER")
      #     dir.create(lib_path, showWarnings = FALSE, recursive = TRUE)
      #     .libPaths(lib_path)
          
      #     # Install packages
      #     cat("ğŸ“¦ Installing remotes package...\n")
      #     install.packages("remotes")
          
      #     if (file.exists("install_packages.R")) {
      #       cat("ğŸ“¦ Installing packages from install_packages.R...\n")
      #       source("install_packages.R")
      #     } else {
      #       cat("âš ï¸ No install_packages.R found, installing common packages\n")
      #       pkgs <- c("rmarkdown", "knitr", "tidyverse", "ggplot2", "bookdown")
      #       cat(paste("ğŸ“¦ Installing packages:", paste(pkgs, collapse=", "), "\n"))
      #       install.packages(pkgs)
      #     }
          
      #     cat("âœ… R package installation complete\n")
      #     cat("ğŸ“Š Installed packages:\n")
      #     ip <- installed.packages()[, c("Package", "Version")]
      #     print(head(ip, 10))
      #     cat(paste("Total packages installed:", nrow(ip), "\n"))

      - name: ğŸ”¨ Render Quarto Project
        uses: quarto-dev/quarto-actions/render@v2
        continue-on-error: false # Explicitly fail if rendering fails

      - name: ğŸ“‹ Check Quarto Build Output
        shell: bash
        run: |
          echo "ğŸ”„ Checking Quarto build output..."
          
          if [ -d "_book" ]; then
            echo "âœ… _book directory exists"
            echo "ğŸ“Š Files in _book directory:"
            ls -la _book | head -n 20
            echo "ğŸ“Š Total files in _book:"
            find _book -type f | wc -l
            
            if [ -f "_book/Machine-Learning-Systems.pdf" ]; then
              echo "âœ… PDF file exists"
              echo "ğŸ“Š PDF file size:"
              du -h "_book/Machine-Learning-Systems.pdf"
            else
              echo "âš ï¸ PDF file not found!"
            fi
          else
            echo "âŒ _book directory not found!"
          fi

      - name: ğŸ“‰ Compress PDF (Linux)
        if: runner.os == 'Linux'
        uses: jy95/ghostscript-action@v1
        with:
          file: './_book/Machine-Learning-Systems.pdf'
          output: './_book/ebook.pdf'
          arbitrary-parameters: '-dCompatibilityLevel=1.4 -dPDFSETTINGS=/ebook'

      - name: âœ… Replace original with compressed (Linux)
        if: runner.os == 'Linux'
        run: mv ./_book/ebook.pdf ./_book/Machine-Learning-Systems.pdf

      - name: ğŸ§° Install Ghostscript (Windows)
        if: runner.os == 'Windows'
        run: choco install ghostscript

      - name: â• Add Ghostscript to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $gsPath = Get-ChildItem "C:\Program Files\gs" | Sort-Object Name -Descending | Select-Object -First 1
          $binPath = Join-Path $gsPath.FullName "bin"
          echo "Adding Ghostscript path: $binPath"
          $env:Path = "$binPath;$env:Path"

          # Confirm it works
          & gswin64c -version
          
      - name: ğŸ“‰ Compress PDF (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $input = "./_book/Machine-Learning-Systems.pdf"
          $output = "./_book/ebook.pdf"

          if (!(Test-Path $input)) {
            Write-Error "âŒ Input PDF not found!"
            exit 1
          }

          Write-Output "ğŸ“‰ Compressing PDF using Ghostscript..."
          & gswin64c `
            -sDEVICE=pdfwrite `
            -dCompatibilityLevel=1.4 `
            -dPDFSETTINGS=/ebook `
            -dNOPAUSE `
            -dQUIET `
            -dBATCH `
            -sOutputFile=$output `
            $input

          if (Test-Path $output) {
            Write-Output "âœ… Compression successful"
            Move-Item -Force $output $input
          } else {
            Write-Error "âŒ Compression failed"
            exit 1
          }

      - name: ğŸ“¤ Upload artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: _book-${{ inputs.os }}
          path: _book

      # Push to dev site
      - name: ğŸš€ Stage to Dev Site
        if: inputs.target == 'dev' && runner.os == 'Linux'
        uses: cpina/github-action-push-to-another-repository@v1.7.2
        env:
          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
        with:
          source-directory: '_book'
          destination-github-username: 'harvard-edge'
          destination-repository-name: 'cs249r_book_dev'
          user-email: khoshnevis.naeem@gmail.com
          target-branch: 'main'
          target-directory: 'docs'
          commit-message: |
            ğŸ“š Push dev branch build

      - name: ğŸ“‹ Dev Deployment Info
        if: inputs.target == 'dev' && runner.os == 'Linux'
        shell: bash
        run: |
          echo "ğŸ”„ Development deployment information:"
          echo "ğŸ“Š Deployed to repository: harvard-edge/cs249r_book_dev"
          echo "ğŸ“Š Target branch: main"
          echo "ğŸ“Š Target directory: docs"
          echo "ğŸ“Š Source directory: _book"
          echo "âœ… Deployment should be complete"

      # Deploy to GitHub Pages
      - name: ğŸš€ Deploy to GitHub Pages
        if: inputs.target == 'main' && runner.os == 'Linux'
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: gh-pages
          render: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ GitHub Pages Deployment Info
        if: inputs.target == 'main' && runner.os == 'Linux'
        shell: bash
        run: |
          echo "ğŸ”„ GitHub Pages deployment information:"
          echo "ğŸ“Š Deployed to: gh-pages branch"
          echo "ğŸ“Š Source directory: _book"
          echo "âœ… Deployment should be complete"
          echo "ğŸŒ Site should be available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

      # Add comprehensive debug artifacts
      - name: ğŸ“¦ Collect Debug Artifacts
        if: always()  # Run even if previous steps failed
        uses: actions/upload-artifact@v4
        with:
          name: debug-${{ inputs.target }}-${{ inputs.os }}
          path: |
            ${{ github.workspace }}/_book/**
            ${{ github.workspace }}/.quarto/**
            ${{ github.workspace }}/**/_cache/**
            ${{ github.workspace }}/**/logs/**
            ${{ github.workspace }}/**/*.log
            ${{ github.workspace }}/**/.jupyter_cache/**
            ${{ github.workspace }}/.Rcheck/**
            ${{ github.workspace }}/**/*.Rout
            ${{ github.workspace }}/**/*.aux
            ${{ github.workspace }}/**/*.blg
            ${{ github.workspace }}/**/*.fls
            ${{ github.workspace }}/**/*.fdb_latexmk
          compression-level: 9  # Maximum compression
          retention-days: 5  # Keep for 5 days

      - name: ğŸ“‹ Debug Artifact Info
        if: always()
        shell: bash
        run: |
          echo "ğŸ”„ Debug artifacts information:"
          echo "ğŸ“Š Collected logs and build artifacts"
          echo "ğŸ“Š Retention period: 5 days"
          echo "ğŸ“Š Target artifact name: debug-${{ inputs.target }}-${{ inputs.os }}"
          echo "âœ… Debug artifacts should be available in GitHub Actions"

      - name: ğŸ“‹ Build Summary
        shell: pwsh
        run: |
          @"
          ## ğŸ“Š Build Status Summary
          ğŸ¯ Target: ${{ inputs.target }}
          ğŸ’» OS: ${{ inputs.os }}
          ğŸ”§ Environment: ${{ inputs.environment }}
          ğŸ“š Quarto Version: ${{ inputs.quarto-version }}
          ğŸ”¬ R Version: ${{ inputs.r-version }}
          ğŸ§© Cache Status:
            - TeX Live: Installed via teatimeguest/setup-texlive-action@v3
            - R Packages: ${{ steps.cache-r-packages.outputs.cache-hit == 'true' && 'âœ… Hit' || 'âŒ Miss' }}
          â° Completed at: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          "@ | Add-Content $env:GITHUB_STEP_SUMMARY