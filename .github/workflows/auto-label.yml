# =============================================================================
# AUTO-LABEL WORKFLOW (LLM-Powered)
# =============================================================================
# Automatically labels issues and PRs using Ollama LLM analysis.
#
# When an issue or PR is created:
#   1. Analyzes the title and body with a small LLM
#   2. Selects appropriate labels from our predefined set
#   3. Applies the labels automatically
#
# This enables the all-contributors workflow to auto-detect projects correctly.
# =============================================================================

name: 'üè∑Ô∏è Auto Label'

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]

env:
  # ==========================================================================
  # AVAILABLE LABELS - Update these if you add/change labels in GitHub
  # ==========================================================================

  # Area labels (pick ONE that best matches)
  AREA_LABELS: |
    area: book - Textbook content (Vol I & II), chapters, Quarto files
    area: tinytorch - TinyTorch framework, tito CLI, modules, tensors, autograd
    area: kits - TinyTorch Kits/ML Kits, hardware, Arduino, sensors
    area: collabs - Colab notebooks and collaborations
    area: tools - Build tools, scripts, CI/CD, GitHub Actions
    area: website - Website presentation and styling
    area: socratiq - SocratiQ AI chatbot

  # Type labels (pick ONE that best matches)
  TYPE_LABELS: |
    type: bug - Bug in rendering or code
    type: errata - Error in textual content
    type: improvement - Improve existing content
    type: new - New course content
    type: question - Further info is requested
    type: code - Programming exercise content
    type: citation - Citation or reference to include

  # Special labels (optional, add if applicable)
  SPECIAL_LABELS: |
    good first issue - Good starter issue for newbies

jobs:
  auto-label:
    name: Auto Label with LLM
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Analyze with LLM
        uses: ai-action/ollama-action@v2
        id: llm
        with:
          model: llama3.2:1b
          prompt: |
            You are a GitHub issue labeler. Analyze this issue/PR and select the most appropriate labels.

            TITLE: ${{ github.event.issue.title || github.event.pull_request.title }}

            BODY: ${{ github.event.issue.body || github.event.pull_request.body }}

            AVAILABLE AREA LABELS (pick exactly ONE):
            ${{ env.AREA_LABELS }}

            AVAILABLE TYPE LABELS (pick exactly ONE):
            ${{ env.TYPE_LABELS }}

            SPECIAL LABELS (add only if clearly applicable):
            ${{ env.SPECIAL_LABELS }}

            Instructions:
            - Pick ONE area label based on which project/component this relates to
            - Pick ONE type label based on what kind of issue this is
            - Only add "good first issue" if it's clearly a simple, well-defined task
            - If unsure about area, default to "area: book"
            - If unsure about type, default to "type: improvement"

            Return ONLY a JSON object with this exact format (no other text):
            {"area": "area: book", "type": "type: bug", "special": []}

            The "special" array should be empty [] or contain "good first issue" if applicable.

      - name: Parse and apply labels
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.llm.outputs.response }}`;
            console.log('LLM response:', response);

            // Valid labels from our GitHub repo
            const validAreaLabels = [
              'area: book',
              'area: tinytorch',
              'area: kits',
              'area: collabs',
              'area: tools',
              'area: website',
              'area: socratiq'
            ];

            const validTypeLabels = [
              'type: bug',
              'type: errata',
              'type: improvement',
              'type: new',
              'type: question',
              'type: code',
              'type: citation'
            ];

            const validSpecialLabels = [
              'good first issue'
            ];

            // Parse LLM response
            let result = { area: 'area: book', type: 'type: improvement', special: [] };

            try {
              const jsonMatch = response.match(/\{[^}]+\}/);
              if (jsonMatch) {
                const parsed = JSON.parse(jsonMatch[0]);
                if (parsed.area) result.area = parsed.area;
                if (parsed.type) result.type = parsed.type;
                if (parsed.special) result.special = parsed.special;
              }
            } catch (e) {
              console.log('Failed to parse JSON, using defaults:', e.message);
            }

            // Validate and collect labels
            const labels = [];

            // Validate area label
            if (validAreaLabels.includes(result.area)) {
              labels.push(result.area);
            } else {
              console.log(`Invalid area label "${result.area}", defaulting to "area: book"`);
              labels.push('area: book');
            }

            // Validate type label
            if (validTypeLabels.includes(result.type)) {
              labels.push(result.type);
            } else {
              console.log(`Invalid type label "${result.type}", defaulting to "type: improvement"`);
              labels.push('type: improvement');
            }

            // Validate special labels
            if (Array.isArray(result.special)) {
              for (const label of result.special) {
                if (validSpecialLabels.includes(label)) {
                  labels.push(label);
                }
              }
            }

            // Apply labels
            const isIssue = '${{ github.event_name }}' === 'issues';
            const number = isIssue
              ? context.payload.issue.number
              : context.payload.pull_request.number;

            console.log(`Applying labels to #${number}: ${labels.join(', ')}`);

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              labels: labels
            });
