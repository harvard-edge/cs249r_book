name: ğŸ”¥ TinyTorch CI

# =============================================================================
# TinyTorch CI - Comprehensive test suite
# =============================================================================
#
# Runs on every push to dev. Tests everything:
#   1. Student journey (all 20 modules + milestones)
#   2. Integration tests
#   3. E2E tests
#   4. CLI tests
#   5. Regression tests
#
# =============================================================================

on:
  push:
    branches: [dev]
    paths:
      - 'tinytorch/**'
      - '.github/workflows/tinytorch-*.yml'
  workflow_call:
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      TITO_ALLOW_SYSTEM: "1"

    defaults:
      run:
        working-directory: ${{ vars.TINYTORCH_ROOT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ vars.TINYTORCH_ROOT }}/requirements.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # =========================================================================
      # Test 1: Student Journey (modules + milestones)
      # =========================================================================
      - name: ğŸ“ Student Journey Validation
        run: |
          echo "Testing complete student journey through all modules..."
          ./bin/tito dev validate --ci

      # =========================================================================
      # Test 2: Integration Tests
      # =========================================================================
      - name: ğŸ”— Integration Tests
        run: |
          echo "Running integration tests..."
          python -m pytest tests/integration/ -v --tb=short -x

      # =========================================================================
      # Test 3: E2E Tests
      # =========================================================================
      - name: ğŸŒ E2E Tests
        run: |
          echo "Running end-to-end tests..."
          python -m pytest tests/e2e/ -v --tb=short

      # =========================================================================
      # Test 4: CLI Tests
      # =========================================================================
      - name: ğŸ’» CLI Tests
        run: |
          echo "Running CLI tests..."
          python -m pytest tests/cli/ -v --tb=short

      # =========================================================================
      # Test 5: Regression Tests
      # =========================================================================
      - name: ğŸ› Regression Tests
        run: |
          echo "Running regression tests..."
          python -m pytest tests/regression/ -v --tb=short

      # =========================================================================
      # Summary
      # =========================================================================
      - name: ğŸ“‹ Test Summary
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ”¥ TinyTorch CI Complete"
          echo "========================================"
