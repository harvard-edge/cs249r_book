# =============================================================================
# ALL-CONTRIBUTORS AUTO-ADD WORKFLOW (LLM-Powered)
# =============================================================================
# Automatically adds contributors when someone comments with @all-contributors.
#
# Uses natural language processing via Ollama LLM to understand contributions:
#   @all-contributors @username helped verify the fix worked
#   @all-contributors @username found a bug in the dataloader
#   @all-contributors @username reviewed the PR and suggested improvements
#
# The LLM maps natural descriptions to contribution types:
#   bug, code, doc, design, ideas, review, test, tool
#
# Project is auto-detected from issue labels/title, or defaults to 'book'.
# =============================================================================

name: 'ðŸ¤– All Contributors Add'

on:
  issue_comment:
    types: [created]

jobs:
  add-contributor:
    name: Add Contributor
    # Only run if comment contains the trigger phrase
    if: contains(github.event.comment.body, '@all-contributors')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Extract trigger line and username
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body;

            // Find the line containing @all-contributors
            const lines = body.split('\n');
            const triggerLine = lines.find(line => line.includes('@all-contributors'));

            if (!triggerLine) {
              console.log('No @all-contributors line found');
              core.setOutput('should_run', 'false');
              return;
            }

            console.log('Trigger line:', triggerLine);

            // Extract username - look for @username pattern after @all-contributors
            const usernameMatch = triggerLine.match(/@all-contributors\s+@(\w+)/i);
            if (!usernameMatch) {
              console.log('No username found in trigger line');
              core.setOutput('should_run', 'false');
              return;
            }

            const username = usernameMatch[1];
            console.log('Username:', username);

            // Get the description (everything after @username)
            const afterUsername = triggerLine.substring(triggerLine.indexOf('@' + username) + username.length + 1).trim();
            console.log('Description:', afterUsername);

            // Auto-detect project from issue context
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name.toLowerCase());
            const title = issue.title.toLowerCase();
            const issueBody = issue.body ? issue.body.toLowerCase() : '';

            let project = 'book';  // default
            if (labels.some(l => l.includes('tinytorch')) ||
                title.includes('tinytorch') || title.includes('tito') ||
                issueBody.includes('tinytorch/')) {
              project = 'tinytorch';
            } else if (labels.some(l => l.includes('kits')) ||
                       title.includes('kits') || issueBody.includes('kits/')) {
              project = 'kits';
            } else if (labels.some(l => l.includes('labs')) ||
                       title.includes('labs') || issueBody.includes('labs/')) {
              project = 'labs';
            }

            console.log('Project:', project);

            core.setOutput('should_run', 'true');
            core.setOutput('username', username);
            core.setOutput('description', afterUsername);
            core.setOutput('trigger_line', triggerLine);
            core.setOutput('project', project);

      - name: Analyze with LLM
        if: steps.extract.outputs.should_run == 'true'
        uses: ai-action/ollama-action@v2
        id: llm
        with:
          model: llama3.1:8b
          prompt: |
            You are parsing a contributor recognition comment. Extract the contribution type(s) from this description.

            DESCRIPTION: ${{ steps.extract.outputs.description }}

            AVAILABLE CONTRIBUTION TYPES (pick one or more that apply):
            - bug: Found or reported a bug, identified issues
            - code: Wrote code, implemented features, fixed bugs
            - doc: Wrote documentation, improved docs, fixed typos
            - design: UI/UX design, visual design, architecture design
            - ideas: Suggested ideas, proposed features, brainstormed
            - review: Reviewed code or PRs, gave feedback on changes
            - test: Tested features, verified fixes, QA testing
            - tool: Built tools, scripts, automation, CLI utilities

            Instructions:
            - Pick the type(s) that best match what the person did
            - If they "verified a fix" or "confirmed it works" -> test
            - If they "found a bug" or "reported an issue" -> bug
            - If they "reviewed" or "gave feedback on code" -> review
            - If they "wrote docs" or "fixed typos" -> doc
            - If they "implemented" or "coded" or "fixed" -> code
            - If unsure, pick the closest match

            Return ONLY a JSON object with this exact format (no other text):
            {"types": ["test"]}

            The "types" array should contain one or more contribution types.

      - name: Parse LLM response
        if: steps.extract.outputs.should_run == 'true'
        id: parse
        uses: actions/github-script@v7
        env:
          LLM_RESPONSE: ${{ steps.llm.outputs.response }}
        with:
          script: |
            const response = process.env.LLM_RESPONSE || '';
            console.log('LLM response:', response);

            const validTypes = ['bug', 'code', 'doc', 'design', 'ideas', 'review', 'test', 'tool'];
            let types = [];

            try {
              // Find JSON in response (LLM might add extra text)
              const jsonMatch = response.match(/\{[\s\S]*?\}/);
              if (jsonMatch) {
                const parsed = JSON.parse(jsonMatch[0]);
                if (parsed.types && Array.isArray(parsed.types)) {
                  types = parsed.types.filter(t => validTypes.includes(t.toLowerCase())).map(t => t.toLowerCase());
                }
              }
            } catch (e) {
              console.log('Failed to parse JSON:', e.message);
            }

            // Fallback: if no types found, try to extract from raw response
            if (types.length === 0) {
              for (const t of validTypes) {
                if (response.toLowerCase().includes(t)) {
                  types.push(t);
                  break;  // Just take the first match as fallback
                }
              }
            }

            if (types.length === 0) {
              console.log('Could not determine contribution type');
              core.setOutput('success', 'false');
              return;
            }

            console.log('Parsed types:', types);
            core.setOutput('success', 'true');
            core.setOutput('types', JSON.stringify(types));

      - name: Checkout repository
        if: steps.extract.outputs.should_run == 'true' && steps.parse.outputs.success == 'true'
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Setup Python
        if: steps.extract.outputs.should_run == 'true' && steps.parse.outputs.success == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get user info from GitHub
        if: steps.extract.outputs.should_run == 'true' && steps.parse.outputs.success == 'true'
        id: userinfo
        uses: actions/github-script@v7
        with:
          script: |
            const username = '${{ steps.extract.outputs.username }}';

            try {
              const { data: user } = await github.rest.users.getByUsername({
                username: username
              });

              core.setOutput('name', user.name || username);
              core.setOutput('avatar_url', user.avatar_url);
              core.setOutput('profile', user.html_url);
              core.setOutput('found', 'true');
            } catch (error) {
              console.log(`User ${username} not found, using defaults`);
              core.setOutput('name', username);
              core.setOutput('avatar_url', `https://avatars.githubusercontent.com/${username}`);
              core.setOutput('profile', `https://github.com/${username}`);
              core.setOutput('found', 'false');
            }

      - name: Update contributor config
        if: steps.extract.outputs.should_run == 'true' && steps.parse.outputs.success == 'true'
        run: |
          python3 << 'EOF'
          import json
          import os

          project = "${{ steps.extract.outputs.project }}"
          username = "${{ steps.extract.outputs.username }}"
          types = json.loads('${{ steps.parse.outputs.types }}')
          name = "${{ steps.userinfo.outputs.name }}"
          avatar_url = "${{ steps.userinfo.outputs.avatar_url }}"
          profile = "${{ steps.userinfo.outputs.profile }}"

          # Map project to config path
          config_paths = {
              'book': 'book/.all-contributorsrc',
              'tinytorch': 'tinytorch/.all-contributorsrc',
              'kits': 'kits/.all-contributorsrc',
              'labs': 'labs/.all-contributorsrc',
          }

          config_path = config_paths[project]

          # Read existing config
          with open(config_path, 'r') as f:
              config = json.load(f)

          contributors = config.get('contributors', [])

          # Check if user already exists
          existing = None
          for i, c in enumerate(contributors):
              if c.get('login', '').lower() == username.lower():
                  existing = i
                  break

          if existing is not None:
              # Merge contribution types
              existing_types = set(contributors[existing].get('contributions', []))
              new_types = existing_types | set(types)
              contributors[existing]['contributions'] = sorted(list(new_types))
              print(f"Updated existing contributor {username} with types: {sorted(list(new_types))}")
          else:
              # Add new contributor
              new_contributor = {
                  'login': username,
                  'name': name,
                  'avatar_url': avatar_url,
                  'profile': profile,
                  'contributions': sorted(types)
              }
              contributors.append(new_contributor)
              print(f"Added new contributor {username} with types: {sorted(types)}")

          config['contributors'] = contributors

          # Write updated config
          with open(config_path, 'w') as f:
              json.dump(config, f, indent=4)
              f.write('\n')

          print(f"Updated {config_path}")

          # Save info for later steps
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"config_path={config_path}\n")
          EOF

      - name: Generate README tables
        if: steps.extract.outputs.should_run == 'true' && steps.parse.outputs.success == 'true'
        run: |
          # Generate tables for the specific project
          python3 ${{ github.workspace }}/.github/workflows/contributors/generate_readme_tables.py --project ${{ steps.extract.outputs.project }} --update

          # Also regenerate the main README
          python3 ${{ github.workspace }}/.github/workflows/contributors/generate_main_readme.py

      - name: Configure Git
        if: steps.extract.outputs.should_run == 'true' && steps.parse.outputs.success == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        if: steps.extract.outputs.should_run == 'true' && steps.parse.outputs.success == 'true'
        run: |
          PROJECT="${{ steps.extract.outputs.project }}"
          USERNAME="${{ steps.extract.outputs.username }}"
          TYPES=$(echo '${{ steps.parse.outputs.types }}' | python3 -c "import sys,json; print(', '.join(json.load(sys.stdin)))")

          # Stage contributor files
          git add "${PROJECT}/.all-contributorsrc" "${PROJECT}/README.md" README.md 2>/dev/null || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: add @${USERNAME} as ${PROJECT} contributor for ${TYPES}"
            git push origin dev
            echo "Changes committed and pushed!"
          fi

      - name: React to comment
        if: steps.extract.outputs.should_run == 'true' && steps.parse.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Add reaction to the comment
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '+1'
            });

            // Post a reply
            const username = '${{ steps.extract.outputs.username }}';
            const project = '${{ steps.extract.outputs.project }}';
            const types = JSON.parse('${{ steps.parse.outputs.types }}');
            const description = '${{ steps.extract.outputs.description }}';

            const body = [
              "I've added @" + username + " as a contributor to **" + project + "**! :tada:",
              "",
              "**Recognized for:** " + types.join(', '),
              "**Based on:** " + (description || "(trigger comment)"),
              "",
              "The contributor list has been updated in:",
              "- `" + project + "/.all-contributorsrc`",
              "- `" + project + "/README.md`",
              "- Main `README.md`",
              "",
              "Thanks for helping recognize contributors! :heart:"
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Handle failed parsing
        if: steps.extract.outputs.should_run == 'true' && steps.parse.outputs.success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              "I couldn't understand what type of contribution to recognize. :thinking:",
              "",
              "**Usage examples:**",
              "```",
              "@all-contributors @username helped verify the fix worked",
              "@all-contributors @username found a bug in the dataloader",
              "@all-contributors @username reviewed the PR",
              "@all-contributors @username wrote documentation for the API",
              "@all-contributors @username implemented the new feature",
              "```",
              "",
              "**Contribution types I understand:**",
              "- bug (found bugs, reported issues)",
              "- code (wrote code, fixed bugs)",
              "- doc (documentation, typos)",
              "- design (UI/UX, architecture)",
              "- ideas (suggestions, proposals)",
              "- review (code review, feedback)",
              "- test (testing, verification)",
              "- tool (built tools, automation)",
              "",
              "**Project** is auto-detected from issue labels."
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Handle missing username
        if: steps.extract.outputs.should_run == 'false' && contains(github.event.comment.body, '@all-contributors')
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              "I need a username to add as a contributor. :thinking:",
              "",
              "**Usage:**",
              "```",
              "@all-contributors @username <description of what they did>",
              "```",
              "",
              "**Examples:**",
              "```",
              "@all-contributors @ngbolin helped verify the fix worked",
              "@all-contributors @user123 found and reported a bug",
              "```"
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
