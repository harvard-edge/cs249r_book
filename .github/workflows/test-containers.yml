name: ðŸ§ª Test Containers

on:
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test-linux-container:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ðŸ³ Pull Linux Container
        run: |
          echo "ðŸ³ Pulling Linux container..."
          docker pull ghcr.io/${{ github.repository }}/quarto-linux:latest
          echo "âœ… Linux container pulled successfully"

      - name: ðŸ“Š Container Information
        run: |
          echo "ðŸ“Š === CONTAINER INFORMATION ==="
          echo "ðŸ“‹ Container Details:"
          docker images ghcr.io/${{ github.repository }}/quarto-linux:latest --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
          
          echo ""
          echo "ðŸ“Š Container Size Analysis:"
          CONTAINER_SIZE=$(docker images ghcr.io/${{ github.repository }}/quarto-linux:latest --format "{{.Size}}")
          echo "ðŸ“¦ Container size: $CONTAINER_SIZE"
          
          # Extract size in MB/GB for comparison
          if [[ $CONTAINER_SIZE == *"GB"* ]]; then
            echo "âš ï¸ Large container detected (>1GB)"
          elif [[ $CONTAINER_SIZE == *"MB"* ]]; then
            echo "âœ… Container size looks reasonable"
          else
            echo "â“ Unknown size format"
          fi

      - name: ðŸ–¥ï¸ OS Information
        run: |
          echo "ðŸ–¥ï¸ === OPERATING SYSTEM INFORMATION ==="
          docker run --rm ghcr.io/${{ github.repository }}/quarto-linux:latest \
            bash -c "
              echo 'ðŸ“Š OS Details:'
              echo '============='
              cat /etc/os-release
              echo ''
              echo 'ðŸ“Š Kernel Information:'
              echo '====================='
              uname -a
              echo ''
              echo 'ðŸ“Š System Resources:'
              echo '===================='
              echo 'Memory:'
              free -h
              echo ''
              echo 'Disk Space:'
              df -h /
              echo ''
              echo 'CPU Info:'
              nproc
              lscpu | grep 'Model name' || echo 'CPU info not available'
            " | tee linux-os-info.log

      - name: ðŸ› ï¸ Tool Versions
        run: |
          echo "ðŸ› ï¸ === TOOL VERSIONS ==="
          echo "ðŸ“‹ Critical Tools in Linux Container:"
          echo "===================================="
          
          docker run --rm ghcr.io/${{ github.repository }}/quarto-linux:latest \
            bash -c "
              echo 'ðŸ“Š Quarto:' && quarto --version | head -1 &&
              echo 'ðŸ“Š Python:' && python3 --version &&
              echo 'ðŸ“Š R:' && R --version | head -1 &&
              echo 'ðŸ“Š TeX Live:' && lualatex --version | head -1 &&
              echo 'ðŸ“Š Ghostscript:' && gs --version | head -1 &&
              echo 'ðŸ“Š Node.js:' && node --version &&
              echo 'ðŸ“Š npm:' && npm --version &&
              echo 'ðŸ“Š Git:' && git --version &&
              echo 'ðŸ“Š Pandoc:' && pandoc --version | head -1 &&
              echo 'ðŸ“Š Inkscape:' && inkscape --version | head -1 &&
              echo 'ðŸ“Š Wget:' && wget --version | head -1 &&
              echo 'ðŸ“Š Curl:' && curl --version | head -1 &&
              echo 'ðŸ“Š Perl:' && perl --version | head -1 &&
              echo 'ðŸ“Š Pip:' && pip3 --version &&
              echo 'âœ… All critical tools available!'
            " | tee linux-tool-versions.log
          
          echo "ðŸ“‹ Versions saved to linux-tool-versions.log"

      - name: ðŸ“¦ Package Information
        run: |
          echo "ðŸ“¦ === PACKAGE INFORMATION ==="
          docker run --rm ghcr.io/${{ github.repository }}/quarto-linux:latest \
            bash -c "
              echo 'ðŸ“Š Python Packages:'
              echo '=================='
              pip3 list | head -20
              echo ''
              echo 'ðŸ“Š R Packages:'
              echo '=============='
              R --slave -e 'cat(\"Installed R packages:\n\"); print(installed.packages()[, \"Package\"][1:20]); cat(\"\nTotal packages:\", nrow(installed.packages()), \"\n\")' || echo 'R package list not available'
              echo ''
              echo 'ðŸ“Š TeX Live Packages:'
              echo '====================='
              tlmgr list --only-installed | head -20 || echo 'TeX Live package list not available'
            " | tee linux-package-info.log

      - name: ðŸ§ª Test Minimal Quarto Build
        run: |
          echo "ðŸ§ª === MINIMAL QUARTO BUILD TEST ==="
          # Create a minimal test document
          cat > test-doc.qmd << 'EOF'
          ---
          title: "Container Test"
          format: html
          ---
          
          # Test Document
          
          This is a test document to verify the container works.
          
          ## Python Code Block
          
          ```{python}
          print("Hello from Python!")
          import sys
          print(f"Python version: {sys.version}")
          ```
          
          ## R Code Block
          
          ```{r}
          cat("Hello from R!\n")
          cat("R version:", R.version.string, "\n")
          ```
          
          ## Math Block
          
          $$
          E = mc^2
          $$
          
          ## Table
          
          | Tool | Version |
          |------|---------|
          | Quarto | Latest |
          | Python | 3.x |
          | R | Latest |
          EOF
          
          # Test the build
          docker run --rm -v $(pwd):/workspace ghcr.io/${{ github.repository }}/quarto-linux:latest \
            bash -c "
              cd /workspace &&
              echo 'ðŸ”¨ Building test document...' &&
              quarto render test-doc.qmd --to html &&
              echo 'âœ… Build successful!' &&
              ls -la test-doc.html &&
              echo 'ðŸ“Š File size:' &&
              du -h test-doc.html &&
              echo 'ðŸ§¹ Cleaning up...' &&
              rm -f test-doc.html
            " | tee linux-build-test.log

      - name: ðŸ“¤ Upload Linux Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-container-test-results
          path: |
            linux-os-info.log
            linux-tool-versions.log
            linux-package-info.log
            linux-build-test.log
          retention-days: 30

  test-windows-container:
    runs-on: windows-latest
    timeout-minutes: 15
    steps:
      - name: ðŸ³ Pull Windows Container
        run: |
          Write-Output "ðŸ³ Pulling Windows container..."
          docker pull ghcr.io/${{ github.repository }}/quarto-windows:latest
          Write-Output "âœ… Windows container pulled successfully"

      - name: ðŸ“Š Container Information (Windows)
        shell: pwsh
        run: |
          Write-Output "ðŸ“Š === CONTAINER INFORMATION ==="
          Write-Output "ðŸ“‹ Container Details:"
          docker images ghcr.io/${{ github.repository }}/quarto-windows:latest --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
          
          Write-Output ""
          Write-Output "ðŸ“Š Container Size Analysis:"
          $CONTAINER_SIZE = docker images ghcr.io/${{ github.repository }}/quarto-windows:latest --format "{{.Size}}"
          Write-Output "ðŸ“¦ Container size: $CONTAINER_SIZE"
          
          if ($CONTAINER_SIZE -match "GB") {
            Write-Output "âš ï¸ Large container detected (>1GB)"
          } elseif ($CONTAINER_SIZE -match "MB") {
            Write-Output "âœ… Container size looks reasonable"
          } else {
            Write-Output "â“ Unknown size format"
          }

      - name: ðŸ–¥ï¸ OS Information (Windows)
        shell: pwsh
        run: |
          Write-Output "ðŸ–¥ï¸ === OPERATING SYSTEM INFORMATION ==="
          docker run --rm ghcr.io/${{ github.repository }}/quarto-windows:latest \
            pwsh -Command "
              Write-Output 'ðŸ“Š OS Details:'
              Write-Output '============='
              Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, TotalPhysicalMemory
              Write-Output ''
              Write-Output 'ðŸ“Š System Resources:'
              Write-Output '===================='
              Get-WmiObject -Class Win32_OperatingSystem | Select-Object Caption, Version, TotalVisibleMemorySize, FreePhysicalMemory
            " | Tee-Object -FilePath "windows-os-info.log"

      - name: ðŸ› ï¸ Tool Versions (Windows)
        shell: pwsh
        run: |
          Write-Output "ðŸ› ï¸ === TOOL VERSIONS ==="
          Write-Output "ðŸ“‹ Critical Tools in Windows Container:"
          Write-Output "======================================"
          
          docker run --rm ghcr.io/${{ github.repository }}/quarto-windows:latest \
            pwsh -Command "
              Write-Output 'ðŸ“Š Quarto:'; quarto --version | Select-Object -First 1;
              Write-Output 'ðŸ“Š Python:'; python3 --version;
              Write-Output 'ðŸ“Š R:'; R --version | Select-Object -First 1;
              Write-Output 'ðŸ“Š TeX Live:'; lualatex --version | Select-Object -First 1;
              Write-Output 'ðŸ“Š Ghostscript:'; gswin64c --version | Select-Object -First 1;
              Write-Output 'ðŸ“Š Node.js:'; node --version;
              Write-Output 'ðŸ“Š npm:'; npm --version;
              Write-Output 'ðŸ“Š Git:'; git --version;
              Write-Output 'ðŸ“Š Pandoc:'; pandoc --version | Select-Object -First 1;
              Write-Output 'âœ… All critical tools available!'
            " | Tee-Object -FilePath "windows-tool-versions.log"
          
          Write-Output "ðŸ“‹ Versions saved to windows-tool-versions.log"

      - name: ðŸ§ª Test Minimal Quarto Build (Windows)
        shell: pwsh
        run: |
          Write-Output "ðŸ§ª === MINIMAL QUARTO BUILD TEST ==="
          # Create a minimal test document
          @"
          ---
          title: 'Container Test'
          format: html
          ---
          
          # Test Document
          
          This is a test document to verify the Windows container works.
          
          ```{python}
          print('Hello from Python!')
          import sys
          print(f'Python version: {sys.version}')
          ```
          
          ```{r}
          cat('Hello from R!\n')
          cat('R version:', R.version.string, '\n')
          ```
          "@ | Out-File -FilePath "test-doc.qmd" -Encoding UTF8
          
          # Test the build
          docker run --rm -v ${PWD}:/workspace ghcr.io/${{ github.repository }}/quarto-windows:latest \
            pwsh -Command "
              Set-Location /workspace;
              Write-Output 'ðŸ”¨ Building test document...';
              quarto render test-doc.qmd --to html;
              Write-Output 'âœ… Build successful!';
              Get-ChildItem test-doc.html;
              Write-Output 'ðŸ“Š File size:';
              (Get-Item test-doc.html).Length;
              Write-Output 'ðŸ§¹ Cleaning up...';
              Remove-Item test-doc.html -Force
            " | Tee-Object -FilePath "windows-build-test.log"

      - name: ðŸ“¤ Upload Windows Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-container-test-results
          path: |
            windows-os-info.log
            windows-tool-versions.log
            windows-build-test.log
          retention-days: 30

  test-container-performance:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ðŸ³ Performance Tests
        run: |
          echo "ðŸ³ === CONTAINER PERFORMANCE TESTS ==="
          
          echo "ðŸ§ª Testing container startup time..."
          echo "â±ï¸ Startup time measurement:"
          time docker run --rm ghcr.io/${{ github.repository }}/quarto-linux:latest \
            bash -c "echo 'Container started successfully'"
          
          echo ""
          echo "ðŸ§ª Testing tool availability speed..."
          echo "â±ï¸ Tool access time measurement:"
          time docker run --rm ghcr.io/${{ github.repository }}/quarto-linux:latest \
            bash -c "quarto --version && python3 --version && R --version"
          
          echo ""
          echo "ðŸ§ª Testing minimal build performance..."
          echo "â±ï¸ Build time measurement:"
          # Create minimal test
          echo '---\ntitle: "Test"\nformat: html\n---\n# Test' > perf-test.qmd
          
          time docker run --rm -v $(pwd):/workspace ghcr.io/${{ github.repository }}/quarto-linux:latest \
            bash -c "cd /workspace && quarto render perf-test.qmd --to html"
          
          echo "âœ… Performance tests completed"

      - name: ðŸ“Š Container Health Summary
        run: |
          echo "ðŸ“Š === CONTAINER HEALTH SUMMARY ==="
          
          echo "ðŸ“‹ Linux Container:"
          echo "=================="
          LINUX_SIZE=$(docker images ghcr.io/${{ github.repository }}/quarto-linux:latest --format "{{.Size}}")
          echo "ðŸ“¦ Size: $LINUX_SIZE"
          
          echo ""
          echo "ðŸ“‹ Windows Container:"
          echo "===================="
          WINDOWS_SIZE=$(docker images ghcr.io/${{ github.repository }}/quarto-windows:latest --format "{{.Size}}" 2>/dev/null || echo "Not available")
          echo "ðŸ“¦ Size: $WINDOWS_SIZE"
          
          echo ""
          echo "ðŸ“Š Health Check Results:"
          echo "========================"
          echo "âœ… Container tests completed successfully"
          echo "ðŸ“‹ Version logs uploaded as artifacts"
          echo "ðŸ“‹ Performance metrics captured"
          echo "ðŸ“‹ OS information documented"
