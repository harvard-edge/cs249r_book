name: TinyTorch Release Check

# =============================================================================
# PATH CONFIGURATION - Uses GitHub Repository Variables (Settings > Variables)
# =============================================================================
# TinyTorch content lives under tinytorch/ in the MLSysBook repo
# Scripts are in .github/tinytorch-scripts/

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      check_level:
        description: 'Check Level'
        required: true
        type: choice
        options:
          - quick
          - standard
          - comprehensive

jobs:
  educational-validation:
    name: Educational Standards Review
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ${{ vars.TINYTORCH_ROOT }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ vars.TINYTORCH_ROOT }}/requirements.txt'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest nbformat nbconvert

      - name: Validate Module Structure
        run: |
          echo "üéì Validating Educational Standards..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_educational_standards.py

      - name: Check Learning Objectives
        run: |
          echo "üìã Checking learning objectives alignment..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/check_learning_objectives.py

      - name: Validate Progressive Disclosure
        run: |
          echo "üîç Validating progressive disclosure patterns..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/check_progressive_disclosure.py

  implementation-validation:
    name: Implementation Standards Review
    runs-on: ubuntu-latest
    needs: educational-validation
    
    defaults:
      run:
        working-directory: ${{ vars.TINYTORCH_ROOT }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ vars.TINYTORCH_ROOT }}/requirements.txt'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Validate Time Estimates
        run: |
          echo "‚è±Ô∏è Validating time estimate consistency..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_time_estimates.py

      - name: Validate Difficulty Ratings
        run: |
          echo "‚≠ê Validating difficulty rating consistency..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_difficulty_ratings.py

      - name: Check Testing Patterns
        run: |
          echo "üß™ Checking test_unit_* and test_module() patterns..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_testing_patterns.py

      - name: Validate Dependency Chain
        run: |
          echo "üîó Validating module dependency chain..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_dependencies.py

      - name: Check NBGrader Metadata
        run: |
          echo "üìù Validating NBGrader metadata..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_nbgrader.py

  test-validation:
    name: Testing Standards Review
    runs-on: ubuntu-latest
    needs: implementation-validation
    
    defaults:
      run:
        working-directory: ${{ vars.TINYTORCH_ROOT }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ vars.TINYTORCH_ROOT }}/requirements.txt'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run Unit Tests
        run: |
          echo "üî¨ Running unit tests..."
          pytest tests/ -v --tb=short

      - name: Run Integration Tests
        run: |
          echo "üß™ Running integration tests..."
          pytest tests/integration/ -v

      - name: Run Checkpoint Tests
        run: |
          echo "‚úÖ Running checkpoint validation..."
          pytest tests/checkpoints/ -v

      - name: Check Test Coverage
        run: |
          echo "üìä Checking test coverage..."
          pytest tests/ --cov=tinytorch --cov-report=term-missing --cov-fail-under=80

  package-validation:
    name: Package Integration Review
    runs-on: ubuntu-latest
    needs: test-validation
    
    defaults:
      run:
        working-directory: ${{ vars.TINYTORCH_ROOT }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ vars.TINYTORCH_ROOT }}/requirements.txt'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install build

      - name: Validate Export Directives
        run: |
          echo "üì¶ Validating export directives..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_exports.py

      - name: Check Import Paths
        run: |
          echo "üîó Checking import path consistency..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_imports.py

      - name: Validate Package Build
        run: |
          echo "üèóÔ∏è Testing package build..."
          python -m build

      - name: Test Package Installation
        run: |
          echo "üì• Testing package installation..."
          pip install dist/*.whl
          python -c "import tinytorch; print(f'TinyTorch {tinytorch.__version__} installed')"

  documentation-validation:
    name: Documentation Standards Review
    runs-on: ubuntu-latest
    needs: package-validation
    
    defaults:
      run:
        working-directory: ${{ vars.TINYTORCH_ROOT }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ vars.TINYTORCH_SITE }}/requirements.txt'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install sphinx jupyter-book
          pip install -r site/requirements.txt

      - name: Validate Module ABOUT.md Files
        run: |
          echo "üìÑ Validating ABOUT.md consistency..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_documentation.py

      - name: Check Checkpoint Markers
        run: |
          echo "üèÅ Validating checkpoint markers..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/check_checkpoints.py

      - name: Build Jupyter Book
        working-directory: ${{ vars.TINYTORCH_SITE }}
        run: |
          echo "üìö Building documentation..."
          jupyter-book build .

  systems-analysis-validation:
    name: Systems Thinking Review
    runs-on: ubuntu-latest
    needs: documentation-validation
    
    defaults:
      run:
        working-directory: ${{ vars.TINYTORCH_ROOT }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ vars.TINYTORCH_ROOT }}/requirements.txt'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Validate Memory Analysis
        run: |
          echo "üß† Checking memory profiling coverage..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_systems_analysis.py --aspect memory

      - name: Validate Performance Analysis
        run: |
          echo "‚ö° Checking performance analysis coverage..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_systems_analysis.py --aspect performance

      - name: Validate Production Context
        run: |
          echo "üöÄ Checking production context coverage..."
          python ${{ github.workspace }}/.github/tinytorch-scripts/validate_systems_analysis.py --aspect production

  release-readiness:
    name: Release Readiness Report
    runs-on: ubuntu-latest
    needs: [educational-validation, implementation-validation, test-validation, package-validation, documentation-validation, systems-analysis-validation]
    
    defaults:
      run:
        working-directory: ${{ vars.TINYTORCH_ROOT }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          pip install pytest pytest-cov

      - name: Generate Release Report
        run: |
          echo "üìã Generating Release Readiness Report..."
          cat << EOF > release-report.md
          # TinyTorch Release Readiness Report

          **Release Type:** ${{ github.event.inputs.release_type || 'PR Check' }}
          **Check Level:** ${{ github.event.inputs.check_level || 'standard' }}
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit:** ${{ github.sha }}

          ## ‚úÖ Quality Gates Passed

          - ‚úÖ **Educational Standards** - Module structure and learning objectives validated
          - ‚úÖ **Implementation Standards** - Time estimates, difficulty ratings, and patterns consistent
          - ‚úÖ **Testing Standards** - All tests passing with adequate coverage
          - ‚úÖ **Package Integration** - Exports, imports, and build successful
          - ‚úÖ **Documentation** - ABOUT.md files and checkpoints validated
          - ‚úÖ **Systems Analysis** - Memory, performance, and production context present

          ## üöÄ Release Authorization

          **Status:** ‚úÖ APPROVED FOR RELEASE

          All quality gates passed. TinyTorch is ready for release.

          ---

          *Generated by TinyTorch Release Check Workflow*
          EOF

          cat release-report.md

      - name: Upload Release Report
        uses: actions/upload-artifact@v4
        with:
          name: tinytorch-release-report
          path: ${{ vars.TINYTORCH_ROOT }}/release-report.md

      - name: Release Check Summary
        run: |
          echo "‚úÖ All quality gates passed!"
          echo "üì¶ TinyTorch is ready for release"
          echo "üéâ Great work maintaining educational and technical excellence!"
