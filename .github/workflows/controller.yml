name: 'üéÆ Controller'

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
    
jobs:
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for changelog

  # Quality Check Jobs (Run on all events)
  structure-check:
    needs: checkout
    uses: ./.github/workflows/structure-check.yml

  link-check:
    needs: checkout
    uses: ./.github/workflows/link-check.yml

  lint-markdown:
    needs: checkout
    uses: ./.github/workflows/lint-markdown.yml

  # Metadata Update Jobs (Run Only After Merge to branches, not on PRs)
  update-changelog:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: [structure-check, link-check, lint-markdown]
    uses: ./.github/workflows/update-changelog.yml

  update-contributors:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: [structure-check, link-check, lint-markdown]
    uses: ./.github/workflows/update-contributors.yml
          
  # Build Jobs (Only run on pushes to branches, not on PRs)
  build-dev:
    name: üîß Development Build
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/dev'
    needs: [update-changelog, update-contributors]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        format: [html, pdf]
    uses: ./.github/workflows/quarto-build.yml
    with:
      environment: development
      os: ${{ matrix.os }}
      format: ${{ matrix.format }}
      deploy: ${{ matrix.os == 'ubuntu-latest' }}
      target: dev
    secrets:
      SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}

  build-main:
    name: üöÄ Production Build
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main'
    needs: [update-changelog, update-contributors]
    strategy:
      fail-fast: false
      matrix:
        format: [html, pdf]
    uses: ./.github/workflows/quarto-build.yml
    with:
      environment: production
      os: ubuntu-latest
      format: ${{ matrix.format }}
      deploy: true
      target: main
    secrets:
      SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}

  report-status:
    needs: [
      structure-check, 
      link-check, 
      lint-markdown,
      update-changelog,
      update-contributors,
      build-dev,
      build-main
    ]
    runs-on: ubuntu-latest
    steps:
      - name: üìä Create Status Report
        shell: bash
        run: |
          echo "# üìä Workflow Status Report" >> $GITHUB_STEP_SUMMARY
          echo >> $GITHUB_STEP_SUMMARY
          echo "## üîç Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "- Structure Check: ${{ needs.structure-check.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Link Check: ${{ needs.link-check.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Markdown Lint: ${{ needs.lint-markdown.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo >> $GITHUB_STEP_SUMMARY

          echo "## üîß Development Build" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.build-dev.result == 'success' && '‚úÖ Success' || needs.build-dev.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo >> $GITHUB_STEP_SUMMARY

          echo "## üöÄ Production Build" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.build-main.result == 'success' && '‚úÖ Success' || needs.build-main.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo >> $GITHUB_STEP_SUMMARY

          echo "## üìù Metadata Updates" >> $GITHUB_STEP_SUMMARY
          echo "- Changelog: ${{ needs.update-changelog.result == 'success' && '‚úÖ Updated' || needs.update-changelog.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Contributors: ${{ needs.update-contributors.result == 'success' && '‚úÖ Updated' || needs.update-contributors.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "‚è∞ Completed at: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY

          FAILED=0
          [[ "${{ needs.structure-check.result }}" != "success" ]] && FAILED=1
          [[ "${{ needs.link-check.result }}" != "success" ]] && FAILED=1
          [[ "${{ needs.lint-markdown.result }}" != "success" ]] && FAILED=1
          [[ "${{ needs.update-changelog.result }}" != "success" && "${{ needs.update-changelog.result }}" != "skipped" ]] && FAILED=1
          [[ "${{ needs.update-contributors.result }}" != "success" && "${{ needs.update-contributors.result }}" != "skipped" ]] && FAILED=1
          [[ "${{ needs.build-dev.result }}" != "success" && "${{ needs.build-dev.result }}" != "skipped" ]] && FAILED=1
          [[ "${{ needs.build-main.result }}" != "success" && "${{ needs.build-main.result }}" != "skipped" ]] && FAILED=1

          if [[ $FAILED -eq 1 ]]; then
            echo "::error::‚ùå One or more workflow steps failed"
            exit 1
          else
            echo "‚úÖ All required checks passed successfully"
          fi
