name: 'üê≥ Build Windows Container'

# This workflow builds the Windows Quarto build container
# Windows containers are more complex but provide performance benefits

# Prevent multiple builds running simultaneously
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if no changes'
        required: false
        default: false
        type: boolean
      no_cache:
        description: 'Disable Docker build cache (fresh build)'
        required: false
        default: false
        type: boolean
      container_registry:
        description: 'Container registry URL'
        required: false
        default: 'ghcr.io'
        type: string
      container_name:
        description: 'Container image name'
        required: false
        default: 'quarto-windows'
        type: string
      container_tag:
        description: 'Container tag'
        required: false
        default: 'latest'
        type: string
  workflow_call:
    inputs:
      force_rebuild:
        required: false
        default: false
        type: boolean
      no_cache:
        required: false
        default: false
        type: boolean
      container_registry:
        required: false
        default: 'ghcr.io'
        type: string
      container_name:
        required: false
        default: 'quarto-windows'
        type: string
      container_tag:
        required: false
        default: 'latest'
        type: string
  # DISABLED: Automatic triggers while working on containers
  # schedule:
  #   - cron: '0 2 * * 0'  # Weekly rebuild (Sunday at 2am - after Linux container)
  # push:
  #   paths:
  #     - 'tools/dependencies/**'
  #     - 'docker/build-quarto-windows/**'
  #     - '.github/workflows/build-windows-container.yml'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: harvard-edge/cs249r_book/quarto-windows
  CONTAINER_TAG: latest
  DOCKERFILE_PATH: ./docker/build-quarto-windows/Dockerfile
  CONTEXT_PATH: .

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120  # 2 hour timeout for Windows builds
    permissions:
      contents: read
      packages: write

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîê Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üê≥ Build Windows container
        run: |
          echo "üöÄ Building Windows container..."
          $useNoCache = "${{ inputs.no_cache }}" -eq "true"
          if ($useNoCache) {
            echo "üìä Cache mode: DISABLED (fresh build)"
            docker build --no-cache -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} -f ${{ env.DOCKERFILE_PATH }} ${{ env.CONTEXT_PATH }}
          } else {
            echo "üìä Cache mode: ENABLED (faster build)"
            docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} -f ${{ env.DOCKERFILE_PATH }} ${{ env.CONTEXT_PATH }}
          }
          
          echo "‚úÖ Local container build completed"

      - name: üê≥ Push Windows container
        run: |
          echo "üì¶ Pushing container to registry..."
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }}
          echo "‚úÖ Container push completed"

      - name: Build Complete
        run: |
          echo "‚úÖ Windows container build completed successfully!"
          echo "üìä Container: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }}"
