name: 'ðŸ³ Build Windows Container'

# This workflow builds the Windows Quarto build container
# Windows containers are more complex but provide performance benefits

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if no changes'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 2 * * 0'  # Weekly rebuild (Sunday at 2am - after Linux container)
  push:
    paths:
      - 'tools/dependencies/**'
      - 'docker/quarto-build-windows/**'
      - '.github/workflows/build-windows-container.yml'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/quarto-build-windows

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ³ Build and push Windows container
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/quarto-build-windows/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: windows/amd64

      - name: ðŸ§ª Test Windows Container Functionality
        run: |
          echo "ðŸ§ª Testing Windows container functionality..."
          
          # Pull the built container
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          # Create a test directory with sample content
          mkdir test-container
          cd test-container
          
          # Create a simple Quarto document for testing
          @"
          ---
          title: "Windows Container Test"
          format: html
          ---
          
          # Test Document
          
          This is a test document to verify the Windows container works properly.
          
          ```{python}
          import pandas as pd
          import numpy as np
          print("Python test successful!")
          ```
          
          ```{r}
          library(ggplot2)
          library(dplyr)
          print("R test successful!")
          ```
          
          ## Math Test
          
          Here's a simple equation: $E = mc^2$
          
          ```{tikz}
          \begin{tikzpicture}
          \node[draw, fill=blue!20] at (0,0) {TikZ Test};
          \node[draw, fill=red!20] at (2,0) {Success};
          \draw[->] (0.8,0) -- (1.2,0);
          \end{tikzpicture}
          ```
          "@ | Out-File -Encoding UTF8 test.qmd
          
          # Test 1: Basic Quarto functionality
          echo "ðŸ“Š Test 1: Basic Quarto functionality..."
          docker run --rm -v ${PWD}:/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest `
            bash -c "cd /workspace && quarto --version"
          
          # Test 2: Python packages
          echo "ðŸ“Š Test 2: Python packages..."
          docker run --rm -v ${PWD}:/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest `
            bash -c "cd /workspace && python3 -c 'import pandas, numpy, jupyter, openai, groq, pybtex, PIL, yaml, yamllint, gradio, jsonschema, pypandoc, ghostscript, absl, pre_commit, requests, titlecase, rich, sentence_transformers, faiss, sklearn, torch; print(\"âœ… All Python packages available!\")'"
          
          # Test 3: R packages
          echo "ðŸ“Š Test 3: R packages..."
          docker run --rm -v ${PWD}:/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest `
            bash -c "cd /workspace && Rscript -e 'library(ggplot2); library(ggrepel); library(knitr); library(rmarkdown); library(tidyverse); library(reshape2); library(reticulate); library(rsvg); library(viridis); library(xml2); library(dplyr); library(grid); cat(\"âœ… All R packages available!\n\")'"
          
          # Test 4: TeX Live and LaTeX
          echo "ðŸ“Š Test 4: TeX Live and LaTeX..."
          docker run --rm -v ${PWD}:/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest `
            bash -c "cd /workspace && lualatex --version && pdflatex --version && echo 'âœ… LaTeX engines available!'"
          
          # Test 5: Ghostscript
          echo "ðŸ“Š Test 5: Ghostscript..."
          docker run --rm -v ${PWD}:/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest `
            bash -c "cd /workspace && gs --version && echo 'âœ… Ghostscript available!'"
          
          # Test 6: Quarto render test
          echo "ðŸ“Š Test 6: Quarto render test..."
          docker run --rm -v ${PWD}:/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest `
            bash -c "cd /workspace && quarto render test.qmd --to html && ls -la test.html && echo 'âœ… Quarto render successful!'"
          
          # Test 7: TikZ compilation test
          echo "ðŸ“Š Test 7: TikZ compilation test..."
          @"
          \documentclass{standalone}
          \usepackage{tikz}
          \usepackage{pgfplots}
          \usepackage{amsmath}
          \usepackage{amssymb}
          \usepackage{xcolor}
          \usepackage[T1]{fontenc}
          \usetikzlibrary{positioning}
          \usetikzlibrary{calc}
          \begin{document}
          \begin{tikzpicture}[font=\small\usefont{T1}{phv}{m}{n}]
          \node[draw, fill=blue!20] at (0,0) {TikZ Test};
          \node[draw, fill=red!20] at (2,0) {Success};
          \draw[->] (0.8,0) -- (1.2,0);
          \end{tikzpicture}
          \end{document}
          "@ | Out-File -Encoding UTF8 tikz_test.tex
          
          docker run --rm -v ${PWD}:/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest `
            bash -c "cd /workspace && lualatex -interaction=nonstopmode tikz_test.tex && ls -la tikz_test.pdf && echo 'âœ… TikZ compilation successful!'"
          
          # Test 8: System resources check
          echo "ðŸ“Š Test 8: System resources..."
          docker run --rm -v ${PWD}:/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest `
            bash -c "df -h . && free -h && echo 'âœ… System resources adequate!'"
          
          # Test 9: Network connectivity
          echo "ðŸ“Š Test 9: Network connectivity..."
          docker run --rm -v ${PWD}:/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest `
            bash -c "curl -s https://cran.r-project.org/ > /dev/null && echo 'âœ… Network connectivity good!'"
          
          # Test 10: Book structure compatibility
          echo "ðŸ“Š Test 10: Book structure compatibility..."
          docker run --rm -v ${PWD}:/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest `
            bash -c "cd /workspace && ls -la quarto/ && echo 'âœ… Quarto directory accessible!'"
          
          # Test 11: Quarto check test
          echo "ðŸ“Š Test 11: Quarto check test..."
          docker run --rm -v ${PWD}:/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest `
            bash -c "cd /workspace/quarto && quarto check"
          
          echo "ðŸŽ‰ All Windows container tests completed successfully!"
          echo "ðŸ“Š Windows container is ready for production use!"

      - name: ðŸ“‹ Container Info
        run: |
          echo "âœ… Windows container built and tested successfully"
          echo "ðŸ“Š Registry: ${{ env.REGISTRY }}"
          echo "ðŸ“Š Image: ${{ env.IMAGE_NAME }}"
          echo "ðŸ“Š Tags: ${{ steps.meta.outputs.tags }}"
          echo "ðŸ“Š Size: $(docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest --format '{{.Size}}')"
          
          echo ""
          echo "ðŸš€ Usage in workflows:"
          echo "container:"
          echo "  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "  options: --user root"
          
          echo ""
          echo "ðŸ§ª Tests performed:"
          echo "âœ… Quarto functionality"
          echo "âœ… Python packages (all from requirements.txt)"
          echo "âœ… R packages (all from install_packages.R)"
          echo "âœ… TeX Live and LaTeX engines"
          echo "âœ… Ghostscript PDF compression"
          echo "âœ… Quarto render test"
          echo "âœ… TikZ compilation test"
          echo "âœ… System resources check"
          echo "âœ… Network connectivity"
          echo "âœ… Book structure compatibility"
          echo "âœ… Quarto check (same as workflow)"
          
          echo ""
          echo "ðŸ“ˆ Expected performance improvement:"
          echo "   Traditional Windows build: 45 minutes"
          echo "   Windows container build: 10-15 minutes" 