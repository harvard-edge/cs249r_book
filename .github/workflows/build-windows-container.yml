name: 'ðŸ³ Build Windows Container'

# This workflow builds the Windows Quarto build container
# Windows containers are more complex but provide performance benefits

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if no changes'
        required: false
        default: false
        type: boolean
      no_cache:
        description: 'Disable Docker build cache (fresh build)'
        required: false
        default: false
        type: boolean
      container_registry:
        description: 'Container registry URL'
        required: false
        default: 'ghcr.io'
        type: string
      container_name:
        description: 'Container image name'
        required: false
        default: 'quarto-windows'
        type: string
      container_tag:
        description: 'Container tag'
        required: false
        default: 'latest'
        type: string
  workflow_call:
    inputs:
      force_rebuild:
        required: false
        default: false
        type: boolean
      no_cache:
        required: false
        default: false
        type: boolean
      container_registry:
        required: false
        default: 'ghcr.io'
        type: string
      container_name:
        required: false
        default: 'quarto-windows'
        type: string
      container_tag:
        required: false
        default: 'latest'
        type: string
  # DISABLED: Automatic triggers while working on containers
  # schedule:
  #   - cron: '0 2 * * 0'  # Weekly rebuild (Sunday at 2am - after Linux container)
  # push:
  #   paths:
  #     - 'tools/dependencies/**'
  #     - 'docker/build-quarto-windows/**'
  #     - '.github/workflows/build-windows-container.yml'

env:
  # Container Registry Configuration (configurable via inputs)
  REGISTRY: ${{ inputs.container_registry || 'ghcr.io' }}
  IMAGE_NAME: ${{ github.repository }}/${{ inputs.container_name || 'quarto-windows' }}
  CONTAINER_TAG: ${{ inputs.container_tag || 'latest' }}
  
  # Container Build Configuration
  DOCKERFILE_PATH: ./docker/build-quarto-windows/Dockerfile
  CONTEXT_PATH: .

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ env.CONTAINER_TAG }}

      - name: ðŸ³ Build Windows container locally for testing
        run: |
          echo "ðŸš€ Building Windows container locally..."
          $useNoCache = "${{ inputs.no_cache }}" -eq "true"
          if ($useNoCache) {
            echo "ðŸ“Š Cache mode: DISABLED (fresh build - manual trigger or no_cache=true)"
            echo "ðŸ”„ Building with --no-cache flag (fresh build)..."
            docker build --no-cache -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} -f ${{ env.DOCKERFILE_PATH }} ${{ env.CONTEXT_PATH }}
          } else {
            echo "ðŸ“Š Cache mode: ENABLED (faster build - called via build manager)" 
            echo "ðŸ”„ Building with cache enabled (faster build)..."
            docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} -f ${{ env.DOCKERFILE_PATH }} ${{ env.CONTEXT_PATH }}
          }
          
          echo "âœ… Local container build completed"
          echo "ðŸ“Š Verifying local image exists..."
          docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }}

      - name: ðŸ³ Push Windows container to registry
        run: |
          echo "ðŸ“¦ Pushing container to registry..."
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }}
          
          echo "âœ… Container push completed"

      - name: ðŸŒ Make container public
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸŒ Making container public..."
          gh api -X PATCH /user/packages/container/${{ env.IMAGE_NAME }}/visibility -f visibility=public
          echo "âœ… Container made public"

      - name: ðŸ§ª Test Windows Container Functionality
        run: |
          echo "ðŸ§ª Testing Windows container functionality..."
          
          # Verify the container image is available locally
          echo "ðŸ“Š Checking available Docker images..."
          docker images
          
          echo "ðŸ” Verifying target image exists..."
          LOCAL_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }}"
          echo "ðŸ“Š Target image: $LOCAL_IMAGE"
          
          if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "$LOCAL_IMAGE"; then
            echo "âœ… Target image found locally"
          else
            echo "âŒ Target image not found! Available images:"
            docker images --format "{{.Repository}}:{{.Tag}}"
            exit 1
          fi
          
          # Use locally built container to save bandwidth and time
          echo "ðŸ“Š Using locally built container for testing..."
          
          # Create a test directory with sample content
          mkdir test-container
          cd test-container
          
          # Create a simple Quarto document for testing
          @"
          ---
          title: "Windows Container Test"
          format: html
          ---
          
          # Test Document
          
          This is a test document to verify the Windows container works properly.
          
          ```{python}
          import pandas as pd
          import numpy as np
          print("Python test successful!")
          ```
          
          ```{r}
          library(ggplot2)
          library(dplyr)
          print("R test successful!")
          ```
          
          ## Math Test
          
          Here's a simple equation: $E = mc^2$
          
          ```{tikz}
          \begin{tikzpicture}
          \node[draw, fill=blue!20] at (0,0) {TikZ Test};
          \node[draw, fill=red!20] at (2,0) {Success};
          \draw[->] (0.8,0) -- (1.2,0);
          \end{tikzpicture}
          ```
          "@ | Out-File -Encoding UTF8 test.qmd
          
          # Test 1: Quarto
          echo "ðŸ“Š Test 1: Quarto installation..."
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} quarto --version
          
          # Test 2: Python and packages
          echo "ðŸ“Š Test 2: Python installation..."
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} python --version
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} python -c "import pandas, numpy, jupyter; print('âœ… Key Python packages available')"
          
          # Test 3: R and packages
          echo "ðŸ“Š Test 3: R installation..."
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} R --version
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} Rscript -e "library(ggplot2); library(knitr); cat('âœ… Key R packages available\n')"
          
          # Test 4: LaTeX engines
          echo "ðŸ“Š Test 4: LaTeX installation..."
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} lualatex --version
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} pdflatex --version
          
          # Test 5: Graphics tools
          echo "ðŸ“Š Test 5: Graphics tools..."
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} gs --version
          
          echo "ðŸŽ‰ All installation tests completed successfully!"
          echo "ðŸ“Š Windows container is ready for production use!"

      - name: ðŸ“‹ Container Info
        run: |
          echo "âœ… Windows container built and tested successfully"
          echo "ðŸ“Š Registry: ${{ env.REGISTRY }}"
          echo "ðŸ“Š Image: ${{ env.IMAGE_NAME }}"
          echo "ðŸ“Š Tag: ${{ env.CONTAINER_TAG }}"
          echo "ðŸ“Š Size: $(docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }} --format '{{.Size}}')'"
          
          echo ""
          echo "ðŸš€ Usage in workflows:"
          echo "container:"
          echo "  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }}"
          
          echo ""
          echo "ðŸ§ª Tests performed:"
          echo "âœ… Quarto installation"
          echo "âœ… Python and key packages"
          echo "âœ… R and key packages"
          echo "âœ… LaTeX engines"
          echo "âœ… Graphics tools"
          
          echo ""
          echo "ðŸ“ˆ Expected performance improvement:"
          echo "   Traditional Windows build: 45 minutes"
          echo "   Windows container build: 10-15 minutes" 