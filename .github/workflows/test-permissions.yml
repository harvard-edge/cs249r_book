name: 'ğŸ” Test Container Registry Permissions'

# Simple workflow to test if we can push to GitHub Container Registry
# This will help identify permission issues before running the full build

on:
  workflow_dispatch:
    inputs:
      test_tag:
        description: 'Test tag for the container'
        required: false
        default: 'test-permissions'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/test-permissions
  CONTAINER_TAG: ${{ inputs.test_tag || 'test-permissions' }}

jobs:
  test-permissions:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Test registry access
        run: |
          set -euo pipefail
          echo "ğŸ” Testing GitHub Container Registry permissions..."
          echo "ğŸ“Š Registry: ${{ env.REGISTRY }}"
          echo "ğŸ“Š Repository: ${{ github.repository }}"
          echo "ğŸ“Š Actor: ${{ github.actor }}"
          
          # Test 1: Docker daemon access
          echo "ğŸ” Test 1: Docker daemon access..."
          if docker info >/dev/null 2>&1; then
            echo "âœ… Docker daemon is accessible"
          else
            echo "âŒ Docker daemon not accessible"
            exit 1
          fi
          
          # Test 2: Registry login
          echo "ğŸ” Test 2: Registry login..."
          if echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin; then
            echo "âœ… Successfully logged into container registry"
          else
            echo "âŒ Failed to log into container registry"
            exit 1
          fi
          
          # Test 3: Push a simple test image
          echo "ğŸ” Test 3: Pushing test image..."
          TEST_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }}"
          
          # Pull hello-world image
          if docker pull hello-world:latest; then
            echo "âœ… Successfully pulled hello-world image"
          else
            echo "âŒ Failed to pull hello-world image"
            exit 1
          fi
          
          # Tag it for our registry
          if docker tag hello-world:latest $TEST_IMAGE; then
            echo "âœ… Successfully tagged test image"
          else
            echo "âŒ Failed to tag test image"
            exit 1
          fi
          
          # Push to registry
          if docker push $TEST_IMAGE; then
            echo "âœ… Successfully pushed test image to registry!"
            echo "ğŸ“Š Test image: $TEST_IMAGE"
          else
            echo "âŒ Failed to push test image to registry"
            echo "ğŸ” This indicates a permissions issue with GitHub Container Registry"
            exit 1
          fi
          
          # Test 4: Pull the image back to verify
          echo "ğŸ” Test 4: Verifying image can be pulled back..."
          if docker pull $TEST_IMAGE; then
            echo "âœ… Successfully pulled test image back from registry!"
            echo "ğŸ‰ All permission tests passed!"
          else
            echo "âŒ Failed to pull test image back from registry"
            exit 1
          fi

      - name: ğŸ“‹ Summary
        run: |
          echo "âœ… Permission test completed successfully!"
          echo "ğŸ“Š Test image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.CONTAINER_TAG }}"
          echo ""
          echo "ğŸ”— Next steps:"
          echo "   1. Check if 'Packages' tab appears in your repository"
          echo "   2. Run the full container build workflow"
          echo "   3. If issues persist, check repository settings"
