name: Wait for Dependency

on:
  workflow_call:
    inputs:
      wait-timeout:
        description: 'Timeout in seconds'
        default: '900'
        required: false
        type: string
      check-name:
        description: 'Name of the check to wait for'
        required: true
        type: string
      polling-interval:
        description: 'Polling interval in seconds'
        default: '30'
        required: false
        type: string

jobs:
  wait-for-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Debug Info Start
        run: |
          echo "Starting to wait for: ${{ inputs.check-name }}"
          echo "Timeout setting: ${{ inputs.wait-timeout }} seconds"
          echo "Polling interval: ${{ inputs.polling-interval }} seconds"
          echo "Current ref: ${{ github.event.pull_request.head.sha || github.sha }}"
          echo "Repository: ${{ github.repository }}"

      - name: Poll until workflow completes
        run: |
          start_time=$(date +%s)
          timeout=${{ inputs.wait-timeout }}
          interval=${{ inputs.polling-interval }}
          
          while true; do
            current_time=$(date +%s)
            elapsed=$((current_time - start_time))
            
            if [ $elapsed -ge $timeout ]; then
              echo "Timeout reached after ${elapsed} seconds"
              exit 1
            fi
            
            # Get full response and debug it
            RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha || github.sha }}/check-runs")
            
            echo "All check runs:"
            echo "$RESPONSE" | jq -r '.check_runs[] | .name + ": " + (.conclusion // "in_progress")'
            
            STATUS=$(echo "$RESPONSE" | jq -r --arg name "${{ inputs.check-name }}" '.check_runs[] | select(.name==$name) | .conclusion')
            
            echo "Current status at $(date) for ${{ inputs.check-name }}: $STATUS"
            
            if [ "$STATUS" = "success" ]; then
              echo "Workflow ${{ inputs.check-name }} completed successfully"
              exit 0
            elif [ "$STATUS" = "failure" ] || [ "$STATUS" = "cancelled" ]; then
              echo "Workflow ${{ inputs.check-name }} failed or was cancelled"
              exit 1
            elif [ -z "$STATUS" ]; then
              echo "No status found for ${{ inputs.check-name }}, might not have started yet"
            fi
            
            echo "Waiting ${interval} seconds before next check..."
            sleep $interval
          done

      - name: Debug Info End
        if: success()
        run: |
          echo "Workflow ${{ inputs.check-name }} completed successfully!"
          echo "Completed at: $(date)"