name: ðŸ§ª TinyTorch Install Test

# =============================================================================
# Fresh Install Simulation
# =============================================================================
# Tests the actual student experience: clean environment, curl install, run
# milestones. Catches issues like Git LFS problems before students hit them.
#
# Runs:
#   - On push to dev (tinytorch changes only)
#   - Weekly scheduled run
#   - Manual trigger with branch selection

on:
  push:
    branches: [dev]
    paths:
      - 'tinytorch/**'
      - '.github/workflows/tinytorch-install-test.yml'
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test installation from'
        required: false
        default: 'main'
        type: string

jobs:
  fresh-install-test:
    name: Fresh Install Simulation
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout (for test script only)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            tinytorch/scripts/test-fresh-install.sh

      - name: Determine branch to test
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "branch=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "branch=main" >> $GITHUB_OUTPUT
          fi

      - name: Run Fresh Install Test (Docker)
        run: |
          chmod +x tinytorch/scripts/test-fresh-install.sh
          ./tinytorch/scripts/test-fresh-install.sh --branch ${{ steps.branch.outputs.branch }}

      - name: Report Success
        if: success()
        run: |
          echo "## âœ… Fresh Install Test Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Branch tested: \`${{ steps.branch.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The installation and milestone tests completed successfully." >> $GITHUB_STEP_SUMMARY

      - name: Report Failure
        if: failure()
        run: |
          echo "## âŒ Fresh Install Test Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Branch tested: \`${{ steps.branch.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details. Common issues:" >> $GITHUB_STEP_SUMMARY
          echo "- Git LFS files not properly converted" >> $GITHUB_STEP_SUMMARY
          echo "- Missing dependencies in requirements.txt" >> $GITHUB_STEP_SUMMARY
          echo "- Interactive prompts blocking execution" >> $GITHUB_STEP_SUMMARY
