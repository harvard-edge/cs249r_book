name: 'ðŸ³ Build Container'

# This workflow builds the Quarto build container and pushes it to GitHub Container Registry
# The container pre-installs all dependencies to eliminate 30-45 minute setup time
# Includes comprehensive testing to ensure all components work properly

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if no changes'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 0 * * 0'  # Weekly rebuild (Sunday at midnight)
  push:
    paths:
      - 'tools/dependencies/**'
      - 'Dockerfile'
      - '.github/workflows/build-container.yml'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/quarto-build

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ³ Build and push container
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ§ª Test Container Functionality
        run: |
          echo "ðŸ§ª Testing container functionality..."
          
          # Pull the built container
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          # Create a test directory with sample content
          mkdir -p test-container
          cd test-container
          
          # Create a simple Quarto document for testing
          cat > test.qmd << 'EOF'
          ---
          title: "Container Test"
          format: html
          ---
          
          # Test Document
          
          This is a test document to verify the container works properly.
          
          ```{python}
          import pandas as pd
          import numpy as np
          print("Python test successful!")
          ```
          
          ```{r}
          library(ggplot2)
          library(dplyr)
          print("R test successful!")
          ```
          
          ## Math Test
          
          Here's a simple equation: $E = mc^2$
          
          ```{tikz}
          \begin{tikzpicture}
          \node[draw, fill=blue!20] at (0,0) {TikZ Test};
          \node[draw, fill=red!20] at (2,0) {Success};
          \draw[->] (0.8,0) -- (1.2,0);
          \end{tikzpicture}
          ```
          EOF
          
          # Test 1: Basic Quarto functionality
          echo "ðŸ“Š Test 1: Basic Quarto functionality..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && quarto --version"
          
          # Test 2: Python packages
          echo "ðŸ“Š Test 2: Python packages..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && python3 -c 'import pandas, numpy, jupyter, openai, groq, pybtex, PIL, yaml, yamllint, gradio, jsonschema, pypandoc, ghostscript, absl, pre_commit, requests, titlecase, rich, sentence_transformers, faiss, sklearn, torch; print(\"âœ… All Python packages available!\")'"
          
          # Test 3: R packages
          echo "ðŸ“Š Test 3: R packages..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && Rscript -e 'library(ggplot2); library(ggrepel); library(knitr); library(rmarkdown); library(tidyverse); library(reshape2); library(reticulate); library(rsvg); library(viridis); library(xml2); library(dplyr); library(grid); cat(\"âœ… All R packages available!\n\")'"
          
          # Test 4: TeX Live and LaTeX
          echo "ðŸ“Š Test 4: TeX Live and LaTeX..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && lualatex --version && pdflatex --version && echo 'âœ… LaTeX engines available!'"
          
          # Test 5: Inkscape
          echo "ðŸ“Š Test 5: Inkscape..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && inkscape --version && echo 'âœ… Inkscape available!'"
          
          # Test 6: Ghostscript
          echo "ðŸ“Š Test 6: Ghostscript..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && gs --version && echo 'âœ… Ghostscript available!'"
          
          # Test 7: Fonts and graphics
          echo "ðŸ“Š Test 7: Fonts and graphics..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && fc-list | head -5 && echo 'âœ… Fonts available!'"
          
          # Test 8: Quarto render test
          echo "ðŸ“Š Test 8: Quarto render test..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && quarto render test.qmd --to html && ls -la test.html && echo 'âœ… Quarto render successful!'"
          
          # Test 9: TikZ compilation test
          echo "ðŸ“Š Test 9: TikZ compilation test..."
          cat > tikz_test.tex << 'EOF'
          \documentclass{standalone}
          \usepackage{tikz}
          \usepackage{pgfplots}
          \usepackage{amsmath}
          \usepackage{amssymb}
          \usepackage{xcolor}
          \usepackage[T1]{fontenc}
          \usetikzlibrary{positioning}
          \usetikzlibrary{calc}
          \begin{document}
          \begin{tikzpicture}[font=\small\usefont{T1}{phv}{m}{n}]
          \node[draw, fill=blue!20] at (0,0) {TikZ Test};
          \node[draw, fill=red!20] at (2,0) {Success};
          \draw[->] (0.8,0) -- (1.2,0);
          \end{tikzpicture}
          \end{document}
          EOF
          
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && lualatex -interaction=nonstopmode tikz_test.tex && ls -la tikz_test.pdf && echo 'âœ… TikZ compilation successful!'"
          
          # Test 10: SVG to PDF conversion test
          echo "ðŸ“Š Test 10: SVG to PDF conversion test..."
          cat > test.svg << 'EOF'
          <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
            <circle cx="50" cy="50" r="40" fill="red"/>
            <text x="50" y="55" text-anchor="middle" fill="white">Test</text>
          </svg>
          EOF
          
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && inkscape --export-type=pdf --export-filename=test.pdf test.svg && ls -la test.pdf && echo 'âœ… SVG to PDF conversion successful!'"
          
          # Test 11: Memory and disk space check
          echo "ðŸ“Š Test 11: System resources..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "df -h . && free -h && echo 'âœ… System resources adequate!'"
          
          # Test 12: Network connectivity (for package downloads)
          echo "ðŸ“Š Test 12: Network connectivity..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "curl -s https://cran.r-project.org/ > /dev/null && echo 'âœ… Network connectivity good!'"
          
          # Test 13: Book structure compatibility test
          echo "ðŸ“Š Test 13: Book structure compatibility..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && ls -la book/ && echo 'âœ… Book directory accessible!'"
          
          # Test 14: Quarto configuration test
          echo "ðŸ“Š Test 14: Quarto configuration test..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace/book && ls -la config/ && echo 'âœ… Quarto config files accessible!'"
          
          # Test 15: Dependencies files test
          echo "ðŸ“Š Test 15: Dependencies files test..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace && ls -la tools/dependencies/ && echo 'âœ… Dependencies files accessible!'"
          
          # Test 16: Quarto check test (same as your workflow)
          echo "ðŸ“Š Test 16: Quarto check test..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace/book && quarto check"
          
          # Test 17: Simulate actual build process
          echo "ðŸ“Š Test 17: Simulate actual build process..."
          docker run --rm -v $(pwd):/workspace ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            bash -c "cd /workspace/book && cp config/_quarto-html.yml _quarto.yml && quarto render --to html --quiet && echo 'âœ… HTML build simulation successful!'"
          
          echo "ðŸŽ‰ All container tests completed successfully!"
          echo "ðŸ“Š Container is ready for production use!"

      - name: ðŸ“‹ Container Info
        run: |
          echo "âœ… Container built and tested successfully"
          echo "ðŸ“Š Registry: ${{ env.REGISTRY }}"
          echo "ðŸ“Š Image: ${{ env.IMAGE_NAME }}"
          echo "ðŸ“Š Tags: ${{ steps.meta.outputs.tags }}"
          echo "ðŸ“Š Size: $(docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest --format '{{.Size}}')"
          
          echo ""
          echo "ðŸš€ Usage in workflows:"
          echo "container:"
          echo "  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "  options: --user root"
          
          echo ""
          echo "ðŸ§ª Tests performed:"
          echo "âœ… Quarto functionality"
          echo "âœ… Python packages (all from requirements.txt)"
          echo "âœ… R packages (all from install_packages.R)"
          echo "âœ… TeX Live and LaTeX engines"
          echo "âœ… Inkscape SVG to PDF conversion"
          echo "âœ… Ghostscript PDF compression"
          echo "âœ… Fonts and graphics libraries"
          echo "âœ… Quarto render test"
          echo "âœ… TikZ compilation test"
          echo "âœ… System resources check"
          echo "âœ… Network connectivity"
          echo "âœ… Book structure compatibility"
          echo "âœ… Quarto configuration files"
          echo "âœ… Dependencies files accessibility"
          echo "âœ… Quarto check (same as workflow)"
          echo "âœ… Actual build process simulation"
          
          echo ""
          echo "ðŸ“ˆ Expected performance improvement:"
          echo "   Traditional build: 45 minutes"
          echo "   Containerized build: 5-10 minutes" 