name: üî• TinyTorch Publish (Live)

# =============================================================================
# TinyTorch Publish Workflow
# =============================================================================
#
# Builds and deploys TinyTorch site to mlsysbook.ai/tinytorch/
# with automatic semantic versioning and release tagging.
#
# WORKFLOW FLOW:
# ==============
#
#   1. validate-inputs
#      ‚îî‚îÄ Calculate next version from tinytorch-v* tags (e.g., v0.1.1 ‚Üí v0.1.2)
#
#   2. preflight (CI checks)
#      ‚îî‚îÄ Run tinytorch-ci.yml tests
#
#   3. update-version (if preflight passes)
#      ‚îî‚îÄ Bump version in 4 files on dev branch:
#         - tinytorch/__init__.py
#         - pyproject.toml
#         - site/_static/version-badge.js
#         - site/extra/install.sh
#
#   4. sync-from-dev
#      ‚îî‚îÄ Merge dev ‚Üí main
#
#   5. build-pdfs (parallel)
#      ‚îî‚îÄ Generate PDF guide and paper
#
#   6. build-and-deploy (if all previous succeed)
#      ‚îî‚îÄ Build Jupyter Book, deploy to gh-pages/tinytorch/
#
#   7. create-tag (if deploy succeeds)
#      ‚îî‚îÄ Create tinytorch-vX.Y.Z tag on main
#
#   8. summary
#      ‚îî‚îÄ Show results in GitHub Actions UI
#
# SAFETY FEATURES:
# ================
#   - Requires typing "PUBLISH" to confirm
#   - Each step checks previous step success
#   - Tag created only after successful deploy
#   - Preflight must pass before any changes
#
# VERSIONING:
# ===========
#   - Tags use format: tinytorch-v{major}.{minor}.{patch}
#   - Separate from book versions (which use v{major}.{minor}.{patch})
#   - Release type (patch/minor/major) determines version bump
#
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'What are you publishing? [Content updates and improvements]'
        required: false
        default: 'Content updates and improvements'
      release_type:
        description: 'Release type [patch]'
        required: true
        type: choice
        options:
          - 'patch'
          - 'minor'
          - 'major'
        default: 'patch'
      confirm:
        description: 'Type "PUBLISH" to confirm (safety check) [required]'
        required: true
        default: ''

permissions:
  contents: write
  actions: read

concurrency:
  group: gh-pages-deploy
  cancel-in-progress: false

jobs:
  validate-inputs:
    name: 'üîç Validate Inputs'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.inputs.confirm == 'PUBLISH'
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      previous_version: ${{ steps.version.outputs.previous_version }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Calculate Next Version
        id: version
        run: |
          echo "üîÑ Getting latest TinyTorch version..."
          
          # Get latest tinytorch-v* tag, default to v0.0.0 if none exist
          LATEST_VERSION=$(git tag -l "tinytorch-v*" | sort -V | tail -n1)
          if [ -z "$LATEST_VERSION" ]; then
            LATEST_VERSION="tinytorch-v0.0.0"
            echo "üìä No TinyTorch tags found, using default: $LATEST_VERSION"
          else
            echo "üìä Latest TinyTorch tag: $LATEST_VERSION"
          fi
          
          # Remove 'tinytorch-v' prefix for calculation
          VERSION_NUM=${LATEST_VERSION#tinytorch-v}
          
          # Split version into components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NUM"
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          
          echo "üìä Previous version: $MAJOR.$MINOR.$PATCH"
          
          # Calculate new version based on release type
          case "${{ github.event.inputs.release_type }}" in
            "major")
              NEW_MAJOR=$((MAJOR + 1))
              NEW_MINOR=0
              NEW_PATCH=0
              ;;
            "minor")
              NEW_MAJOR=$MAJOR
              NEW_MINOR=$((MINOR + 1))
              NEW_PATCH=0
              ;;
            "patch")
              NEW_MAJOR=$MAJOR
              NEW_MINOR=$MINOR
              NEW_PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="tinytorch-v$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH"
          echo "üéØ New version: $NEW_VERSION (${{ github.event.inputs.release_type }} release)"
          
          # Export for other steps
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "previous_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

  preflight:
    name: '‚úàÔ∏è Preflight Checks'
    needs: validate-inputs
    uses: ./.github/workflows/tinytorch-ci.yml
    with:
      preflight_level: 'standard'

  update-version:
    name: 'üìù Update Version in Code'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate-inputs, preflight]
    if: needs.preflight.result == 'success'

    steps:
      - name: üì• Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üìù Update version in tinytorch/__init__.py
        run: |
          echo "üìù Updating version in tinytorch/tinytorch/__init__.py..."
          
          # Extract just the version number (without tinytorch- prefix)
          VERSION_NUM="${{ needs.validate-inputs.outputs.new_version }}"
          VERSION_NUM=${VERSION_NUM#tinytorch-v}
          
          # Update __version__ in __init__.py
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION_NUM\"/" tinytorch/tinytorch/__init__.py
          
          echo "‚úÖ Version updated to $VERSION_NUM"
          cat tinytorch/tinytorch/__init__.py | grep "__version__"

      - name: üìù Update version in pyproject.toml
        run: |
          echo "üìù Updating version in tinytorch/pyproject.toml..."
          
          VERSION_NUM="${{ needs.validate-inputs.outputs.new_version }}"
          VERSION_NUM=${VERSION_NUM#tinytorch-v}
          
          # Update version in pyproject.toml
          sed -i "s/^version = \".*\"/version = \"$VERSION_NUM\"/" tinytorch/pyproject.toml
          
          echo "‚úÖ pyproject.toml version updated"
          cat tinytorch/pyproject.toml | grep "^version"

      - name: üìù Update version in website badge
        run: |
          echo "üìù Updating version in tinytorch/site/_static/version-badge.js..."
          
          VERSION_NUM="${{ needs.validate-inputs.outputs.new_version }}"
          VERSION_NUM=${VERSION_NUM#tinytorch-v}
          
          # Update version in version-badge.js
          sed -i "s/const version = versionMeta ? versionMeta.content : '[0-9.]*'/const version = versionMeta ? versionMeta.content : '$VERSION_NUM'/" tinytorch/site/_static/version-badge.js
          
          echo "‚úÖ version-badge.js updated"
          cat tinytorch/site/_static/version-badge.js | grep "const version"

      - name: üìù Update version in installer
        run: |
          echo "üìù Updating version in tinytorch/site/extra/install.sh..."
          
          VERSION_NUM="${{ needs.validate-inputs.outputs.new_version }}"
          VERSION_NUM=${VERSION_NUM#tinytorch-v}
          
          # Update version in install.sh
          sed -i "s/TINYTORCH_VERSION=\"[0-9.]*\"/TINYTORCH_VERSION=\"$VERSION_NUM\"/" tinytorch/site/extra/install.sh
          
          echo "‚úÖ install.sh updated"
          cat tinytorch/site/extra/install.sh | grep "TINYTORCH_VERSION"

      - name: üíæ Commit version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add tinytorch/tinytorch/__init__.py tinytorch/pyproject.toml tinytorch/site/_static/version-badge.js tinytorch/site/extra/install.sh
          git commit -m "chore(tinytorch): bump version to ${{ needs.validate-inputs.outputs.new_version }}" || echo "No changes to commit"
          git push origin dev

  sync-from-dev:
    name: 'üîÑ Sync dev ‚Üí main'
    runs-on: ubuntu-latest
    needs: [validate-inputs, preflight, update-version]

    steps:
      - name: üì• Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üîÑ Merge dev into main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "üì• Fetching dev branch..."
          git fetch origin dev

          echo "üîÑ Merging dev into main..."
          git merge origin/dev --no-edit -m "üî• TinyTorch ${{ needs.validate-inputs.outputs.new_version }}: ${{ github.event.inputs.description }}"

          echo "üöÄ Pushing updated main..."
          git push origin main

  build-pdfs:
    name: 'üìö Build PDFs'
    needs: [validate-inputs, preflight, sync-from-dev]
    uses: ./.github/workflows/tinytorch-build-pdfs.yml
    with:
      ref: main

  build-and-deploy:
    name: 'üî• Build & Deploy'
    runs-on: ubuntu-latest
    needs: [validate-inputs, preflight, update-version, sync-from-dev, build-pdfs]
    if: always() && needs.preflight.result == 'success' && needs.update-version.result == 'success' && needs.sync-from-dev.result == 'success'

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          ref: main  # Use freshly synced main

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tinytorch/site/requirements.txt'

      - name: üì¶ Install dependencies
        working-directory: tinytorch
        run: |
          pip install --upgrade pip
          pip install -r site/requirements.txt

      - name: üî® Build Jupyter Book
        working-directory: tinytorch/site
        run: |
          jupyter-book build . --all
          touch _build/html/.nojekyll

      - name: üì• Download PDF Guide
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: TinyTorch-Guide
          path: ./pdf-artifacts/guide

      - name: üì• Download PDF Paper
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: TinyTorch-Paper
          path: ./pdf-artifacts/paper

      - name: üìÅ Inject PDFs into site
        run: |
          echo "üìÅ Injecting PDFs into built site..."
          mkdir -p tinytorch/site/_build/html/_static/downloads

          if [ -f ./pdf-artifacts/guide/tinytorch-course.pdf ]; then
            cp ./pdf-artifacts/guide/tinytorch-course.pdf tinytorch/site/_build/html/_static/downloads/TinyTorch-Guide.pdf
            echo "‚úÖ Injected TinyTorch-Guide.pdf"
          else
            echo "‚ö†Ô∏è Guide PDF not found"
          fi

          if [ -f ./pdf-artifacts/paper/paper.pdf ]; then
            cp ./pdf-artifacts/paper/paper.pdf tinytorch/site/_build/html/_static/downloads/TinyTorch-Paper.pdf
            echo "‚úÖ Injected TinyTorch-Paper.pdf"
          else
            echo "‚ö†Ô∏è Paper PDF not found"
          fi

          echo ""
          echo "üì¶ Downloads folder contents:"
          ls -la tinytorch/site/_build/html/_static/downloads/ || echo "No downloads folder"

      - name: üöÄ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./tinytorch/site/_build/html
          destination_dir: tinytorch
          publish_branch: gh-pages
          keep_files: true
          commit_message: 'üî• Deploy TinyTorch ${{ needs.validate-inputs.outputs.new_version }} - ${{ github.sha }}'

  create-tag:
    name: 'üè∑Ô∏è Create Release Tag'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate-inputs, build-and-deploy]
    if: needs.build-and-deploy.result == 'success'

    steps:
      - name: üì• Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Fetch latest main (includes the merge commit)
          git fetch origin main
          git checkout main
          git pull origin main
          
          TAG="${{ needs.validate-inputs.outputs.new_version }}"
          
          echo "üè∑Ô∏è Creating tag: $TAG on commit $(git rev-parse HEAD)"
          
          # Delete existing tag if it exists
          git tag -d "$TAG" 2>/dev/null || true
          git push origin --delete "$TAG" 2>/dev/null || true
          
          # Create annotated tag on current HEAD (latest main)
          git tag -a "$TAG" -m "TinyTorch $TAG: ${{ github.event.inputs.description }}"
          git push origin "$TAG"
          
          echo "‚úÖ Tag $TAG created and pushed"

  summary:
    name: 'üìã Publication Summary'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate-inputs, build-and-deploy, create-tag]
    if: always()

    steps:
      - name: üìã Summary
        run: |
          echo "## üî• TinyTorch Publication Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate-inputs.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Previous:** ${{ needs.validate-inputs.outputs.previous_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Type:** ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Description:** ${{ github.event.inputs.description }}" >> $GITHUB_STEP_SUMMARY
          echo "**Published by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üåê Access:" >> $GITHUB_STEP_SUMMARY
          echo "- üìñ [TinyTorch Website](https://mlsysbook.ai/tinytorch/)" >> $GITHUB_STEP_SUMMARY
          echo "- üè∑Ô∏è [Release Tag](https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate-inputs.outputs.new_version }})" >> $GITHUB_STEP_SUMMARY

  fail-validation:
    name: '‚ùå Validation Failed'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.inputs.confirm != 'PUBLISH'

    steps:
      - name: ‚ùå Invalid confirmation
        run: |
          echo "## ‚ùå Publication Cancelled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** You must type exactly 'PUBLISH' to confirm" >> $GITHUB_STEP_SUMMARY
          echo "**Received:** ${{ github.event.inputs.confirm }}" >> $GITHUB_STEP_SUMMARY
          exit 1
