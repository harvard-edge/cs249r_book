name: 'Workflow Controller'

on:
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  set-environment:
    runs-on: ubuntu-latest
    outputs:
      deploy_env: ${{ steps.set_env.outputs.deploy_env }}
    steps:
      - name: Set DEPLOY_ENV
        id: set_env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "deploy_env=production" >> $GITHUB_ENV
            echo "deploy_env=production" >> $GITHUB_OUTPUT
          else
            echo "deploy_env=development" >> $GITHUB_ENV
            echo "deploy_env=development" >> $GITHUB_OUTPUT
          fi
          
  checkout:
    needs: set-environment
    runs-on: ubuntu-latest
    outputs:
      matrix_os: '["ubuntu-latest", "windows-latest"]'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

  structure-check:
    needs: checkout
    uses: ./.github/workflows/structure-check.yml
    with:
      matrix_os: ${{ needs.checkout.outputs.matrix_os }}

  link-check:
    needs: checkout
    uses: ./.github/workflows/link-check.yml
    with:
      matrix_os: ${{ needs.checkout.outputs.matrix_os }}

  quarto-check:
    needs: checkout
    uses: ./.github/workflows/quarto-check.yml
    with:
      matrix_os: ${{ needs.checkout.outputs.matrix_os }}

  markdown-lint:
    needs: checkout
    uses: ./.github/workflows/lint-markdown.yml

  update-changelog:
    needs: [set-environment, structure-check, link-check, quarto-check, markdown-lint]
    uses: ./.github/workflows/update-changelog.yml
    with:
      environment: ${{ needs.set-environment.outputs.deploy_env }}

  update-contributors:
    needs: [structure-check, link-check, quarto-check, markdown-lint]
    uses: ./.github/workflows/update-contributors.yml

  build-main:
    if: github.ref == 'refs/heads/main'
    needs: [update-changelog, update-contributors]
    uses: ./.github/workflows/main-build.yml
    with:
      environment: production

  build-dev:
    if: github.ref == 'refs/heads/dev'
    needs: [update-changelog, update-contributors]
    uses: ./.github/workflows/dev-build.yml
    with:
      environment: development

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build-main
    uses: ./.github/workflows/deploy.yml
    with:
      environment: production

  report-status:
    needs: [set-environment, structure-check, link-check, quarto-check, markdown-lint, update-changelog, update-contributors, build-main, build-dev, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create Status Report
        run: |
          echo "## ðŸ“Š Workflow Status Report" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ” Quality Checks" >> $GITHUB_STEP_SUMMARY
          for check in "structure-check" "link-check" "quarto-check" "markdown-lint"; do
            if [ "${{ needs[check].result }}" = "success" ]; then
              echo "âœ… $check: Passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $check: Failed" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "### ðŸ“ Metadata Updates" >> $GITHUB_STEP_SUMMARY
          for update in "update-changelog" "update-contributors"; do
            if [ "${{ needs[update].result }}" = "success" ]; then
              echo "âœ… $update: Completed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $update: Failed" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "### ðŸ”¨ Build (Main)" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.build-main.result }}" = "success" ]; then
              echo "âœ… Built Successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "### ðŸš€ Deployment" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.deploy.result }}" = "success" ]; then
              echo "âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            echo "### ðŸ”¨ Build (Dev)" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.build-dev.result }}" = "success" ]; then
              echo "âœ… Built Successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ•’ Completed at: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        if: always()
        run: |
          FAILED=0
          for job in "structure-check" "link-check" "quarto-check" "markdown-lint" "update-changelog" "update-contributors"; do
            if [ "${{ needs[job].result }}" != "success" ]; then
              FAILED=1
              break
            fi
          done
          
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            if [ "${{ needs.build-main.result }}" != "success" ] || [ "${{ needs.deploy.result }}" != "success" ]; then
              FAILED=1
            fi
          fi
          
          if [ "${{ github.ref }}" = "refs/heads/dev" ] && [ "${{ needs.build-dev.result }}" != "success" ]; then
            FAILED=1
          fi
          
          if [ "$FAILED" = "1" ]; then
            echo "::error::One or more workflow steps failed"
            exit 1
          fi
