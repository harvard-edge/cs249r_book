name: 'ðŸŽ® Workflow Controller'

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for changelog

  # Quality Check Jobs (Run on all events)
  structure-check:
    needs: checkout
    uses: ./.github/workflows/structure-check.yml

  link-check:
    needs: checkout
    uses: ./.github/workflows/link-check.yml

  lint-markdown:
    needs: checkout
    uses: ./.github/workflows/lint-markdown.yml

  # Metadata Update Jobs (Run Only After Merge to branches, not on PRs)
  update-changelog:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: [structure-check, link-check, lint-markdown]
    uses: ./.github/workflows/update-changelog.yml

  update-contributors:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: [structure-check, link-check, lint-markdown]
    uses: ./.github/workflows/update-contributors.yml

  # PR Validation Build (Only run on PRs, don't deploy)
  validate-build:
    if: github.event_name == 'pull_request'
    needs: [structure-check, link-check, lint-markdown]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        format: [html, pdf]
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ§ª Test Quarto Build
        uses: ./.github/workflows/quarto-build.yml
        with:
          environment: test
          os: ubuntu-latest
          format: ${{ matrix.format }}
          deploy: false
          
  # Build Jobs (Only run on pushes to branches, not on PRs)
  build-dev:
    name: ðŸ”§ Development Build
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/dev'
    needs: [update-changelog, update-contributors]
    strategy:
      matrix:
        os: [ubuntu-latest]
        format: [html, pdf]
    uses: ./.github/workflows/quarto-build.yml
    with:
      environment: development
      os: ${{ matrix.os }}
      format: ${{ matrix.format }}
      deploy: true
      target: dev
    secrets:
      SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}

  # Lightweight HTML-only build for dev branch (faster)
  build-dev-light:
    name: ðŸ’¨ Fast HTML Dev Build
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/dev'
    needs: checkout
    uses: ./.github/workflows/quarto-build-lite.yml
    with:
      environment: development
      os: ubuntu-latest
      target: dev
    secrets:
      SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}

  build-main:
    name: ðŸš€ Production Build
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main'
    needs: [update-changelog, update-contributors]
    strategy:
      matrix:
        format: [html, pdf]
    uses: ./.github/workflows/quarto-build.yml
    with:
      environment: production
      os: ubuntu-latest
      format: ${{ matrix.format }}
      deploy: true
      target: main
    secrets:
      SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}

  # Status Reporting
  report-status:
    if: always()
    needs: [
      structure-check, 
      link-check, 
      lint-markdown,
      update-changelog,
      update-contributors,
      build-dev,
      build-dev-light,
      build-main,
      validate-build
    ]
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š Create Status Report
        run: |
          {
            echo "# ðŸ“Š Workflow Status Report"
            echo
            echo "## ðŸ” Quality Checks"
            echo "- Structure Check: ${{ needs.structure-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}"
            echo "- Link Check: ${{ needs.link-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}"
            echo "- Markdown Lint: ${{ needs.lint-markdown.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}"
            echo
            
            if [[ "${{ github.event_name }}" == "push" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              echo "## ðŸ“ Metadata Updates"
              if [[ "${{ contains(needs.*, 'update-changelog') }}" == "true" ]]; then
                echo "- Changelog: ${{ needs.update-changelog.result == 'success' && 'âœ… Updated' || 'âŒ Failed' }}"
              fi
              if [[ "${{ contains(needs.*, 'update-contributors') }}" == "true" ]]; then
                echo "- Contributors: ${{ needs.update-contributors.result == 'success' && 'âœ… Updated' || 'âŒ Failed' }}"
              fi
              echo
            fi
            
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              echo "## ðŸ§ª Build Validation"
              if [[ "${{ contains(needs.*, 'validate-build') }}" == "true" ]]; then
                echo "- Build Check: ${{ needs.validate-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}"
              fi
              echo
            fi
            
            if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" != "pull_request" ]]; then
              echo "## ðŸš€ Production Build"
              if [[ "${{ contains(needs.*, 'build-main') }}" == "true" ]]; then
                echo "- Main Build: ${{ needs.build-main.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}"
              fi
            fi
            
            if [[ "${{ github.ref }}" == "refs/heads/dev" && "${{ github.event_name }}" != "pull_request" ]]; then
              echo "## ðŸ”§ Development Build"
              if [[ "${{ contains(needs.*, 'build-dev') }}" == "true" ]]; then
                echo "- Dev Build: ${{ needs.build-dev.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}"
              fi
              if [[ "${{ contains(needs.*, 'build-dev-light') }}" == "true" ]]; then
                echo "- Light HTML Build: ${{ needs.build-dev-light.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}"
              fi
            fi
            
            echo
            echo "---"
            echo "â° Completed at: $(date '+%Y-%m-%d %H:%M:%S')"
          } >> $GITHUB_STEP_SUMMARY