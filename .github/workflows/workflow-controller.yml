name: 'Workflow Controller'

on:
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  initialize:
    runs-on: ubuntu-latest
    outputs:
      matrix_os: '["ubuntu-latest", "windows-latest"]'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

  # Initial checks and validation
  quality-checks:
    needs: initialize
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: ${{ fromJson(needs.initialize.outputs.matrix_os) }}
    steps:
      - name: Run Structure Check
        uses: ./.github/workflows/structure-check.yml
        with:
          os: ${{ matrix.os }}
      
      - name: Run Link Check
        uses: ./.github/workflows/link-check.yml
        with:
          os: ${{ matrix.os }}
      
      - name: Run Quarto Check
        uses: ./.github/workflows/quarto-check.yml
        with:
          os: ${{ matrix.os }}

      - name: Run Markdown Lint
        uses: ./.github/workflows/lint-markdown.yml

  # Update metadata
  update-metadata:
    needs: quality-checks
    runs-on: ubuntu-latest
    steps:
      - name: Update Changelog
        uses: ./.github/workflows/update-changelog.yml
        with:
          environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

      - name: Update Contributors
        uses: ./.github/workflows/update-contributors.yml

  # Branch-specific builds
  build:
    needs: update-metadata
    uses: ./.github/workflows/${{ github.ref == 'refs/heads/main' && 'main-build' || 'dev-build' }}.yml
    with:
      environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

  # Deployment (only on main branch)
  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Deploy to Production
        uses: ./.github/workflows/deploy.yml

  # Status reporting
  report-status:
    needs: [quality-checks, update-metadata, build, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create Status Report
        run: |
          echo "## 📊 Workflow Status Report" >> $GITHUB_STEP_SUMMARY
          
          # Quality Checks Status
          echo "### 🔍 Quality Checks" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.quality-checks.result }}" = "success" ]; then
            echo "✅ Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Metadata Updates Status
          echo "### 📝 Metadata Updates" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.update-metadata.result }}" = "success" ]; then
            echo "✅ Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Build Process Status
          echo "### 🔨 Build Process" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "✅ Built Successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Build Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Deployment Status (main branch only)
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "### 🚀 Deployment" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.deploy.result }}" = "success" ]; then
              echo "✅ Deployed Successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Add summary footer
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "🕒 Completed at: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        if: always()
        run: |
          if [ "${{ needs.quality-checks.result }}" != "success" ] || \
             [ "${{ needs.update-metadata.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             ([ "${{ github.ref }}" = "refs/heads/main" ] && [ "${{ needs.deploy.result }}" != "success" ]); then
            echo "::error::One or more workflow steps failed"
            exit 1
          fi