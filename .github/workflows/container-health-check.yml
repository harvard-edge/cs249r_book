name: ğŸ’Š Container Health Check

# Comprehensive health validation for build containers
# Tests essential Quarto build tools and functionality
# Runs daily to ensure container reliability

on:
  workflow_dispatch:
    inputs:
      container_registry:
        description: 'Container registry URL'
        required: false
        default: 'ghcr.io'
        type: string
      container_tag:
        description: 'Container tag to test'
        required: false
        default: 'latest'
        type: string
      test_linux:
        description: 'Test Linux container'
        required: false
        default: true
        type: boolean
      test_windows:
        description: 'Test Windows container'
        required: false
        default: true
        type: boolean
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

# Centralized Container Configuration - Single Source of Truth
env:
  REGISTRY: ${{ inputs.container_registry || 'ghcr.io' }}
  CONTAINER_TAG: ${{ inputs.container_tag || 'latest' }}
  LINUX_CONTAINER_NAME: 'quarto-linux'
  WINDOWS_CONTAINER_NAME: 'quarto-windows'
  # Computed full image names
  LINUX_IMAGE: ${{ inputs.container_registry || 'ghcr.io' }}/${{ github.repository }}/quarto-linux:${{ inputs.container_tag || 'latest' }}
  WINDOWS_IMAGE: ${{ inputs.container_registry || 'ghcr.io' }}/${{ github.repository }}/quarto-windows:${{ inputs.container_tag || 'latest' }}

jobs:
  # Matrix strategy for both container platforms
  container-health-check:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false  # Test both containers even if one fails
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            container_name: quarto-linux
            shell: bash
          - os: windows-latest
            platform: windows  
            container_name: quarto-windows
            shell: pwsh
    
    env:
      CONTAINER_IMAGE: ${{ inputs.container_registry || 'ghcr.io' }}/${{ github.repository }}/${{ matrix.container_name }}:${{ inputs.container_tag || 'latest' }}
      PLATFORM: ${{ matrix.platform }}
      
    steps:
      - name: ğŸ³ Pull Container
        if: |
          (matrix.platform == 'linux' && inputs.test_linux != false) ||
          (matrix.platform == 'windows' && inputs.test_windows != false)
        run: |
          echo "ğŸ³ Pulling ${{ matrix.platform }} container..."
          echo "ğŸ“¦ Image: ${{ env.CONTAINER_IMAGE }}"
          docker pull ${{ env.CONTAINER_IMAGE }}
          echo "âœ… Container pulled successfully"

      - name: ğŸ“Š Container Information
        if: |
          (matrix.platform == 'linux' && inputs.test_linux != false) ||
          (matrix.platform == 'windows' && inputs.test_windows != false)
        run: |
          echo "ğŸ“Š === CONTAINER INFORMATION ==="
          echo "ğŸ“‹ Platform: ${{ matrix.platform }}"
          echo "ğŸ“‹ Image: ${{ env.CONTAINER_IMAGE }}"
          echo "ğŸ“‹ Container Details:"
          docker images ${{ env.CONTAINER_IMAGE }} --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
          
          echo ""
          echo "ğŸ“Š Container Size Analysis:"
          ${{ matrix.platform == 'windows' && '$CONTAINER_SIZE = ' || 'CONTAINER_SIZE=$(' }}docker images ${{ env.CONTAINER_IMAGE }} --format "{{.Size}}"${{ matrix.platform == 'windows' && '' || ')' }}
          echo "ğŸ“¦ Container size: ${{ matrix.platform == 'windows' && '$CONTAINER_SIZE' || '$CONTAINER_SIZE' }}"

      - name: ğŸ–¥ï¸ OS Information  
        if: |
          (matrix.platform == 'linux' && inputs.test_linux != false) ||
          (matrix.platform == 'windows' && inputs.test_windows != false)
        run: |
          echo "ğŸ–¥ï¸ === OPERATING SYSTEM INFORMATION ==="
          ${{ matrix.platform == 'linux' && format('docker run --rm {0} bash -c "
            echo ''ğŸ“Š OS Details:''
            echo ''=============''
            cat /etc/os-release
            echo ''''
            echo ''ğŸ“Š System Resources:''
            echo ''====================''
            echo ''Memory:''
            free -h
            echo ''''
            echo ''Disk Space:''
            df -h /
            echo ''''
            echo ''CPU Info:''
            nproc
            lscpu | grep ''Model name'' || echo ''CPU info not available''
          " | tee {1}-os-info.log', env.CONTAINER_IMAGE, matrix.platform) }}${{ matrix.platform == 'windows' && format('docker run --rm {0} pwsh -Command "
            Write-Output ''ğŸ“Š OS Details:''
            Write-Output ''=============''
            Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, TotalPhysicalMemory
            Write-Output ''''
            Write-Output ''ğŸ“Š System Resources:''
            Write-Output ''====================''
            Get-WmiObject -Class Win32_OperatingSystem | Select-Object Caption, Version, TotalVisibleMemorySize, FreePhysicalMemory
          " | Tee-Object -FilePath "{1}-os-info.log"', env.CONTAINER_IMAGE, matrix.platform) }}

      - name: ğŸ› ï¸ Essential Quarto Build Tools
        if: |
          (matrix.platform == 'linux' && inputs.test_linux != false) ||
          (matrix.platform == 'windows' && inputs.test_windows != false)
        run: |
          echo "ğŸ› ï¸ === ESSENTIAL QUARTO BUILD TOOLS ==="
          echo "ğŸ“‹ Testing only tools needed for Quarto builds:"
          echo "================================================"
          
          ${{ matrix.platform == 'linux' && format('docker run --rm {0} bash -c "
            echo ''ğŸ“Š Checking Quarto...'' && quarto --version | head -1 && echo ''âœ… Quarto: OK'' || echo ''âŒ Quarto: FAILED'' &&
            echo ''ğŸ“Š Checking Python...'' && python3 --version && echo ''âœ… Python: OK'' || echo ''âŒ Python: FAILED'' &&
            echo ''ğŸ“Š Checking R...'' && R --version | head -1 && echo ''âœ… R: OK'' || echo ''âŒ R: FAILED'' &&
            echo ''ğŸ“Š Checking LuaLaTeX...'' && lualatex --version | head -1 && echo ''âœ… LuaLaTeX: OK'' || echo ''âŒ LuaLaTeX: FAILED'' &&
            echo ''ğŸ“Š Checking Ghostscript...'' && gs --version | head -1 && echo ''âœ… Ghostscript: OK'' || echo ''âŒ Ghostscript: FAILED'' &&
            echo ''ğŸ“Š Checking Inkscape...'' && inkscape --version | head -1 && echo ''âœ… Inkscape: OK'' || echo ''âŒ Inkscape: FAILED'' &&
            echo ''ğŸ¯ === TOOL CHECK SUMMARY ==='' &&
            echo ''âœ… All essential Quarto build tools verified!''
          " | tee {1}-tool-versions.log', env.CONTAINER_IMAGE, matrix.platform) }}${{ matrix.platform == 'windows' && format('docker run --rm {0} pwsh -Command "
            Write-Output ''ğŸ“Š Checking Quarto...''; if (quarto --version) {{ Write-Output ''âœ… Quarto: OK'' }} else {{ Write-Output ''âŒ Quarto: FAILED'' }};
            Write-Output ''ğŸ“Š Checking Python...''; if (python --version) {{ Write-Output ''âœ… Python: OK'' }} else {{ Write-Output ''âŒ Python: FAILED'' }};
            Write-Output ''ğŸ“Š Checking R...''; if (R --version) {{ Write-Output ''âœ… R: OK'' }} else {{ Write-Output ''âŒ R: FAILED'' }};
            Write-Output ''ğŸ“Š Checking LuaLaTeX...''; if (lualatex --version) {{ Write-Output ''âœ… LuaLaTeX: OK'' }} else {{ Write-Output ''âŒ LuaLaTeX: FAILED'' }};
            Write-Output ''ğŸ“Š Checking Ghostscript...''; if (gswin64c --version) {{ Write-Output ''âœ… Ghostscript: OK'' }} else {{ Write-Output ''âŒ Ghostscript: FAILED'' }};
            Write-Output ''ğŸ“Š Checking Inkscape...''; if (inkscape --version) {{ Write-Output ''âœ… Inkscape: OK'' }} else {{ Write-Output ''âŒ Inkscape: FAILED'' }};
            Write-Output ''ğŸ¯ === TOOL CHECK SUMMARY ==='';
            Write-Output ''âœ… All essential Quarto build tools verified!''
          " | Tee-Object -FilePath "{1}-tool-versions.log"', env.CONTAINER_IMAGE, matrix.platform) }}
          
          echo "ğŸ“‹ Essential tool versions saved to ${{ matrix.platform }}-tool-versions.log"

      - name: ğŸ” Quarto Check (Comprehensive)
        if: |
          (matrix.platform == 'linux' && inputs.test_linux != false) ||
          (matrix.platform == 'windows' && inputs.test_windows != false)
        run: |
          echo "ğŸ” === QUARTO CHECK (COMPREHENSIVE DETAILS) ==="
          echo "ğŸ“‹ Running quarto check to validate full installation:"
          echo "===================================================="
          
          ${{ matrix.platform == 'linux' && format('docker run --rm {0} bash -c "
            echo ''ğŸ” Running quarto check...'' &&
            if quarto check; then
              echo ''âœ… Quarto check: PASSED - All components verified!''
            else
              echo ''âŒ Quarto check: FAILED - Issues detected!''
              exit 1
            fi
          " | tee {1}-quarto-check.log', env.CONTAINER_IMAGE, matrix.platform) }}${{ matrix.platform == 'windows' && format('docker run --rm {0} pwsh -Command "
            Write-Output ''ğŸ” Running quarto check...'';
            if (quarto check) {{
              Write-Output ''âœ… Quarto check: PASSED - All components verified!''
            }} else {{
              Write-Output ''âŒ Quarto check: FAILED - Issues detected!''
              exit 1
            }}
          " | Tee-Object -FilePath "{1}-quarto-check.log"', env.CONTAINER_IMAGE, matrix.platform) }}
          
          echo "ğŸ“‹ Quarto check results saved to ${{ matrix.platform }}-quarto-check.log"


      - name: ğŸ“Š ${{ matrix.platform }} Container Test Summary
        if: |
          (matrix.platform == 'linux' && inputs.test_linux != false) ||
          (matrix.platform == 'windows' && inputs.test_windows != false)
        run: |
          echo "ğŸ“Š === ${{ matrix.platform == 'linux' && 'LINUX' || 'WINDOWS' }} CONTAINER TEST SUMMARY ==="
          echo "========================================"
          echo ""
          echo "ğŸ” RESULTS:"
          echo "----------"

      - name: ğŸ“Š Linux Container Analysis
        if: matrix.platform == 'linux' && inputs.test_linux != false
        run: |
          # Check if all log files exist and contain success indicators
          if [ -f linux-tool-versions.log ]; then
            if grep -q "âœ….*Quarto.*OK" linux-tool-versions.log && \
               grep -q "âœ….*Python.*OK" linux-tool-versions.log && \
               grep -q "âœ….*R.*OK" linux-tool-versions.log && \
               grep -q "âœ….*LuaLaTeX.*OK" linux-tool-versions.log && \
               grep -q "âœ….*Ghostscript.*OK" linux-tool-versions.log && \
               grep -q "âœ….*Inkscape.*OK" linux-tool-versions.log; then
              echo "âœ… Essential Tools: ALL PASSED"
            else
              echo "âŒ Essential Tools: SOME FAILED"
            fi
          else
            echo "âš ï¸ Essential Tools: TEST SKIPPED (no log file)"
          fi
          
          if [ -f linux-quarto-check.log ]; then
            if grep -q "âœ….*Quarto check.*PASSED" linux-quarto-check.log; then
              echo "âœ… Quarto Check: PASSED"
            else
              echo "âŒ Quarto Check: FAILED"
            fi
          else
            echo "âš ï¸ Quarto Check: TEST SKIPPED (no log file)"
          fi
          
          echo ""
          echo "ğŸ¯ OVERALL STATUS:"
          echo "-----------------"
          if [ -f linux-tool-versions.log ] && [ -f linux-quarto-check.log ]; then
            if grep -q "âœ…" linux-tool-versions.log && \
               grep -q "âœ….*PASSED" linux-quarto-check.log; then
              echo "ğŸŸ¢ LINUX CONTAINER: FULLY OPERATIONAL âœ…"
              echo "   Ready for Quarto builds!"
            else
              echo "ğŸ”´ LINUX CONTAINER: ISSUES DETECTED âŒ"
              echo "   Check logs for details"
            fi
          else
            echo "âš ï¸ LINUX CONTAINER: TESTS SKIPPED OR INCOMPLETE"
            echo "   Some test steps may have been disabled or failed"
          fi
          echo "========================================"

      - name: ğŸ“Š Windows Container Analysis
        if: matrix.platform == 'windows' && inputs.test_windows != false
        run: |
          if (Test-Path "windows-tool-versions.log") {
            $toolsOK = (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*Quarto.*OK") -and
                       (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*Python.*OK") -and
                       (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*R.*OK") -and
                       (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*LuaLaTeX.*OK") -and
                       (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*Ghostscript.*OK") -and
                       (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*Inkscape.*OK")
            
            if ($toolsOK) {
              Write-Output "âœ… Essential Tools: ALL PASSED"
            } else {
              Write-Output "âŒ Essential Tools: SOME FAILED"
            }
          } else {
            Write-Output "âš ï¸ Essential Tools: TEST SKIPPED (no log file)"
          }
          
          if (Test-Path "windows-quarto-check.log") {
            if (Select-String -Path "windows-quarto-check.log" -Pattern "âœ….*Quarto check.*PASSED") {
              Write-Output "âœ… Quarto Check: PASSED"
            } else {
              Write-Output "âŒ Quarto Check: FAILED"
            }
          } else {
            Write-Output "âš ï¸ Quarto Check: TEST SKIPPED (no log file)"
          }
          
          Write-Output ""
          Write-Output "ğŸ¯ OVERALL STATUS:"
          Write-Output "-----------------"
          
          if ((Test-Path "windows-tool-versions.log") -and (Test-Path "windows-quarto-check.log")) {
            $toolsOK = (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*Quarto.*OK") -and
                       (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*Python.*OK") -and
                       (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*R.*OK") -and
                       (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*LuaLaTeX.*OK") -and
                       (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*Ghostscript.*OK") -and
                       (Select-String -Path "windows-tool-versions.log" -Pattern "âœ….*Inkscape.*OK")
            $checkPassed = Select-String -Path "windows-quarto-check.log" -Pattern "âœ….*PASSED"
            
            if ($toolsOK -and $checkPassed) {
              Write-Output "ğŸŸ¢ WINDOWS CONTAINER: FULLY OPERATIONAL âœ…"
              Write-Output "   Ready for Quarto builds!"
            } else {
              Write-Output "ğŸ”´ WINDOWS CONTAINER: ISSUES DETECTED âŒ"
              Write-Output "   Check logs for details"
            }
          } else {
            Write-Output "âš ï¸ WINDOWS CONTAINER: TESTS SKIPPED OR INCOMPLETE"
            Write-Output "   Some test steps may have been disabled or failed"
          }
          Write-Output "========================================"

      - name: ğŸ“¤ Upload Test Artifacts
        if: |
          (matrix.platform == 'linux' && inputs.test_linux != false) ||
          (matrix.platform == 'windows' && inputs.test_windows != false)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-container-test-results
          path: |
            ${{ matrix.platform }}-os-info.log
            ${{ matrix.platform }}-tool-versions.log
            ${{ matrix.platform }}-quarto-check.log
          retention-days: 30

  # Final summary job
  final-summary:
    needs: container-health-check
    runs-on: ubuntu-latest
    if: always()  # Always run to provide summary
    
    steps:
      - name: ğŸ¯ Final Container Health Summary
        run: |
          echo "ğŸ¯ === FINAL CONTAINER HEALTH SUMMARY ==="
          echo "=========================================="
          echo ""
          
          # Get container sizes
          LINUX_IMAGE="${{ inputs.container_registry || 'ghcr.io' }}/${{ github.repository }}/quarto-linux:${{ inputs.container_tag || 'latest' }}"
          WINDOWS_IMAGE="${{ inputs.container_registry || 'ghcr.io' }}/${{ github.repository }}/quarto-windows:${{ inputs.container_tag || 'latest' }}"
          LINUX_SIZE=$(docker images "$LINUX_IMAGE" --format "{{.Size}}" 2>/dev/null || echo "Not available")
          WINDOWS_SIZE=$(docker images "$WINDOWS_IMAGE" --format "{{.Size}}" 2>/dev/null || echo "Not available")
          
          echo "ğŸ“¦ CONTAINER SIZES:"
          echo "------------------"
          echo "ğŸ§ Linux:   $LINUX_SIZE"
          echo "ğŸªŸ Windows: $WINDOWS_SIZE"
          echo ""
          
          echo "ğŸ” TEST RESULTS:"
          echo "---------------"
          echo "âœ… Container health checks completed"
          echo "âœ… All test artifacts uploaded"
          echo ""
          
          echo "ğŸ¯ FINAL STATUS:"
          echo "---------------"
          echo "ğŸŸ¢ CONTAINER TESTING: COMPLETED SUCCESSFULLY âœ…"
          echo "ğŸ“‹ Containers validated and ready for production use"
          echo "ğŸ“Š Detailed logs available in artifacts"
          echo "========================================"