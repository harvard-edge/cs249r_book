name: 'ðŸ’Š Container Health Check'

# Comprehensive health check for Quarto build containers  
# Tests that all critical tools (R, Quarto, Inkscape, TeX Live, etc.) are properly installed
# Used by other workflows to determine optimal build strategy

on:
  workflow_dispatch:  # ðŸš€ Manual trigger for testing and debugging
    inputs:
      container_registry:
        required: false
        type: string
        default: 'ghcr.io'
        description: 'Container registry URL'
      container_tag:
        required: false
        type: string
        default: 'latest'
        description: 'Container tag to check'
      linux_container_name:
        required: false
        type: string
        default: 'quarto-linux'
        description: 'Linux container name'
      windows_container_name:
        required: false
        type: string
        default: 'quarto-windows'
        description: 'Windows container name'

      test_linux:
        required: false
        type: boolean
        default: true
        description: 'Test Linux container'
      test_windows:
        required: false
        type: boolean
        default: true
        description: 'Test Windows container'
  workflow_call:  # ðŸ“ž Called by other workflows
    inputs:
      container_registry:
        required: false
        type: string
        default: 'ghcr.io'
        description: 'Container registry URL'
      container_tag:
        required: false
        type: string
        default: 'latest'
        description: 'Container tag to check'
      linux_container_name:
        required: false
        type: string
        default: 'quarto-linux'
        description: 'Linux container name'
      windows_container_name:
        required: false
        type: string
        default: 'quarto-windows'
        description: 'Windows container name'
      test_linux:
        required: false
        type: boolean
        default: true
        description: 'Test Linux container'
      test_windows:
        required: false
        type: boolean
        default: true
        description: 'Test Windows container'

    outputs:
      linux-container-healthy:
        description: "Whether Linux container is healthy and ready"
        value: ${{ jobs.check-containers.outputs.container-healthy }}
      windows-container-healthy:
        description: "Whether Windows container is healthy and ready"
        value: ${{ jobs.check-containers.outputs.container-healthy }}
      containers-need-rebuild:
        description: "Whether containers need rebuilding"
        value: ${{ jobs.health-summary.outputs.need-rebuild }}
      container-strategy:
        description: "Recommended build strategy"
        value: ${{ jobs.health-summary.outputs.strategy }}
      linux-tools-status:
        description: "Linux container tools status"
        value: ${{ jobs.check-containers.outputs.tools-status }}
      windows-tools-status:
        description: "Windows container tools status"
        value: ${{ jobs.check-containers.outputs.tools-status }}

env:
  REGISTRY: ${{ inputs.container_registry || 'ghcr.io' }}
  LINUX_IMAGE: ${{ inputs.container_registry || 'ghcr.io' }}/${{ github.repository }}/${{ inputs.linux_container_name || 'quarto-linux' }}:${{ inputs.container_tag || 'latest' }}
  WINDOWS_IMAGE: ${{ inputs.container_registry || 'ghcr.io' }}/${{ github.repository }}/${{ inputs.windows_container_name || 'quarto-windows' }}:${{ inputs.container_tag || 'latest' }}

jobs:
  check-containers:
    name: ðŸ” ${{ matrix.platform_name }} Container Health Check
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 60
    # Run check if called by workflow_call OR if manual dispatch (platform filtering happens at step level)
    if: github.event_name == 'workflow_call' || github.event_name == 'workflow_dispatch'
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            platform_name: ðŸ§ Linux
            runner: ubuntu-latest
            container_image_env: LINUX_IMAGE
            gs_command: gs
            shell: bash
          - platform: windows
            platform_name: ðŸªŸ Windows
            runner: windows-latest
            container_image_env: WINDOWS_IMAGE
            gs_command: gswin64c
            shell: pwsh
    
    outputs:
      # Each platform's results will be captured in the health-summary job
      container-healthy: ${{ steps.health-check.outputs.healthy }}
      tools-status: ${{ steps.tool-check.outputs.status }}
      container-available: ${{ steps.availability.outputs.available }}
      platform: ${{ matrix.platform }}

    steps:
      - name: ðŸŽ¯ Check if platform should run
        id: should-run
        shell: bash
        run: |
          # For workflow_call, always run
          if [ "${{ github.event_name }}" = "workflow_call" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… Running via workflow_call - all platforms enabled"
          # For workflow_dispatch, check platform-specific inputs
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ matrix.platform }}" = "linux" ] && [ "${{ inputs.test_linux }}" = "true" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "âœ… Linux platform enabled for manual dispatch"
            elif [ "${{ matrix.platform }}" = "windows" ] && [ "${{ inputs.test_windows }}" = "true" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "âœ… Windows platform enabled for manual dispatch"
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ ${{ matrix.platform }} platform disabled for manual dispatch"
            fi
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "âŒ Unsupported event type: ${{ github.event_name }}"
          fi

      - name: ðŸ” Check Linux container availability
        id: availability-linux
        if: steps.should-run.outputs.should_run == 'true' && matrix.platform == 'linux'
        shell: bash
        timeout-minutes: 15
        run: |
          echo "ðŸ” Checking Linux container availability..."
          echo "ðŸ“Š Image: ${{ env.LINUX_IMAGE }}"
          
          if docker manifest inspect "${{ env.LINUX_IMAGE }}" >/dev/null 2>&1; then
            echo "âœ… Linux container found"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Linux container not found"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ” Check Windows container availability
        id: availability-windows
        if: steps.should-run.outputs.should_run == 'true' && matrix.platform == 'windows'
        shell: pwsh
        timeout-minutes: 15
        run: |
          Write-Output "ðŸ” Checking Windows container availability..."
          Write-Output "ðŸ“Š Image: ${{ env.WINDOWS_IMAGE }}"
          
          try {
            docker manifest inspect "${{ env.WINDOWS_IMAGE }}" | Out-Null
            Write-Output "âœ… Windows container manifest found"
            
            # Pre-pull the container to avoid timeout during tool testing
            Write-Output "ðŸ“¦ Pre-pulling Windows container (this may take a while for large containers)..."
            docker pull "${{ env.WINDOWS_IMAGE }}"
            Write-Output "âœ… Windows container pulled successfully"
            "available=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } catch {
            Write-Output "âŒ Windows container not available or pull failed: $_"
            "available=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: ðŸ“Š Set availability output
        id: availability
        if: steps.should-run.outputs.should_run == 'true'
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            echo "available=${{ steps.availability-linux.outputs.available }}" >> $GITHUB_OUTPUT
          else
            echo "available=${{ steps.availability-windows.outputs.available }}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ› ï¸ Test critical tools (Linux)
        id: tool-check-linux
        if: steps.should-run.outputs.should_run == 'true' && steps.availability.outputs.available == 'true' && matrix.platform == 'linux'
        shell: bash
        timeout-minutes: 15
        run: |
            echo "ðŸ› ï¸ Testing critical tools in Linux container..."
            
            # Test actual build commands used in workflows
            docker run --rm ${{ env.LINUX_IMAGE }} bash -c "
              echo '=== QUARTO ECOSYSTEM HEALTH CHECK ==='
              
              # Test Quarto version and check
              echo 'ðŸ” Testing Quarto...'
              if quarto --version >/dev/null 2>&1; then
                echo 'ðŸ“ Quarto location: \$(which quarto)'
                echo 'âœ… Quarto version: \$(quarto --version | head -1)'
                
                # Test quarto check (most important test!)
                echo 'ðŸ” Running quarto check...'
                if quarto check; then
                  echo 'âœ… Quarto check: PASSED'
                else
                  echo 'âŒ Quarto check: FAILED'
                  exit 1
                fi
              else
                echo 'âŒ Quarto: NOT INSTALLED'
                exit 1
              fi
              
              # Test Python (required for code execution)
              echo 'ðŸ” Testing Python...'
              if python3 --version; then
                echo 'ðŸ“ Python location: \$(which python3)'
                echo 'âœ… Python: WORKING'
              else
                echo 'âŒ Python: FAILED'
                exit 1
              fi
              
              # Test R (required for R code execution)
              echo 'ðŸ” Testing R...'
              if R --version; then
                echo 'ðŸ“ R location: \$(which R)'
                echo 'âœ… R: WORKING'
              else
                echo 'âŒ R: FAILED'
                exit 1
              fi
              
              # Test LaTeX (lualatex specifically for PDF builds)
              echo 'ðŸ” Testing LaTeX...'
              if lualatex --version; then
                echo 'âœ… LuaLaTeX: INSTALLED'
                
                # Test actual LaTeX compilation capability
                echo 'ðŸ” Testing LaTeX compilation...'
                echo '\documentclass{article}\begin{document}Test\end{document}' > test.tex
                if lualatex -interaction=nonstopmode test.tex; then
                  echo 'âœ… LaTeX compilation: WORKING'
                  rm -f test.tex test.pdf test.log test.aux
                else
                  echo 'âŒ LaTeX compilation: FAILED'
                  exit 1
                fi
              else
                echo 'âŒ LuaLaTeX: NOT INSTALLED'
                exit 1
              fi
              
              # Test Ghostscript (for PDF compression)
              echo 'ðŸ” Testing Ghostscript...'
              if gs --version; then
                echo 'âœ… Ghostscript: INSTALLED'
                
                # Test PDF compression with actual command used in builds
                echo 'ðŸ” Testing PDF compression with real workflow command...'
                # Create a minimal test PDF first
                echo '\documentclass{article}\begin{document}Test PDF for compression\end{document}' > test-compress.tex
                if lualatex -interaction=nonstopmode test-compress.tex >/dev/null 2>&1; then
                  echo 'ðŸ“„ Created test PDF for compression test'
                  
                  # Test the exact gs command used in quarto-build-container.yml
                  if gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 -dPDFSETTINGS=/ebook -dNOPAUSE -dQUIET -dBATCH -sOutputFile=test-compressed.pdf test-compress.pdf; then
                    echo 'âœ… Ghostscript PDF compression: WORKING (real workflow command)'
                    rm -f test-compress.* test-compressed.pdf
                  else
                    echo 'âŒ Ghostscript PDF compression: FAILED'
                    exit 1
                  fi
                else
                  echo 'âš ï¸ Could not create test PDF, testing basic gs command...'
                  if gs -sDEVICE=pdfwrite -dNOPAUSE -dBATCH -dQUIET; then
                    echo 'âœ… Ghostscript basic test: WORKING'
                  else
                    echo 'âŒ Ghostscript basic test: FAILED'
                    exit 1
                  fi
                fi
              else
                echo 'âŒ Ghostscript: NOT INSTALLED'
                exit 1
              fi
              
              # Test Inkscape (for SVG processing in books)
              echo 'ðŸ” Testing Inkscape...'
              if inkscape --version; then
                echo 'âœ… Inkscape: WORKING'
              else
                echo 'âŒ Inkscape: NOT INSTALLED'
                exit 1
              fi
              
              echo 'âœ… All Quarto ecosystem tools are working!'
            " && echo "status=healthy" >> $GITHUB_OUTPUT || echo "status=unhealthy" >> $GITHUB_OUTPUT

      - name: ðŸ› ï¸ Test critical tools (Windows)
        id: tool-check-windows
        if: steps.should-run.outputs.should_run == 'true' && steps.availability.outputs.available == 'true' && matrix.platform == 'windows'
        shell: pwsh
        timeout-minutes: 15
        run: |
          Write-Output "ðŸ› ï¸ Testing critical tools in Windows container..."
            
            try {
              docker run --rm ${{ env.WINDOWS_IMAGE }} pwsh -Command "
                Write-Output '=== QUARTO ECOSYSTEM HEALTH CHECK (WINDOWS) ==='
                
                # Test Quarto version and check
                Write-Output 'ðŸ” Testing Quarto...'
                try {
                  Write-Output ('ðŸ“ Quarto location: ' + (where.exe quarto))
                  quarto --version
                  Write-Output 'âœ… Quarto: INSTALLED'
                  
                  # Test quarto check (most important test!)
                  Write-Output 'ðŸ” Running quarto check...'
                  quarto check
                  Write-Output 'âœ… Quarto check: PASSED'
                } catch {
                  Write-Output 'âŒ Quarto: FAILED'
                  exit 1
                }
                
                # Test Python (required for code execution)
                Write-Output 'ðŸ” Testing Python...'
                try {
                  Write-Output ('ðŸ“ Python location: ' + (where.exe python3))
                  python3 --version
                  Write-Output 'âœ… Python: WORKING'
                } catch {
                  Write-Output 'âŒ Python: FAILED'
                  exit 1
                }
                
                # Test R (required for R code execution)
                Write-Output 'ðŸ” Testing R...'
                try {
                  Write-Output ('ðŸ“ R location: ' + (where.exe R))
                  & R --version
                  Write-Output 'âœ… R: WORKING'
                } catch {
                  Write-Output 'âŒ R: FAILED'
                  exit 1
                }
                
                # Test LaTeX (lualatex specifically for PDF builds)
                Write-Output 'ðŸ” Testing LaTeX...'
                try {
                  Write-Output ('ðŸ“ LuaLaTeX location: ' + (where.exe lualatex))
                  lualatex --version
                  Write-Output 'âœ… LuaLaTeX: INSTALLED'
                  
                  # Test actual LaTeX compilation capability
                  Write-Output 'ðŸ” Testing LaTeX compilation...'
                  '\documentclass{article}\begin{document}Test\end{document}' | Out-File -FilePath 'test.tex' -Encoding UTF8
                  lualatex -interaction=nonstopmode test.tex
                  Write-Output 'âœ… LaTeX compilation: WORKING'
                  Remove-Item -Path 'test.*' -Force -ErrorAction SilentlyContinue
                } catch {
                  Write-Output 'âŒ LaTeX: FAILED'
                  exit 1
                }
                
                # Test Ghostscript (for PDF compression - Windows uses gswin64c)
                Write-Output 'ðŸ” Testing Ghostscript...'
                try {
                  Write-Output ('ðŸ“ Ghostscript location: ' + (where.exe gswin64c))
                  gswin64c --version
                  Write-Output 'âœ… Ghostscript: INSTALLED'
                  
                  # Test PDF compression with actual command used in builds
                  Write-Output 'ðŸ” Testing PDF compression with real workflow command...'
                  # Create a minimal test PDF first
                  '\documentclass{article}\begin{document}Test PDF for compression\end{document}' | Out-File -FilePath 'test-compress.tex' -Encoding UTF8
                  try {
                    \$null = lualatex -interaction=nonstopmode test-compress.tex 2>\$null
                    Write-Output 'ðŸ“„ Created test PDF for compression test'
                    
                    # Test the exact gswin64c command used in quarto-build-container.yml
                    gswin64c -sDEVICE=pdfwrite -dCompatibilityLevel:1.4 -dPDFSETTINGS=/ebook -dNOPAUSE -dBATCH -sOutputFile=test-compressed.pdf test-compress.pdf
                    Write-Output 'âœ… Ghostscript PDF compression: WORKING (real workflow command)'
                    Remove-Item -Path 'test-compress.*', 'test-compressed.pdf' -Force -ErrorAction SilentlyContinue
                  } catch {
                    Write-Output 'âš ï¸ Could not create test PDF, testing basic gswin64c command...'
                    gswin64c -sDEVICE=pdfwrite -dNOPAUSE -dBATCH -dQUIET
                    Write-Output 'âœ… Ghostscript basic test: WORKING'
                  }
                } catch {
                  Write-Output 'âŒ Ghostscript: FAILED'
                  exit 1
                }
                
                Write-Output 'âœ… All Quarto ecosystem tools are working!'
              "
              "status=healthy" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            } catch {
              "status=unhealthy" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            }

      - name: ðŸ“Š Set tool check output
        id: tool-check
        if: steps.should-run.outputs.should_run == 'true'
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            echo "status=${{ steps.tool-check-linux.outputs.status }}" >> $GITHUB_OUTPUT
          else
            echo "status=${{ steps.tool-check-windows.outputs.status }}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸŽ¯ ${{ matrix.platform_name }} container health summary
        id: health-check
        if: always()
        shell: bash
        run: |
          # Check if platform should run
          if [ "${{ steps.should-run.outputs.should_run }}" != "true" ]; then
            echo "healthy=skipped" >> $GITHUB_OUTPUT
            echo "â­ï¸ ${{ matrix.platform_name }} platform was skipped"
            exit 0
          fi
          
          # Linux/Bash version
          if [ "${{ matrix.platform }}" = "linux" ]; then
            if [ "${{ steps.availability.outputs.available }}" = "true" ] && [ "${{ steps.tool-check.outputs.status }}" = "healthy" ]; then
              echo "healthy=true" >> $GITHUB_OUTPUT
              echo "âœ… Linux container is healthy and ready"
            else
              echo "healthy=false" >> $GITHUB_OUTPUT
              echo "âŒ Linux container health check failed"
            fi
          fi
          
          # Windows version (using bash syntax)
          if [ "${{ matrix.platform }}" = "windows" ]; then
            if [ "${{ steps.availability.outputs.available }}" = "true" ] && [ "${{ steps.tool-check.outputs.status }}" = "healthy" ]; then
              echo "healthy=true" >> $GITHUB_OUTPUT
              echo "âœ… Windows container is healthy and ready"
            else
              echo "healthy=false" >> $GITHUB_OUTPUT
              echo "âŒ Windows container health check failed"
            fi
          fi

  health-summary:
    name: ðŸ“Š Health Summary  
    needs: [check-containers]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      need-rebuild: ${{ steps.summary.outputs.need-rebuild }}
      strategy: ${{ steps.summary.outputs.strategy }}
    
    steps:
      - name: ðŸ“Š Generate health summary
        id: summary
        run: |
          echo "ðŸ“Š Container Health Summary"
          echo "=========================="
          
          # Extract results from matrix job
          LINUX_RESULT="${{ toJson(needs.check-containers.result) }}"
          WINDOWS_RESULT="${{ toJson(needs.check-containers.result) }}"
          
          # Get outputs from each matrix job - need to parse the matrix outputs
          # For now, we'll check if the overall job succeeded and parse from there
          MATRIX_OUTPUTS='${{ toJson(needs.check-containers.outputs) }}'
          
          # Default values
          LINUX_HEALTHY="unknown"
          WINDOWS_HEALTHY="unknown"
          LINUX_SKIPPED="false" 
          WINDOWS_SKIPPED="false"
          LINUX_FAILED="false"
          WINDOWS_FAILED="false"
          LINUX_CANCELLED="false"
          WINDOWS_CANCELLED="false"
          
          # Check overall job status
          if [ "${{ needs.check-containers.result }}" = "skipped" ]; then
            LINUX_SKIPPED="true"
            WINDOWS_SKIPPED="true"
          elif [ "${{ needs.check-containers.result }}" = "failure" ]; then
            LINUX_FAILED="true"
            WINDOWS_FAILED="true"
          elif [ "${{ needs.check-containers.result }}" = "cancelled" ]; then
            LINUX_CANCELLED="true" 
            WINDOWS_CANCELLED="true"
          elif [ "${{ needs.check-containers.result }}" = "success" ]; then
            # Assume healthy if job succeeded (simplified for now)
            LINUX_HEALTHY="true"
            WINDOWS_HEALTHY="true"
          fi
          
          # Create detailed status table
          echo ""
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚                   ðŸ¥ CONTAINER HEALTH STATUS                   â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ Platform â”‚ Status    â”‚ Available â”‚ Tools â”‚ Result          â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          
          # Linux status
          if [ "$LINUX_SKIPPED" = "true" ]; then
            echo "â”‚ ðŸ§ Linux  â”‚ â­ï¸ SKIP    â”‚    â­ï¸      â”‚  â­ï¸   â”‚ Not tested      â”‚"
            LINUX_HEALTHY="skipped"
          elif [ "$LINUX_CANCELLED" = "true" ]; then
            echo "â”‚ ðŸ§ Linux  â”‚ â¹ï¸ CANCEL  â”‚    â“      â”‚  â“   â”‚ Cancelled       â”‚"
            LINUX_HEALTHY="cancelled"
          elif [ "$LINUX_FAILED" = "true" ]; then
            echo "â”‚ ðŸ§ Linux  â”‚ âŒ FAIL    â”‚    â“      â”‚  â“   â”‚ Failed          â”‚"
            LINUX_HEALTHY="failed"
          elif [ "$LINUX_HEALTHY" = "true" ]; then
            echo "â”‚ ðŸ§ Linux  â”‚ âœ… HEALTHY â”‚    âœ…      â”‚  âœ…   â”‚ All tools OK    â”‚"
          else
            echo "â”‚ ðŸ§ Linux  â”‚ âŒ UNHEALTHYâ”‚   â“      â”‚  âŒ   â”‚ Tool issues     â”‚"
          fi
          
          # Windows status
          if [ "$WINDOWS_SKIPPED" = "true" ]; then
            echo "â”‚ ðŸªŸ Windowsâ”‚ â­ï¸ SKIP    â”‚    â­ï¸      â”‚  â­ï¸   â”‚ Not tested      â”‚"
            WINDOWS_HEALTHY="skipped"
          elif [ "$WINDOWS_CANCELLED" = "true" ]; then
            echo "â”‚ ðŸªŸ Windowsâ”‚ â¹ï¸ CANCEL  â”‚    â“      â”‚  â“   â”‚ Timeout/Cancel  â”‚"
            WINDOWS_HEALTHY="cancelled"
          elif [ "$WINDOWS_FAILED" = "true" ]; then
            echo "â”‚ ðŸªŸ Windowsâ”‚ âŒ FAIL    â”‚    â“      â”‚  â“   â”‚ Failed          â”‚"
            WINDOWS_HEALTHY="failed"
          elif [ "$WINDOWS_HEALTHY" = "true" ]; then
            echo "â”‚ ðŸªŸ Windowsâ”‚ âœ… HEALTHY â”‚    âœ…      â”‚  âœ…   â”‚ All tools OK    â”‚"
          else
            echo "â”‚ ðŸªŸ Windowsâ”‚ âŒ UNHEALTHYâ”‚   â“      â”‚  âŒ   â”‚ Tool issues     â”‚"
          fi
          
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # Tool status breakdown  
          echo "ðŸ› ï¸ Tool Status Breakdown:"
          echo "========================"
          # Matrix jobs make it complex to extract individual platform results
          # For now, we'll use the overall status to determine tool health
          
          if [ "$LINUX_HEALTHY" = "true" ]; then
            echo "ðŸ§ Linux Container Tools:"
            echo "  âœ… Quarto (with quarto check)"
            echo "  âœ… Python3" 
            echo "  âœ… R"
            echo "  âœ… LuaLaTeX (with compilation test)"
            echo "  âœ… Ghostscript (with PDF compression test)"
            echo "  âœ… Inkscape"
          elif [ "$LINUX_HEALTHY" = "skipped" ]; then
            echo "ðŸ§ Linux Container: â­ï¸ Skipped - no tool data"
          elif [ "$LINUX_HEALTHY" = "cancelled" ]; then
            echo "ðŸ§ Linux Container: â¹ï¸ Cancelled - no tool data"
          else
            echo "ðŸ§ Linux Container: âŒ Failed health check - some tools may be missing"
          fi
          
          echo ""
          
          if [ "$WINDOWS_HEALTHY" = "true" ]; then
            echo "ðŸªŸ Windows Container Tools:"
            echo "  âœ… Quarto (with quarto check)"
            echo "  âœ… Python3"
            echo "  âœ… R" 
            echo "  âœ… LuaLaTeX (with compilation test)"
            echo "  âœ… Ghostscript/gswin64c (with PDF compression test)"
          elif [ "$WINDOWS_HEALTHY" = "skipped" ]; then
            echo "ðŸªŸ Windows Container: â­ï¸ Skipped - no tool data"
          elif [ "$WINDOWS_HEALTHY" = "cancelled" ]; then
            echo "ðŸªŸ Windows Container: â¹ï¸ Cancelled/Timeout - container may be too large or slow"
          else
            echo "ðŸªŸ Windows Container: âŒ Failed health check - some tools may be missing"
          fi
          
          echo ""
          
          # Determine strategy based on what was tested and results
          HEALTHY_COUNT=0
          TOTAL_TESTED=0
          
          # Count healthy and tested containers
          if [ "$LINUX_HEALTHY" = "true" ]; then
            HEALTHY_COUNT=$((HEALTHY_COUNT + 1))
          fi
          if [ "$WINDOWS_HEALTHY" = "true" ]; then
            HEALTHY_COUNT=$((HEALTHY_COUNT + 1))
          fi
          if [ "$LINUX_HEALTHY" != "skipped" ]; then
            TOTAL_TESTED=$((TOTAL_TESTED + 1))
          fi
          if [ "$WINDOWS_HEALTHY" != "skipped" ]; then
            TOTAL_TESTED=$((TOTAL_TESTED + 1))
          fi
          
          # Determine strategy
          echo "ðŸŽ¯ Build Strategy Recommendation:"
          echo "================================="
          if [ "$HEALTHY_COUNT" -gt 0 ] && [ "$TOTAL_TESTED" -gt 0 ] && [ "$HEALTHY_COUNT" -eq "$TOTAL_TESTED" ]; then
            STRATEGY="container"
            NEED_REBUILD="false"
            if [ "$TOTAL_TESTED" -eq 1 ]; then
              echo "âœ… RESULT: Use container builds (tested container is healthy)"
            else
              echo "âœ… RESULT: Use container builds (all tested containers healthy)"
            fi
            echo "ðŸš€ Action: Use existing containers for fast builds"
          elif [ "$HEALTHY_COUNT" -gt 0 ]; then
            STRATEGY="hybrid"
            NEED_REBUILD="false"
            echo "âš¡ RESULT: Use hybrid approach (some containers healthy)"
            echo "ðŸ”„ Action: Use healthy containers where possible, fallback for others"
          elif [ "$TOTAL_TESTED" -eq 0 ]; then
            STRATEGY="unknown"
            NEED_REBUILD="true"
            echo "â“ RESULT: Cannot determine strategy (no containers tested)"
            echo "ðŸ” Action: Run health check with containers enabled"
          else
            STRATEGY="baremetal" 
            NEED_REBUILD="true"
            echo "ðŸ”§ RESULT: Use baremetal builds (no healthy containers)"
            echo "ðŸ—ï¸ Action: Rebuild containers or use GitHub runners directly"
          fi
          
          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT
          echo "need-rebuild=$NEED_REBUILD" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ“‹ Summary:"
          echo "  Strategy: $STRATEGY"
          echo "  Rebuild needed: $NEED_REBUILD"
          echo "  Tested: $TOTAL_TESTED containers"
          echo "  Healthy: $HEALTHY_COUNT containers"
