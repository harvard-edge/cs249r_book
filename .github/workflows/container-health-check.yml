name: '🔍 Container Health Check'

# Comprehensive health check for Quarto build containers  
# Tests that all critical tools (R, Quarto, Inkscape, TeX Live, etc.) are properly installed
# Used by other workflows to determine optimal build strategy

on:
  workflow_dispatch:  # 🚀 Manual trigger for testing and debugging
    inputs:
      container_registry:
        required: false
        type: string
        default: 'ghcr.io'
        description: 'Container registry URL'
      container_tag:
        required: false
        type: string
        default: 'latest'
        description: 'Container tag to check'
      linux_container_name:
        required: false
        type: string
        default: 'quarto-linux'
        description: 'Linux container name'
      windows_container_name:
        required: false
        type: string
        default: 'quarto-windows'
        description: 'Windows container name'

      test_linux:
        required: false
        type: boolean
        default: true
        description: 'Test Linux container'
      test_windows:
        required: false
        type: boolean
        default: true
        description: 'Test Windows container'
  workflow_call:  # 📞 Called by other workflows
    inputs:
      container_registry:
        required: false
        type: string
        default: 'ghcr.io'
        description: 'Container registry URL'
      container_tag:
        required: false
        type: string
        default: 'latest'
        description: 'Container tag to check'
      linux_container_name:
        required: false
        type: string
        default: 'quarto-linux'
        description: 'Linux container name'
      windows_container_name:
        required: false
        type: string
        default: 'quarto-windows'
        description: 'Windows container name'

    outputs:
      linux-container-healthy:
        description: "Whether Linux container is healthy and ready"
        value: ${{ jobs.check-linux-container.outputs.container-healthy }}
      windows-container-healthy:
        description: "Whether Windows container is healthy and ready"
        value: ${{ jobs.check-windows-container.outputs.container-healthy }}
      containers-need-rebuild:
        description: "Whether containers need rebuilding"
        value: ${{ jobs.health-summary.outputs.need-rebuild }}
      container-strategy:
        description: "Recommended build strategy"
        value: ${{ jobs.health-summary.outputs.strategy }}
      linux-tools-status:
        description: "Linux container tools status"
        value: ${{ jobs.check-linux-container.outputs.tools-status }}
      windows-tools-status:
        description: "Windows container tools status" 
        value: ${{ jobs.check-windows-container.outputs.tools-status }}

env:
  REGISTRY: ${{ inputs.container_registry || 'ghcr.io' }}
  LINUX_IMAGE: ${{ inputs.container_registry || 'ghcr.io' }}/${{ github.repository }}/${{ inputs.linux_container_name || 'quarto-linux' }}:${{ inputs.container_tag || 'latest' }}
  WINDOWS_IMAGE: ${{ inputs.container_registry || 'ghcr.io' }}/${{ github.repository }}/${{ inputs.windows_container_name || 'quarto-windows' }}:${{ inputs.container_tag || 'latest' }}

jobs:
  check-linux-container:
    name: 🐧 Linux Container Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Run Linux check if called by workflow_call OR if manual dispatch with test_linux enabled
    if: github.event_name == 'workflow_call' || (github.event_name == 'workflow_dispatch' && inputs.test_linux == true)
    outputs:
      container-healthy: ${{ steps.health-check.outputs.healthy }}
      tools-status: ${{ steps.tool-check.outputs.status }}
      container-available: ${{ steps.availability.outputs.available }}
    
    steps:
      - name: 🔍 Check container availability
        id: availability
        run: |
          echo "🔍 Checking Linux container availability..."
          echo "📊 Image: ${{ env.LINUX_IMAGE }}"
          
          if docker manifest inspect "${{ env.LINUX_IMAGE }}" >/dev/null 2>&1; then
            echo "✅ Linux container found"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Linux container not found"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0  # Don't fail the job, just mark as unavailable
          fi

      - name: 🛠️ Test critical tools
        id: tool-check
        if: steps.availability.outputs.available == 'true'
        run: |
          echo "🛠️ Testing critical tools in Linux container..."
          
          # List of critical tools to test
          TOOLS_STATUS="✅"
          FAILED_TOOLS=""
          
          echo "📊 Testing tool versions and availability:"
          
          # Test actual build commands used in workflows
          docker run --rm ${{ env.LINUX_IMAGE }} bash -c "
            echo '=== QUARTO ECOSYSTEM HEALTH CHECK ==='
            
            # Test Quarto version and check
            echo '🔍 Testing Quarto...'
            if quarto --version >/dev/null 2>&1; then
              echo '✅ Quarto version: \$(quarto --version | head -1)'
              
              # Test quarto check (most important test!)
              if quarto check >/dev/null 2>&1; then
                echo '✅ Quarto check: PASSED'
              else
                echo '❌ Quarto check: FAILED'
                exit 1
              fi
            else
              echo '❌ Quarto: NOT INSTALLED'
              exit 1
            fi
            
            # Test Python (required for code execution)
            echo '🔍 Testing Python...'
            if python3 --version >/dev/null 2>&1; then
              echo '✅ Python: \$(python3 --version)'
            else
              echo '❌ Python: FAILED'
              exit 1
            fi
            
            # Test R (required for R code execution)
            echo '🔍 Testing R...'
            if R --version >/dev/null 2>&1; then
              echo '✅ R: \$(R --version | head -1)'
            else
              echo '❌ R: FAILED'
              exit 1
            fi
            
            # Test LaTeX (lualatex specifically for PDF builds)
            echo '🔍 Testing LaTeX...'
            if lualatex --version >/dev/null 2>&1; then
              echo '✅ LuaLaTeX: \$(lualatex --version | head -1)'
              
              # Test actual LaTeX compilation capability
              echo '\documentclass{article}\begin{document}Test\end{document}' > test.tex
              if lualatex -interaction=nonstopmode test.tex >/dev/null 2>&1; then
                echo '✅ LaTeX compilation: WORKING'
                rm -f test.tex test.pdf test.log test.aux
              else
                echo '❌ LaTeX compilation: FAILED'
                exit 1
              fi
            else
              echo '❌ LuaLaTeX: NOT INSTALLED'
              exit 1
            fi
            
            # Test Ghostscript (for PDF compression)
            echo '🔍 Testing Ghostscript...'
            if gs --version >/dev/null 2>&1; then
              echo '✅ Ghostscript: \$(gs --version | head -1)'
              
              # Test PDF compression capability (the actual command used)
              echo 'Testing PDF compression with gs -sDEVICE=pdfwrite...'
              if gs -sDEVICE=pdfwrite -dNOPAUSE -dBATCH -dQUIET >/dev/null 2>&1; then
                echo '✅ Ghostscript PDF compression: WORKING'
              else
                echo '⚠️ Ghostscript PDF compression: CHECK FAILED'
              fi
            else
              echo '❌ Ghostscript: NOT INSTALLED'
              exit 1
            fi
            
            # Test Inkscape (for SVG processing in books)
            echo '🔍 Testing Inkscape...'
            if inkscape --version >/dev/null 2>&1; then
              echo '✅ Inkscape: \$(inkscape --version | head -1)'
            else
              echo '❌ Inkscape: NOT INSTALLED'
              exit 1
            fi
            
            echo '✅ All Quarto ecosystem tools are working!'
          " && echo "status=healthy" >> $GITHUB_OUTPUT || echo "status=unhealthy" >> $GITHUB_OUTPUT

      - name: 🎯 Linux container health summary
        id: health-check
        if: always()
        run: |
          if [ "${{ steps.availability.outputs.available }}" = "true" ] && [ "${{ steps.tool-check.outputs.status }}" = "healthy" ]; then
            echo "healthy=true" >> $GITHUB_OUTPUT
            echo "✅ Linux container is healthy and ready"
          else
            echo "healthy=false" >> $GITHUB_OUTPUT
            echo "❌ Linux container health check failed"
          fi

  check-windows-container:
    name: 🪟 Windows Container Health Check
    runs-on: windows-latest
    timeout-minutes: 10
    # Run Windows check if called by workflow_call OR if manual dispatch with test_windows enabled
    if: github.event_name == 'workflow_call' || (github.event_name == 'workflow_dispatch' && inputs.test_windows == true)
    outputs:
      container-healthy: ${{ steps.health-check.outputs.healthy }}
      tools-status: ${{ steps.tool-check.outputs.status }}
      container-available: ${{ steps.availability.outputs.available }}
    
    steps:
      - name: 🔍 Check container availability
        id: availability
        shell: pwsh
        run: |
          Write-Output "🔍 Checking Windows container availability..."
          Write-Output "📊 Image: ${{ env.WINDOWS_IMAGE }}"
          
          try {
            docker manifest inspect "${{ env.WINDOWS_IMAGE }}" | Out-Null
            Write-Output "✅ Windows container found"
            "available=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } catch {
            Write-Output "❌ Windows container not found"
            "available=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: 🛠️ Test critical tools
        id: tool-check
        if: steps.availability.outputs.available == 'true'
        shell: pwsh
        run: |
          Write-Output "🛠️ Testing critical tools in Windows container..."
          
          try {
            docker run --rm ${{ env.WINDOWS_IMAGE }} pwsh -Command "
              Write-Output '=== QUARTO ECOSYSTEM HEALTH CHECK (WINDOWS) ==='
              
              # Test Quarto version and check
              Write-Output '🔍 Testing Quarto...'
              if (Get-Command quarto -ErrorAction SilentlyContinue) {
                Write-Output ('✅ Quarto version: ' + (quarto --version | Select-Object -First 1))
                
                # Test quarto check (most important test!)
                try {
                  \$null = quarto check 2>\$null
                  Write-Output '✅ Quarto check: PASSED'
                } catch {
                  Write-Output '❌ Quarto check: FAILED'
                  exit 1
                }
              } else {
                Write-Output '❌ Quarto: NOT INSTALLED'
                exit 1
              }
              
              # Test Python (required for code execution)
              Write-Output '🔍 Testing Python...'
              if (Get-Command python3 -ErrorAction SilentlyContinue) {
                Write-Output ('✅ Python: ' + (python3 --version))
              } else {
                Write-Output '❌ Python: FAILED'
                exit 1
              }
              
              # Test R (required for R code execution)
              Write-Output '🔍 Testing R...'
              if (Get-Command R -ErrorAction SilentlyContinue) {
                Write-Output ('✅ R: ' + (R --version | Select-Object -First 1))
              } else {
                Write-Output '❌ R: FAILED'
                exit 1
              }
              
              # Test LaTeX (lualatex specifically for PDF builds)
              Write-Output '🔍 Testing LaTeX...'
              if (Get-Command lualatex -ErrorAction SilentlyContinue) {
                Write-Output ('✅ LuaLaTeX: ' + (lualatex --version | Select-Object -First 1))
                
                # Test actual LaTeX compilation capability
                '\documentclass{article}\begin{document}Test\end{document}' | Out-File -FilePath 'test.tex' -Encoding UTF8
                try {
                  \$null = lualatex -interaction=nonstopmode test.tex 2>\$null
                  Write-Output '✅ LaTeX compilation: WORKING'
                  Remove-Item -Path 'test.*' -Force -ErrorAction SilentlyContinue
                } catch {
                  Write-Output '❌ LaTeX compilation: FAILED'
                  exit 1
                }
              } else {
                Write-Output '❌ LuaLaTeX: NOT INSTALLED'
                exit 1
              }
              
              # Test Ghostscript (for PDF compression - Windows uses gswin64c)
              Write-Output '🔍 Testing Ghostscript...'
              if (Get-Command gswin64c -ErrorAction SilentlyContinue) {
                Write-Output ('✅ Ghostscript: ' + (gswin64c --version | Select-Object -First 1))
                
                # Test PDF compression capability (the actual command used)
                Write-Output 'Testing PDF compression with gswin64c -sDEVICE=pdfwrite...'
                try {
                  \$null = gswin64c -sDEVICE=pdfwrite -dNOPAUSE -dBATCH -dQUIET 2>\$null
                  Write-Output '✅ Ghostscript PDF compression: WORKING'
                } catch {
                  Write-Output '⚠️ Ghostscript PDF compression: CHECK FAILED'
                }
              } else {
                Write-Output '❌ Ghostscript: NOT INSTALLED'
                exit 1
              }
              
              Write-Output '✅ All Quarto ecosystem tools are working!'
            "
            "status=healthy" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } catch {
            "status=unhealthy" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: 🎯 Windows container health summary
        id: health-check
        if: always()
        shell: pwsh
        run: |
          if ("${{ steps.availability.outputs.available }}" -eq "true" -and "${{ steps.tool-check.outputs.status }}" -eq "healthy") {
            "healthy=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Output "✅ Windows container is healthy and ready"
          } else {
            "healthy=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Output "❌ Windows container health check failed"
          }

  health-summary:
    name: 📊 Health Summary
    needs: [check-linux-container, check-windows-container]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      need-rebuild: ${{ steps.summary.outputs.need-rebuild }}
      strategy: ${{ steps.summary.outputs.strategy }}
    
    steps:
      - name: 📊 Generate health summary
        id: summary
        run: |
          echo "📊 Container Health Summary"
          echo "=========================="
          
          LINUX_HEALTHY="${{ needs.check-linux-container.outputs.container-healthy }}"
          WINDOWS_HEALTHY="${{ needs.check-windows-container.outputs.container-healthy }}"
          LINUX_SKIPPED="${{ needs.check-linux-container.result == 'skipped' }}"
          WINDOWS_SKIPPED="${{ needs.check-windows-container.result == 'skipped' }}"
          
          # Display Linux status
          if [ "$LINUX_SKIPPED" = "true" ]; then
            echo "🐧 Linux container: ⏭️ SKIPPED (unchecked in manual run)"
            LINUX_HEALTHY="skipped"
          else
            echo "🐧 Linux container: $LINUX_HEALTHY"
          fi
          
          # Display Windows status  
          if [ "$WINDOWS_SKIPPED" = "true" ]; then
            echo "🪟 Windows container: ⏭️ SKIPPED (unchecked in manual run)"
            WINDOWS_HEALTHY="skipped"
          else
            echo "🪟 Windows container: $WINDOWS_HEALTHY"
          fi
          
          # Determine strategy based on what was tested and results
          HEALTHY_COUNT=0
          TOTAL_TESTED=0
          
          # Count healthy and tested containers
          if [ "$LINUX_HEALTHY" = "true" ]; then
            HEALTHY_COUNT=$((HEALTHY_COUNT + 1))
          fi
          if [ "$WINDOWS_HEALTHY" = "true" ]; then
            HEALTHY_COUNT=$((HEALTHY_COUNT + 1))
          fi
          if [ "$LINUX_HEALTHY" != "skipped" ]; then
            TOTAL_TESTED=$((TOTAL_TESTED + 1))
          fi
          if [ "$WINDOWS_HEALTHY" != "skipped" ]; then
            TOTAL_TESTED=$((TOTAL_TESTED + 1))
          fi
          
          # Determine strategy
          if [ "$HEALTHY_COUNT" -gt 0 ] && [ "$TOTAL_TESTED" -gt 0 ] && [ "$HEALTHY_COUNT" -eq "$TOTAL_TESTED" ]; then
            STRATEGY="container"
            NEED_REBUILD="false"
            if [ "$TOTAL_TESTED" -eq 1 ]; then
              echo "✅ Tested container is healthy - use container builds"
            else
              echo "✅ All tested containers healthy - use container builds"
            fi
          elif [ "$HEALTHY_COUNT" -gt 0 ]; then
            STRATEGY="hybrid"
            NEED_REBUILD="false"
            echo "⚡ Some tested containers healthy - use hybrid approach"
          elif [ "$TOTAL_TESTED" -eq 0 ]; then
            STRATEGY="unknown"
            NEED_REBUILD="true"
            echo "❓ No containers tested - cannot determine strategy"
          else
            STRATEGY="baremetal"
            NEED_REBUILD="true"
            echo "🔧 No healthy containers - rebuild needed, use baremetal"
          fi
          
          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT
          echo "need-rebuild=$NEED_REBUILD" >> $GITHUB_OUTPUT
          
          echo ""
          echo "📋 Recommended strategy: $STRATEGY"
          echo "🔧 Rebuild needed: $NEED_REBUILD"
