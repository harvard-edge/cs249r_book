name: 'ðŸ“š Quarto Build (Container)'

# Set retention period to 7 days
env:
  GITHUB_ACTIONS_RETENTION_DAYS: 7

# Cancel duplicate builds for same target+os+format combination
concurrency:
  group: quarto-build-${{ inputs.target }}-${{ inputs.build_os }}-${{ inputs.build_format }}-${{ github.sha }}
  cancel-in-progress: true

# This workflow uses pre-built containers with all dependencies installed
# Containers include fixed versions of Quarto, R, Python, TeX Live, etc.
# This is the primary workflow for fast, consistent builds
on:
  workflow_dispatch:
    inputs:
      build_format:
        required: false
        type: choice
        default: 'both'
        description: 'Formats to build'
        options:
          - html
          - pdf
          - both
      build_os:
        required: false
        type: choice
        default: 'both'
        description: 'Operating systems to build on'
        options:
          - linux
          - windows
          - both
      target:
        required: false
        type: choice
        default: 'dev'
        description: 'Target branch (dev/main) - determines build behavior'
        options:
          - dev
          - main
      quarto-log-level:
        required: false
        type: choice
        default: 'INFO'
        description: 'Quarto log level'
        options:
          - INFO
          - DEBUG
      artifact_name_template:
        required: false
        type: string
        default: '{prefix}-{format}-{os}'
        description: 'Artifact naming pattern. Example: "book-html-linux" (prefix=book, format=html, os=linux)'
  workflow_call:
    inputs:
      build_format:
        required: false
        type: string
        default: 'both'
        description: 'Formats to build (html/pdf/both)'
      build_os:
        required: false
        type: string
        default: 'both'
        description: 'Operating systems to build on (linux/windows/both)'
      target:
        required: false
        type: string
        default: ''
        description: 'Target branch (dev/main) - determines build behavior'
      # Container configuration (optional overrides)
      container_registry:
        required: false
        type: string
        default: 'ghcr.io'
        description: 'Container registry URL'
      container_tag:
        required: false
        type: string
        default: 'latest'
        description: 'Container tag to use'
      # Legacy inputs for backward compatibility (if needed)
      format:
        required: false
        type: string
        default: ''
        description: 'Legacy format input - use build_format instead'
      os:
        required: false
        type: string
        default: ''
        description: 'Legacy OS input - use build_os instead'

    outputs:
      html-artifact-name:
        description: "Name of uploaded HTML artifact (if built)"
        value: ${{ jobs.build.outputs.html-artifact-name }}
      pdf-artifact-name:
        description: "Name of uploaded PDF artifact (if built)"
        value: ${{ jobs.build.outputs.pdf-artifact-name }}
      build-status:
        description: "Overall build status (success/failure/skipped)"
        value: ${{ jobs.build.outputs.build-status }}
      formats-built:
        description: "Comma-separated list of formats that were built"
        value: ${{ jobs.build.outputs.formats-built }}

permissions:
  contents: write
  pages: write

jobs:
  # Unified build job using matrix strategy (filtered by input)
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - format: html
            os: ubuntu-latest
            os_name: linux
            container_name: quarto-linux
          - format: pdf
            os: ubuntu-latest
            os_name: linux
            container_name: quarto-linux
          - format: html
            os: windows-latest
            os_name: windows
            container_name: quarto-windows
          - format: pdf
            os: windows-latest
            os_name: windows
            container_name: quarto-windows
    # Container directive only works on Linux runners - Windows containers handled in steps
    container: ${{ matrix.os_name == 'linux' && format('{0}/{1}/{2}:{3}', inputs.container_registry || 'ghcr.io', github.repository, matrix.container_name, inputs.container_tag || 'latest') || '' }}
    timeout-minutes: 120
    # Matrix job will run for both OS options, filtering handled in steps
    outputs:
      html-artifact-name: ${{ steps.upload-html-artifacts.outputs.artifact-id }}
      pdf-artifact-name: ${{ steps.upload-pdf-artifacts.outputs.artifact-id }}
      build-status: ${{ steps.build-summary.outputs.status }}
      formats-built: ${{ steps.build-summary.outputs.formats }}
    env:
      QUARTO_LOG_LEVEL: ${{ inputs.quarto-log-level || 'INFO' }}
      OS_NAME: ${{ matrix.os_name }}
      PYTHONIOENCODING: utf-8
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    steps:
      - name: ðŸŽ¯ Check if this matrix job should run
        id: should-run
        shell: bash
        run: |
          # Check if format is enabled
          FORMAT_ENABLED=false
          if [ "${{ inputs.build_format }}" = "${{ matrix.format }}" ] || [ "${{ inputs.build_format }}" = "both" ] || [ "${{ inputs.build_format }}" = "" ]; then
            FORMAT_ENABLED=true
          fi
          
          # Check if OS is enabled
          OS_ENABLED=false
          if [ "${{ inputs.build_os }}" = "${{ matrix.os_name }}" ] || [ "${{ inputs.build_os }}" = "both" ] || [ "${{ inputs.build_os }}" = "" ]; then
            OS_ENABLED=true
          fi
          
          # Only run if both format and OS are enabled
          if [ "$FORMAT_ENABLED" = "true" ] && [ "$OS_ENABLED" = "true" ]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "âœ… Running build: ${{ matrix.format }} on ${{ matrix.os_name }}"
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping: ${{ matrix.format }} on ${{ matrix.os_name }}"
          fi

      - name: ðŸ“Š Build Configuration Summary
        if: steps.should-run.outputs.should-run == 'true'
        shell: bash
        run: |
          echo "ðŸ“Š Build configuration:"
          echo "  Format: ${{ matrix.format }}"
          echo "  OS: ${{ matrix.os_name }}"
          echo "  Container: ${{ matrix.container_name }}"
          echo "  Target: ${{ inputs.target }}"

      - name: ðŸš¦ Set Initial Build Status
        if: steps.should-run.outputs.should-run == 'true'
        shell: bash
        run: |
          echo "ðŸš¦ Setting initial build status to pending..."
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
            -d "{
              \"state\": \"pending\",
              \"description\": \"Quarto build started (${{ matrix.os_name }} container)\",
              \"context\": \"ci/quarto-build-${{ matrix.os_name }}-${{ matrix.format }}\"
            }"

      - name: ðŸ“¥ Checkout repository
        if: steps.should-run.outputs.should-run == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ³ Setup Windows Container (Manual)
        if: steps.should-run.outputs.should-run == 'true' && matrix.os_name == 'windows'
        shell: pwsh
        run: |
          # Windows containers must be handled manually since GitHub Actions container: only works on Linux
          $CONTAINER_REGISTRY = "${{ inputs.container_registry || 'ghcr.io' }}"
          $CONTAINER_IMAGE = "$CONTAINER_REGISTRY/${{ github.repository }}/${{ matrix.container_name }}:${{ inputs.container_tag || 'latest' }}"
          
          Write-Output "ðŸ³ Setting up Windows container manually..."
          Write-Output "ðŸ“Š Container Image: $CONTAINER_IMAGE"
          
          # Login to container registry
          Write-Output "ðŸ” Logging into container registry..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login $CONTAINER_REGISTRY -u ${{ github.actor }} --password-stdin
          
          # Pull the container
          Write-Output "ðŸ“¦ Pulling Windows container (this may take a while)..."
          docker pull $CONTAINER_IMAGE
          
          # Test the container
          Write-Output "ðŸ§ª Testing Windows container..."
          docker run --rm $CONTAINER_IMAGE cmd /c "echo Container is working"
          
          Write-Output "âœ… Windows container setup complete"
          
          # Store container image for later steps
          echo "WINDOWS_CONTAINER_IMAGE=$CONTAINER_IMAGE" >> $env:GITHUB_ENV

      - name: ðŸ“‹ Container Environment Info
        if: steps.should-run.outputs.should-run == 'true'
        shell: bash
        run: |
          echo "ðŸ”„ Container build environment information..."
          echo "ðŸ“Š Container Configuration:"
          echo "  Registry: ${{ inputs.container_registry }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  Container: ${{ matrix.container_name }}"
          echo "  Tag: ${{ inputs.container_tag }}"
          echo "  Full Image: ${{ format('{0}/{1}/{2}:{3}', inputs.container_registry, github.repository, matrix.container_name, inputs.container_tag) }}"
          echo "  OS: ${{ matrix.os_name }}"
          echo ""
          echo "ðŸ“Š Pre-installed versions:"
          echo "  Quarto: $(quarto --version)"
          echo "  Python: $(python3 --version)"
          echo "  R: $(R --version | head -1)"
          echo "  TeX Live: $(lualatex --version | head -1)"
          echo "ðŸ“Š System resources:"
          echo "  Disk space: $(df -h . | tail -1)"
          echo "  Memory: $(free -h | grep Mem)"

      - name: ðŸ”¨ Build HTML (Linux Container)
        if: steps.should-run.outputs.should-run == 'true' && matrix.format == 'html' && matrix.os_name == 'linux'
        shell: bash
        run: |
          # Linux: Already running in container
          echo "ðŸš€ Setting up HTML configuration (Linux container)..."
          cd quarto
          rm -f _quarto.yml
          cp config/_quarto-html.yml _quarto.yml
          echo "âœ… Configuration set to HTML"
          
          echo "ðŸ”¨ Building HTML in Linux container..."
          echo "â° HTML build started at: $(date)"
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
            -d "{
              \"state\": \"pending\",
              \"description\": \"Building HTML content (${{ matrix.os_name }} container)\",
              \"context\": \"ci/quarto-build-${{ matrix.os_name }}-${{ matrix.format }}\"
            }"
          
          quarto render --to html
          echo "âœ… HTML build completed at: $(date)"

      - name: ðŸ”¨ Build HTML (Windows Container)
        if: steps.should-run.outputs.should-run == 'true' && matrix.format == 'html' && matrix.os_name == 'windows'
        shell: pwsh
        run: |
          # Windows: Use docker run with mounted volumes
          Write-Output "ðŸš€ Setting up HTML configuration (Windows container)..."
          Set-Location quarto
          Remove-Item -Force _quarto.yml -ErrorAction SilentlyContinue
          Copy-Item config/_quarto-html.yml _quarto.yml
          Write-Output "âœ… Configuration set to HTML"
          Set-Location ..
          
          Write-Output "ðŸ”¨ Building HTML in Windows container..."
          Write-Output "â° HTML build started at: $(Get-Date)"
          
          curl -X POST `
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" `
            -H "Accept: application/vnd.github.v3+json" `
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" `
            -d "{
              `"state`": `"pending`",
              `"description`": `"Building HTML content (${{ matrix.os_name }} container)`",
              `"context`": `"ci/quarto-build-${{ matrix.os_name }}-${{ matrix.format }}`"
            }"
          
          # Run Quarto in Windows container with volume mount
          Write-Output "ðŸ” Debugging container setup..."
          Write-Output "Current directory: ${PWD}"
          Write-Output "Container image: $env:WINDOWS_CONTAINER_IMAGE"
          
          # First, test the volume mount and directory structure
          docker run --rm -v "${PWD}:C:/workspace" $env:WINDOWS_CONTAINER_IMAGE pwsh -Command "
            Write-Output '=== CONTAINER DIRECTORY DIAGNOSTICS ==='
            Write-Output 'ðŸ“‚ Current working directory:'
            Get-Location
            Write-Output 'ðŸ“‚ Container C:/ contents:'
            Get-ChildItem C:/ | Format-Table Name, Length, LastWriteTime
            Write-Output 'ðŸ“‚ Workspace mount contents:'
            if (Test-Path 'C:/workspace') {
              Get-ChildItem 'C:/workspace' | Format-Table Name, Length, LastWriteTime
              Write-Output 'ðŸ“‚ Quarto directory contents:'
              if (Test-Path 'C:/workspace/quarto') {
                Get-ChildItem 'C:/workspace/quarto' | Format-Table Name, Length, LastWriteTime
                Write-Output 'ðŸ“„ Quarto config files:'
                Get-ChildItem 'C:/workspace/quarto' -Filter '*.yml' | Format-Table Name, Length
              } else {
                Write-Output 'âŒ C:/workspace/quarto does not exist'
              }
            } else {
              Write-Output 'âŒ C:/workspace mount failed'
            }
            Write-Output 'ðŸ“ Quarto location:'
            where.exe quarto
            Write-Output 'ðŸ” Quarto check:'
            quarto check
          "
          
          docker run --rm -v "${PWD}:C:/workspace" -w "C:/workspace/quarto" $env:WINDOWS_CONTAINER_IMAGE quarto render --to html
          Write-Output "âœ… HTML build completed at: $(Get-Date)"
        
      - name: ðŸ”¨ Build PDF (Linux Container)
        if: steps.should-run.outputs.should-run == 'true' && matrix.format == 'pdf' && matrix.os_name == 'linux'
        shell: bash
        run: |
          # Linux: Already running in container
          echo "ðŸš€ Setting up PDF configuration (Linux container)..."
          cd quarto
          rm -f _quarto.yml
          cp config/_quarto-pdf.yml _quarto.yml
          echo "âœ… Configuration set to PDF"
          
          echo "ðŸ”¨ Building PDF in Linux container..."
          echo "â° PDF build started at: $(date)"
          echo "ðŸ“Š This should be much faster with pre-installed dependencies"
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
            -d "{
              \"state\": \"pending\",
              \"description\": \"Building PDF content (${{ matrix.os_name }} container) - optimized\",
              \"context\": \"ci/quarto-build-${{ matrix.os_name }}-${{ matrix.format }}\"
            }"
          
          quarto render --to titlepage-pdf
          echo "âœ… PDF build completed at: $(date)"

      - name: ðŸ”¨ Build PDF (Windows Container)
        if: steps.should-run.outputs.should-run == 'true' && matrix.format == 'pdf' && matrix.os_name == 'windows'
        shell: pwsh
        run: |
          # Windows: Use docker run with mounted volumes
          Write-Output "ðŸš€ Setting up PDF configuration (Windows container)..."
          Set-Location quarto
          Remove-Item -Force _quarto.yml -ErrorAction SilentlyContinue
          Copy-Item config/_quarto-pdf.yml _quarto.yml
          Write-Output "âœ… Configuration set to PDF"
          Set-Location ..
          
          Write-Output "ðŸ”¨ Building PDF in Windows container..."
          Write-Output "â° PDF build started at: $(Get-Date)"
          Write-Output "ðŸ“Š This should be much faster with pre-installed dependencies"
          
          curl -X POST `
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" `
            -H "Accept: application/vnd.github.v3+json" `
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" `
            -d "{
              `"state`": `"pending`",
              `"description`": `"Building PDF content (${{ matrix.os_name }} container) - optimized`",
              `"context`": `"ci/quarto-build-${{ matrix.os_name }}-${{ matrix.format }}`"
            }"
          
          # Run Quarto in Windows container with volume mount
          docker run --rm -v "${PWD}:C:/workspace" -w "C:/workspace/quarto" $env:WINDOWS_CONTAINER_IMAGE quarto render --to titlepage-pdf
          Write-Output "âœ… PDF build completed at: $(Get-Date)"

      - name: ðŸ“‰ Compress PDF with Ghostscript (Linux)
        if: steps.should-run.outputs.should-run == 'true' && matrix.format == 'pdf' && matrix.os_name == 'linux'
        shell: bash
        run: |
          # Linux: Already running in container with Ghostscript pre-installed
          if [ -f "_build/pdf/Machine-Learning-Systems.pdf" ]; then
            echo "ðŸ“‰ Compressing PDF using Ghostscript (Linux container)..."
            gs \
              -sDEVICE=pdfwrite \
              -dCompatibilityLevel=1.4 \
              -dPDFSETTINGS=/ebook \
              -dNOPAUSE \
              -dQUIET \
              -dBATCH \
              -sOutputFile="./_build/pdf/ebook.pdf" \
              "./_build/pdf/Machine-Learning-Systems.pdf"

            mv ./_build/pdf/ebook.pdf ./_build/pdf/Machine-Learning-Systems.pdf
            echo "âœ… PDF compression completed"
          else
            echo "âš ï¸ PDF file not found for compression"
          fi

      - name: ðŸ“‰ Compress PDF with Ghostscript (Windows)
        if: steps.should-run.outputs.should-run == 'true' && matrix.format == 'pdf' && matrix.os_name == 'windows'
        shell: pwsh
        run: |
          # Windows: Use Ghostscript in Windows container
          $input = "./_build/pdf/Machine-Learning-Systems.pdf"
          $output = "./_build/pdf/ebook.pdf"

          if (!(Test-Path $input)) {
            Write-Warning "âš ï¸ Input PDF not found! Skipping compression..."
            exit 0
          }

          Write-Output "ðŸ“‰ Compressing PDF using Ghostscript (Windows container)..."
          # Run Ghostscript in Windows container with volume mount
          docker run --rm -v "${PWD}:C:/workspace" -w "C:/workspace" $env:WINDOWS_CONTAINER_IMAGE gswin64c -sDEVICE=pdfwrite -dCompatibilityLevel:1.4 -dPDFSETTINGS=/ebook -dNOPAUSE -dBATCH -sOutputFile="C:/workspace/_build/pdf/ebook.pdf" "C:/workspace/_build/pdf/Machine-Learning-Systems.pdf"

          if (Test-Path $output) {
            Move-Item -Force $output $input
            Write-Output "âœ… PDF compression completed"
          } else {
            Write-Warning "âš ï¸ Compression failed but continuing"
          }

      - name: ðŸ“¤ Upload HTML artifacts
        if: steps.should-run.outputs.should-run == 'true' && matrix.format == 'html'
        id: upload-html-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ format('{0}-html-{1}', inputs.target, env.OS_NAME) }}
          path: _build/html

      - name: ðŸ“¤ Upload PDF artifacts
        if: steps.should-run.outputs.should-run == 'true' && matrix.format == 'pdf'
        id: upload-pdf-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ format('{0}-pdf-{1}', inputs.target, env.OS_NAME) }}
          path: _build/pdf

      - name: ðŸ“‹ Build Declaration
        if: steps.should-run.outputs.should-run == 'true'
        run: |
          HTML_ARTIFACT="${{ format('{0}-html-{1}', inputs.target, env.OS_NAME) }}"
          PDF_ARTIFACT="${{ format('{0}-pdf-{1}', inputs.target, env.OS_NAME) }}"
          echo "ðŸ“¦ Build Declaration: Successfully created artifacts"
          echo "ðŸ“Š Format: ${{ matrix.format }}"
          echo "ðŸ“Š OS: ${{ matrix.os_name }}"
          echo "ðŸ“Š Artifact: ${HTML_ARTIFACT}${PDF_ARTIFACT}"
          echo "ðŸ“Š Target: ${{ inputs.target }}"
          echo "ðŸ“Š Method: Fast Container Build ($OS_NAME)"
          echo "ðŸ“ Note: This workflow only builds artifacts - deployment handled by publish-live workflow"
          echo "html_artifact=$HTML_ARTIFACT" >> $GITHUB_OUTPUT
          echo "pdf_artifact=$PDF_ARTIFACT" >> $GITHUB_OUTPUT

      - name: ðŸŽ¯ Set Final Build Status
        if: always()
        shell: bash
        run: |
          echo "ðŸŽ¯ Setting final build status..."
          
          # Check if this job was supposed to run
          if [ "${{ steps.should-run.outputs.should-run }}" = "true" ]; then
            if [ "${{ job.status }}" = "success" ]; then
              STATE="success"
              DESCRIPTION="Build completed successfully (${{ matrix.os_name }} container)"
            else
              STATE="failure"
              DESCRIPTION="Build failed (${{ matrix.os_name }} container)"
            fi
            
            echo "ðŸ“Š Final status: $STATE"
            echo "ðŸ“ Description: $DESCRIPTION"
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
              -d "{
                \"state\": \"$STATE\",
                \"description\": \"$DESCRIPTION\",
                \"context\": \"ci/quarto-build-${{ matrix.os_name }}-${{ matrix.format }}\"
              }"
            
            echo "âœ… Commit status updated successfully"
          else
            echo "â­ï¸ Skipped matrix job for ${{ matrix.os_name }} (not requested)"
          fi

      - name: ðŸ“‹ Build summary outputs
        id: build-summary
        if: always()
        shell: bash
        run: |
          # Determine build status and formats built
          if [ "${{ steps.should-run.outputs.should-run }}" = "true" ]; then
            # Check if the build was successful for this matrix combination
            if [ "${{ job.status }}" = "success" ]; then
              BUILD_STATUS="success"
              FORMATS_BUILT="${{ matrix.format }}"
            else
              BUILD_STATUS="failure"
              FORMATS_BUILT=""
            fi
          else
            BUILD_STATUS="skipped"
            FORMATS_BUILT=""
          fi
          
          echo "status=$BUILD_STATUS" >> $GITHUB_OUTPUT
          echo "formats=$FORMATS_BUILT" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Build Status: $BUILD_STATUS"
          echo "ðŸ“¦ Formats Built: $FORMATS_BUILT"

 