name: 'ğŸ“š Quarto Build (Container)'

# Set retention period to 7 days
env:
  GITHUB_ACTIONS_RETENTION_DAYS: 7

# Cancel duplicate builds for same target+os+format combination
concurrency:
  group: quarto-build-${{ inputs.target }}-${{ inputs.os }}-${{ inputs.format }}-${{ github.sha }}
  cancel-in-progress: true

# This workflow uses pre-built containers with all dependencies installed
# Containers include fixed versions of Quarto, R, Python, TeX Live, etc.
# This is the primary workflow for fast, consistent builds
on:
  workflow_dispatch:
    inputs:
      os:
        required: false
        type: choice
        default: 'ubuntu-latest'
        description: 'Operating system to run on'
        options:
          - ubuntu-latest
          - windows-latest
      target:
        required: false
        type: choice
        default: 'dev'
        description: 'Target branch (dev/main) - determines build behavior'
        options:
          - dev
          - main
      html_format:
        required: false
        type: boolean
        default: true
        description: 'Build HTML format'
      pdf_format:
        required: false
        type: boolean
        default: false
        description: 'Build PDF format'
      quarto-log-level:
        required: false
        type: choice
        default: 'INFO'
        description: 'Quarto log level'
        options:
          - INFO
          - DEBUG
      artifact_name_template:
        required: false
        type: string
        default: '{prefix}-{format}-{os}'
        description: 'Artifact name template. Use {prefix}, {format} for html/pdf, and {os} for linux/windows'
  workflow_call:
    inputs:
      os:
        required: true
        type: string
        description: 'Operating system to run on (ubuntu-latest/windows-latest)'
      format:
        required: false
        type: string
        default: 'html'
        description: 'Format to build (html/pdf/all)'
      target:
        required: false
        type: string
        default: ''
        description: 'Target branch (dev/main) - determines build behavior'
      # Container configuration (optional overrides)
      container_registry:
        required: false
        type: string
        default: 'ghcr.io'
        description: 'Container registry URL'
      container_tag:
        required: false
        type: string
        default: 'latest'
        description: 'Container tag to use'
      # Legacy inputs for backward compatibility (if needed)
      html_format:
        required: false
        type: boolean
        default: false
        description: 'Build HTML format (legacy - use format instead)'
      pdf_format:
        required: false
        type: boolean
        default: false
        description: 'Build PDF format (legacy - use format instead)'

permissions:
  contents: write
  pages: write

# Standardized outputs for calling workflows
outputs:
  build_success:
    description: "Whether the build completed successfully"
    value: ${{ jobs.build.outputs.build_success }}
  html_artifact:
    description: "HTML artifact name (empty if not built)"
    value: ${{ jobs.build.outputs.html_artifact }}
  pdf_artifact:
    description: "PDF artifact name (empty if not built)"
    value: ${{ jobs.build.outputs.pdf_artifact }}
  os_name:
    description: "Operating system name (linux/windows)"
    value: ${{ jobs.build.outputs.os_name }}
  target:
    description: "Build target (dev/main)"
    value: ${{ jobs.build.outputs.target }}
  formats_built:
    description: "Comma-separated list of formats built"
    value: ${{ jobs.build.outputs.formats_built }}

jobs:
  # Unified build job using matrix strategy (filtered by input)
  build:
    runs-on: ${{ matrix.os }}
    outputs:
      build_success: ${{ steps.outputs.outputs.build_success }}
      html_artifact: ${{ steps.outputs.outputs.html_artifact }}
      pdf_artifact: ${{ steps.outputs.outputs.pdf_artifact }}
      os_name: ${{ steps.outputs.outputs.os_name }}
      target: ${{ steps.outputs.outputs.target }}
      formats_built: ${{ steps.outputs.outputs.formats_built }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            os_name: linux
            container_name: quarto-linux
          - os: windows-latest
            os_name: windows
            container_name: quarto-windows
    container: ${{ format('{0}/{1}/{2}:{3}', inputs.container_registry, github.repository, matrix.container_name, inputs.container_tag) }}
    timeout-minutes: 60
    if: inputs.os == matrix.os  # Only run the matrix entry that matches the input OS
    env:
      QUARTO_LOG_LEVEL: ${{ inputs.quarto-log-level || 'INFO' }}
      OS_NAME: ${{ matrix.os_name }}
      PYTHONIOENCODING: utf-8
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    steps:
      - name: ğŸ”§ Convert Format Input to Flags
        id: format-flags
        shell: bash
        run: |
          echo "ğŸ”§ Converting format input to build flags..."
          
          # Determine which formats to build based on input
          if [ "${{ inputs.format }}" = "html" ] || [ "${{ inputs.html_format }}" = "true" ]; then
            BUILD_HTML="true"
          else
            BUILD_HTML="false"
          fi
          
          if [ "${{ inputs.format }}" = "pdf" ] || [ "${{ inputs.pdf_format }}" = "true" ]; then
            BUILD_PDF="true"
          else
            BUILD_PDF="false"
          fi
          
          if [ "${{ inputs.format }}" = "all" ]; then
            BUILD_HTML="true"
            BUILD_PDF="true"
          fi
          
          echo "ğŸ“Š Build configuration:"
          echo "  Format input: '${{ inputs.format }}'"
          echo "  HTML format: $BUILD_HTML"
          echo "  PDF format: $BUILD_PDF"
          echo "  OS: ${{ matrix.os_name }}"
          
          echo "html_format=$BUILD_HTML" >> $GITHUB_OUTPUT
          echo "pdf_format=$BUILD_PDF" >> $GITHUB_OUTPUT

      - name: ğŸš¦ Set Initial Build Status
        shell: bash
        run: |
          echo "ğŸš¦ Setting initial build status to pending..."
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
            -d "{
              \"state\": \"pending\",
              \"description\": \"Quarto build started (${{ matrix.os_name }} container)\",
              \"context\": \"ci/quarto-build-${{ matrix.os }}-${{ inputs.format }}\"
            }"

      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Container Environment Info
        shell: bash
        run: |
          echo "ğŸ”„ Container build environment information..."
          echo "ğŸ“Š Container Configuration:"
          echo "  Registry: ${{ inputs.container_registry }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  Container: ${{ matrix.container_name }}"
          echo "  Tag: ${{ inputs.container_tag }}"
          echo "  Full Image: ${{ format('{0}/{1}/{2}:{3}', inputs.container_registry, github.repository, matrix.container_name, inputs.container_tag) }}"
          echo "  OS: ${{ matrix.os_name }}"
          echo ""
          echo "ğŸ“Š Pre-installed versions:"
          echo "  Quarto: $(quarto --version)"
          echo "  Python: $(python3 --version)"
          echo "  R: $(R --version | head -1)"
          echo "  TeX Live: $(lualatex --version | head -1)"
          echo "ğŸ“Š System resources:"
          echo "  Disk space: $(df -h . | tail -1)"
          echo "  Memory: $(free -h | grep Mem)"

      - name: ğŸ”¨ Build HTML (copy config and render)
        if: steps.format-flags.outputs.html_format == 'true'
        shell: bash
        run: |
          echo "ğŸš€ Setting up HTML configuration..."
          cd quarto
          rm -f _quarto.yml
          cp config/_quarto-html.yml _quarto.yml
          echo "âœ… Configuration set to HTML"
          
          echo "ğŸ”¨ Building HTML..."
          echo "â° HTML build started at: $(date)"
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
            -d "{
              \"state\": \"pending\",
              \"description\": \"Building HTML content (${{ matrix.os_name }} container)\",
              \"context\": \"ci/quarto-build-${{ matrix.os }}-html\"
            }"
          
          quarto render --to html
          echo "âœ… HTML build completed at: $(date)"
        
      - name: ğŸ”¨ Build PDF (copy config and render)
        if: steps.format-flags.outputs.pdf_format == 'true'
        shell: bash
        run: |
          echo "ğŸš€ Setting up PDF configuration..."
          cd quarto
          rm -f _quarto.yml
          cp config/_quarto-pdf.yml _quarto.yml
          echo "âœ… Configuration set to PDF"
          
          echo "ğŸ”¨ Building PDF..."
          echo "â° PDF build started at: $(date)"
          echo "ğŸ“Š This should be much faster with pre-installed dependencies"
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
            -d "{
              \"state\": \"pending\",
              \"description\": \"Building PDF content (${{ matrix.os_name }} container) - optimized\",
              \"context\": \"ci/quarto-build-${{ inputs.os }}-pdf\"
            }"
          
          quarto render --to titlepage-pdf
          echo "âœ… PDF build completed at: $(date)"

      - name: ğŸ“‰ Compress PDF with Ghostscript (Linux)
        if: steps.format-flags.outputs.pdf_format == 'true' && runner.os == 'Linux'
        shell: bash
        run: |
          if [ -f "build/pdf/Machine-Learning-Systems.pdf" ]; then
            echo "ğŸ“‰ Compressing PDF using Ghostscript (Linux)..."
            gs \
              -sDEVICE=pdfwrite \
              -dCompatibilityLevel=1.4 \
              -dPDFSETTINGS=/ebook \
              -dNOPAUSE \
              -dQUIET \
              -dBATCH \
              -sOutputFile="./build/pdf/ebook.pdf" \
              "./build/pdf/Machine-Learning-Systems.pdf"

            mv ./build/pdf/ebook.pdf ./build/pdf/Machine-Learning-Systems.pdf
          else
            echo "âš ï¸ PDF file not found for compression"
          fi

      - name: ğŸ“‰ Compress PDF with Ghostscript (Windows)
        if: steps.format-flags.outputs.pdf_format == 'true' && runner.os == 'Windows'
        shell: pwsh
        run: |
          $input = "./build/pdf/Machine-Learning-Systems.pdf"
          $output = "./build/pdf/ebook.pdf"

          if (!(Test-Path $input)) {
            Write-Warning "âš ï¸ Input PDF not found! Skipping compression..."
            exit 0
          }

          Write-Output "ğŸ“‰ Compressing PDF using Ghostscript (Windows)..."
          & gswin64c -sDEVICE=pdfwrite -dCompatibilityLevel:1.4 -dPDFSETTINGS=/ebook -dNOPAUSE -dBATCH -sOutputFile="$output" "$input"

          if (Test-Path $output) {
            Move-Item -Force $output $input
          } else {
            Write-Warning "âš ï¸ Compression failed but continuing"
          }

      - name: ğŸ“¤ Upload HTML artifacts
        if: steps.format-flags.outputs.html_format == 'true'
        id: upload-html-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ format('{0}-html-{1}', inputs.target, env.OS_NAME) }}
          path: build/html

      - name: ğŸ“¤ Upload PDF artifacts
        if: steps.format-flags.outputs.pdf_format == 'true'
        id: upload-pdf-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ format('{0}-pdf-{1}', inputs.target, env.OS_NAME) }}
          path: build/pdf

      - name: ğŸ“‹ Build Declaration
        id: outputs
        run: |
          # Determine artifact names (empty if not built)
          if [ "${{ steps.format-flags.outputs.html_format }}" = "true" ]; then
            HTML_ARTIFACT="${{ format('{0}-html-{1}', inputs.target, env.OS_NAME) }}"
          else
            HTML_ARTIFACT=""
          fi
          
          if [ "${{ steps.format-flags.outputs.pdf_format }}" = "true" ]; then
            PDF_ARTIFACT="${{ format('{0}-pdf-{1}', inputs.target, env.OS_NAME) }}"
          else
            PDF_ARTIFACT=""
          fi
          
          # Determine formats built
          FORMATS_BUILT=""
          if [ "${{ steps.format-flags.outputs.html_format }}" = "true" ]; then
            FORMATS_BUILT="html"
          fi
          if [ "${{ steps.format-flags.outputs.pdf_format }}" = "true" ]; then
            if [ -n "$FORMATS_BUILT" ]; then
              FORMATS_BUILT="$FORMATS_BUILT,pdf"
            else
              FORMATS_BUILT="pdf"
            fi
          fi
          
          echo "ğŸ“¦ Build Declaration: Successfully created artifacts"
          echo "ğŸ“Š HTML Artifact: '$HTML_ARTIFACT' (enabled: ${{ steps.format-flags.outputs.html_format }})"
          echo "ğŸ“Š PDF Artifact: '$PDF_ARTIFACT' (enabled: ${{ steps.format-flags.outputs.pdf_format }})"
          echo "ğŸ“Š OS: ${{ inputs.os }}"
          echo "ğŸ“Š Target: ${{ inputs.target }}"
          echo "ğŸ“Š Method: Fast Container Build ($OS_NAME)"
          echo "ğŸ“Š Formats Built: $FORMATS_BUILT"
          echo "ğŸ“ Note: This workflow only builds artifacts - deployment handled by publish-live workflow"
          
          # Standardized outputs
          echo "build_success=true" >> $GITHUB_OUTPUT
          echo "html_artifact=$HTML_ARTIFACT" >> $GITHUB_OUTPUT
          echo "pdf_artifact=$PDF_ARTIFACT" >> $GITHUB_OUTPUT
          echo "os_name=$OS_NAME" >> $GITHUB_OUTPUT
          echo "target=${{ inputs.target }}" >> $GITHUB_OUTPUT
          echo "formats_built=$FORMATS_BUILT" >> $GITHUB_OUTPUT

      - name: ğŸ¯ Set Final Build Status
        if: always()
        shell: bash
        run: |
          echo "ğŸ¯ Setting final build status..."
          
          if [ "${{ job.status }}" = "success" ]; then
            STATE="success"
            DESCRIPTION="Build completed successfully (${{ matrix.os_name }} container)"
          else
            STATE="failure"
            DESCRIPTION="Build failed (${{ matrix.os_name }} container)"
          fi
          
          echo "ğŸ“Š Final status: $STATE"
          echo "ğŸ“ Description: $DESCRIPTION"
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
            -d "{
              \"state\": \"$STATE\",
              \"description\": \"$DESCRIPTION\",
              \"context\": \"ci/quarto-build-${{ inputs.os }}-${{ inputs.format }}\"
            }"
          
          echo "âœ… Commit status updated successfully"

 