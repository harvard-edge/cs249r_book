name: '💯 Validate Dev'

# Enhanced dev workflow: validate + build + preview deployment
# Replaces complex container orchestration with simple, reliable build calls

env:
  GITHUB_ACTIONS_RETENTION_DAYS: 7

# Cancel duplicate builds on same branch
concurrency:
  group: validate-dev-${{ github.ref }}
  cancel-in-progress: true

# Triggers: dev branch pushes and manual testing
on:
  push:
    branches: [dev]  # Auto-trigger for dev branch
  workflow_dispatch:  # Manual trigger for testing
    inputs:
      test_branch:
        description: 'Branch to test (for feature branch testing)'
        required: false
        default: ''
        type: string
      build_format:
        description: 'Format to build'
        required: false
        default: 'html'
        type: choice
        options:
          - html
          - pdf
          - all
      deploy_preview:
        description: 'Deploy preview to staging'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pages: write

jobs:
  # Step 1: Pre-commit validation
  pre-commit:
    name: '🔍 Pre-commit Checks'
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.test_branch || github.ref }}
          fetch-depth: 0

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: 🔍 Run pre-commit checks
        run: |
          echo "🔍 Installing and running pre-commit..."
          python -m pip install --upgrade pip
          pip install pre-commit
          pre-commit install --install-hooks
          pre-commit run --all-files

  # Step 2: Build HTML for preview (smart fallback strategy)
  build-html-preview:
    name: '🔨 Build HTML Preview'
    needs: [pre-commit]
    runs-on: ubuntu-latest
    outputs:
      build_success: ${{ steps.container-build.outputs.build_success || steps.baremetal-build.outputs.build_success }}
      html_artifact: ${{ steps.container-build.outputs.html_artifact || steps.baremetal-build.outputs.html_artifact }}
      build_method: ${{ steps.container-build.outputs.build_success && 'container' || 'baremetal' }}
    
    steps:
      - name: 🚀 Try Container Build First
        id: container-build
        continue-on-error: true
        uses: ./.github/workflows/quarto-build-container.yml
        with:
          os: ubuntu-latest
          format: ${{ inputs.build_format || 'html' }}
          target: dev

      - name: 🖥️ Fallback to Baremetal Build
        id: baremetal-build
        if: steps.container-build.outputs.build_success != 'true'
        uses: ./.github/workflows/quarto-build-baremetal.yml
        with:
          os: ubuntu-latest
          format: ${{ inputs.build_format || 'html' }}
          target: dev

  # Step 3: Deploy preview to staging (dev branch only)
  deploy-preview:
    name: '🚀 Deploy Preview'
    needs: [build-html-preview]
    if: |
      always() && 
      needs.build-html-preview.outputs.build_success == 'true' && 
      needs.build-html-preview.outputs.html_artifact != '' &&
      (github.ref == 'refs/heads/dev' || inputs.deploy_preview == true)
    runs-on: ubuntu-latest
    environment:
      name: development
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev/
      
    steps:
      - name: 📥 Download HTML artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-html-preview.outputs.html_artifact }}
          path: ./preview-site
          
      - name: 🚀 Deploy to GitHub Pages (dev staging)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./preview-site
          destination_dir: dev
          keep_files: false
          commit_message: |
            🚀 Deploy dev preview from ${{ github.sha }}
            
            Built using: ${{ needs.build-html-preview.outputs.build_method }}
            Artifact: ${{ needs.build-html-preview.outputs.html_artifact }}
            Branch: ${{ github.ref_name }}

  # Step 4: Results and summary
  build-report:
    name: '📊 Build Report'
    if: always()
    needs: [pre-commit, build-html-preview, deploy-preview]
    runs-on: ubuntu-latest
    
    steps:
      - name: 📋 Generate build summary
        run: |
          echo "# 🎯 Enhanced Dev Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📊 Build Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-commit**: ${{ needs.pre-commit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build-html-preview.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Preview Deploy**: ${{ needs.deploy-preview.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-html-preview.outputs.build_success }}" = "true" ]; then
            echo "## ✅ Build Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Method**: ${{ needs.build-html-preview.outputs.build_method }}" >> $GITHUB_STEP_SUMMARY
            echo "- **HTML Artifact**: ${{ needs.build-html-preview.outputs.html_artifact }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ needs.deploy-preview.result }}" = "success" ]; then
              echo "- **Preview URL**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev/" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 🎯 Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.pre-commit.result }}" = "success" ] && [ "${{ needs.build-html-preview.result }}" = "success" ]; then
            echo "✅ **Validation Passed** - Ready for development work" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.deploy-preview.result }}" = "success" ]; then
              echo "🚀 **Preview Deployed** - Check the staging site" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ **Validation Failed** - Check the logs above" >> $GITHUB_STEP_SUMMARY
          fi