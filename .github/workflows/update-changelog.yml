name: 'Update Changelog'

on:
  workflow_call:
  workflow_dispatch:

jobs:
  update-changelog:
    name: 📝 Update Changelog
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Essential for changelog generation
      
      - name: 🔄 Fetch all branches
        run: |
          # Fetch all branches
          git fetch --all --tags --force
          
          # Explicitly fetch the branches needed for changelog generation
          git fetch origin gh-pages:refs/remotes/origin/gh-pages || echo "No gh-pages branch found yet"
          git fetch origin dev:refs/remotes/origin/dev || echo "No dev branch found"
          
          # Show branches for debugging
          echo "Available branches:"
          git branch -a
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 🔧 Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: 🔍 Find changelog script
        id: find-script
        run: |
          # Check potential script locations
          if [ -f ".github/scripts/update_changelog.py" ]; then
            echo "script_path=.github/scripts/update_changelog.py" >> $GITHUB_OUTPUT
            echo "Found script at .github/scripts/update_changelog.py"
          elif [ -f "scripts/update-changelog.py" ]; then
            echo "script_path=scripts/update-changelog.py" >> $GITHUB_OUTPUT
            echo "Found script at scripts/update-changelog.py"
          elif [ -f "scripts/update_changelog.py" ]; then
            echo "script_path=scripts/update_changelog.py" >> $GITHUB_OUTPUT
            echo "Found script at scripts/update_changelog.py"
          else
            echo "Error: Could not find changelog update script"
            find . -name "*.py" | grep -i changelog
            exit 1
          fi
      
      - name: 🔄 Run Changelog Update
        id: update
        run: |
          # Make changelog script executable
          chmod +x ${{ steps.find-script.outputs.script_path }}
          
          # Run update script
          python3 ${{ steps.find-script.outputs.script_path }}
          
          # Check for changes
          if [ -n "$(git status --porcelain CHANGELOG.md)" ]; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "Changes detected in CHANGELOG.md"
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "No changes to CHANGELOG.md"
          fi
      
      - name: 💾 Commit & Push Changes
        if: steps.update.outputs.changes_made == 'true'
        run: |
          # Determine the correct branch to push to
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          
          # For pull requests
          if [ -n "$GITHUB_HEAD_REF" ]; then
            TARGET_BRANCH=$GITHUB_HEAD_REF
          # For direct pushes
          else
            TARGET_BRANCH=$CURRENT_BRANCH
          fi
          
          echo "Committing changes to branch: $TARGET_BRANCH"
          
          git add CHANGELOG.md
          git commit -m "🤖 Auto-update changelog [skip ci]"
          git push origin HEAD:$TARGET_BRANCH