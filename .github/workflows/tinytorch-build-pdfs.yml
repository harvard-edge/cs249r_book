name: ðŸ“š TinyTorch Build PDFs

# =============================================================================
# Manual PDF Build Workflow
# =============================================================================
# This is a manual-only workflow for building TinyTorch PDFs.
# It does NOT affect the main site deployment.
#
# Use: Actions â†’ TinyTorch Build PDFs â†’ Run workflow
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      build_guide:
        description: 'Build Course Guide PDF'
        required: true
        type: boolean
        default: true
      build_paper:
        description: 'Build Research Paper PDF'
        required: true
        type: boolean
        default: true

jobs:
  build-pdf-guide:
    name: 'ðŸ“š Build Course Guide'
    runs-on: ubuntu-latest
    if: inputs.build_guide

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tinytorch/site/requirements.txt'

      - name: ðŸ“¦ Install dependencies
        working-directory: tinytorch
        run: |
          pip install --upgrade pip
          pip install -r site/requirements.txt
          pip install -e .

      - name: ðŸ“š Generate LaTeX
        working-directory: tinytorch/site
        run: |
          jupyter-book build . --builder latex --config _config_pdf.yml
          python3 scripts/latex_postprocessor.py
          cp _static/logos/fire-emoji.png _build/latex/
          cp _static/logos/logo-mlsysbook.png _build/latex/

      - name: ðŸ“š Compile PDF with XeLaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: tinytorch-course.tex
          working_directory: tinytorch/site/_build/latex
          latexmk_use_xelatex: true

      - name: ðŸ“¤ Upload PDF Guide
        uses: actions/upload-artifact@v4
        with:
          name: TinyTorch-Guide
          path: tinytorch/site/_build/latex/tinytorch-course.pdf
          retention-days: 30

  build-pdf-paper:
    name: 'ðŸ“‘ Build Research Paper'
    runs-on: ubuntu-latest
    if: inputs.build_paper

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“‘ Compile Paper with LuaLaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: paper.tex
          working_directory: tinytorch/paper
          latexmk_use_lualatex: true

      - name: ðŸ“¤ Upload PDF Paper
        uses: actions/upload-artifact@v4
        with:
          name: TinyTorch-Paper
          path: tinytorch/paper/paper.pdf
          retention-days: 30

  summary:
    name: 'ðŸ“Š Build Summary'
    runs-on: ubuntu-latest
    needs: [build-pdf-guide, build-pdf-paper]
    if: always()

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ“š TinyTorch PDF Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| PDF | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.build_guide }}" = "true" ]; then
            echo "| ðŸ“š Course Guide | ${{ needs.build-pdf-guide.result }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“š Course Guide | skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ inputs.build_paper }}" = "true" ]; then
            echo "| ðŸ“‘ Research Paper | ${{ needs.build-pdf-paper.result }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“‘ Research Paper | skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
          echo "PDFs are available as artifacts above (valid for 30 days)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To add to the site, download and place in:" >> $GITHUB_STEP_SUMMARY
          echo "- \`tinytorch/site/_static/downloads/TinyTorch-Guide.pdf\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`tinytorch/site/_static/downloads/TinyTorch-Paper.pdf\`" >> $GITHUB_STEP_SUMMARY
