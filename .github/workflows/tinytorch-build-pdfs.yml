name: 'ðŸ”¥ TinyTorch Â· ðŸ”¨ Build PDFs'

# =============================================================================
# PDF Build Workflow (Artifacts Only)
# =============================================================================
# Builds TinyTorch PDFs and uploads as artifacts.
# PDFs are injected into the site during deployment (not committed to repo).
#
# Use: Actions â†’ TinyTorch Build PDFs â†’ Run workflow
# =============================================================================

on:
  workflow_dispatch:
  # Can be called by publish workflows
  workflow_call:
    inputs:
      ref:
        description: "Git ref to checkout (branch, tag, or SHA)"
        type: string
        required: false
        default: ''
    outputs:
      guide_built:
        description: "Whether the guide PDF was built successfully"
        value: ${{ jobs.build-pdf-guide.result == 'success' }}
      paper_built:
        description: "Whether the paper PDF was built successfully"
        value: ${{ jobs.build-pdf-paper.result == 'success' }}

permissions:
  contents: read

jobs:
  build-pdf-guide:
    name: 'ðŸ“š Build Course Guide'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tinytorch/site/requirements.txt'

      - name: ðŸŸ¢ Setup Node.js (for Mermaid)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: ðŸ“¦ Install dependencies
        working-directory: tinytorch
        run: |
          pip install --upgrade pip
          pip install -r site/requirements.txt
          pip install -e .

      - name: ðŸ“š Generate LaTeX
        working-directory: tinytorch/site
        run: |
          jupyter-book build . --builder latex --config _config_pdf.yml --toc _toc_pdf.yml
          python3 scripts/latex_postprocessor.py
          cp _static/logos/fire-emoji.png _build/latex/
          cp _static/logos/logo-mlsysbook.png _build/latex/
          cp _static/images/tito.png _build/latex/

      - name: ðŸ“š Compile PDF with XeLaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: tinytorch-course.tex
          working_directory: tinytorch/site/_build/latex
          latexmk_use_xelatex: true

      - name: ðŸ“¤ Upload PDF Guide
        uses: actions/upload-artifact@v4
        with:
          name: TinyTorch-Guide
          path: tinytorch/site/_build/latex/tinytorch-course.pdf
          retention-days: 90

  build-pdf-paper:
    name: 'ðŸ“‘ Build Research Paper'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: ðŸ“‘ Compile Paper with LuaLaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: paper.tex
          working_directory: tinytorch/paper
          latexmk_use_lualatex: true

      - name: ðŸ“¤ Upload PDF Paper
        uses: actions/upload-artifact@v4
        with:
          name: TinyTorch-Paper
          path: tinytorch/paper/paper.pdf
          retention-days: 90

  summary:
    name: 'ðŸ“Š Build Summary'
    runs-on: ubuntu-latest
    needs: [build-pdf-guide, build-pdf-paper]
    if: always()

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ“š TinyTorch PDF Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| PDF | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“š Course Guide | ${{ needs.build-pdf-guide.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‘ Research Paper | ${{ needs.build-pdf-paper.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "PDFs are uploaded as artifacts and will be injected during site deployment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To deploy with these PDFs, run the appropriate publish workflow:" >> $GITHUB_STEP_SUMMARY
          echo "- **Live**: TinyTorch Publish (Live)" >> $GITHUB_STEP_SUMMARY
          echo "- **Dev**: TinyTorch Preview (Dev)" >> $GITHUB_STEP_SUMMARY
