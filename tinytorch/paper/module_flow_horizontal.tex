% Horizontal Module Dependency Diagram for TinyTorch Paper
% Use with: \input{module_flow_horizontal.tex}
% Requires: \usepackage{tikz}, \usetikzlibrary{shapes,arrows,positioning,shadows,calc,backgrounds}

\begin{figure*}[t]
\centering
\resizebox{\textwidth}{!}{%
\begin{tikzpicture}[
    node distance=0.4cm and 0.6cm,
    every node/.style={font=\scriptsize\sffamily},
    % Tier styles
    foundation/.style={
        rectangle, 
        draw=blue!60!black, 
        top color=blue!5, 
        bottom color=blue!15, 
        text=blue!40!black,
        minimum width=1.4cm, 
        minimum height=0.6cm, 
        rounded corners=3pt,
        drop shadow={opacity=0.2, shadow xshift=1pt, shadow yshift=-1pt}
    },
    architecture/.style={
        rectangle, 
        draw=purple!60!black, 
        top color=purple!5, 
        bottom color=purple!15, 
        text=purple!40!black,
        minimum width=1.4cm, 
        minimum height=0.6cm, 
        rounded corners=3pt,
        drop shadow={opacity=0.2, shadow xshift=1pt, shadow yshift=-1pt}
    },
    optimization/.style={
        rectangle, 
        draw=orange!60!black, 
        top color=orange!5, 
        bottom color=orange!15, 
        text=orange!40!black,
        minimum width=1.4cm, 
        minimum height=0.6cm, 
        rounded corners=3pt,
        drop shadow={opacity=0.2, shadow xshift=1pt, shadow yshift=-1pt}
    },
    capstone/.style={
        rectangle, 
        draw=red!60!black, 
        top color=red!5, 
        bottom color=red!15, 
        text=red!40!black,
        minimum width=1.4cm, 
        minimum height=0.6cm, 
        rounded corners=3pt,
        drop shadow={opacity=0.2, shadow xshift=1pt, shadow yshift=-1pt}
    },
    % Arrow style
    arr/.style={->, >=stealth, thick, gray!60},
    tier/.style={draw=gray!40, dashed, rounded corners=5pt, inner sep=8pt}
]

% === FOUNDATION TIER (01-08) ===
\node[foundation] (T) {01 Tensor};
\node[foundation, right=of T] (A) {02 Activ.};
\node[foundation, right=of A] (L) {03 Layers};
\node[foundation, right=of L] (Loss) {04 Losses};
\node[foundation, right=of Loss] (Data) {05 DataLoad.};
\node[foundation, right=of Data] (Auto) {06 Autograd};
\node[foundation, right=of Auto] (Opt) {07 Optim.};
\node[foundation, right=of Opt] (Train) {08 Training};

% Foundation arrows
\draw[arr] (T) -- (A);
\draw[arr] (A) -- (L);
\draw[arr] (L) -- (Loss);
\draw[arr] (Loss) -- (Data);
\draw[arr] (Data) -- (Auto);
\draw[arr] (Auto) -- (Opt);
\draw[arr] (Opt) -- (Train);

% === ARCHITECTURE TIER (09-13) ===

% Vision path (top branch)
\node[architecture, above right=0.6cm and 0.8cm of Train] (Spatial) {09 CNNs};
% Branch up from Train
\draw[arr, rounded corners=5pt] (Train.east) -- ++(0.3,0) |- (Spatial.west);

% Language path (bottom branch)
\node[architecture, below right=0.6cm and 0.8cm of Train] (Tok) {10 Token.};
\node[architecture, right=of Tok] (Emb) {11 Embed.};
\node[architecture, right=of Emb] (Att) {12 Attention};
\node[architecture, right=of Att] (Trans) {13 Transform.};

% Branch down from Train - shift turn point slightly to separate lines
\draw[arr, rounded corners=5pt] (Train.east) -- ++(0.3,0) |- (Tok.west);

\draw[arr] (Tok) -- (Emb);
\draw[arr] (Emb) -- (Att);
\draw[arr] (Att) -- (Trans);

% === OPTIMIZATION TIER (14-19) ===
% Profiling - convergence point
\node[optimization, right=1.5cm of Spatial, yshift=-0.6cm] (Prof) {14 Profiling};

% Converge to Profiling
\draw[arr, rounded corners=5pt] (Spatial.east) -| (Prof.north);
\draw[arr, rounded corners=5pt] (Trans.east) -| (Prof.south);

% Parallel optimization branches
\node[optimization, above right=0.4cm and 0.6cm of Prof] (Quant) {15 Quant.};
\node[optimization, right=0.4cm of Quant] (Comp) {16 Compress.};
\node[optimization, below right=0.4cm and 0.6cm of Prof] (Accel) {17 Accel.};
\node[optimization, right=0.4cm of Accel] (Memo) {18 Memo.};

% Branch from Profiling
% Use different x-offsets for the turn to separate visual clutter if needed, 
% or just anchors.
\draw[arr, rounded corners=5pt] (Prof.east) -- ++(0.2,0) |- (Quant.west);
\draw[arr, rounded corners=5pt] (Prof.east) -- ++(0.2,0) |- (Accel.west);

% Internal optimization flows
\draw[arr] (Quant) -- (Comp);
\draw[arr] (Accel) -- (Memo);

% Benchmarking - convergence
\node[optimization, right=0.8cm of Prof, xshift=2.8cm] (Bench) {19 Benchmark};

% Route to Benchmark - use perpendicular paths
\draw[arr, rounded corners=5pt] (Comp.east) -| (Bench.north);
\draw[arr, rounded corners=5pt] (Memo.east) -| (Bench.south);

% === CAPSTONE (20) ===
\node[capstone, right=0.8cm of Bench] (Cap) {20 Capstone};
\draw[arr] (Bench) -- (Cap);

% === TIER LABELS ===
\node[above=0.8cm of L, font=\scriptsize\bfseries\sffamily, blue!60!black] {FOUNDATION (01-08)};
\node[above=0.9cm of Att, font=\scriptsize\bfseries\sffamily, purple!60!black] {ARCHITECTURE (09-13)};
\node[above=0.9cm of Comp, font=\scriptsize\bfseries\sffamily, orange!60!black] {OPTIMIZATION (14-19)};

% === PATH LABELS ===
\node[above=0.15cm of Spatial, font=\tiny\sffamily, gray] {Vision};
\node[below=0.15cm of Tok, font=\tiny\sffamily, gray] {Language};
\node[above=0.1cm of Quant, font=\tiny\sffamily, gray] {Size};
\node[below=0.1cm of Memo, font=\tiny\sffamily, gray] {Speed};

\end{tikzpicture}%
}
\caption{\textbf{Module Dependency Graph.} TinyTorch's 20 modules form a directed acyclic graph with two architectural paths. Foundation modules (blue, M01--08) build core infrastructure sequentially, culminating in Training (M08). From Training, two paths branch: the \emph{Vision} path (M09) builds CNNs for spatial processing; the \emph{Language} path (M10--13) builds tokenization through transformers. Both paths converge at Profiling (M14), then branch into parallel optimization tracks---\emph{Model-level} (quantization, compression) and \emph{Runtime} (acceleration, memoization)---before final convergence at Benchmarking (M19) and Capstone (M20).}
\label{fig:module-flow}
\end{figure*}