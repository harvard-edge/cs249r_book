% Horizontal Module Dependency Diagram for TinyTorch Paper
% Use with: \input{module_flow_horizontal.tex}
% Requires: \usepackage{tikz}, \usetikzlibrary{shapes,arrows,positioning,shadows,calc,backgrounds}

\begin{figure*}[t]
\centering
\resizebox{\textwidth}{!}{%
\begin{tikzpicture}[
    node distance=0.4cm and 0.6cm,
    every node/.style={font=\scriptsize\sffamily},
    % Tier styles
    foundation/.style={
        rectangle, 
        draw=blue!60!black, 
        top color=blue!5, 
        bottom color=blue!15, 
        text=blue!40!black,
        minimum width=1.4cm, 
        minimum height=0.6cm, 
        rounded corners=3pt,
        drop shadow={opacity=0.2, shadow xshift=1pt, shadow yshift=-1pt}
    },
    architecture/.style={
        rectangle, 
        draw=purple!60!black, 
        top color=purple!5, 
        bottom color=purple!15, 
        text=purple!40!black,
        minimum width=1.4cm, 
        minimum height=0.6cm, 
        rounded corners=3pt,
        drop shadow={opacity=0.2, shadow xshift=1pt, shadow yshift=-1pt}
    },
    optimization/.style={
        rectangle, 
        draw=orange!60!black, 
        top color=orange!5, 
        bottom color=orange!15, 
        text=orange!40!black,
        minimum width=1.4cm, 
        minimum height=0.6cm, 
        rounded corners=3pt,
        drop shadow={opacity=0.2, shadow xshift=1pt, shadow yshift=-1pt}
    },
    capstone/.style={
        rectangle, 
        draw=red!60!black, 
        top color=red!5, 
        bottom color=red!15, 
        text=red!40!black,
        minimum width=1.4cm, 
        minimum height=0.6cm, 
        rounded corners=3pt,
        drop shadow={opacity=0.2, shadow xshift=1pt, shadow yshift=-1pt}
    },
    % Arrow style
    arr/.style={->, >=stealth, thick, gray!60},
    tier/.style={draw=gray!40, dashed, rounded corners=5pt, inner sep=8pt}
]

% === FOUNDATION TIER (01-08) ===
% Row 1
\node[foundation] (T) {01 Tensor};
\node[foundation, right=of T] (A) {02 Activ.};
\node[foundation, right=of A] (L) {03 Layers};
\node[foundation, right=of L] (Loss) {04 Losses};

% Row 2 - positioned below Row 1
\node[foundation, below=0.6cm of T] (Data) {05 DataLoad.};
\node[foundation, right=of Data] (Auto) {06 Autograd};
\node[foundation, right=of Auto] (Opt) {07 Optim.};
\node[foundation, right=of Opt] (Train) {08 Training};

% Foundation arrows
\draw[arr] (T) -- (A);
\draw[arr] (A) -- (L);
\draw[arr] (L) -- (Loss);
% Wrap from end of Row 1 to start of Row 2
% Route between the two rows to avoid cutting through nodes
\draw[arr, rounded corners=5pt] (Loss.south) -- ++(0,-0.3) -| (Data.north);
\draw[arr] (Data) -- (Auto);
\draw[arr] (Auto) -- (Opt);
\draw[arr] (Opt) -- (Train);

% === ARCHITECTURE TIER (09-13) ===

    % Language path (bottom branch)
    \node[architecture, below right=0.6cm and 0.8cm of Train] (Tok) {10 Token.};
    \node[architecture, right=of Tok] (Emb) {11 Embed.};
    \node[architecture, right=of Emb] (Att) {12 Attention};
    \node[architecture, right=of Att] (Trans) {13 Transform.};

    % Branch down from Train
    \draw[arr, rounded corners=5pt] (Train.east) -- ++(0.3,0) |- (Tok.west);

    \draw[arr] (Tok) -- (Emb);
    \draw[arr] (Emb) -- (Att);
    \draw[arr] (Att) -- (Trans);

    % Vision path (top branch) - Centered above the Language path
    \node[architecture] (Spatial) at ($(Tok.north)!0.5!(Trans.north) + (0, 1.2)$) {09 CNNs};

    % Branch up from Train
    \draw[arr, rounded corners=5pt] (Train.east) -- ++(0.3,0) |- (Spatial.west);

    % === OPTIMIZATION TIER (14-19) ===
    % Profiling - convergence point
    % Position relative to the longest branch (Trans) to avoid overlap
    \node[optimization, right=1.0cm of Trans, yshift=1.2cm] (Prof) {14 Profiling};

    % Converge to Profiling
    \draw[arr, rounded corners=5pt] (Spatial.east) -| (Prof.north);
    \draw[arr, rounded corners=5pt] (Trans.east) -| (Prof.south);

% Parallel optimization branches
\node[optimization, above right=0.4cm and 0.6cm of Prof] (Quant) {15 Quant.};
\node[optimization, right=0.4cm of Quant] (Comp) {16 Compress.};
\node[optimization, below right=0.4cm and 0.6cm of Prof] (Accel) {17 Accel.};
\node[optimization, right=0.4cm of Accel] (Memo) {18 Memo.};

% Branch from Profiling
% Use different x-offsets for the turn to separate visual clutter if needed, 
% or just anchors.
\draw[arr, rounded corners=5pt] (Prof.east) -- ++(0.2,0) |- (Quant.west);
\draw[arr, rounded corners=5pt] (Prof.east) -- ++(0.2,0) |- (Accel.west);

% Internal optimization flows
\draw[arr] (Quant) -- (Comp);
\draw[arr] (Accel) -- (Memo);

% Benchmarking - convergence
\node[optimization, right=0.8cm of Prof, xshift=2.8cm] (Bench) {19 Benchmark};

% Route to Benchmark - use perpendicular paths
\draw[arr, rounded corners=5pt] (Comp.east) -| (Bench.north);
\draw[arr, rounded corners=5pt] (Memo.east) -| (Bench.south);

% === CAPSTONE (20) ===
\node[capstone, right=0.8cm of Bench] (Cap) {20 Capstone};
\draw[arr] (Bench) -- (Cap);

    % === TIER LABELS ===
    % Define a common vertical position above the highest elements (Foundation Row 1)
    % T is in the top row of Foundation. We add ample space above it.
    \path (T.north) ++(0, 1.2) coordinate (LabelLine);

    % Foundation Label - Centered over Foundation section (Row 1 midpoint)
    \node[font=\scriptsize\bfseries\sffamily, blue!60!black] at (LabelLine -| $(T)!0.5!(Loss)$) {FOUNDATION (01-08)};

    % Architecture Label - Centered over Architecture section (Spatial node is centered horizontally)
    \node[font=\scriptsize\bfseries\sffamily, purple!60!black] at (LabelLine -| Spatial) {ARCHITECTURE (09-13)};

    % Optimization Label - Centered over Optimization section (Midpoint of Prof and Bench)
    \node[font=\scriptsize\bfseries\sffamily, orange!60!black] at (LabelLine -| $(Prof)!0.5!(Bench)$) {OPTIMIZATION (14-19)};

    % === PATH LABELS ===
    \node[above=0.15cm of Spatial, font=\scriptsize\sffamily, gray] {Vision};
    \node[below=0.15cm of Tok, font=\scriptsize\sffamily, gray] {Language};
    \node[above=0.1cm of Quant, font=\scriptsize\sffamily, gray] {Size};
    \node[below=0.1cm of Memo, font=\scriptsize\sffamily, gray] {Speed};

\end{tikzpicture}%
}
\caption{\textbf{Module Dependency Graph.} TinyTorch's 20 modules form a directed acyclic graph with two architectural paths. Foundation modules (blue, M01--08) build core infrastructure sequentially, culminating in Training (M08). From Training, two paths branch: the \emph{Vision} path (M09) builds CNNs for spatial processing; the \emph{Language} path (M10--13) builds tokenization through transformers. Both paths converge at Profiling (M14), then branch into parallel optimization tracks---\emph{Model-level} (quantization, compression) and \emph{Runtime} (acceleration, memoization)---before final convergence at Benchmarking (M19) and Capstone (M20).}
\label{fig:module-flow}
\end{figure*}