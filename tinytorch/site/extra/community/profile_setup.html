<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Profile</title>
    <link rel="icon" href="assets/flame.svg" type="image/svg+xml">
    <style>
        /* Basic clean styling */
        body {
            margin: 0;
            width: 100%;
            min-height: 100vh;
            overflow: auto; /* Allow scrolling if too tall */
            display: flex;
            align-items: center;
            justify-content: center;
            /* Graph paper background color */
            background-color: #f0f4f8;
            /* CSS Gradients to create graph paper lines */
            background-image:
                linear-gradient(#e1e5ea 1px, transparent 1px),
                linear-gradient(90deg, #e1e5ea 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Verdana', sans-serif;
            color: #333;
            background: transparent; /* Clear for layers below */
            padding: 20px; /* Safe area */
            box-sizing: border-box;
        }

        #bgCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            /* Graph paper lines */
            background-image:
                linear-gradient(#e1e5ea 1px, transparent 1px),
                linear-gradient(90deg, #e1e5ea 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 800px; /* Slightly smaller */
            /* max-height removed to allow content to dictate height within reason, or use viewport constraint */
            max-height: 85vh; /* Keep some constraint but allow scroll inside */
            display: flex;
            align-items: stretch;
            overflow: hidden;
            z-index: 1;
        }

        .form-content {
            flex: 1;
            padding: 40px; /* Reduced padding */
            overflow-y: auto;
        }

        .candle-side {
            flex: 0 0 300px; /* Reduced width */
            background: #fcfcfc;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid #f0f0f0;
        }

        #candleCanvas {
            height: 50vh;
            max-height: 400px;
            aspect-ratio: 16/24;

            /* Keep the sharp pixel art look */
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;

            filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.05));
            transform: translateY(120px); /* Lower the candle a bit */
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column-reverse;
                max-height: none; /* Allow full height on mobile scroll */
                height: auto;
            }
            .candle-side {
                flex: 0 0 150px;
                width: 100%;
                border-left: none;
                border-bottom: 1px solid #eee;
            }
            #candleCanvas {
                height: 150px;
            }
            .form-content {
                width: 100%;
                padding: 25px;
                max-height: none;
            }
        }

        h2 { margin-top: 0; color: #222; font-size: 1.5rem; margin-bottom: 8px; } /* Smaller header */
        p.subtitle { color: #666; font-size: 0.9rem; margin-bottom: 25px; line-height: 1.4; }

        .form-group { margin-bottom: 20px; }

        label { display: block; font-weight: bold; font-size: 0.9rem; color: #444; margin-bottom: 8px; }
        .optional { font-weight: normal; color: #888; font-size: 0.8rem; margin-left: 5px; }

        input, textarea {
            width: 100%; padding: 12px;
            border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 1rem; font-family: inherit;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus { border-color: #ff6600; outline: none; }

        textarea { resize: vertical; min-height: 80px; }

        button {
            width: 100%; padding: 14px;
            background: #ff6600; color: white;
            border: none; border-radius: 8px;
            font-weight: bold; font-size: 1.1rem;
            cursor: pointer; transition: background 0.2s, transform 0.1s;
            margin-top: 10px;
        }
        button:hover { background: #e65c00; transform: translateY(-1px); }
        button:disabled { background: #ffcc99; cursor: not-allowed; transform: none; }

        /* Autocomplete Dropdown */
        .input-wrapper { position: relative; }
        .suggestions {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ccc; border-radius: 8px;
            max-height: 150px; overflow-y: auto; display: none; z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-top: 4px;
        }
        .suggestion-item { padding: 12px; cursor: pointer; font-size: 0.9em; border-bottom: 1px solid #eee; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: #fff5e6; color: #ff6600; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<div class="grid-overlay"></div>

<div class="container">
    <div class="form-content">
        <h2>ðŸ”¥ Tiny ðŸ”¥ Torch: Complete Your Profile</h2>
        <p class="subtitle">Tell us a bit about yourself to get started</p>

        <form id="setupForm">
            <div class="form-group">
                <label>Display Name *</label>
                <input type="text" id="displayName" required placeholder="e.g. Kai">
            </div>

            <div class="form-group">
                <label>Full Name <span class="optional">(Optional)</span></label>
                <input type="text" id="fullName" placeholder="e.g. Kai Kleinbard">
            </div>

            <div class="form-group">
                <label>Institution / Company *</label>
                <input type="text" id="institution" required placeholder="e.g. Harvard University" value="Independent">
                <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">Defaults to "Independent" if you are not affiliated.</div>
            </div>

            <div class="form-group">
                <label>Location (City) *</label>
                <div class="input-wrapper">
                    <input type="text" id="locationInput" required placeholder="Start typing..." autocomplete="off">
                    <div id="suggestions" class="suggestions"></div>
                </div>
            </div>

            <div class="form-group">
                <label>Summary / Bio <span class="optional">(Optional)</span></label>
                <textarea id="summary" placeholder="A brief summary about yourself and your interests in AI..."></textarea>
            </div>

            <div class="form-group">
                <label>Websites <span class="optional">(Optional, comma-separated)</span></label>
                <input type="text" id="websites" placeholder="https://github.com/..., https://linkedin.com/...">
            </div>

            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="mailingList" checked style="width: auto;">
                <label for="mailingList" style="margin: 0; font-weight: normal;">Subscribe to our mailing list</label>
            </div>

            <input type="hidden" id="latParams">
            <input type="hidden" id="lonParams">

            <button type="submit" id="saveBtn">Complete Setup</button>
        </form>
    </div>

    <!-- Candle Canvas Inside Container -->
    <canvas id="candleCanvas" width="16" height="24"></canvas>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { SUPABASE_PROJECT_URL, SUPABASE_ANON_KEY, SUPABASE_URL, getBasePath } from './modules/config.js';
    import { initCandle } from './modules/candle.js';
    import { initTerrain } from './modules/terrain.js';

    // Initialize Animations
    initCandle('candleCanvas');
    initTerrain('bgCanvas');

    const supabase = createClient(SUPABASE_PROJECT_URL, SUPABASE_ANON_KEY);

    // --- 1. AUTOCOMPLETE LOGIC ---
    const locInput = document.getElementById('locationInput');
    const box = document.getElementById('suggestions');
    let timer;

    locInput.addEventListener('input', (e) => {
        clearTimeout(timer);
        // Reset hidden coords if user types manually
        document.getElementById('latParams').value = "";
        document.getElementById('lonParams').value = "";

        if(e.target.value.length < 3) { box.style.display = 'none'; return; }

        timer = setTimeout(async () => {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e.target.value)}`);
                const data = await res.json();

                box.innerHTML = '';
                if(data.length) box.style.display = 'block';

                data.slice(0,5).forEach(place => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = place.display_name;
                    div.onclick = () => {
                        locInput.value = place.display_name;
                        document.getElementById('latParams').value = place.lat;
                        document.getElementById('lonParams').value = place.lon;
                        box.style.display = 'none';
                    };
                    box.appendChild(div);
                });
            } catch(e) { console.error(e); }
        }, 300);
    });

    // --- 2. PRE-FILL LOGIC ---
    async function loadUser() {
        const { data: { user } } = await supabase.auth.getUser();
        if(!user) {
            window.location.href = getBasePath() + '/index.html';
            return;
        }

        // 1. Try to grab name from Google/GitHub metadata
        if(user.user_metadata) {
            if(user.user_metadata.full_name) {
                document.getElementById('fullName').value = user.user_metadata.full_name;
                // Heuristic for display name: First part of full name
                const parts = user.user_metadata.full_name.split(' ');
                if(parts.length > 0) document.getElementById('displayName').value = parts[0];
            }
            if(user.user_metadata.name && !document.getElementById('fullName').value) {
                 document.getElementById('fullName').value = user.user_metadata.name;
            }
        }

        // 2. Check if they partially filled the DB before
        const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        if(profile) {
            if(profile.display_name) document.getElementById('displayName').value = profile.display_name;
            if(profile.full_name) document.getElementById('fullName').value = profile.full_name;
            if(profile.location) document.getElementById('locationInput').value = profile.location;

            // Institution logic
            let inst = "Independent";
            if(profile.institution) {
                 const dbInst = Array.isArray(profile.institution) ? profile.institution[0] : profile.institution;
                 if(dbInst && dbInst.trim() !== "") inst = dbInst;
            }
            document.getElementById('institution').value = inst;

            if(profile.bio || profile.summary) document.getElementById('summary').value = profile.bio || profile.summary;

            if(profile.website || profile.websites) {
                const sites = profile.website || profile.websites;
                document.getElementById('websites').value = Array.isArray(sites) ? sites.join(', ') : sites;
            }

            if(profile.mailing_list !== undefined && profile.mailing_list !== null) {
                document.getElementById('mailingList').checked = profile.mailing_list;
            }
        }
    }
    loadUser();

    // --- 3. SUBMIT LOGIC (Call Edge Function) ---
    document.getElementById('setupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('saveBtn');
        btn.textContent = "Saving Profile...";
        btn.disabled = true;

        const { data: { session } } = await supabase.auth.getSession();

        // Prepare Institution as Array
        const instVal = document.getElementById('institution').value.trim();
        const institutions = instVal ? [instVal] : ["Independent"];

        // Prepare Websites as Array
        const webVal = document.getElementById('websites').value;
        const websites = webVal.split(',').map(s => s.trim()).filter(s => s);

        try {
            const res = await fetch(`${SUPABASE_URL}/update-profile`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({
                    display_name: document.getElementById('displayName').value,
                    full_name: document.getElementById('fullName').value,
                    institution: institutions,
                    location: locInput.value,
                    bio: document.getElementById('summary').value,
                    website: websites,
                    mailing_list: document.getElementById('mailingList').checked,
                    // Geo
                    latitude: document.getElementById('latParams').value ? parseFloat(document.getElementById('latParams').value) : undefined,
                    longitude: document.getElementById('lonParams').value ? parseFloat(document.getElementById('lonParams').value) : undefined
                })
            });

            if(!res.ok) throw new Error("Save failed");

            // Success! Send to main app
            window.location.href = getBasePath() + '/dashboard.html';

        } catch(err) {
            console.error(err);
            alert("Error saving. Please try again.");
            btn.textContent = "Complete Setup";
            btn.disabled = false;
        }
    });

    // Close dropdown if clicking outside
    document.addEventListener('click', (e) => {
        if(e.target !== locInput) box.style.display = 'none';
    });
</script>

</body>
</html>
