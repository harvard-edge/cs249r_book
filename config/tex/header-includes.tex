% Package imports

% \usepackage[outercaption, ragged]{sidecap}  % Commented out to make figure captions inline instead of in margin
\usepackage{adjustbox}
\usepackage{afterpage}
\usepackage{morefloats}
\usepackage{array}
\usepackage{atbegshi} % Package to insert content at the beginning
\usepackage[english]{babel}
\usepackage{caption}
%\captionsetup[table]{belowskip=5pt}
\captionsetup{format=plain}
\DeclareCaptionLabelFormat{mylabel}{#1
#2:\hspace{1.0ex}}
\DeclareCaptionFont{ninept}{\fontsize{7pt}{8}\selectfont #1}
\captionsetup[figure]{labelfont={bf,ninept},labelsep=space,
belowskip=2pt,aboveskip=6pt,labelformat=mylabel,
justification=raggedright,singlelinecheck=false,font={ninept}}

\captionsetup[table]{belowskip=6pt,labelfont={bf,ninept},labelsep=none,
labelformat=mylabel,justification=centering,singlelinecheck=false,font={ninept}}

\usepackage{etoolbox}% For redefining footnotes
\usepackage{fancyhdr}
\usepackage{listings}
\usepackage{fontspec}
\usepackage{geometry}
\usepackage{graphicx}
\usepackage{float}
\usepackage{hyperref}
\usepackage{ifthen}
\usepackage{longtable}
\usepackage{luatex85}
\usepackage{marginfix} % Fixes the issue of margin notes being cut off
\usepackage{marginnote}
\renewcommand\raggedrightmarginnote{\sloppy}
\renewcommand\raggedleftmarginnote{\sloppy}
\usepackage{mathptmx}
\usepackage{microtype} % Optional: improves justification and hyphenation
\usepackage{newpxtext} % Palatino-like font
\usepackage{ragged2e}
\usepackage{sidenotes}
\usepackage{tikz}
\usetikzlibrary{positioning}
\usetikzlibrary{calc}
\usepackage[explicit,newparttoc]{titlesec}%
\usepackage{tocloft}
\usepackage[dvipsnames]{xcolor}
\usepackage{changepage}
\usepackage{emptypage}
\usepackage[all]{nowidow}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{enumitem}
\usepackage{needspace}
% Define uppercase version for compatibility with Quarto filters
\let\Needspace\needspace
\usepackage{fontawesome5}
\usepackage{qrcode}
\qrset{link, height=15mm}
\usepackage{tikzpagenodes}

% Increase float limits to handle many figures
\extrafloats{100}
\setcounter{topnumber}{10}
\setcounter{bottomnumber}{10}
\setcounter{totalnumber}{20}
\renewcommand{\topfraction}{.9}
\renewcommand{\bottomfraction}{.9}
\renewcommand{\textfraction}{.1}
\renewcommand{\floatpagefraction}{.8}

% Define the Crimson color
\definecolor{crimson}{HTML}{A51C30}
% Quiz-question colors (hex “E1F3F8” → RGB 225,243,248; “119EC7” → RGB 17,158,199)
\definecolor{quiz-question-color1}{RGB}{225,243,248}
\definecolor{quiz-question-color2}{RGB}{17,158,199}

% Quiz-answer colors   (hex “FAEAF1” → RGB 250,234,241; “980e5a” → RGB 152,14,90)
\definecolor{quiz-answer-color1}{RGB}{250,234,241}
\definecolor{quiz-answer-color2}{RGB}{152,14,90}

\def\tightlist{}
\setlist{itemsep=1pt, parsep=1pt, topsep=0pt,after={\vspace{0.3\baselineskip}}}
\let\tightlist\relax

\makeatletter
\@ifpackageloaded{framed}{}{\usepackage{framed}}
\@ifpackageloaded{fancyvrb}{}{\usepackage{fancyvrb}}
\makeatother 


%New float "codelisting" has been updated
\AtBeginDocument{%
\floatstyle{ruled}
\newfloat{codelisting}{!htb}{lop}
\floatname{codelisting}{Listing}
\floatplacement{codelisting}{!htb}
\captionsetup[codelisting]{labelfont=bf,skip=-2pt,labelfont={bf,ninept},labelformat=mylabel,
singlelinecheck=false,width=\linewidth,labelsep=none,font={ninept}}
\renewenvironment{snugshade}{%
   \def\FrameCommand{\fboxsep=5pt\colorbox{shadecolor}}%
   \MakeFramed{\advance\hsize-\width\FrameRestore}%
   \leftskip 0.5em \rightskip 0.5em}%
   {\endMakeFramed}%
}

%The space before and after the verbatim environment "Highlighting" has been reduced
\fvset{listparameters=\setlength{\topsep}{0pt}\setlength{\partopsep}{0pt}}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{framesep=0mm,commandchars=\\\{\}}

\makeatletter
\renewcommand\fs@ruled{\def\@fs@cfont{\bfseries}\let\@fs@capt\floatc@ruled
\def\@fs@pre{\hrule height.8pt depth0pt \kern2pt}%
\def\@fs@post{\kern2pt\hrule\relax}%
\def\@fs@mid{\kern2pt\hrule\kern-2pt}%space between float and caption
\let\@fs@iftopcapt\iftrue}
\makeatother

% Explicit hyphenation rules
\hyphenation{
  light-weight
  light-weight-ed
  de-vel-op-ment
  un-der-stand-ing
  mod-els
  prin-ci-ples
  ex-per-tise
  com-pli-cat-ed
}

\lstset{
breaklines=true,  % wraping
breakatwhitespace=true,
basicstyle=\ttfamily,
frame=none,
keepspaces=true,
showspaces=false,
showtabs=false,
columns=flexible,
belowskip=0pt,
aboveskip=0pt
}
\geometry{
  paperwidth=7.5in,
  paperheight=9.25in,
  top=1in,
  bottom=1in,
  inner=1in,
  outer=2.25in,
  footskip=30pt,
  marginparwidth=1.5in,
  twoside
}

% Redefine \sidenote to include a custom minimalist styled box with a vertical bar
\renewcommand{\thefootnote}{\textcolor{crimson}{\arabic{footnote}}}

% Save the old \sidenote command (only if it exists)
\makeatletter
\@ifundefined{oldsidenote}{
  \let\oldsidenote\sidenote%
}{}
\makeatother

% Redefine \sidenote
\renewcommand{\sidenote}[1]{%
  \oldsidenote{%
    \noindent
    \color{crimson!100} % Set the color for the vertical line
    \raisebox{0em}{% Raise the vertical line to align with the number
      \rule{0.5pt}{1.5em} % Thin vertical line with fixed height
    }
    \hspace{0.3em} % Spacing between the line and the sidenote text
    \color{black} % Reset color for sidenote text
    {\footnotesize #1} % Sidenote text in smaller font size
  }%
}

% Redefine the figure environment (fixes the bug where even page captions don't show, odd I know!)
\makeatletter
\let\oldfigure\figure%
\let\endoldfigure\endfigure%
\renewenvironment{figure}[1][htbp]{%
  \oldfigure[#1]%
}{%
  \endoldfigure%
}
\makeatother

\patchcmd{\chapter}{\thispagestyle{plain}}{\thispagestyle{fancy}}{}{}

% Page style settings
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE]{\small\color{crimson}\nouppercase{\rightmark}}
\fancyhead[RO]{\color{crimson}\thepage}
\fancyhead[LO]{\small\color{crimson}\nouppercase{\leftmark}}
\fancyhead[RE]{\color{crimson}\thepage}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyfoot[C]{\color{crimson}\thepage}
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
}

% KOMA-Script adjustments
\addtokomafont{disposition}{\rmfamily\color{crimson}}
\addtokomafont{chapter}{\color{crimson}}
\addtokomafont{section}{\color{crimson}}
\addtokomafont{subsection}{\color{crimson}}

\newenvironment{abstract}{
  \chapter*{\abstractname}
  \addcontentsline{toc}{chapter}{\abstractname}
  \small
}{
  \clearpage
}

\hypersetup{
  linkcolor=crimson,
  citecolor=crimson,
  urlcolor=crimson,
  pdfpagelayout=TwoPageRight, % This sets the layout to two-page mode with the first page alone
  pdfstartview=Fit % This sets the initial zoom to fit the page
}

% --- Summary text that will be written below \part
\newcommand{\partsummary}{} % empty by default
\newif\ifhaspartsummary%
\haspartsummaryfalse%

\newcommand{\setpartsummary}[1]{%
  \renewcommand{\partsummary}{#1}%
  \haspartsummarytrue%
}

\definecolor{BrownLL}{RGB}{233,222,220}
\definecolor{BlueDD}{RGB}{62,100,125}

\titleformat{\part}[display]
{\thispagestyle{empty}}{}{20pt}{
\begin{tikzpicture}[remember picture,overlay]
%%%
%%
\node[crimson,align=flush right,
inner sep=0,outer sep=0mm,draw=none,%
anchor=east,minimum height=31mm, text width=1.2\textwidth,
yshift=-30mm,font={%
\fontsize{98pt}{104}\selectfont\bfseries}]  (BG) at (current page text area.north east){\thepart};
%
\node[black,inner sep=0mm,draw=none,
anchor=mid,text width=1.2\textwidth,
 minimum height=35mm, align=right,
node distance=7mm,below=of BG,
font={\fontsize{30pt}{34}\selectfont}]
(BGG)  {\hyphenchar\font=-1 \color{black}\MakeUppercase {#1}};
\draw [crimson,line width=3pt] ([yshift=0mm]BGG.north west) -- ([yshift=0mm]BGG.north east);
\draw [crimson,line width=2pt] ([yshift=0mm]BGG.south west) -- ([yshift=0mm]BGG.south east);
%
\node[fill=crimson,text=white,rotate=90,%
anchor=south west,minimum height=15mm,
minimum width=40mm,font={%
\fontsize{20pt}{20}\selectfont\bfseries}](BP)  at
(current page text area.south east)
{{\sffamily Part}~\thepart};
%
% Numbered parts do NOT show descriptions - only Roman numeral, title, and sidebar
\end{tikzpicture}
}[]

\renewcommand{\thepart}{\Roman{part}}

% Define neural network gradient colors inspired by the main page
\definecolor{NeuralBlue}{RGB}{52,144,220}      % Deep blue for input nodes
\definecolor{NeuralTeal}{RGB}{72,162,193}      % Teal transition
\definecolor{NeuralPurple}{RGB}{120,81,169}    % Purple middle layer
\definecolor{NeuralMagenta}{RGB}{180,69,137}   % Magenta transition  
\definecolor{NeuralCrimson}{RGB}{165,28,48}    % Crimson output nodes

% ==========================================
% CURRENT CLEAN DESIGN (SAVED)
% ==========================================
% \titleformat{name=\part,numberless}[display]
% {\thispagestyle{empty}}{}{20pt}{%
% \begin{tikzpicture}[remember picture,overlay]
% % Simple, clean, full-page design
% % Subtle background gradient
% \fill[NeuralBlue,opacity=0.04] (current page.north west) rectangle (current page.south east);
% \fill[NeuralPurple,opacity=0.03] ([xshift=6cm]current page.north west) rectangle ([xshift=15cm,yshift=-12cm]current page.north west);
% \fill[NeuralMagenta,opacity=0.02] ([xshift=10cm,yshift=-6cm]current page.north west) rectangle (current page.south east);
% % Sparse neural nodes
% \fill[NeuralBlue,opacity=0.5] ([xshift=2cm,yshift=-3cm]current page.north west) circle (1mm);
% \fill[NeuralBlue,opacity=0.4] ([xshift=4cm,yshift=-8cm]current page.north west) circle (0.8mm);
% \fill[NeuralTeal,opacity=0.6] ([xshift=8cm,yshift=-4cm]current page.north west) circle (1.2mm);
% \fill[NeuralTeal,opacity=0.4] ([xshift=12cm,yshift=-10cm]current page.north west) circle (0.9mm);
% \fill[NeuralPurple,opacity=0.7] ([xshift=14cm,yshift=-6cm]current page.north west) circle (1.1mm);
% \fill[crimson,opacity=0.8] ([xshift=10cm,yshift=-8cm]current page.north west) circle (1.5mm);
% % Minimal connections
% \draw[NeuralTeal,opacity=0.2,line width=0.3pt] ([xshift=2cm,yshift=-3cm]current page.north west) -- ([xshift=8cm,yshift=-4cm]current page.north west);
% \draw[NeuralPurple,opacity=0.2,line width=0.3pt] ([xshift=8cm,yshift=-4cm]current page.north west) -- ([xshift=14cm,yshift=-6cm]current page.north west);
% % Centered title
% \node[anchor=center,font={\fontsize{40pt}{44}\selectfont\bfseries}] at ([xshift=10cm,yshift=-6cm]current page.north west) {\color{crimson}\MakeUppercase{#1}};
% % Centered description
% \ifhaspartsummary\node[inner sep=8pt,text width=12cm,fill=white,fill opacity=0.95,rounded corners=2pt,align=center,font={\fontsize{9pt}{12}\selectfont},anchor=center] at ([xshift=10cm,yshift=-14cm]current page.north west) {\partsummary};\fi
% \end{tikzpicture}%
% }

% ==========================================
% RESTORED ORIGINAL WITH CURVED CONNECTIONS
% ==========================================
\titleformat{name=\part,numberless}[display]
{\thispagestyle{empty}}{}{20pt}{%
\begin{tikzpicture}[remember picture,overlay]
% Original neural network design with curved connections
% Flowing background elements
\fill[NeuralBlue,opacity=0.08] (current page.north west) rectangle ([xshift=8cm,yshift=-6cm]current page.north west);
\fill[NeuralPurple,opacity=0.08] ([xshift=6cm,yshift=-4cm]current page.north west) rectangle ([xshift=14cm,yshift=-10cm]current page.north west);
\fill[NeuralMagenta,opacity=0.08] ([xshift=10cm,yshift=-6cm]current page.north west) rectangle ([xshift=18cm,yshift=-12cm]current page.north west);
% Neural nodes
\foreach \i in {1,2,...,6} {\fill[NeuralBlue,opacity=0.6] ([xshift=1cm,yshift=-\i*1.5cm-3cm]current page.north west) circle (1mm);}
\foreach \i in {1,2,...,4} {\fill[NeuralTeal,opacity=0.6] ([xshift=4cm,yshift=-\i*2cm-4cm]current page.north west) circle (1mm);}
\foreach \i in {1,2,3} {\fill[NeuralPurple,opacity=0.6] ([xshift=7cm,yshift=-\i*2.5cm-5cm]current page.north west) circle (1mm);}
\fill[crimson,opacity=0.8] ([xshift=10cm,yshift=-7cm]current page.north west) circle (1.5mm);
% Beautiful curved connection lines instead of straight ones
\foreach \i in {2,4,6} {
  \foreach \j in {2,4} {
    \draw[NeuralTeal,opacity=0.3,line width=0.2pt] ([xshift=1.1cm,yshift=-\i*1.5cm-3cm]current page.north west) 
      .. controls ++(1cm,-0.5cm) and ++(-1cm,0.5cm) .. ([xshift=3.9cm,yshift=-\j*2cm-4cm]current page.north west);
  }
}
\foreach \i in {2,4} {
  \foreach \j in {2,3} {
    \draw[NeuralPurple,opacity=0.3,line width=0.2pt] ([xshift=4.1cm,yshift=-\i*2cm-4cm]current page.north west) 
      .. controls ++(1.5cm,-0.3cm) and ++(-1.5cm,0.3cm) .. ([xshift=6.9cm,yshift=-\j*2.5cm-5cm]current page.north west);
  }
}
\foreach \i in {2,3} {
  \draw[NeuralMagenta,opacity=0.3,line width=0.2pt] ([xshift=7.1cm,yshift=-\i*2.5cm-5cm]current page.north west) 
    .. controls ++(1.5cm,-0.2cm) and ++(-1.5cm,0.2cm) .. ([xshift=9.9cm,yshift=-7cm]current page.north west);
}
% Enhanced bold typography without decorative line - margin aware
\node[anchor=center,font={\fontsize{44pt}{48}\selectfont\bfseries}] at ([xshift=0.5\textwidth,yshift=-15cm]current page text area.north west) {\color{crimson}\MakeUppercase{#1}};
% Description removed completely - no description box
\end{tikzpicture}%
}

% Redefine \section
\titleformat{\section}
  {\normalfont\Large\bfseries\color{crimson}\raggedright} % Set the color to crimson
  {\thesection}
  {0.5em}
  {#1}
\titlespacing*{\section}{0pc}{14pt plus 4pt minus 4pt}{6pt plus 2pt minus 2pt}[0pc]

% Redefine \subsection
\titleformat{\subsection}
  {\normalfont\large\bfseries\color{crimson}\raggedright} % Set the color to crimson
  {\thesubsection}
  {0.5em}
  {#1}
\titlespacing*{\subsection}{0pc}{12pt plus 4pt minus 4pt}{5pt plus 1pt minus 2pt}[0pc]

% Redefine \subsubsection
\titleformat{\subsubsection}
  {\normalfont\normalsize\bfseries\color{crimson}\raggedright} % Set the color to crimson
  {\thesubsubsection}
  {0.5em}
  {#1}
\titlespacing*{\subsubsection}{0pc}{12pt plus 4pt minus 4pt}{5pt plus 1pt minus 2pt}[0pc]

% Redefine \paragraph (if you want to apply the Crimson color here)
\titleformat{\paragraph}[runin]
  {\normalfont\normalsize\bfseries\color{crimson}} % Set the color to crimson
  {\theparagraph}
  {0.5em}
  {#1}
  [\textbf{.}]
  \titlespacing*{\paragraph}{0pc}{6pt plus 2pt minus 2pt}{0.5em}[0pc]

% Redefine \subparagraph (if you want to apply the Crimson color here)
\titleformat{\subparagraph}[runin]
  {\normalfont\normalsize\itshape\color{crimson}}% Set the color to crimson
  {\thesubparagraph}
  {0.5em}
  {#1}
  [\textbf{.}]
  \titlespacing*{\subparagraph}{0pc}{6pt plus 2pt minus 2pt}{0.5em}[0pc]

% Customize Chapter title format
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries\color{crimson}} % Apply the crimson color
  {\chaptername\ \thechapter} % Prefix "Chapter X"
  {20pt} % Space between number and title
  {\Huge #1} % Format the title itself
  []

% Customize Chapter title format
\titleformat{name=\chapter,numberless}%[display]
  {\normalfont\huge\bfseries\color{crimson}} % Apply the crimson color
  {} % Prefix "Chapter X"
  {20pt} % Space between number and title
  {\Huge #1} % Format the title itself#1
  []

% Ensure that \chaptername is set to "Chapter"
\renewcommand{\chaptername}{Chapter}
\setcounter{tocdepth}{2}
\setlength{\cftchapnumwidth}{2em}  % Adjust width for chapter numbers
\setlength{\cftsecnumwidth}{2.75em} % Adjust width for section numbers
\setlength{\cftsubsecnumwidth}{3.25em} % Adjust width for subsection numbers
\setlength{\cftsubsubsecnumwidth}{4em} % Adjust width for subsubsection numbers
\setlength{\cftsubsecindent}{4.25em}  % Adjust the indent for alignment
\setlength{\cftsubsubsecindent}{7.5em}  % Adjust the indent for alignment

% Customize TOC chapter format
\renewcommand{\cftchapfont}{\bfseries\color{crimson}} % Makes TOC chapters crimson
\renewcommand{\cftchappresnum}{\color{crimson}Chapter~} % Adds "Chapter" in crimson

% Customize TOC part format
\renewcommand{\cftpartpresnum}{Part}
\newlength{\xpartspace}
\settowidth{\xpartspace}{\cftpartpresnum}
\addtolength{\cftpartnumwidth}{\xpartspace}
\cftpagenumbersoff{part}

\makeatletter
\renewcommand{\cftpartfont}{\hfil\bfseries\color{crimson}}
\renewcommand{\cftpartpresnum}{%
  \begin{lrbox}{\@tempboxa}%
    \bfseries\color{crimson}Part~~\thepart%
  \end{lrbox}%
  \usebox{\@tempboxa}%
}
\renewcommand{\cftpartaftersnum}{\hfil}
\makeatother

% Ensure correct spacing for TOC numbering
\newlength{\xtraspace}
\settowidth{\xtraspace}{\cftchappresnum\cftchapaftersnum}
\addtolength{\cftchapnumwidth}{\xtraspace}

% Command for unnumbered chapters with TOC entry
\newcommand{\likechapter}[1]{%    
    \chapter*{#1}
    \addcontentsline{toc}{chapter}{\textcolor{crimson}{#1}} % Color TOC entry
}

% Page numbering setup
\makeatletter
% Store whether we've seen the first of each type
\newif\if@firstnumbered%
\@firstnumberedtrue%
\newif\if@firstunnumbered%
\@firstunnumberedtrue%

% Store the page numbers
\newcounter{lastRomanPage}
\setcounter{lastRomanPage}{1}

% Initial setup for front matter
\AtBeginDocument{
  \pagenumbering{roman}
  \renewcommand{\thepage}{\roman{page}}
}

% Modify chapter to handle page numbering
\let\old@chapter\chapter%
\renewcommand{\chapter}{%
  \@ifstar{\unnumbered@chapter}{\numbered@chapter}%
}

\newcommand{\numbered@chapter}[1]{%
  \if@firstnumbered%
    \cleardoublepage%
    \setcounter{lastRomanPage}{\value{page}}%
    \pagenumbering{arabic}%
    \@firstnumberedfalse%
  \else
    \setcounter{page}{\value{page}}%
  \fi
  \setcounter{sidenote}{1}% Reset footnote counter
  \old@chapter{#1}%
}

% Handle unnumbered chapters
\newcommand{\unnumbered@chapter}[1]{%
  \if@firstunnumbered%
    \clearpage
    \setcounter{lastRomanPage}{\value{page}}%
    \pagenumbering{roman}%
    \@firstunnumberedfalse%
  \fi
  \setcounter{sidenote}{1}% Reset footnote counter
  % Save the current chapter counter value
  \edef\tempchapter{\the\value{chapter}}%
  \old@chapter*{#1}%
  % Restore the chapter counter to prevent increment
  \setcounter{chapter}{\tempchapter}%
}
\makeatother


\AtBeginEnvironment{longtable}{\scriptsize} % Adjust to \footnotesize or \scriptsize if needed

% Custom frontmatter figure numbering
% This makes frontmatter figures (chapter 0) use alphabetic numbering: Figure A, Figure B, etc.
% Main content figures continue to use standard chapter.number format: Figure 1.1, Figure 2.1, etc.
\makeatletter
\@ifundefined{c@chapter}{}{%
  \renewcommand{\thefigure}{\ifnum\c@chapter=0 \Alph{figure}\else\thechapter.\arabic{figure}\fi}
}
\makeatother

\setcounter{chapter}{0}
